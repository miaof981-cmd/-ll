# 真机测试指南 - 订阅消息

## ✅ 已完成的改进

我已经在测试页面添加了**调试日志显示**功能！

现在在真机上测试时，页面顶部会显示一个黑色的调试日志框，实时显示测试过程中的每一步操作和结果。

---

## 📱 真机测试步骤

### 第1步：编译并预览

1. **点击微信开发者工具顶部的"编译"按钮**
   - 确保最新代码已编译

2. **点击右上角"预览"按钮**
   - 会生成一个二维码

3. **用手机微信扫码**
   - 打开小程序

---

### 第2步：进入测试页面

**方法1：通过"我的"页面（推荐）**
1. 点击底部"我的"标签
2. 如果你是管理员，会看到"管理功能"区域
3. 点击"📨 订阅消息测试"

**方法2：通过控制台**
1. 在小程序任意页面
2. 在开发者工具的控制台输入：
   ```javascript
   wx.navigateTo({url: '/pages/test-notification/test-notification'})
   ```
3. 手机上的小程序会自动跳转

---

### 第3步：查看调试日志

进入测试页面后，**页面顶部会显示一个黑色的调试日志框**：

```
调试日志
───────────────────────
[10:30:15] 用户openid: o5_xU4wY1pz-JxOi8XdA_O0bBHw
[10:30:15] 页面加载完成
```

这个日志框会实时显示所有操作！

---

### 第4步：开始测试

1. **点击"测试3: 模拟下单并发送通知"按钮**

2. **观察调试日志**，应该会看到：
   ```
   [10:30:20] ========== 开始测试 ==========
   [10:30:20] 检查登录状态: 已登录
   [10:30:21] 步骤1: 请求订阅消息授权
   ```

3. **弹出授权窗口**
   - 显示："次元学校想给你发送通知"
   - 包含："订单支付成功通知"
   - **点击"允许"或"总是允许"**

4. **继续观察日志**：
   ```
   [10:30:22] 授权结果: {"xxx":"accept"}
   [10:30:22] 步骤2: 创建测试订单
   [10:30:23] ✅ 订单创建成功: order_id_xxx
   [10:30:23] 步骤3: 发送订阅消息
   [10:30:23] 模板ID: RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg
   [10:30:24] ✅ 订阅消息发送完成
   [10:30:24] ========== 测试完成 ==========
   ```

5. **立即打开微信**
   - 查看"服务通知"
   - 应该收到一条"订单支付成功通知"

---

## 🔍 根据日志排查问题

### 情况1：日志显示"❌ 未登录"

**解决：**
1. 返回小程序首页
2. 点击底部"我的"
3. 完成微信登录
4. 再次进入测试页面

---

### 情况2：日志停在"步骤1: 请求订阅消息授权"

**可能原因：**
- 授权窗口没弹出
- 模板ID配置错误

**解决：**
1. 检查是否有授权弹窗
2. 如果没有，查看日志是否有错误信息
3. 把日志内容截图发给我

---

### 情况3：日志显示"步骤3: 发送订阅消息"后报错

**可能原因：**
- 云函数没上传
- 云函数执行失败

**解决：**
1. 查看日志中的错误信息
2. 确认云函数已上传
3. 把完整的错误日志发给我

---

### 情况4：日志显示"✅ 订阅消息发送完成"但没收到消息

**可能原因：**
- 云函数发送成功，但微信服务器没推送
- 模板数据格式问题

**解决：**
1. 等待1-2分钟（有时会延迟）
2. 检查微信的"服务通知"设置是否开启
3. 查看云函数日志（下一步）

---

## 🔍 查看云函数日志

如果测试页面显示"发送完成"但没收到消息：

1. **在电脑上打开微信开发者工具**
2. 点击顶部"云开发"按钮
3. 左侧菜单 → "云函数"
4. 找到 `sendSubscribeMessage`
5. 点击"日志"标签
6. 查看最新的调用记录

**成功的日志：**
```
📨 发送订阅消息: {
  touser: "o5_xU4wY1pz-JxOi8XdA_O0bBHw",
  template_id: "RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg",
  page: "/pages/user/orders/detail?id=xxx"
}
✅ 订阅消息发送成功: { errCode: 0, errMsg: "openapi.subscribeMessage.send:ok" }
```

**失败的日志：**
```
❌ 订阅消息发送失败: {
  errCode: 43101,
  errMsg: "user refuse to accept the msg"
}
```

---

## 📝 测试检查清单

测试时请确认：

- [ ] 云函数 `sendSubscribeMessage` 已上传
- [ ] 已在手机上扫码打开小程序
- [ ] 已完成登录（有openid）
- [ ] 调试日志框正常显示
- [ ] 授权窗口弹出并点击"允许"
- [ ] 日志显示"✅ 订阅消息发送完成"
- [ ] 微信收到服务通知

---

## 💡 重要提示

1. **必须在真机上测试**
   - 开发者工具看不到微信服务通知

2. **调试日志是关键**
   - 页面顶部的黑色日志框会显示所有信息
   - 如果有问题，把日志截图发给我

3. **授权很重要**
   - 必须点击"允许"才能收到消息
   - 如果点了"拒绝"，需要重新测试

4. **云函数日志是最终确认**
   - 如果云函数日志显示成功，但没收到消息
   - 可能是微信服务器的问题或延迟

---

## 🎯 现在开始测试

1. **编译 → 预览 → 扫码**
2. **进入测试页面**
3. **点击"测试3"按钮**
4. **观察调试日志**
5. **把日志截图发给我**

---

**有任何问题，把调试日志截图发给我！**



