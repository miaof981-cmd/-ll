# 数据库集合创建清单

## ⚠️ 重要提示

在使用小程序之前，需要在微信开发者工具的云开发控制台创建以下数据库集合。

---

## 📋 必需的数据库集合

请在 **微信开发者工具** → **云开发** → **数据库** 中创建以下集合：

### 1. 用户相关

| 集合名称 | 说明 | 权限设置 |
|---------|------|---------|
| `users` | 用户信息 | 所有用户可读，仅创建者可写 |
| `admin_list` | 管理员白名单 | 仅管理员可读写 |
| `photographer_accounts` | 摄影师账号 | 仅管理员可读写 |

### 2. 学生管理

| 集合名称 | 说明 | 权限设置 |
|---------|------|---------|
| `students` | 学生信息 | 所有用户可读，仅创建者和管理员可写 |
| `archives` | 学籍档案 | 所有用户可读，仅管理员可写 |

### 3. 活动与订单

| 集合名称 | 说明 | 权限设置 |
|---------|------|---------|
| `activities` | 活动信息 | 所有用户可读，仅管理员可写 |
| `activity_categories` | 活动分类 | 所有用户可读，仅管理员可写 |
| `activity_orders` | 活动订单 | 仅创建者和管理员可读写 |

### 4. 摄影师管理

| 集合名称 | 说明 | 权限设置 |
|---------|------|---------|
| `photographers` | 摄影师信息 | 所有用户可读，仅管理员可写 |

### 5. 内容管理

| 集合名称 | 说明 | 权限设置 |
|---------|------|---------|
| `announcements` | 公告 | 所有用户可读，仅管理员可写 |
| `banners` | 轮播图 | 所有用户可读，仅管理员可写 |

---

## 🚀 快速创建步骤

### 方法一：逐个创建（推荐）

1. 打开微信开发者工具
2. 点击左侧 **"云开发"** 按钮
3. 进入 **"数据库"** 标签
4. 点击 **"+"** 或 **"添加集合"**
5. 输入集合名称（如：`users`）
6. 点击确定
7. 重复步骤4-6，创建所有集合

### 方法二：批量创建

如果您熟悉数据库操作，可以使用云开发控制台的批量导入功能。

---

## ✅ 验证集合是否创建成功

创建完成后，您应该在数据库列表中看到以下12个集合：

- [x] users
- [x] admin_list
- [x] photographer_accounts
- [x] students
- [x] archives
- [x] activities
- [x] activity_categories  ⚠️ **新增，必须创建**
- [x] activity_orders
- [x] photographers
- [x] announcements
- [x] banners

---

## 🔧 常见问题

### Q1: 提示 "database collection not exists" 错误

**原因：** 对应的数据库集合未创建

**解决：** 
1. 检查上面的清单
2. 在云开发数据库中创建缺失的集合
3. 刷新小程序

### Q2: `activity_categories` 是什么？

**说明：** 这是新增的活动分类集合，用于管理活动的分类（如：证件照、毕业照、艺术照等）

**必须创建：** 是的，否则活动页面会报错

### Q3: 数据库权限如何设置？

**建议设置：**

1. **用户可读的集合**（users, students, activities, photographers, announcements, banners）
   - 所有用户可读
   - 仅创建者或管理员可写

2. **仅管理员的集合**（admin_list, activity_categories）
   - 仅管理员可读写

3. **订单类集合**（activity_orders, archives）
   - 仅创建者和管理员可读写

---

## 📝 初始化数据

创建集合后，建议添加一些初始数据：

### 1. 添加第一个管理员

在 `admin_list` 集合中手动添加一条记录：

```json
{
  "openid": "您的微信OpenID",
  "name": "管理员姓名",
  "phone": "13800138000",
  "permissions": ["all"],
  "isActive": true,
  "createdAt": "2025-10-14T00:00:00.000Z"
}
```

**获取OpenID方法：**
1. 先以普通用户登录小程序
2. 进入"我的"页面
3. 复制显示的OpenID
4. 在数据库中添加该OpenID为管理员

### 2. 创建活动分类

在管理员后台 → 分类管理 → 添加分类：

- 📸 证件照（排序：0）
- 🎓 毕业照（排序：1）
- 🎨 艺术照（排序：2）
- 🎉 节日活动（排序：3）

---

## ⚡ 一键创建脚本（高级）

如果您熟悉云函数，可以创建一个初始化云函数：

```javascript
// 云函数 initDatabase
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const collections = [
    'users',
    'admin_list',
    'photographer_accounts',
    'students',
    'archives',
    'activities',
    'activity_categories',
    'activity_orders',
    'photographers',
    'announcements',
    'banners'
  ]
  
  const results = []
  
  for (const name of collections) {
    try {
      await db.createCollection(name)
      results.push({ name, success: true })
    } catch (e) {
      results.push({ name, success: false, error: e.message })
    }
  }
  
  return results
}
```

---

## 8. order_photo_history（订单照片历史记录表）

**用途**：存储订单中被拒绝的照片历史记录，用于审核时查看修改历程

**字段结构**：
```json
{
  "_id": "系统自动生成",
  "_openid": "系统自动生成",
  "orderId": "订单ID（关联activity_orders）",
  "photos": ["照片URL数组"],
  "rejectType": "拒绝类型：admin-管理员驳回, user-用户拒绝",
  "rejectReason": "拒绝原因",
  "rejectCount": 1,
  "rejectedAt": "2025-01-14T12:00:00.000Z",
  "createdAt": "2025-01-14T12:00:00.000Z"
}
```

**索引建议**：
- `orderId`（升序）+ `createdAt`（降序）- 用于查询订单的历史记录并按时间排序

**创建步骤**：
1. 云开发控制台 → 数据库 → 添加集合
2. 集合名称：`order_photo_history`
3. 权限设置：所有用户可读，仅创建者可读写
4. 创建组合索引：
   - 字段1：`orderId` 升序
   - 字段2：`createdAt` 降序

**使用场景**：
- 管理员审核时查看每次拒绝的照片
- 对比不同版本的作品质量
- 追踪修改进度和历史
- 为争议提供证据

---

## 🎯 总结

1. **必须创建** 13个数据库集合（新增 order_photo_history）
2. **特别注意** `activity_categories` 和 `order_photo_history` 是新增集合
3. **设置权限** 根据上面的建议设置
4. **添加管理员** 手动添加第一个管理员记录
5. **创建索引** 特别是 order_photo_history 的组合索引

完成以上步骤后，小程序即可正常运行！🚀

