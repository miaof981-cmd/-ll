# 修复摄影师提交作品问题

## 问题描述

摄影师上传作品后，订单仍显示"还没有上传作品"，`photos` 字段不存在。

## 根本原因

**架构设计问题：跨用户写操作在客户端执行**

```
用户A（家长） → 创建订单（_openid: user_a）
摄影师B → 尝试更新订单 → ❌ 失败（_openid: photographer_b，无权修改）
```

- 订单的 `_openid` 是创建者（家长）
- 摄影师的 `_openid` 是摄影师本人
- 数据库权限：即使设置为"所有用户可写"，也无法跨 `_openid` 修改

---

## 正确的架构

**所有跨用户写操作必须通过云函数完成**

```
客户端（只读/提交参数）
    ↓
云函数（角色校验 + 写入）
    ↓
数据库（管理员权限）
```

---

## 解决方案

### 1. 创建云函数 `photographerSubmitWork`

**功能：**
- ✅ 接收订单ID、照片数组、备注
- ✅ 验证摄影师身份（查询 `photographers` 表）
- ✅ 验证摄影师权限（是否是订单指定的摄影师）
- ✅ 验证订单状态（是否可以提交作品）
- ✅ 更新订单状态为 `pending_review`
- ✅ 保存照片和备注

**权限校验逻辑：**
```javascript
// 1. 查询当前用户是否是摄影师
const photographer = await db.collection('photographers')
  .where({ _openid: wxContext.OPENID })
  .get();

// 2. 验证是否是订单指定的摄影师
if (order.photographerId !== photographer._id) {
  return { success: false, error: '无权限' };
}
```

---

### 2. 修改前端代码

**修改前（直接操作数据库）：**
```javascript
await db.collection('activity_orders').doc(orderId).update({
  data: {
    status: 'pending_review',
    photos: this.data.uploadedPhotos,
    // ...
  }
});
```

**修改后（调用云函数）：**
```javascript
const result = await wx.cloud.callFunction({
  name: 'photographerSubmitWork',
  data: {
    orderId: this.data.orderId,
    photos: this.data.uploadedPhotos,
    photographerNote: this.data.photographerNote
  }
});

if (result.result.success) {
  // 提交成功
} else {
  // 显示错误
}
```

---

## 修改的文件

1. **新建云函数：**
   - `/cloudfunctions/photographerSubmitWork/index.js`
   - `/cloudfunctions/photographerSubmitWork/package.json`
   - `/cloudfunctions/photographerSubmitWork/config.json`

2. **修改前端：**
   - `/miniprogram/pages/photographer/order-detail.js`

---

## 部署步骤

### 1. 上传云函数

1. 在微信开发者工具中
2. 右键点击 `cloudfunctions/photographerSubmitWork` 文件夹
3. 选择 "上传并部署：云端安装依赖"
4. 等待上传成功（文件夹变绿色）

### 2. 编译并测试

1. 点击"编译"
2. 摄影师登录
3. 进入订单详情
4. 上传照片
5. 点击"提交作品"
6. 查看是否成功

---

## 测试验证

### 使用测试工具验证

1. 提交作品后
2. 运行 "测试22: 检查订单photos字段"
3. 应该看到：

```
订单 1:
  订单状态: pending_review  ✅ 状态已更新
  支付状态: paid
  photos字段: ✅ 存在 (数组)
  照片数量: 3  ✅ 照片已保存
  photographerNote: 已拍摄完成  ✅ 备注已保存
  submittedAt: 2025-10-21T12:00:00.000Z  ✅ 提交时间已记录
```

---

## 其他需要改为云函数的操作

根据同样的原则，以下操作也应该改为云函数：

### 1. 管理员审核订单
- ✅ 已完成（`adminApproveOrder`）

### 2. 用户确认作品
- ⚠️ 待处理
- 创建 `userConfirmWork` 云函数

### 3. 摄影师接单/拒单
- ⚠️ 待处理
- 创建 `photographerAcceptOrder` 云函数

### 4. 订单取消/退款
- ⚠️ 待处理
- 创建 `cancelOrder` 云函数

---

## 数据库权限配置

**推荐配置：**

```json
{
  "read": true,
  "write": false
}
```

**说明：**
- ✅ 所有用户可读（用于查询和显示）
- ❌ 禁止客户端直接写入
- ✅ 所有写操作通过云函数完成
- ✅ 云函数内部进行角色和权限校验

---

## 安全性提升

### 修改前：
- ❌ 客户端可以直接修改订单
- ❌ 没有权限校验
- ❌ 容易被篡改

### 修改后：
- ✅ 客户端只读
- ✅ 云函数内部校验身份和权限
- ✅ 防止恶意修改
- ✅ 所有操作有日志记录

---

## 版本信息

- 修复日期：2025-10-21
- 版本：v1.0.2-photographer-submit-fix
- 影响范围：摄影师提交作品功能

---

## 注意事项

1. **必须上传云函数**
   - 云函数未上传，功能无法使用
   - 上传后等待30秒确保部署完成

2. **数据库权限建议**
   - 测试环境：可以保持"所有用户可写"
   - 生产环境：强烈建议改为"禁止客户端写入"

3. **兼容性**
   - 旧数据不受影响
   - 新的提交操作会正确保存

4. **错误处理**
   - 如果提交失败，查看控制台日志
   - 云函数会返回详细的错误信息

