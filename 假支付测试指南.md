# 假支付测试指南 - 测试订阅消息

## ✅ 已完成的准备工作

1. 创建了测试页面：`pages/test-notification/`
2. 模板ID已配置：`RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg`
3. 云函数已准备：`sendSubscribeMessage`

---

## 🎯 测试步骤（5分钟完成）

### 第1步：上传云函数（必须先做）

**在微信开发者工具中：**

1. 找到 `cloudfunctions/sendSubscribeMessage` 文件夹
2. 右键点击
3. 选择：**"上传并部署：云端安装依赖"**
4. 等待上传完成

---

### 第2步：编译小程序

1. 点击微信开发者工具顶部的 **"编译"** 按钮
2. 等待编译完成

---

### 第3步：进入测试页面

**方法1：直接输入路径**
- 在微信开发者工具顶部，找到页面路径输入框
- 输入：`pages/test-notification/test-notification`
- 按回车

**方法2：通过控制台**
- 打开控制台（Console）
- 输入：
  ```javascript
  wx.navigateTo({
    url: '/pages/test-notification/test-notification'
  })
  ```
- 按回车

---

### 第4步：开始测试

你会看到一个漂亮的测试页面，有3个测试按钮：

#### 测试1：请求订阅授权（推荐先测试）

1. 点击 **"测试1: 请求订阅授权"** 按钮
2. 应该弹出授权窗口
3. 显示："次元学校想给你发送通知"
4. 包含："订单支付成功通知"
5. 点击 **"允许"** 或 **"总是允许"**

**预期结果：**
- 授权成功
- 页面显示授权结果

---

#### 测试2：发送订单通知（测试完整流程）

1. 点击 **"测试2: 发送订单通知"** 按钮
2. 弹出授权窗口，点击"允许"
3. 等待发送完成

**预期结果：**
- 显示"通知发送成功"
- 打开微信，查看"服务通知"
- 应该收到一条订单通知

---

#### 测试3：模拟下单并发送通知（推荐用这个！）

1. 点击 **"测试3: 模拟下单并发送通知"** 按钮
2. 这会模拟完整的下单流程：
   - ✅ 请求订阅消息授权
   - ✅ 创建测试订单（不涉及支付）
   - ✅ 发送订阅消息
3. 完成后可以查看订单详情

**预期结果：**
- ✅ 创建了一个测试订单（订单号以TEST开头）
- ✅ 发送了订阅消息
- ✅ 微信收到"订单支付成功通知"
- ✅ 可以在订单列表中看到测试订单

**注意：这个测试不会触发真实支付，只是模拟下单成功的场景！**

---

## 📱 查看微信通知

### 在手机上测试（推荐）

1. 微信开发者工具 → 点击右上角 **"预览"**
2. 扫码在手机上打开小程序
3. 进入测试页面
4. 点击测试按钮
5. 授权后，立即打开微信查看"服务通知"

### 在开发者工具测试

- 授权和发送都能正常工作
- 但看不到实际的消息通知
- 可以在控制台看到发送成功的日志

---

## 🔍 查看云函数日志

**验证消息是否真的发送了：**

1. 点击微信开发者工具顶部 **"云开发"** 按钮
2. 左侧菜单 → **"云函数"**
3. 找到 `sendSubscribeMessage`
4. 点击 **"日志"**
5. 查看最新的调用记录

**成功的日志应该显示：**
```
📨 发送订阅消息: { touser: 'xxx', template_id: 'RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg', ... }
✅ 订阅消息发送成功
```

---

## ❓ 常见问题

### Q1: 找不到测试页面？

**解决：**
1. 检查 `app.json` 是否包含测试页面路径
2. 重新编译小程序

### Q2: 提示"请先登录小程序"？

**解决：**
1. 先进入小程序首页
2. 完成登录
3. 再进入测试页面

### Q3: 授权窗口没弹出？

**检查：**
1. 模板ID是否正确填写
2. 云函数是否上传成功
3. 控制台是否有报错

### Q4: 发送成功但没收到消息？

**可能原因：**
1. 在开发者工具测试（工具不显示消息）
   - **解决：** 用手机扫码测试
2. 用户拒绝了授权
   - **解决：** 重新测试并点击"允许"
3. 模板ID错误
   - **解决：** 检查 `notification.js` 中的模板ID

### Q5: 云函数报错？

**查看错误信息：**
1. 云开发控制台 → 云函数 → sendSubscribeMessage → 日志
2. 常见错误：
   - `invalid template_id`：模板ID错误
   - `user refuse`：用户拒绝授权
   - `openapi is not authorized`：云函数权限问题

---

## 🎉 测试成功标准

- ✅ 授权窗口正常弹出
- ✅ 点击允许后无报错
- ✅ 控制台显示"发送成功"
- ✅ 云函数日志显示成功
- ✅ 手机微信收到服务通知
- ✅ 点击通知能跳转（如果配置了跳转页面）

---

## 📝 测试记录

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 云函数上传 | ⏳ | |
| 授权弹窗 | ⏳ | |
| 消息发送 | ⏳ | |
| 手机接收 | ⏳ | |
| 云函数日志 | ⏳ | |

---

## 🚀 测试完成后

如果测试成功，说明：
1. ✅ 订阅消息功能正常
2. ✅ 云函数配置正确
3. ✅ 模板ID有效

接下来可以：
- 继续创建其他4个模板
- 或者先解决支付问题
- 测试完成后可以删除测试订单

---

## 🧹 清理测试数据（可选）

测试完成后，可以删除测试订单：

1. 打开云开发控制台
2. 数据库 → `activity_orders`
3. 找到订单号以 `TEST` 开头的记录
4. 删除这些测试数据

---

**现在开始测试吧！有问题随时告诉我！** 🚀

