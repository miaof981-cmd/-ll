# 数据库集合创建步骤

## 问题诊断

从日志可以看到：
```
❌ 查询历史记录失败: database collection not exists
```

**原因：** `order_photo_history` 集合还没有在云数据库中创建！

## 解决方案：立即创建集合

### 步骤1：创建集合

1. 打开**微信开发者工具**
2. 点击顶部的**"云开发"**按钮
3. 在左侧菜单中点击**"数据库"**
4. 点击**"添加集合"**按钮（通常在右上角）
5. 在弹出的对话框中：
   - **集合名称**：输入 `order_photo_history`
   - **权限设置**：选择"仅创建者可读写"
6. 点击**"确定"**

### 步骤2：创建索引（提升查询性能）

1. 在数据库页面，点击刚创建的 `order_photo_history` 集合
2. 点击**"索引管理"**标签
3. 点击**"添加"**按钮
4. 创建组合索引：
   - **索引名称**：`orderId_createdAt`
   - **字段1**：`orderId` (升序)
   - **字段2**：`createdAt` (降序)
5. 点击**"确定"**

### 步骤3：验证创建成功

在数据库页面的集合列表中，应该能看到：
- ✅ `order_photo_history` 集合
- ✅ 显示0条记录（新建集合为空）

## 集合说明

### `order_photo_history` 集合的作用

用于保存订单的历史提交记录，包括：
- 摄影师每次提交的照片
- 管理员或用户的拒绝原因
- 提交时间和拒绝时间
- 拒绝类型（admin/user）

### 数据结构

```json
{
  "_id": "自动生成",
  "_openid": "自动生成",
  "orderId": "订单ID",
  "photos": ["照片URL数组"],
  "rejectType": "admin/user",
  "rejectReason": "拒绝原因",
  "rejectCount": "拒绝次数（用户拒绝时）",
  "submittedAt": "提交时间",
  "rejectedAt": "拒绝时间",
  "createdAt": "记录创建时间"
}
```

## 代码已修复

已经将所有历史记录保存的错误处理改为：
```javascript
catch (historyErr) {
  console.warn('⚠️ 保存历史记录失败（集合可能不存在）:', historyErr.message);
  // 不影响主流程继续执行
}
```

这样即使集合不存在，也不会阻塞订单的正常操作流程。

## 测试步骤

### 1. 创建集合后的测试

1. **编译并刷新小程序**
2. **管理员审核页面** → 点击"快速拒绝"按钮
3. **查看控制台日志**：
   - ✅ 应该显示：`✅ 历史记录保存成功`
   - ❌ 不应该显示：`database collection not exists`

### 2. 完整流程测试

1. **摄影师提交作品** → 订单状态变为"待审核"
2. **管理员拒绝作品** → 输入拒绝原因
3. **查看审核详情页** → 应该能在处理记录中看到历史提交的照片
4. **摄影师重新提交** → 之前的照片应该出现在"历史提交"区域
5. **用户拒绝作品** → 同样应该保存到历史记录

## 其他优化建议

### 建议创建的索引（提升性能）

在云开发控制台 → 数据库 → 各集合中创建以下索引：

#### `activity_orders` 集合
1. **索引1**：`status` (升序) - 用于按状态筛选订单
2. **索引2**：`status` (升序) + `submittedAt` (降序) - 用于审核列表排序

#### `banners` 集合
- **索引**：`_openid` (升序) + `order` (升序) - 用于轮播图排序

#### `announcements` 集合
- **索引**：`_openid` (升序) + `createdAt` (降序) - 用于公告排序

#### `students` 集合
- **索引**：`studentId` (升序) - 用于学号查询

> 注意：这些索引控制台已经在日志中提示了，可以直接点击快速创建链接。

## 完成确认

创建完成后，请回复：
- ✅ 已创建 `order_photo_history` 集合
- ✅ 已创建索引
- ✅ 快速拒绝功能正常工作
- ✅ 活动图片正常显示

然后我们可以提交代码并继续其他功能开发。

