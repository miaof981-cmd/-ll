# 图片加载优化 - 快速测试指南

## 测试步骤

### 第一步：清空缓存（首次加载测试）

1. 打开微信开发者工具
2. 点击 **调试器** → **Storage** → **Clear**
3. 或在小程序中执行：
   ```javascript
   wx.removeStorageSync('image_url_cache_v2')
   ```

### 第二步：首次进入订单页

1. 小程序中点击 **我的订单**
2. 观察控制台日志：

**预期输出**：
```
📄 [分页加载] 第1页，每页20条，跳过0条
✅ [加载完成] 第1页，本次加载 20 条订单
✅ 使用缓存: 0 张 | 🔄 转换新图: 45 张 | ⚠️ 转换失败: 0 张 | ✅ 总计: 45 张
📊 [订单列表] 总计 20 条，可加载更多
```

**耗时参考**：
- 总加载时间：**0.5-1.5 秒**
- 图片转换时间：**300-500ms**

---

### 第三步：滚动加载更多

1. 向下滚动到订单列表底部
2. 自动触发加载下一页

**预期输出**：
```
📄 [分页加载] 第2页，每页20条，跳过20条
✅ [加载完成] 第2页，本次加载 20 条订单
✅ 使用缓存: 30 张 | 🔄 转换新图: 12 张 | ⚠️ 转换失败: 0 张 | ✅ 总计: 42 张
📊 [订单列表] 总计 40 条，可加载更多
```

**注意**：
- 缓存命中率提升（第1页的图片已缓存）
- 仅转换新图片（第2页独有的图片）

---

### 第四步：退出再进入（缓存命中测试）

1. 返回首页
2. 再次点击 **我的订单**

**预期输出**：
```
📄 [分页加载] 第1页，每页20条，跳过0条
✅ [加载完成] 第1页，本次加载 20 条订单
✅ 使用缓存: 45 张 | 🔄 转换新图: 0 张 | ⚠️ 转换失败: 0 张 | ✅ 总计: 45 张
📊 [订单列表] 总计 20 条，可加载更多
```

**耗时参考**：
- 总加载时间：**<0.5 秒**（秒开）
- 图片转换时间：**0ms**（全部命中缓存）

---

### 第五步：下拉刷新

1. 在订单列表顶部下拉
2. 触发刷新

**预期行为**：
- 重置为第1页
- 保留缓存（图片秒开）
- 更新订单数据

**预期输出**：
```
📄 [分页加载] 第1页，每页20条，跳过0条
✅ 使用缓存: 45 张 | 🔄 转换新图: 0 张
📊 [订单列表] 总计 20 条，可加载更多
```

---

### 第六步：节流测试

1. 快速切换页面（订单页 → 首页 → 订单页）
2. 在 3 秒内重复进入

**预期输出**：
```
⏸️ 距离上次加载不足3秒，跳过重复加载
```

**节流生效**：避免重复请求，保护性能。

---

## 性能验证

### 控制台日志检查

#### ✅ 正确示例
```
✅ 使用缓存: 38 张 | 🔄 转换新图: 3 张 | ⚠️ 转换失败: 0 张 | ✅ 总计: 41 张
📊 [订单列表] 总计 20 条，可加载更多
```

#### ❌ 错误示例（未优化前）
```
📸 [图片转换] 开始处理 45 个图片URL
📸 [图片转换] 去重后 42 个唯一URL
✅ [图片缓存] 命中 0 个
🔄 [图片转换] 需要转换 42 个
📦 [图片转换] 分 1 批处理
🔄 [批次 1/1] 转换 42 个
✅ [图片转换] 完成，共转换 42 个
```

---

### 性能对比表

| 测试项 | 优化前 | 优化后 | 提升 |
|--------|--------|--------|------|
| 首次加载（20条订单） | 2-3秒 | 0.5-1秒 | **60%+** |
| 再次进入（缓存命中） | 2-3秒 | <0.5秒 | **80%+** |
| 数据库请求次数 | 60+ | 3 | **95%** |
| 图片转换请求 | 全部 | 仅新图 | **按需** |
| 控制台日志行数 | 200+ | 10 | **95%** |

---

## 调试模式

如需查看详细日志，修改配置：

```javascript
// miniprogram/utils/image-url-manager.js
const CONFIG = {
  DEBUG_MODE: true, // 开启调试模式
  // ...
};
```

**调试模式输出**：
- 每批转换详情
- 缓存命中详情
- 图片URL校验详情
- 失败图片完整路径

---

## 常见问题排查

### 1. 图片不显示
**症状**：部分图片显示占位图
**原因**：云存储文件不存在或权限不足
**排查**：
```
⚠️ 转换失败: 1 张
```
检查 `cloud://` 路径是否正确

### 2. 缓存未命中
**症状**：每次进入都转换全部图片
**原因**：缓存被清除或过期
**排查**：
```javascript
// 检查缓存状态
const imageUrlManager = require('./utils/image-url-manager.js');
console.log(imageUrlManager.getCacheStats());
// 输出：{ total: 50, valid: 50, expired: 0 }
```

### 3. 分页未生效
**症状**：一次性加载全部订单
**原因**：`pageSize` 配置未生效
**排查**：
```javascript
// orders.js
console.log(this.data.pageSize); // 应输出 20
```

### 4. 节流未生效
**症状**：频繁重复加载
**原因**：节流延迟过短
**调整**：
```javascript
// orders.js
_throttleDelay: 1000, // 改为 1 秒
```

---

## 验收标准

✅ **首次加载**：< 1.5 秒
✅ **再次进入**：< 0.5 秒（缓存命中）
✅ **缓存命中率**：> 80%（第2次进入）
✅ **图片转换失败率**：< 5%
✅ **控制台日志**：简洁清晰，无冗余
✅ **下拉刷新**：正常工作
✅ **上拉加载更多**：自动触发

---

## 下一步

1. ✅ 完成上述所有测试
2. ✅ 验证性能指标达标
3. ✅ 记录测试结果
4. 🚀 推送至远程仓库
5. 🏷️ 打标签：`图片加载性能优化版`

---

**测试完成后，请将测试结果反馈给开发者！**

