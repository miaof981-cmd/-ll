# å†å²è®°å½•æ˜¾ç¤ºé—®é¢˜ - å®Œæ•´æŠ¥å‘Š

## æ ¸å¿ƒé—®é¢˜

### é—®é¢˜1ï¼šå†å²è®°å½•æ˜¾ç¤ºä¸å…¨
**ç°è±¡ï¼š** è®¢å•è¯¦æƒ…é¡µçš„"å¤„ç†è®°å½•"åŒºåŸŸæ²¡æœ‰æ˜¾ç¤ºå†å²æäº¤çš„ç…§ç‰‡å’Œæ‹’ç»è®°å½•

### é—®é¢˜2ï¼šæ— æ³•ç‚¹å‡»æ‹’ç»æŒ‰é’®
**ç°è±¡ï¼š** åœ¨å®¡æ ¸è¯¦æƒ…é¡µç‚¹å‡»"æ‹’ç»"æŒ‰é’®æ²¡æœ‰ååº”

### é—®é¢˜3ï¼šå›¾ç‰‡åŠ è½½é”™è¯¯
**ç°è±¡ï¼š** æ§åˆ¶å°æŠ¥é”™ `Failed to load image`

---

## å…³é”®æ—¥å¿—åˆ†æ

### ä»æœ€æ–°æ—¥å¿—ä¸­å‘ç°çš„é—®é¢˜

```javascript
detail.js:96  ğŸ” æŸ¥è¯¢å†å²è®°å½•ï¼Œè®¢å•ID: 4ea4942768ee46b802b41517326ece21
detail.js:102 ğŸ“‹ å†å²è®°å½•æŸ¥è¯¢ç»“æœ: []
detail.js:108 âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°å†å²è®°å½•
detail.js:169 å†å²è®°å½•æ•°é‡: 0
```

**å…³é”®å‘ç°ï¼š**
1. âœ… æŸ¥è¯¢å†å²è®°å½•çš„ä»£ç **æ­£å¸¸æ‰§è¡Œ**äº†
2. âœ… æ•°æ®åº“æŸ¥è¯¢**æˆåŠŸ**äº†
3. âŒ ä½†æ˜¯ `order_photo_history` é›†åˆæ˜¯**ç©ºçš„** (æŸ¥è¯¢ç»“æœ: [])
4. âŒ **æ²¡æœ‰çœ‹åˆ°**"å°è¯•ä»è®¢å•å­—æ®µé‡å»ºå†å²è®°å½•"çš„æ—¥å¿—

### è®¢å•ä¿¡æ¯åˆ†æ

```javascript
è®¢å•ä¿¡æ¯: {
  _id: "4ea4942768ee46b802b41517326ece21",
  _openid: "o5_xU4wY1pz-JxOi8XdAX_O0bbHw",
  activityId: "43d365dc68ee129202af48e635a3651e",
  createdAt: "2025-10-14T12:48:55.663Z",
  lifePhotos: Array(1),
  ...
}
```

**é—®é¢˜ï¼šæ—¥å¿—ä¸­æ²¡æœ‰æ˜¾ç¤ºè®¢å•çš„è¿™äº›å…³é”®å­—æ®µï¼š**
- `rejectCount` - æ‹’ç»æ¬¡æ•°
- `adminRejectReason` - ç®¡ç†å‘˜æ‹’ç»åŸå› 
- `rejectReason` - ç”¨æˆ·æ‹’ç»åŸå› 
- `status` - è®¢å•çŠ¶æ€

---

## æ ¹æœ¬åŸå› æ¨æµ‹

### åŸå› 1ï¼šè®¢å•ä»æœªè¢«æ‹’ç»è¿‡ â­â­â­ æœ€å¯èƒ½

**è¯æ®ï¼š**
- æ•°æ®åº“æŸ¥è¯¢ç»“æœä¸ºç©º `[]`
- æ²¡æœ‰è§¦å‘"ä»è®¢å•å­—æ®µé‡å»º"çš„é€»è¾‘
- è¯´æ˜è®¢å•çš„ `rejectCount` ä¸º 0 æˆ–ä¸å­˜åœ¨

**ç»“è®ºï¼š**
- å¦‚æœè¿™ä¸ªè®¢å•ä»æœªè¢«æ‹’ç»è¿‡ï¼Œæ²¡æœ‰å†å²è®°å½•æ˜¯**æ­£å¸¸çš„**
- åªæœ‰è¢«æ‹’ç»åé‡æ–°æäº¤ï¼Œæ‰ä¼šæœ‰å†å²è®°å½•æ˜¾ç¤º

### åŸå› 2ï¼šä»£ç æ›´æ–°æœªå®Œå…¨ç”Ÿæ•ˆ

**è¯æ®ï¼š**
- æ—¥å¿—ä¸­åº”è¯¥æœ‰"å°è¯•ä»è®¢å•å­—æ®µé‡å»ºå†å²è®°å½•"
- ä½†å®é™…ä¸Šæ²¡æœ‰è¿™æ¡æ—¥å¿—
- è¯´æ˜ `if (order.rejectCount && order.rejectCount > 0)` æ¡ä»¶ä¸æˆç«‹

**å¯èƒ½åŸå› ï¼š**
- ä»£ç å·²æ›´æ–°ï¼Œä½†è®¢å•ç¡®å®æ²¡æœ‰ `rejectCount` å­—æ®µ
- æˆ–è€… `rejectCount` ä¸º 0

### åŸå› 3ï¼šorder_photo_history é›†åˆä¸ºç©º

**äº‹å®ï¼š**
- é›†åˆå·²åˆ›å»º âœ…
- ç´¢å¼•å·²åˆ›å»º âœ…
- ä½†é›†åˆé‡Œæ²¡æœ‰ä»»ä½•æ•°æ® âŒ

**åŸå› ï¼š**
- æ‰€æœ‰æ‹’ç»æ“ä½œéƒ½å‘ç”Ÿåœ¨é›†åˆåˆ›å»ºä¹‹å‰
- æ–°çš„æ‹’ç»æ“ä½œè¿˜æ²¡æœ‰å‘ç”Ÿè¿‡

---

## æˆ‘ä»¬å·²ç»åšçš„åŠªåŠ›

### 1. åˆ›å»ºæ•°æ®åº“é›†åˆ
- âœ… åˆ›å»ºäº† `order_photo_history` é›†åˆ
- âœ… åˆ›å»ºäº†ç´¢å¼• `orderId_createdAt_desc`
  - orderId (å‡åº)
  - createdAt (é™åº)

### 2. ä¿®å¤é”™è¯¯å¤„ç†
**æ–‡ä»¶ï¼š** `miniprogram/pages/admin/review/review.js`
- å°† `console.error` æ”¹ä¸º `console.warn`
- æ·»åŠ "é›†åˆå¯èƒ½ä¸å­˜åœ¨"æç¤º
- ç¡®ä¿é”™è¯¯ä¸ä¼šé˜»å¡ä¸»æµç¨‹

### 3. å¢å¼ºå†å²è®°å½•é€»è¾‘
**æ–‡ä»¶ï¼š** `miniprogram/pages/admin/review/detail.js`
- ä¼˜å…ˆä» `order_photo_history` é›†åˆæŸ¥è¯¢
- å¦‚æœé›†åˆä¸ºç©ºï¼Œå°è¯•ä»è®¢å•å­—æ®µé‡å»ºï¼š
  - æ£€æŸ¥ `order.rejectCount`
  - æå– `adminRejectReason` + `adminRejectedAt`
  - æå– `rejectReason` + `rejectedAt`
  - æ„å»ºä¸´æ—¶å†å²è®°å½•æ•°ç»„

### 4. åˆ›å»ºäº‘å‡½æ•°è¡¥å……æ—§æ•°æ®
**äº‘å‡½æ•°ï¼š** `fixOrderHistory`
- æ‰«ææ‰€æœ‰è®¢å•
- æŸ¥æ‰¾æœ‰æ‹’ç»ä¿¡æ¯ä½†æ²¡æœ‰å†å²è®°å½•çš„è®¢å•
- è‡ªåŠ¨è¡¥å……å†å²è®°å½•åˆ° `order_photo_history`

**çŠ¶æ€ï¼š** å·²åˆ›å»ºä½†å¯èƒ½æœªæ‰§è¡ŒæˆåŠŸï¼ˆè¿”å› addedCount: 0ï¼‰

---

## æ ¸å¿ƒé—®é¢˜å®šä½

### ä¸ºä»€ä¹ˆæ²¡æœ‰å†å²è®°å½•ï¼Ÿ

**æ¨æµ‹1ï¼šè®¢å•æœ¬èº«å°±æ²¡æœ‰å†å²**
- è¿™ä¸ªè®¢å•ï¼ˆID: 4ea4942768ee46b802b41517326ece21ï¼‰
- å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡æäº¤ï¼Œä»æœªè¢«æ‹’ç»è¿‡
- æ‰€ä»¥æ²¡æœ‰å†å²è®°å½•æ˜¯**æ­£å¸¸çš„**

**æ¨æµ‹2ï¼šè®¢å•è¢«æ‹’ç»è¿‡ï¼Œä½†æ•°æ®ä¸¢å¤±**
- æ‹’ç»æ“ä½œå‘ç”Ÿåœ¨ `order_photo_history` é›†åˆåˆ›å»ºä¹‹å‰
- æ—§ç‰ˆæœ¬ä»£ç æ²¡æœ‰ä¿å­˜ `rejectCount` ç­‰å­—æ®µ
- å¯¼è‡´æ—¢æ²¡æœ‰æ•°æ®åº“è®°å½•ï¼Œä¹Ÿæ— æ³•ä»è®¢å•é‡å»º

### ä¸ºä»€ä¹ˆ"ä»è®¢å•å­—æ®µé‡å»º"æ²¡æœ‰æ‰§è¡Œï¼Ÿ

**ä»£ç é€»è¾‘ï¼š**
```javascript
if (order.rejectCount && order.rejectCount > 0) {
  // é‡å»ºé€»è¾‘
}
```

**é—®é¢˜ï¼š**
- è®¢å•çš„ `rejectCount` å­—æ®µä¸º 0ã€undefined æˆ–ä¸å­˜åœ¨
- å¯¼è‡´æ¡ä»¶ä¸æˆç«‹ï¼Œè·³è¿‡äº†é‡å»ºé€»è¾‘

---

## éœ€è¦éªŒè¯çš„å…³é”®ä¿¡æ¯

### 1. æŸ¥çœ‹è®¢å•è¯¦ç»†å­—æ®µ

**æ“ä½œæ­¥éª¤ï¼š**
1. æ‰“å¼€äº‘å¼€å‘ â†’ æ•°æ®åº“
2. ç‚¹å‡» `activity_orders` é›†åˆ
3. æ‰¾åˆ°è®¢å• ID: `4ea4942768ee46b802b41517326ece21`
4. æŸ¥çœ‹å®Œæ•´çš„è®¢å•æ•°æ®

**éœ€è¦ç¡®è®¤çš„å­—æ®µï¼š**
```json
{
  "_id": "4ea4942768ee46b802b41517326ece21",
  "status": "?",              // è®¢å•çŠ¶æ€
  "rejectCount": ?,           // æ‹’ç»æ¬¡æ•°
  "adminRejectReason": "?",   // ç®¡ç†å‘˜æ‹’ç»åŸå› 
  "adminRejectedAt": "?",     // ç®¡ç†å‘˜æ‹’ç»æ—¶é—´
  "rejectReason": "?",        // ç”¨æˆ·æ‹’ç»åŸå› 
  "rejectedAt": "?",          // ç”¨æˆ·æ‹’ç»æ—¶é—´
  "photos": [],               // æäº¤çš„ç…§ç‰‡
  "submittedAt": "?"          // æäº¤æ—¶é—´
}
```

### 2. æ£€æŸ¥ order_photo_history é›†åˆ

**ç¡®è®¤ï¼š**
- é›†åˆé‡Œæœ‰å¤šå°‘æ¡è®°å½•ï¼Ÿ
- å¦‚æœä¸º 0ï¼Œè¯´æ˜ä»æœªæœ‰æ‹’ç»æ“ä½œæˆåŠŸä¿å­˜è¿‡

### 3. æµ‹è¯•æ–°çš„æ‹’ç»æ“ä½œ

**æ­¥éª¤ï¼š**
1. æ‰¾ä¸€ä¸ªæ–°çš„å¾…å®¡æ ¸è®¢å•ï¼ˆä¸æ˜¯è¿™ä¸ªï¼‰
2. ç‚¹å‡»"å¿«é€Ÿæ‹’ç»"
3. è¾“å…¥æ‹’ç»åŸå› 
4. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æ˜¾ç¤ºï¼š`âœ… å†å²è®°å½•ä¿å­˜æˆåŠŸ`
5. é‡æ–°è¿›å…¥è¯¦æƒ…é¡µ
6. çœ‹å†å²è®°å½•æ˜¯å¦æ˜¾ç¤º

---

## ç»™å¦ä¸€ä¸ªAIçš„å®Œæ•´é—®é¢˜æè¿°

### èƒŒæ™¯

æˆ‘æ­£åœ¨å¼€å‘ä¸€ä¸ªå¾®ä¿¡å°ç¨‹åºçš„è®¢å•å®¡æ ¸ç³»ç»Ÿã€‚ç³»ç»Ÿéœ€è¦æ˜¾ç¤ºè®¢å•çš„å†å²æ‹’ç»è®°å½•ï¼ŒåŒ…æ‹¬ï¼š
- æ‘„å½±å¸ˆæäº¤çš„ç…§ç‰‡
- ç®¡ç†å‘˜/ç”¨æˆ·çš„æ‹’ç»åŸå› 
- æ‹’ç»æ—¶é—´

### æŠ€æœ¯æ ˆ

- å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘
- äº‘æ•°æ®åº“ï¼ˆMongoDBï¼‰
- äº‘å‡½æ•°

### æ•°æ®æ¨¡å‹

#### activity_orders é›†åˆï¼ˆè®¢å•è¡¨ï¼‰
```javascript
{
  _id: String,
  status: String,         // pending_review, in_progress, completedç­‰
  rejectCount: Number,    // æ‹’ç»æ¬¡æ•°
  adminRejectReason: String,
  adminRejectedAt: String,
  rejectReason: String,   // ç”¨æˆ·æ‹’ç»åŸå› 
  rejectedAt: String,
  photos: Array,
  submittedAt: String
}
```

#### order_photo_history é›†åˆï¼ˆå†å²è®°å½•è¡¨ï¼‰
```javascript
{
  _id: String,
  orderId: String,        // å…³è”è®¢å•ID
  photos: Array,
  rejectType: String,     // 'admin' æˆ– 'user'
  rejectReason: String,
  submittedAt: String,
  rejectedAt: String,
  createdAt: String
}
```

### æ ¸å¿ƒä»£ç 

**æŸ¥è¯¢å†å²è®°å½•ï¼š**
```javascript
// 1. å…ˆæŸ¥è¯¢æ•°æ®åº“
const historyRes = await db.collection('order_photo_history')
  .where({ orderId: orderId })
  .orderBy('createdAt', 'desc')
  .get();

// 2. å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œå°è¯•ä»è®¢å•å­—æ®µé‡å»º
if (historyRes.data.length === 0) {
  if (order.rejectCount && order.rejectCount > 0) {
    // ä» adminRejectReason/rejectReason é‡å»ºå†å²
    historyPhotos.push({...});
  }
}
```

### é—®é¢˜ç°è±¡

1. **å†å²è®°å½•æ˜¾ç¤ºä¸ºç©º**
   - æ§åˆ¶å°æ—¥å¿—ï¼š`ğŸ“‹ å†å²è®°å½•æŸ¥è¯¢ç»“æœ: []`
   - é¡µé¢ä¸Šçœ‹ä¸åˆ°ä»»ä½•å†å²è®°å½•

2. **"ä»è®¢å•å­—æ®µé‡å»º"é€»è¾‘æ²¡æœ‰æ‰§è¡Œ**
   - æ²¡æœ‰çœ‹åˆ° `ğŸ”„ å°è¯•ä»è®¢å•å­—æ®µé‡å»ºå†å²è®°å½•...` æ—¥å¿—
   - è¯´æ˜ `order.rejectCount` ä¸æ»¡è¶³æ¡ä»¶

3. **order_photo_history é›†åˆä¸ºç©º**
   - é›†åˆå·²åˆ›å»ºï¼Œç´¢å¼•å·²åˆ›å»º
   - ä½†é‡Œé¢æ²¡æœ‰ä»»ä½•æ•°æ®

### æ§åˆ¶å°æ—¥å¿—

```
detail.js:96  ğŸ” æŸ¥è¯¢å†å²è®°å½•ï¼Œè®¢å•ID: 4ea4942768ee46b802b41517326ece21
detail.js:102 ğŸ“‹ å†å²è®°å½•æŸ¥è¯¢ç»“æœ: []
detail.js:108 âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°å†å²è®°å½•
detail.js:169 å†å²è®°å½•æ•°é‡: 0
```

**æ³¨æ„ï¼š** æ²¡æœ‰å‡ºç°"å°è¯•ä»è®¢å•å­—æ®µé‡å»º"çš„æ—¥å¿—ã€‚

### å·²å°è¯•çš„è§£å†³æ–¹æ¡ˆ

1. âœ… åˆ›å»ºäº† `order_photo_history` é›†åˆå’Œç´¢å¼•
2. âœ… ä¿®å¤äº†é”™è¯¯å¤„ç†ï¼ˆé¿å…é˜»å¡ï¼‰
3. âœ… å®ç°äº†ä»è®¢å•å­—æ®µé‡å»ºå†å²çš„é€»è¾‘
4. âŒ ä½†é‡å»ºé€»è¾‘æ²¡æœ‰æ‰§è¡Œï¼ˆå¯èƒ½æ˜¯æ¡ä»¶ä¸æ»¡è¶³ï¼‰

### ç–‘é—®

1. **è®¢å•æ˜¯å¦è¢«æ‹’ç»è¿‡ï¼Ÿ**
   - å¦‚æœä»æœªæ‹’ç»ï¼Œæ²¡æœ‰å†å²è®°å½•æ˜¯æ­£å¸¸çš„å—ï¼Ÿ

2. **rejectCount å­—æ®µä¸ºä»€ä¹ˆä¸å­˜åœ¨ï¼Ÿ**
   - æ—§ç‰ˆæœ¬ä»£ç æ²¡æœ‰ä¿å­˜è¿™ä¸ªå­—æ®µï¼Ÿ
   - è¿˜æ˜¯æ‹’ç»æ“ä½œæœ¬èº«å°±æ²¡æˆåŠŸï¼Ÿ

3. **å¦‚ä½•è¡¥å……æ—§æ•°æ®ï¼Ÿ**
   - æœ‰äº‘å‡½æ•° `fixOrderHistory`ï¼Œä½†æ‰§è¡Œåè¿”å› addedCount: 0
   - æ˜¯æ‰«æé€»è¾‘æœ‰é—®é¢˜ï¼Œè¿˜æ˜¯ç¡®å®æ²¡æœ‰æ—§æ•°æ®ï¼Ÿ

4. **é‡å»ºé€»è¾‘çš„æ¡ä»¶æ˜¯å¦åˆç†ï¼Ÿ**
   ```javascript
   if (order.rejectCount && order.rejectCount > 0)
   ```
   - æ˜¯å¦åº”è¯¥æ£€æŸ¥å…¶ä»–å­—æ®µï¼Ÿ
   - æ¯”å¦‚ `adminRejectReason` æˆ– `rejectReason` å­˜åœ¨ï¼Ÿ

### éœ€è¦çš„å¸®åŠ©

1. å¦‚ä½•åˆ¤æ–­è®¢å•æ˜¯å¦è¢«æ‹’ç»è¿‡ï¼ˆé™¤äº† rejectCountï¼‰ï¼Ÿ
2. å¦‚ä½•ä»è®¢å•çš„å…¶ä»–å­—æ®µåˆ¤æ–­æ˜¯å¦æœ‰å†å²æ•°æ®ï¼Ÿ
3. é‡å»ºé€»è¾‘åº”è¯¥æ£€æŸ¥å“ªäº›æ¡ä»¶æ‰æœ€åˆç†ï¼Ÿ
4. äº‘å‡½æ•°æ‰«æé€»è¾‘åº”è¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

---

## å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼ˆå»ºè®®ï¼‰

### æ–¹æ¡ˆ1ï¼šç›´æ¥æŸ¥çœ‹æ•°æ®åº“ç¡®è®¤ï¼ˆæœ€å¿«ï¼‰

1. æ‰“å¼€äº‘æ•°æ®åº“
2. æŸ¥çœ‹è®¢å• `4ea4942768ee46b802b41517326ece21` çš„å®Œæ•´å­—æ®µ
3. ç¡®è®¤æ˜¯å¦çœŸçš„æœ‰ `rejectCount`ã€`adminRejectReason` ç­‰å­—æ®µ

**å¦‚æœå­—æ®µä¸å­˜åœ¨** â†’ è¯´æ˜è®¢å•ä»æœªè¢«æ‹’ç»ï¼Œæ²¡æœ‰å†å²æ˜¯æ­£å¸¸çš„

**å¦‚æœå­—æ®µå­˜åœ¨** â†’ è¯´æ˜é‡å»ºé€»è¾‘æœ‰é—®é¢˜ï¼Œéœ€è¦è°ƒæ•´æ¡ä»¶

### æ–¹æ¡ˆ2ï¼šæ‰©å±•é‡å»ºæ¡ä»¶

**å½“å‰æ¡ä»¶ï¼š**
```javascript
if (order.rejectCount && order.rejectCount > 0)
```

**å»ºè®®æ”¹ä¸ºï¼š**
```javascript
if (order.adminRejectReason || order.rejectReason) {
  // åªè¦æœ‰ä»»ä½•æ‹’ç»åŸå› ï¼Œå°±å°è¯•é‡å»º
}
```

### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ–°çš„æ‹’ç»æµ‹è¯•

1. æ‰¾ä¸€ä¸ªæ–°è®¢å•
2. æ‹’ç»å®ƒ
3. çœ‹çœ‹æ–°çš„æ‹’ç»æ˜¯å¦èƒ½æ­£ç¡®ä¿å­˜å’Œæ˜¾ç¤º
4. å¦‚æœå¯ä»¥ï¼Œè¯´æ˜ä»£ç æ˜¯å¯¹çš„ï¼Œåªæ˜¯æ—§æ•°æ®ç¡®å®æ²¡æœ‰

---

## ä»£ç æ–‡ä»¶ä½ç½®

- å®¡æ ¸è¯¦æƒ…é¡µJSï¼š`miniprogram/pages/admin/review/detail.js`
- å®¡æ ¸åˆ—è¡¨JSï¼š`miniprogram/pages/admin/review/review.js`
- äº‘å‡½æ•°ï¼š`cloudfunctions/fixOrderHistory/index.js`
- è®¢å•å·¥å…·ï¼š`miniprogram/utils/order-status.js`

---

**å¸Œæœ›è¿™ä»½æŠ¥å‘Šèƒ½å¸®ä½ æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼**

