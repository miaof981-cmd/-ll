# 云开发部署指南

## 📋 第一步：开通云开发

### 1.1 打开微信开发者工具
1. 打开您的小程序项目
2. 点击顶部菜单栏的"云开发"按钮
3. 如果是第一次使用，会提示开通云开发

### 1.2 创建云环境
1. 点击"开通云开发"
2. 环境名称：`prod-xxxx`（系统自动生成）
3. 付费方式：选择"按量计费"（有免费额度）
4. 点击"创建"

### 1.3 记录环境ID
创建成功后，会显示环境ID，格式如：`cloud-xxxxx`

**重要**：请记录这个ID，后面需要配置！

---

## 📋 第二步：创建数据库集合

### 2.1 进入云开发控制台
1. 在微信开发者工具中，点击"云开发"
2. 进入"数据库"页面

### 2.2 创建以下集合

点击"添加集合"，创建以下集合：

| 集合名称 | 说明 | 权限设置 |
|---------|------|---------|
| `photographers` | 摄影师信息 | 仅创建者可读写 |
| `students` | 学生信息 | 仅创建者可读写 |
| `applications` | 申请订单 | 仅创建者可读写 |
| `announcements` | 公告 | 仅创建者可读写 |
| `banners` | 轮播图 | 仅创建者可读写 |
| `archives` | 学籍档案 | 仅创建者可读写 |

**注意**：权限设置为"仅创建者可读写"更安全，数据操作通过云函数进行。

---

## 📋 第三步：上传云函数

### 3.1 右键上传photographers云函数
1. 在微信开发者工具中，找到 `cloudfunctions/photographers`
2. 右键 → 上传并部署：云端安装依赖
3. 等待上传完成

### 3.2 上传students云函数
1. 右键 `cloudfunctions/students`
2. 上传并部署：云端安装依赖

### 3.3 上传applications云函数
1. 右键 `cloudfunctions/applications`
2. 上传并部署：云端安装依赖

### 3.4 验证上传成功
在云开发控制台 → 云函数 → 应该看到3个云函数

---

## 📋 第四步：开启HTTP触发器（重要！）

这一步是让Web管理后台能调用云函数的关键！

### 4.1 开启photographers云函数HTTP触发
1. 在云开发控制台 → 云函数 → 点击`photographers`
2. 找到"触发器配置"
3. 点击"添加触发器"
4. 类型选择：HTTP
5. 点击"确定"
6. **复制生成的HTTP地址**，格式如：
   ```
   https://your-env-id.service.tcloudbase.com/photographers
   ```

### 4.2 对另外两个云函数重复操作
- `students` 云函数
- `applications` 云函数

### 4.3 记录所有HTTP地址
请记录3个云函数的HTTP触发器地址！

---

## 📋 第五步：配置环境ID

### 5.1 配置小程序端

打开 `miniprogram/app.js`，找到第5行：

```javascript
const envId = 'school-env-xxxxx'; // 请替换为您的云环境 ID
```

替换为您的环境ID：

```javascript
const envId = 'cloud-xxxxx'; // 替换为第一步记录的ID
```

### 5.2 配置Web管理后台

打开 `admin/js/cloud-api.js`，找到第8行：

```javascript
baseURL: {
  photographers: 'https://your-env-id.service.tcloudbase.com/photographers',
  students: 'https://your-env-id.service.tcloudbase.com/students',
  applications: 'https://your-env-id.service.tcloudbase.com/applications'
}
```

替换为您的HTTP触发器地址：

```javascript
baseURL: {
  photographers: 'https://cloud-xxxxx.service.tcloudbase.com/photographers',
  students: 'https://cloud-xxxxx.service.tcloudbase.com/students',
  applications: 'https://cloud-xxxxx.service.tcloudbase.com/applications'
}
```

---

## 📋 第六步：测试云开发

### 6.1 测试小程序端

1. 在微信开发者工具中运行小程序
2. 打开控制台Console
3. 应该看到：`✅ 云开发初始化成功，环境ID: cloud-xxxxx`
4. 尝试登录或访问首页，查看是否正常

### 6.2 测试Web管理后台

1. 打开 `admin/index.html`
2. 登录管理员账号
3. 进入"摄影师管理"
4. 尝试添加一个测试摄影师
5. 打开浏览器控制台，查看是否调用成功

---

## 📋 第七步：宝塔部署Web后台

### 7.1 上传文件到服务器

使用FTP或宝塔文件管理，上传`admin`文件夹到服务器：

```
/www/wwwroot/your-domain.com/admin/
```

### 7.2 配置Nginx

在宝塔面板 → 网站 → 您的网站 → 配置文件，添加：

```nginx
location /admin/ {
    alias /www/wwwroot/your-domain.com/admin/;
    index index.html;
    try_files $uri $uri/ /admin/index.html;
}
```

### 7.3 配置SSL（可选但推荐）

在宝塔面板申请免费SSL证书，启用HTTPS。

### 7.4 访问测试

访问：`https://your-domain.com/admin/`

应该能看到登录页面。

---

## ✅ 完成检查清单

请确保以下所有步骤都已完成：

```
□ 开通云开发，记录环境ID
□ 创建6个数据库集合
□ 上传3个云函数
□ 开启3个云函数的HTTP触发器
□ 配置小程序端环境ID（app.js）
□ 配置Web后台HTTP地址（cloud-api.js）
□ 测试小程序端云开发
□ 测试Web后台云API
□ 宝塔部署Web后台
□ 访问测试成功
```

---

## 🎯 验证成功的标志

### 小程序端
- 控制台显示：`✅ 云开发初始化成功`
- 可以正常登录
- 数据保存后刷新不丢失

### Web管理后台
- 控制台没有云API错误
- 可以添加/编辑/删除数据
- 数据与小程序同步

---

## 💰 成本说明

### 免费额度（每天）
- 云函数调用：40,000次
- 数据库读操作：50,000次
- 数据库写操作：30,000次
- 存储空间：2GB
- 流量：1GB

### 预估
对于学校小程序，**免费额度完全够用**！

---

## 🔧 常见问题

### Q1: 控制台显示"未配置云开发环境ID"
**A**: 请检查`app.js`中的`envId`是否正确配置。

### Q2: Web后台提示"未配置云函数HTTP触发器"
**A**: 请检查`cloud-api.js`中的`baseURL`是否配置了正确的HTTP地址。

### Q3: 云函数调用失败
**A**: 
1. 确认云函数已上传
2. 确认HTTP触发器已开启
3. 查看云函数日志排查错误

### Q4: 数据不同步
**A**: 
1. 确认小程序和Web后台使用同一个环境ID
2. 检查云函数调用是否成功
3. 查看数据库中的数据是否正确

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. 微信开发者工具的控制台
2. 云开发控制台的云函数日志
3. 浏览器控制台的错误信息

提供这些信息可以更快定位问题！

---

**祝您部署顺利！** 🎉

