# 摄影师权限问题排查指南

## 问题现象
在管理后台添加了摄影师OpenID，但手机预览时没有摄影师权限。

## 排查步骤

### 1. 检查云数据库记录

在微信开发者工具 → 云开发 → 数据库中检查：

#### 检查 `photographer_accounts` 集合
```javascript
// 查询你添加的OpenID是否存在
{
  "openid": "你的OpenID"
}
```

**应该看到的字段：**
- `openid`: 你的微信OpenID
- `photographerId`: 摄影师ID
- `name`: 摄影师名称
- `isActive`: true （重要！）
- `createdAt`: 创建时间

**如果没有记录，说明添加失败**

### 2. 检查 `photographers` 集合
```javascript
// 查找摄影师信息
{
  "wechatOpenid": "你的OpenID"
}
```

**应该看到：**
- `name`: 摄影师姓名
- `wechatOpenid`: 绑定的OpenID
- 其他摄影师信息

### 3. 重新部署云函数

**非常重要！** 修改云函数后必须重新部署：

1. 在微信开发者工具中
2. 右键点击 `cloudfunctions/unifiedLogin` 文件夹
3. 选择 "云函数增量上传: 更新文件"
4. 等待上传完成

### 4. 清除缓存重新登录

**步骤：**
1. 在小程序中退出登录
2. 微信开发者工具中点击 "清除缓存"
3. 点击 "编译"
4. 重新登录

### 5. 查看登录日志

在开发者工具 Console 中查看登录时的输出：

```
🔍 调试信息 - 我的页面加载:
  userInfo: {...}
  currentRole: ...
  userRoles: [...]  ← 这里应该包含 'photographer'
  isPhotographer: true  ← 应该是 true
```

## 常见问题和解决方案

### 问题1: photographer_accounts 表中没有记录

**原因：** 添加摄影师时OpenID填写错误或未绑定

**解决方案：**
1. 在"我的"页面复制正确的OpenID
2. 重新编辑摄影师信息
3. 粘贴正确的OpenID
4. 保存

### 问题2: isActive 字段为 false

**原因：** 账号被禁用

**解决方案：**
在云数据库中手动修改 `photographer_accounts` 表：
```javascript
{
  "isActive": true
}
```

### 问题3: 云函数未更新

**原因：** 代码修改后未重新部署

**解决方案：**
右键云函数文件夹 → 云函数增量上传: 更新文件

### 问题4: 登录信息缓存

**原因：** 使用的是旧的登录信息

**解决方案：**
1. 退出登录
2. 清除缓存
3. 重新编译
4. 重新登录

## 手动添加摄影师权限（临时方案）

如果以上方法都不行，可以直接在云数据库中添加：

### 方法1: 在 photographer_accounts 表中添加记录

```javascript
{
  "openid": "你的OpenID（从我的页面复制）",
  "photographerId": "对应的摄影师_id",
  "name": "摄影师名称",
  "isActive": true,
  "createdAt": "2025-01-14T12:00:00.000Z"
}
```

### 方法2: 在云开发控制台运行

1. 打开云开发控制台
2. 数据库 → photographer_accounts
3. 点击"添加记录"
4. 填写上述字段
5. 保存

## 验证权限生效

重新登录后，在"我的"页面应该看到：

1. **角色徽章显示：**
   - 📷 摄影师

2. **摄影功能区域：**
   - 标题："摄影功能"
   - 菜单项："📷 工作台"

3. **控制台输出：**
   ```
   isPhotographer: true
   userRoles: ["parent", "photographer"]
   ```

## 测试步骤

1. 点击"工作台"能否进入摄影师工作台
2. 查看是否能看到订单列表
3. 尝试上传作品

## 需要帮助？

如果以上步骤都无法解决，请提供以下信息：

1. Console 中的完整登录日志
2. `photographer_accounts` 表的截图
3. `photographers` 表的截图
4. 云函数是否已重新部署

