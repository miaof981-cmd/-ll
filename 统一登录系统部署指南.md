# 统一登录系统部署指南

## 🎯 系统概述

统一登录系统允许所有用户通过**同一个微信授权入口**登录，系统自动识别用户角色（家长/管理员/摄影师），无需密码、无需区分入口。

---

## 📝 部署步骤

### 1. 上传云函数

在开发者工具中，右键点击以下云函数并选择"上传并部署：云端安装依赖"：

```
cloudfunctions/unifiedLogin/
```

**验证方法：**
- 打开云开发控制台 → 云函数
- 确认 `unifiedLogin` 显示为"已部署"

---

### 2. 创建数据库集合

在云开发控制台 → 数据库，创建以下集合：

#### 2.1 users 集合（用户表）
- 集合名称：`users`
- 权限设置：
  ```json
  {
    "read": "doc._openid == auth.openid",
    "write": "doc._openid == auth.openid"
  }
  ```

#### 2.2 admin_list 集合（管理员白名单）
- 集合名称：`admin_list`
- 权限设置：
  ```json
  {
    "read": true,
    "write": false
  }
  ```

#### 2.3 photographer_accounts 集合（摄影师账号）
- 集合名称：`photographer_accounts`
- 权限设置：
  ```json
  {
    "read": true,
    "write": false
  }
  ```

---

### 3. 添加管理员白名单

在 `admin_list` 集合中，手动添加管理员记录：

**步骤：**
1. 先用微信登录一次小程序（获取 openid）
2. 在云开发控制台 → 数据库 → `users` 集合中查看您的 `_openid`
3. 在 `admin_list` 集合中添加记录：

```json
{
  "openid": "您的微信openid",
  "name": "管理员姓名",
  "phone": "13800138000",
  "permissions": ["all"],
  "isActive": true,
  "createdAt": "2025-01-14T00:00:00.000Z"
}
```

**获取 openid 的方法：**

方法1：在登录页添加临时代码
```javascript
// 在 pages/login/login.js 的 wechatLogin 中添加
console.log('您的 openid:', res.result.openid);
```

方法2：查看 users 集合
- 登录后，在 `users` 集合中会自动创建记录
- 查看 `_openid` 字段

---

### 4. 绑定摄影师账号（可选）

如果要将某个微信号设置为摄影师，在 `photographer_accounts` 集合中添加：

```json
{
  "openid": "摄影师的微信openid",
  "photographerId": "PHO001",
  "name": "摄影师姓名",
  "isActive": true,
  "createdAt": "2025-01-14T00:00:00.000Z"
}
```

注意：`photographerId` 需要关联 `photographers` 集合中的记录。

---

## 🧪 测试登录流程

### 测试1：普通家长登录
1. 使用非管理员微信登录
2. 应该自动识别为"家长"角色
3. 跳转到个人中心
4. 可以查看孩子列表（需先申请入学）

### 测试2：管理员登录
1. 使用添加到白名单的微信登录
2. 应该自动识别为"管理员"角色
3. 跳转到管理后台

### 测试3：多角色切换
1. 将一个用户同时添加到 `admin_list` 和 `photographer_accounts`
2. 登录时会显示角色选择界面
3. 选择角色后跳转到对应首页
4. 在个人中心可以切换角色

---

## 🔧 角色识别逻辑

```
用户登录
  ↓
获取 openid
  ↓
检查 admin_list → 是管理员？ → 添加 admin 角色
  ↓
检查 photographer_accounts → 是摄影师？ → 添加 photographer 角色
  ↓
默认添加 parent 角色
  ↓
返回用户拥有的所有角色
  ↓
如果只有1个角色 → 直接跳转
如果有多个角色 → 显示选择界面
```

---

## 📱 页面路由

### 角色首页映射
- **家长** → `/pages/my/my`（个人中心）
- **管理员** → `/pages/admin/admin`（管理后台）
- **摄影师** → `/pages/photographer/tasks`（接单中心）

### 角色切换流程
1. 在个人中心点击角色徽章
2. 跳转到 `/pages/role-select/role-select`
3. 选择新角色
4. 更新 currentRole
5. 跳转到新角色首页

---

## 🔐 数据安全

1. **openid 自动获取**：使用微信云开发，openid 由服务器端自动获取，不可伪造
2. **权限控制**：数据库权限设置确保用户只能读写自己的数据
3. **角色验证**：每次角色切换都会重新验证用户是否拥有该角色

---

## ⚠️ 常见问题

### Q: 管理员登录后还是显示家长身份？
A: 检查 `admin_list` 集合中的 openid 是否正确，且 `isActive: true`

### Q: 如何给多个用户设置管理员？
A: 在 `admin_list` 集合中添加多条记录，每个管理员一条

### Q: 孩子列表为空？
A: 需要先完成入学申请并审核通过，系统会自动关联到用户的 children 数组

### Q: 角色切换后数据不更新？
A: 检查 `currentRole` 是否正确保存到 Storage，刷新页面重新加载

---

## 🚀 下一步优化

- [ ] 添加角色权限细分（查看/编辑/删除）
- [ ] 实现子账号管理（一个家长多个孩子）
- [ ] 添加角色切换动画效果
- [ ] 优化角色选择页面 UI
- [ ] 添加登录日志记录

---

## 📞 技术支持

如有问题，请查看：
- `统一登录系统设计.md` - 系统设计文档
- 云开发控制台 - 查看云函数日志
- 开发者工具 Console - 查看客户端日志

