# 诊断用户信息问题 - 完整指南

## 🎯 问题
无论真机还是模拟器，都显示"微信用户"和默认头像，没有显示真实的微信昵称和头像。

---

## 🔍 诊断步骤

### 第1步：检查控制台日志 ⭐️

1. **打开控制台**
   - 微信开发者工具底部的"Console"标签

2. **进入"我的"页面**
   - 点击底部导航的"我的"

3. **查看日志输出**

**你会看到详细的调试信息：**

```
========================================
🔍 调试信息 - 我的页面加载:
========================================
📦 本地存储内容:
  userInfo: {
    "_id": "...",
    "_openid": "o5_xU4wY...",
    "nickName": "???",      ← 重点看这里
    "avatarUrl": "???",     ← 重点看这里
    "openid": "o5_xU4wY...",
    "roles": ["admin", "photographer", "parent"]
  }
  currentRole: admin
  userRoles: ["admin", "photographer", "parent"]

👤 用户信息详情:
  昵称 (nickName): ???
  头像 (avatarUrl): ???
  OpenID (_openid): o5_xU4wY...
  OpenID (openid): o5_xU4wY...
  角色 (roles): ["admin", "photographer", "parent"]
========================================
```

---

## 🧪 根据日志判断问题

### 情况1：nickName 和 avatarUrl 都存在 ✅

```
👤 用户信息详情:
  昵称 (nickName): 你的昵称
  头像 (avatarUrl): https://thirdwx.qlogo.cn/...
```

**说明：** 数据是完整的，但页面没有显示

**可能原因：**
- WXML 模板问题
- 头像 URL 加载失败
- 缓存问题

**解决方法：** 跳到"解决方案 A"

---

### 情况2：nickName 或 avatarUrl 为空/undefined ❌

```
👤 用户信息详情:
  昵称 (nickName): undefined
  头像 (avatarUrl): undefined
```

**说明：** 数据根本没有保存

**可能原因：**
- 登录时云函数返回的数据不完整
- 本地存储保存失败

**解决方法：** 跳到"解决方案 B"

---

### 情况3：nickName 是"微信用户" ❌

```
👤 用户信息详情:
  昵称 (nickName): 微信用户
  头像 (avatarUrl): /path/to/default/avatar.png
```

**说明：** 保存的是默认测试数据

**可能原因：**
- `wx.getUserProfile()` 返回的就是默认数据
- 云函数保存的是测试数据

**解决方法：** 跳到"解决方案 C"

---

## 💡 解决方案 A：数据完整但页面不显示

### 第1步：检查 WXML

查看 `miniprogram/pages/my/my.wxml` 第12行：

```xml
<image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
```

**确认：**
- ✅ 使用的是 `userInfo.avatarUrl`
- ✅ 没有拼写错误

### 第2步：检查头像URL

在控制台输入：

```javascript
console.log('头像URL:', this.data.userInfo.avatarUrl);
```

**如果是 `http://` 开头：**
- 需要在 `project.config.json` 中设置 `"checkSiteMap": false`
- 或添加到域名白名单

### 第3步：添加头像加载失败处理

修改 WXML：

```xml
<image 
  class="avatar" 
  src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" 
  mode="aspectFill"
  binderror="onAvatarError"
></image>
```

添加错误处理：

```javascript
onAvatarError(e) {
  console.error('❌ 头像加载失败:', e.detail.errMsg);
  console.log('当前头像URL:', this.data.userInfo.avatarUrl);
}
```

---

## 💡 解决方案 B：数据为空

### 第1步：检查登录流程

打开 `miniprogram/pages/login/login.js`，找到登录成功后的代码（第64-66行）：

```javascript
// 3. 保存用户信息和所有角色
wx.setStorageSync('unifiedUserInfo', user);
wx.setStorageSync('userRoles', roles);
```

**添加日志：**

```javascript
console.log('💾 保存到本地存储的数据:');
console.log('  user:', JSON.stringify(user, null, 2));
console.log('  roles:', roles);
```

### 第2步：重新登录

1. 清除本地存储：
   ```javascript
   wx.clearStorageSync();
   ```

2. 重新进入登录页面

3. 点击"微信登录"

4. 查看控制台日志

**检查云函数返回的数据：**

```
☁️ unifiedLogin 返回结果: {
  "success": true,
  "user": {
    "_id": "...",
    "nickName": "???",      ← 重点看这里
    "avatarUrl": "???",     ← 重点看这里
    "openid": "o5_xU4wY..."
  },
  "roles": ["admin", "photographer", "parent"]
}
```

**如果 `nickName` 和 `avatarUrl` 为空：**
- 云函数没有正确保存/返回数据
- 需要检查云函数代码

---

## 💡 解决方案 C：保存的是默认数据

### 问题原因

`wx.getUserProfile()` 返回的就是默认的测试数据，而不是真实的用户信息。

### 检查调用点

在登录页面（`miniprogram/pages/login/login.js`）第40-42行：

```javascript
// 1. 获取用户信息
const { userInfo } = await wx.getUserProfile({
  desc: '用于完善用户资料'
});

console.log('✅ 获取微信信息成功:', userInfo.nickName);
console.log('📸 头像URL:', userInfo.avatarUrl);
```

**添加详细日志：**

```javascript
console.log('========================================');
console.log('📱 wx.getUserProfile 返回的完整数据:');
console.log(JSON.stringify(userInfo, null, 2));
console.log('========================================');
```

### 可能的原因

#### 原因1：模拟器限制

**模拟器的 `wx.getUserProfile()` 可能返回默认数据！**

**解决：** 必须在真机上测试

1. 点击"真机调试"
2. 用微信扫码
3. 在手机上重新登录
4. 查看真机日志

#### 原因2：授权被拒绝

**如果用户拒绝了授权，会返回默认数据。**

**检查：** 查看登录日志中是否有错误

```javascript
catch (e) {
  console.error('❌ 登录失败:', e);
  if (e.errMsg && e.errMsg.includes('cancel')) {
    console.log('⚠️ 用户取消了授权');
  }
}
```

#### 原因3：小程序配置问题

**检查 `app.json` 是否有用户信息权限配置：**

```json
{
  "permission": {
    "scope.userInfo": {
      "desc": "用于完善用户资料"
    }
  }
}
```

---

## 🚀 快速诊断命令

### 在控制台直接运行

#### 1. 检查本地存储

```javascript
console.log('=== 本地存储诊断 ===');
const userInfo = wx.getStorageSync('unifiedUserInfo');
console.log('userInfo:', JSON.stringify(userInfo, null, 2));
console.log('nickName:', userInfo?.nickName);
console.log('avatarUrl:', userInfo?.avatarUrl);
```

#### 2. 检查页面数据

```javascript
console.log('=== 页面数据诊断 ===');
const pages = getCurrentPages();
const currentPage = pages[pages.length - 1];
console.log('页面 data.userInfo:', currentPage.data.userInfo);
console.log('nickName:', currentPage.data.userInfo?.nickName);
console.log('avatarUrl:', currentPage.data.userInfo?.avatarUrl);
```

#### 3. 强制刷新页面

```javascript
const pages = getCurrentPages();
const currentPage = pages[pages.length - 1];
currentPage.checkLoginStatus();
```

---

## 📸 需要提供的截图

**如果问题仍未解决，请提供以下截图：**

### 1. 控制台完整日志

包括：
- "我的"页面加载时的日志
- `unifiedUserInfo` 的完整内容
- `nickName` 和 `avatarUrl` 的值

### 2. 页面显示

- "我的"页面的完整截图
- 包括头像、昵称、角色标签

### 3. Storage 内容

1. 打开"Storage" → "Storage"标签
2. 找到 `unifiedUserInfo`
3. 截图显示完整内容

### 4. 云函数返回（如果重新登录）

- 登录时云函数返回的完整数据
- 特别是 `user.nickName` 和 `user.avatarUrl`

---

## 🎯 完整诊断流程

```
1. 编译小程序
   ↓
2. 进入"我的"页面
   ↓
3. 打开控制台，查看日志
   ↓
4. 找到这些关键信息：
   - userInfo 的完整内容
   - nickName 的值
   - avatarUrl 的值
   ↓
5. 根据日志判断：
   
   【情况1】nickName 和 avatarUrl 都有值
   → 跳到"解决方案 A"
   
   【情况2】nickName 或 avatarUrl 为空
   → 跳到"解决方案 B"
   
   【情况3】nickName 是"微信用户"
   → 跳到"解决方案 C"
   ↓
6. 按照对应的解决方案操作
   ↓
7. 重新测试
   ↓
8. 如果仍有问题：
   - 截图日志
   - 截图页面
   - 截图 Storage
   - 反馈给我
```

---

## 🎉 成功标志

问题解决后，你会看到：

### 控制台日志
```
👤 用户信息详情:
  昵称 (nickName): 你的真实昵称
  头像 (avatarUrl): https://thirdwx.qlogo.cn/...
  OpenID (_openid): o5_xU4wY...
```

### 页面显示
- ✅ 真实的微信头像
- ✅ 真实的微信昵称
- ✅ 正确的角色标签

---

**现在请：**
1. 点击"编译"
2. 进入"我的"页面
3. 查看控制台日志
4. **把日志中 `nickName` 和 `avatarUrl` 的值截图发给我**

我会根据具体情况告诉你下一步怎么做！🚀

