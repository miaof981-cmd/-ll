# è¯Šæ–­ç”¨æˆ·ä¿¡æ¯é—®é¢˜ - å®Œæ•´æŒ‡å—

## ğŸ¯ é—®é¢˜
æ— è®ºçœŸæœºè¿˜æ˜¯æ¨¡æ‹Ÿå™¨ï¼Œéƒ½æ˜¾ç¤º"å¾®ä¿¡ç”¨æˆ·"å’Œé»˜è®¤å¤´åƒï¼Œæ²¡æœ‰æ˜¾ç¤ºçœŸå®çš„å¾®ä¿¡æ˜µç§°å’Œå¤´åƒã€‚

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### ç¬¬1æ­¥ï¼šæ£€æŸ¥æ§åˆ¶å°æ—¥å¿— â­ï¸

1. **æ‰“å¼€æ§åˆ¶å°**
   - å¾®ä¿¡å¼€å‘è€…å·¥å…·åº•éƒ¨çš„"Console"æ ‡ç­¾

2. **è¿›å…¥"æˆ‘çš„"é¡µé¢**
   - ç‚¹å‡»åº•éƒ¨å¯¼èˆªçš„"æˆ‘çš„"

3. **æŸ¥çœ‹æ—¥å¿—è¾“å‡º**

**ä½ ä¼šçœ‹åˆ°è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š**

```
========================================
ğŸ” è°ƒè¯•ä¿¡æ¯ - æˆ‘çš„é¡µé¢åŠ è½½:
========================================
ğŸ“¦ æœ¬åœ°å­˜å‚¨å†…å®¹:
  userInfo: {
    "_id": "...",
    "_openid": "o5_xU4wY...",
    "nickName": "???",      â† é‡ç‚¹çœ‹è¿™é‡Œ
    "avatarUrl": "???",     â† é‡ç‚¹çœ‹è¿™é‡Œ
    "openid": "o5_xU4wY...",
    "roles": ["admin", "photographer", "parent"]
  }
  currentRole: admin
  userRoles: ["admin", "photographer", "parent"]

ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…:
  æ˜µç§° (nickName): ???
  å¤´åƒ (avatarUrl): ???
  OpenID (_openid): o5_xU4wY...
  OpenID (openid): o5_xU4wY...
  è§’è‰² (roles): ["admin", "photographer", "parent"]
========================================
```

---

## ğŸ§ª æ ¹æ®æ—¥å¿—åˆ¤æ–­é—®é¢˜

### æƒ…å†µ1ï¼šnickName å’Œ avatarUrl éƒ½å­˜åœ¨ âœ…

```
ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…:
  æ˜µç§° (nickName): ä½ çš„æ˜µç§°
  å¤´åƒ (avatarUrl): https://thirdwx.qlogo.cn/...
```

**è¯´æ˜ï¼š** æ•°æ®æ˜¯å®Œæ•´çš„ï¼Œä½†é¡µé¢æ²¡æœ‰æ˜¾ç¤º

**å¯èƒ½åŸå› ï¼š**
- WXML æ¨¡æ¿é—®é¢˜
- å¤´åƒ URL åŠ è½½å¤±è´¥
- ç¼“å­˜é—®é¢˜

**è§£å†³æ–¹æ³•ï¼š** è·³åˆ°"è§£å†³æ–¹æ¡ˆ A"

---

### æƒ…å†µ2ï¼šnickName æˆ– avatarUrl ä¸ºç©º/undefined âŒ

```
ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…:
  æ˜µç§° (nickName): undefined
  å¤´åƒ (avatarUrl): undefined
```

**è¯´æ˜ï¼š** æ•°æ®æ ¹æœ¬æ²¡æœ‰ä¿å­˜

**å¯èƒ½åŸå› ï¼š**
- ç™»å½•æ—¶äº‘å‡½æ•°è¿”å›çš„æ•°æ®ä¸å®Œæ•´
- æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥

**è§£å†³æ–¹æ³•ï¼š** è·³åˆ°"è§£å†³æ–¹æ¡ˆ B"

---

### æƒ…å†µ3ï¼šnickName æ˜¯"å¾®ä¿¡ç”¨æˆ·" âŒ

```
ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…:
  æ˜µç§° (nickName): å¾®ä¿¡ç”¨æˆ·
  å¤´åƒ (avatarUrl): /path/to/default/avatar.png
```

**è¯´æ˜ï¼š** ä¿å­˜çš„æ˜¯é»˜è®¤æµ‹è¯•æ•°æ®

**å¯èƒ½åŸå› ï¼š**
- `wx.getUserProfile()` è¿”å›çš„å°±æ˜¯é»˜è®¤æ•°æ®
- äº‘å‡½æ•°ä¿å­˜çš„æ˜¯æµ‹è¯•æ•°æ®

**è§£å†³æ–¹æ³•ï¼š** è·³åˆ°"è§£å†³æ–¹æ¡ˆ C"

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ Aï¼šæ•°æ®å®Œæ•´ä½†é¡µé¢ä¸æ˜¾ç¤º

### ç¬¬1æ­¥ï¼šæ£€æŸ¥ WXML

æŸ¥çœ‹ `miniprogram/pages/my/my.wxml` ç¬¬12è¡Œï¼š

```xml
<image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
```

**ç¡®è®¤ï¼š**
- âœ… ä½¿ç”¨çš„æ˜¯ `userInfo.avatarUrl`
- âœ… æ²¡æœ‰æ‹¼å†™é”™è¯¯

### ç¬¬2æ­¥ï¼šæ£€æŸ¥å¤´åƒURL

åœ¨æ§åˆ¶å°è¾“å…¥ï¼š

```javascript
console.log('å¤´åƒURL:', this.data.userInfo.avatarUrl);
```

**å¦‚æœæ˜¯ `http://` å¼€å¤´ï¼š**
- éœ€è¦åœ¨ `project.config.json` ä¸­è®¾ç½® `"checkSiteMap": false`
- æˆ–æ·»åŠ åˆ°åŸŸåç™½åå•

### ç¬¬3æ­¥ï¼šæ·»åŠ å¤´åƒåŠ è½½å¤±è´¥å¤„ç†

ä¿®æ”¹ WXMLï¼š

```xml
<image 
  class="avatar" 
  src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" 
  mode="aspectFill"
  binderror="onAvatarError"
></image>
```

æ·»åŠ é”™è¯¯å¤„ç†ï¼š

```javascript
onAvatarError(e) {
  console.error('âŒ å¤´åƒåŠ è½½å¤±è´¥:', e.detail.errMsg);
  console.log('å½“å‰å¤´åƒURL:', this.data.userInfo.avatarUrl);
}
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ Bï¼šæ•°æ®ä¸ºç©º

### ç¬¬1æ­¥ï¼šæ£€æŸ¥ç™»å½•æµç¨‹

æ‰“å¼€ `miniprogram/pages/login/login.js`ï¼Œæ‰¾åˆ°ç™»å½•æˆåŠŸåçš„ä»£ç ï¼ˆç¬¬64-66è¡Œï¼‰ï¼š

```javascript
// 3. ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ‰€æœ‰è§’è‰²
wx.setStorageSync('unifiedUserInfo', user);
wx.setStorageSync('userRoles', roles);
```

**æ·»åŠ æ—¥å¿—ï¼š**

```javascript
console.log('ğŸ’¾ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨çš„æ•°æ®:');
console.log('  user:', JSON.stringify(user, null, 2));
console.log('  roles:', roles);
```

### ç¬¬2æ­¥ï¼šé‡æ–°ç™»å½•

1. æ¸…é™¤æœ¬åœ°å­˜å‚¨ï¼š
   ```javascript
   wx.clearStorageSync();
   ```

2. é‡æ–°è¿›å…¥ç™»å½•é¡µé¢

3. ç‚¹å‡»"å¾®ä¿¡ç™»å½•"

4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

**æ£€æŸ¥äº‘å‡½æ•°è¿”å›çš„æ•°æ®ï¼š**

```
â˜ï¸ unifiedLogin è¿”å›ç»“æœ: {
  "success": true,
  "user": {
    "_id": "...",
    "nickName": "???",      â† é‡ç‚¹çœ‹è¿™é‡Œ
    "avatarUrl": "???",     â† é‡ç‚¹çœ‹è¿™é‡Œ
    "openid": "o5_xU4wY..."
  },
  "roles": ["admin", "photographer", "parent"]
}
```

**å¦‚æœ `nickName` å’Œ `avatarUrl` ä¸ºç©ºï¼š**
- äº‘å‡½æ•°æ²¡æœ‰æ­£ç¡®ä¿å­˜/è¿”å›æ•°æ®
- éœ€è¦æ£€æŸ¥äº‘å‡½æ•°ä»£ç 

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ Cï¼šä¿å­˜çš„æ˜¯é»˜è®¤æ•°æ®

### é—®é¢˜åŸå› 

`wx.getUserProfile()` è¿”å›çš„å°±æ˜¯é»˜è®¤çš„æµ‹è¯•æ•°æ®ï¼Œè€Œä¸æ˜¯çœŸå®çš„ç”¨æˆ·ä¿¡æ¯ã€‚

### æ£€æŸ¥è°ƒç”¨ç‚¹

åœ¨ç™»å½•é¡µé¢ï¼ˆ`miniprogram/pages/login/login.js`ï¼‰ç¬¬40-42è¡Œï¼š

```javascript
// 1. è·å–ç”¨æˆ·ä¿¡æ¯
const { userInfo } = await wx.getUserProfile({
  desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™'
});

console.log('âœ… è·å–å¾®ä¿¡ä¿¡æ¯æˆåŠŸ:', userInfo.nickName);
console.log('ğŸ“¸ å¤´åƒURL:', userInfo.avatarUrl);
```

**æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š**

```javascript
console.log('========================================');
console.log('ğŸ“± wx.getUserProfile è¿”å›çš„å®Œæ•´æ•°æ®:');
console.log(JSON.stringify(userInfo, null, 2));
console.log('========================================');
```

### å¯èƒ½çš„åŸå› 

#### åŸå› 1ï¼šæ¨¡æ‹Ÿå™¨é™åˆ¶

**æ¨¡æ‹Ÿå™¨çš„ `wx.getUserProfile()` å¯èƒ½è¿”å›é»˜è®¤æ•°æ®ï¼**

**è§£å†³ï¼š** å¿…é¡»åœ¨çœŸæœºä¸Šæµ‹è¯•

1. ç‚¹å‡»"çœŸæœºè°ƒè¯•"
2. ç”¨å¾®ä¿¡æ‰«ç 
3. åœ¨æ‰‹æœºä¸Šé‡æ–°ç™»å½•
4. æŸ¥çœ‹çœŸæœºæ—¥å¿—

#### åŸå› 2ï¼šæˆæƒè¢«æ‹’ç»

**å¦‚æœç”¨æˆ·æ‹’ç»äº†æˆæƒï¼Œä¼šè¿”å›é»˜è®¤æ•°æ®ã€‚**

**æ£€æŸ¥ï¼š** æŸ¥çœ‹ç™»å½•æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯

```javascript
catch (e) {
  console.error('âŒ ç™»å½•å¤±è´¥:', e);
  if (e.errMsg && e.errMsg.includes('cancel')) {
    console.log('âš ï¸ ç”¨æˆ·å–æ¶ˆäº†æˆæƒ');
  }
}
```

#### åŸå› 3ï¼šå°ç¨‹åºé…ç½®é—®é¢˜

**æ£€æŸ¥ `app.json` æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯æƒé™é…ç½®ï¼š**

```json
{
  "permission": {
    "scope.userInfo": {
      "desc": "ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™"
    }
  }
}
```

---

## ğŸš€ å¿«é€Ÿè¯Šæ–­å‘½ä»¤

### åœ¨æ§åˆ¶å°ç›´æ¥è¿è¡Œ

#### 1. æ£€æŸ¥æœ¬åœ°å­˜å‚¨

```javascript
console.log('=== æœ¬åœ°å­˜å‚¨è¯Šæ–­ ===');
const userInfo = wx.getStorageSync('unifiedUserInfo');
console.log('userInfo:', JSON.stringify(userInfo, null, 2));
console.log('nickName:', userInfo?.nickName);
console.log('avatarUrl:', userInfo?.avatarUrl);
```

#### 2. æ£€æŸ¥é¡µé¢æ•°æ®

```javascript
console.log('=== é¡µé¢æ•°æ®è¯Šæ–­ ===');
const pages = getCurrentPages();
const currentPage = pages[pages.length - 1];
console.log('é¡µé¢ data.userInfo:', currentPage.data.userInfo);
console.log('nickName:', currentPage.data.userInfo?.nickName);
console.log('avatarUrl:', currentPage.data.userInfo?.avatarUrl);
```

#### 3. å¼ºåˆ¶åˆ·æ–°é¡µé¢

```javascript
const pages = getCurrentPages();
const currentPage = pages[pages.length - 1];
currentPage.checkLoginStatus();
```

---

## ğŸ“¸ éœ€è¦æä¾›çš„æˆªå›¾

**å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹æˆªå›¾ï¼š**

### 1. æ§åˆ¶å°å®Œæ•´æ—¥å¿—

åŒ…æ‹¬ï¼š
- "æˆ‘çš„"é¡µé¢åŠ è½½æ—¶çš„æ—¥å¿—
- `unifiedUserInfo` çš„å®Œæ•´å†…å®¹
- `nickName` å’Œ `avatarUrl` çš„å€¼

### 2. é¡µé¢æ˜¾ç¤º

- "æˆ‘çš„"é¡µé¢çš„å®Œæ•´æˆªå›¾
- åŒ…æ‹¬å¤´åƒã€æ˜µç§°ã€è§’è‰²æ ‡ç­¾

### 3. Storage å†…å®¹

1. æ‰“å¼€"Storage" â†’ "Storage"æ ‡ç­¾
2. æ‰¾åˆ° `unifiedUserInfo`
3. æˆªå›¾æ˜¾ç¤ºå®Œæ•´å†…å®¹

### 4. äº‘å‡½æ•°è¿”å›ï¼ˆå¦‚æœé‡æ–°ç™»å½•ï¼‰

- ç™»å½•æ—¶äº‘å‡½æ•°è¿”å›çš„å®Œæ•´æ•°æ®
- ç‰¹åˆ«æ˜¯ `user.nickName` å’Œ `user.avatarUrl`

---

## ğŸ¯ å®Œæ•´è¯Šæ–­æµç¨‹

```
1. ç¼–è¯‘å°ç¨‹åº
   â†“
2. è¿›å…¥"æˆ‘çš„"é¡µé¢
   â†“
3. æ‰“å¼€æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ—¥å¿—
   â†“
4. æ‰¾åˆ°è¿™äº›å…³é”®ä¿¡æ¯ï¼š
   - userInfo çš„å®Œæ•´å†…å®¹
   - nickName çš„å€¼
   - avatarUrl çš„å€¼
   â†“
5. æ ¹æ®æ—¥å¿—åˆ¤æ–­ï¼š
   
   ã€æƒ…å†µ1ã€‘nickName å’Œ avatarUrl éƒ½æœ‰å€¼
   â†’ è·³åˆ°"è§£å†³æ–¹æ¡ˆ A"
   
   ã€æƒ…å†µ2ã€‘nickName æˆ– avatarUrl ä¸ºç©º
   â†’ è·³åˆ°"è§£å†³æ–¹æ¡ˆ B"
   
   ã€æƒ…å†µ3ã€‘nickName æ˜¯"å¾®ä¿¡ç”¨æˆ·"
   â†’ è·³åˆ°"è§£å†³æ–¹æ¡ˆ C"
   â†“
6. æŒ‰ç…§å¯¹åº”çš„è§£å†³æ–¹æ¡ˆæ“ä½œ
   â†“
7. é‡æ–°æµ‹è¯•
   â†“
8. å¦‚æœä»æœ‰é—®é¢˜ï¼š
   - æˆªå›¾æ—¥å¿—
   - æˆªå›¾é¡µé¢
   - æˆªå›¾ Storage
   - åé¦ˆç»™æˆ‘
```

---

## ğŸ‰ æˆåŠŸæ ‡å¿—

é—®é¢˜è§£å†³åï¼Œä½ ä¼šçœ‹åˆ°ï¼š

### æ§åˆ¶å°æ—¥å¿—
```
ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…:
  æ˜µç§° (nickName): ä½ çš„çœŸå®æ˜µç§°
  å¤´åƒ (avatarUrl): https://thirdwx.qlogo.cn/...
  OpenID (_openid): o5_xU4wY...
```

### é¡µé¢æ˜¾ç¤º
- âœ… çœŸå®çš„å¾®ä¿¡å¤´åƒ
- âœ… çœŸå®çš„å¾®ä¿¡æ˜µç§°
- âœ… æ­£ç¡®çš„è§’è‰²æ ‡ç­¾

---

**ç°åœ¨è¯·ï¼š**
1. ç‚¹å‡»"ç¼–è¯‘"
2. è¿›å…¥"æˆ‘çš„"é¡µé¢
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
4. **æŠŠæ—¥å¿—ä¸­ `nickName` å’Œ `avatarUrl` çš„å€¼æˆªå›¾å‘ç»™æˆ‘**

æˆ‘ä¼šæ ¹æ®å…·ä½“æƒ…å†µå‘Šè¯‰ä½ ä¸‹ä¸€æ­¥æ€ä¹ˆåšï¼ğŸš€

