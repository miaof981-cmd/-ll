# 🧪 测试摄影师角色识别

## 快速测试步骤

### 步骤1：获取您的 OpenID

1. 打开小程序
2. 点击"我的"Tab
3. 找到 OpenID 显示区域
4. 点击复制

**预期结果：**
```
OpenID: oXXXX-XXXXXXXXXXXXXXXXXXXX
[点击复制]
```

---

### 步骤2：检查 `photographer_accounts` 集合

打开云开发控制台：
```
云开发 > 数据库 > photographer_accounts
```

**检查是否有记录包含您的 OpenID：**

✅ **正确的记录示例：**
```json
{
  "_id": "abc123",
  "openid": "oXXXX-XXXXXXXXXXXXXXXXXXXX",  // 与步骤1的OpenID一致
  "photographerId": "photographer_id_123",
  "name": "张三",
  "isActive": true,  // 必须是 true
  "createdAt": "2025-10-14T10:00:00.000Z"
}
```

❌ **错误的示例：**
```json
{
  "_id": "abc123",
  "wechatOpenid": "oXXXX-XX...",  // ❌ 字段名错误，应该是 openid
  "photographerId": "...",
  "name": "张三",
  "isActive": false,  // ❌ 应该是 true
  "createdAt": "..."
}
```

---

### 步骤3：如果没有记录，立即添加

#### 方法A：通过小程序管理后台（最简单）

1. **在小程序中操作：**
   ```
   我的 > 管理后台 > 摄影师管理 > 选择摄影师 > 编辑
   ```

2. **在"绑定微信账号"区域：**
   - 点击"手动输入OpenID"
   - 粘贴步骤1复制的 OpenID
   - 点击"保存"

3. **系统会自动创建 `photographer_accounts` 记录**

#### 方法B：直接在云数据库添加

1. **打开云开发控制台：**
   ```
   云开发 > 数据库 > photographer_accounts > 添加记录
   ```

2. **填写 JSON（替换实际值）：**
   ```json
   {
     "openid": "步骤1复制的OpenID",
     "photographerId": "对应的摄影师_id",
     "name": "您的名字",
     "isActive": true
   }
   ```

3. **点击"确定"**

---

### 步骤4：重新登录并查看日志

1. **退出登录：**
   - 我的 > 退出登录

2. **重新登录：**
   - 点击"微信授权登录"

3. **查看控制台日志：**

开发者工具底部的"Console"标签应该显示：

```
✅ 登录成功
👤 用户信息: Object {_openid: "oXXXX-XX...", nickName: "...", ...}
👤 用户角色: Array(2) ["parent", "photographer"]  ← 这里必须包含 photographer
📋 云函数完整返回: Object {success: true, user: {...}, roles: Array(2)}
💾 已保存到本地存储:
  currentRole: photographer
  userRoles: Array(2) ["parent", "photographer"]
```

**关键检查：**
- ✅ `userRoles` 数组中包含 `"photographer"`
- ✅ `currentRole` 为 `"photographer"` 或 `"admin"`（如果您也是管理员）

---

### 步骤5：查看"我的"页面

点击"我的"Tab，查看控制台：

```
🔍 调试信息 - 我的页面加载:
  userInfo: Object {...}
  currentRole: "photographer"
  userRoles: Array(2) ["parent", "photographer"]
  isAdmin: false
  isPhotographer: true  ← 这里必须是 true
  isParent: true
```

**页面上应该显示：**

```
┌─────────────────────────────────────┐
│ 👤 您的昵称                         │
│                                     │
│ [ 👨‍👩‍👧‍👦 家长 ] [ 📷 摄影师 ]          │
│                                     │
│ OpenID: oXXXX-XX... [点击复制]      │
└─────────────────────────────────────┘

📷 摄影功能
┌─────────────────────────────────────┐
│ 📷 工作台                      →    │  ← 应该显示这个
└─────────────────────────────────────┘

👨‍👩‍👧‍👦 我的孩子
...
```

---

### 步骤6：进入摄影师工作台

1. **点击"工作台"**

2. **应该看到：**
   ```
   ┌─────────────────────────────────────┐
   │ 📷 摄影师工作台                      │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │     您的头像                         │
   │     您的名字                         │
   │     专业摄影师                       │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │  0        0        0        0       │
   │ 待接单   进行中   已完成   总订单    │
   └─────────────────────────────────────┘
   
   [ 全部 ] [ 待支付 ] [ 进行中 ] [ 已完成 ]
   
   暂无订单
   ```

---

## 🐛 常见问题速查

### 问题1：登录后 `userRoles` 中没有 `photographer`

**原因：**
- `photographer_accounts` 集合中没有您的 OpenID 记录
- 或者 `isActive` 为 `false`
- 或者 `openid` 字段值不匹配

**解决：**
- 重新执行步骤2和步骤3
- 确保 `openid` 字段值与您的 OpenID **完全一致**
- 确保 `isActive` 为 `true`

---

### 问题2：`isPhotographer` 为 false

**原因：**
- 本地存储中的 `userRoles` 没有更新
- 需要重新登录

**解决：**
1. 完全退出小程序
2. 清除缓存：开发者工具 > 清除缓存 > 全部清除
3. 重新编译
4. 重新登录

---

### 问题3：点击"工作台"报错或跳转失败

**原因：**
- 页面路径配置错误
- 或页面文件不存在

**解决：**
1. 检查 `app.json` 中是否包含：
   ```json
   "pages/photographer/tasks"
   ```

2. 检查文件是否存在：
   ```
   miniprogram/pages/photographer/
     ├── tasks.js
     ├── tasks.json
     ├── tasks.wxml
     └── tasks.wxss
   ```

3. 如果文件不存在，重新拉取代码并编译

---

### 问题4：控制台没有调试日志

**原因：**
- 代码没有热重载
- 或者版本不是最新的

**解决：**
1. 拉取最新代码：
   ```bash
   git pull
   ```

2. 重新编译小程序

3. 如果还是没有，检查代码是否正确更新

---

## ✅ 成功标志

当以下所有条件都满足时，说明配置成功：

- [x] 登录时控制台显示 `userRoles: ["parent", "photographer"]`
- [x] "我的"页面控制台显示 `isPhotographer: true`
- [x] "我的"页面显示"📷 摄影师"徽章
- [x] "我的"页面显示"摄影功能 > 工作台"入口
- [x] 点击"工作台"能成功进入摄影师工作台页面
- [x] 工作台页面显示您的摄影师信息和订单列表

---

## 📞 需要帮助？

如果仍然无法解决，请提供：

1. **步骤4的控制台日志截图**
2. **步骤5的控制台日志截图**
3. **您的 OpenID**
4. **`photographer_accounts` 集合截图**

这样可以快速定位问题！

