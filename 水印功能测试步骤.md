# 水印功能测试步骤

## 前置条件

1. 确保订单状态为 `pending_confirm`（待确认）
2. 订单中有摄影师上传的照片
3. 使用真机或开发者工具的真机预览模式测试（部分Canvas功能模拟器不支持）

## 测试步骤

### 方式一：完整流程测试

1. **创建订单**
   - 以家长身份登录
   - 选择活动并申请
   - 完成支付

2. **摄影师上传照片**
   - 以摄影师身份登录
   - 进入工作台
   - 找到对应订单
   - 上传照片并提交

3. **查看带水印的照片**
   - 切换回家长账号
   - 进入"我的订单"
   - 点击"待确认"的订单
   - 在时间线中看到"提交作品"部分
   - 点击照片预览

4. **预期结果**
   - 照片上应该有红色的水印文字："确认收图后水印自动消除"
   - 水印以45度角倾斜
   - 水印规律覆盖整个图片
   - 透明度60%，清晰可见但不影响查看

### 方式二：直接修改数据库测试

如果已有订单，可以直接在云开发控制台修改：

1. 打开云开发控制台
2. 进入数据库 -> `activity_orders` 集合
3. 找到一个订单记录
4. 修改以下字段：
   ```json
   {
     "status": "pending_confirm",
     "photos": ["cloud://xxx.png", "cloud://xxx.jpg"],
     "submittedAt": "2025-10-14T12:00:00.000Z"
   }
   ```
5. 保存后，在小程序中查看该订单
6. 点击时间线中的照片预览

## 调试方法

### 查看控制台日志

预览照片时，控制台会输出以下日志：

- `"加载中..."` - 开始添加水印
- `"水印添加成功: ..."` - 水印添加成功，显示临时文件路径
- `"添加水印失败: ..."` - 如果失败，会显示错误信息

### 常见问题

1. **看不到水印**
   - 检查订单状态是否为 `pending_confirm`
   - 检查控制台是否有错误日志
   - 确认Canvas元素是否正确渲染

2. **Canvas节点未找到**
   - 可能是页面还没完全加载
   - 尝试延迟点击预览按钮

3. **图片加载失败**
   - 检查云存储中的图片是否存在
   - 检查图片URL是否有效

## 水印效果示例

水印应该是这样的：
- 颜色：大红色 (#FF0000)
- 透明度：60%
- 角度：-45度
- 文字："确认收图后水印自动消除"
- 布局：网格状覆盖整个图片
- 间距：根据图片大小自动计算（约为最小边长的40%）

## 确认后的效果

用户点击"确认满意"后：
- 订单状态变为 `completed`
- 再次预览照片时，不会显示水印
- 用户可以保存清晰的原图

