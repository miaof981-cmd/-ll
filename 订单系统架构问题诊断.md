# 订单系统架构问题诊断报告

## 🐛 问题描述

**现象：**
- 摄影师在电脑模拟器提交作品成功
- 订单状态变为 `pending_confirm`（待用户确认）
- 但用户在手机预览时看不到这个订单

---

## 🔍 问题根源分析

### 关键发现：订单所有权问题

**用户订单列表查询逻辑（`orders.js` 第68-73行）：**
```javascript
const res = await db.collection('activity_orders')
  .where({
    _openid: userOpenId  // ❌ 问题：只查询用户自己创建的订单
  })
  .orderBy('createdAt', 'desc')
  .get();
```

**问题分析：**
1. 订单的 `_openid` 字段 = **创建订单的人的openid**
2. 如果订单是通过"注册孩子"页面创建的 → `_openid` = 家长的openid ✅
3. 如果订单是管理员/测试创建的 → `_openid` = 创建者的openid ❌
4. 用户查询时：`where({ _openid: 当前用户openid })` → 只能看到自己创建的订单

**这就是为什么用户看不到订单的原因！**

---

## 📊 完整订单流程梳理

### 流程1：正常用户下单（activity/apply）

```
用户A登录
  ↓
填写申请表单
  ↓
调用云函数 createActivityOrder
  ↓
订单创建（_openid = 用户A的openid）
  ↓
用户A在"我的订单"中能看到 ✅
```

### 流程2：注册孩子下单（apply/payment）

```
用户B登录
  ↓
注册孩子页面填写信息
  ↓
客户端直接创建订单（payment.js 第151行）
  ↓
订单创建（_openid = 用户B的openid）
  ↓
用户B在"我的订单"中能看到 ✅
```

### 流程3：测试/管理员创建订单

```
测试工具/管理员
  ↓
创建测试订单
  ↓
订单创建（_openid = 测试者/管理员的openid）❌
  ↓
实际用户查不到这个订单 ❌
```

---

## 🏗️ 架构设计问题总结

### 问题1：订单所有权混乱

**当前设计：**
- `_openid` = 创建订单的人（可能是用户、管理员、测试者）
- 查询逻辑：`where({ _openid: 当前用户openid })`

**问题：**
- ❌ 管理员创建的订单，用户看不到
- ❌ 测试订单，用户看不到
- ❌ 没有明确的"订单归属"字段

**正确设计应该是：**
```javascript
{
  _openid: "创建者openid",           // 自动字段，保留
  userId: "订单所属用户openid",       // 新增：订单归属用户
  studentId: "学生ID",                // 关联学生
  createdBy: "创建者类型",            // user/admin/photographer
  // ...
}
```

---

### 问题2：支付后订单状态不统一

**从代码看到的状态设置：**

#### createActivityOrder 云函数（L96）
```javascript
status: 'pending_payment'  // 待支付
```

#### payment.js（L143）
```javascript
status: 'pending_payment',  // 待支付
paymentStatus: 'unpaid'
```

#### 支付成功后应该变为什么？
- ❓ `in_progress`？
- ❓ `pending_upload`？
- ❓ 直接保持 `pending_payment` 直到摄影师提交？

**问题：支付回调逻辑不清楚**

---

### 问题3：跨用户写操作权限

**已修复：**
- ✅ 摄影师提交作品 → 使用云函数 `photographerSubmitWork`
- ✅ 管理员审核 → 使用云函数 `adminApproveOrder`

**未修复：**
- ❌ 用户确认作品 → 直接客户端操作
- ❌ 用户取消订单 → 直接客户端操作
- ❌ 支付回调更新订单 → 需确认

---

## ✅ 解决方案

### 方案1：修改订单数据结构（推荐）

**添加 `userId` 字段明确订单归属：**

```javascript
// 创建订单时
{
  _openid: wxContext.OPENID,      // 创建者（系统自动）
  userId: event.userId,            // 订单所属用户（明确指定）
  studentId: event.studentId,      // 关联学生
  // ...
}

// 查询订单时
db.collection('activity_orders')
  .where({ userId: currentUserOpenId })  // 按userId查询
  .get();
```

---

### 方案2：兼容现有数据（临时方案）

**修改查询逻辑，多字段匹配：**

```javascript
// 查询当前用户的订单
const res = await db.collection('activity_orders')
  .where(db.command.or([
    { _openid: userOpenId },           // 用户自己创建的
    { parentPhone: userPhone },         // 通过手机号匹配
    { studentId: userStudentId }        // 通过学号匹配
  ]))
  .orderBy('createdAt', 'desc')
  .get();
```

**问题：**
- ❌ 需要额外字段（手机号、学号）
- ❌ 性能较差
- ❌ 不够精确

---

### 方案3：数据迁移（最彻底）

**步骤：**
1. 为所有现有订单添加 `userId` 字段
2. `userId` = `_openid`（假设都是用户自己创建的）
3. 修改所有创建订单的代码，明确指定 `userId`
4. 修改查询逻辑为 `where({ userId })`

---

## 🎯 推荐修复方案（分步骤）

### 第1步：立即修复 - 添加userId字段

**修改 `createActivityOrder` 云函数：**
```javascript
const orderRes = await db.collection('activity_orders').add({
  data: {
    _openid: wxContext.OPENID,        // 创建者
    userId: wxContext.OPENID,          // 默认订单归属创建者
    // 如果是管理员代创建，传入真实用户的openid
    // userId: event.targetUserId || wxContext.OPENID,
    // ...
  }
});
```

**修改 `payment.js`：**
```javascript
const orderData = {
  // ...
  _openid: userOpenId,     // 保留（系统字段）
  userId: userOpenId,      // 新增：明确订单归属
  // ...
};
```

---

### 第2步：修改查询逻辑

**修改 `orders.js`：**
```javascript
// 查询订单
const res = await db.collection('activity_orders')
  .where({
    userId: userOpenId  // ✅ 改为查询userId
  })
  .orderBy('createdAt', 'desc')
  .get();
```

---

### 第3步：数据迁移脚本

创建测试工具"测试23: 迁移订单userId"：

```javascript
async migrateOrderUserId() {
  const db = wx.cloud.database();
  
  // 查询所有没有userId的订单
  const orders = await db.collection('activity_orders')
    .where({
      userId: db.command.exists(false)
    })
    .get();
  
  // 批量更新：userId = _openid
  for (const order of orders.data) {
    await db.collection('activity_orders')
      .doc(order._id)
      .update({
        data: {
          userId: order._openid  // 设置userId为当前的_openid
        }
      });
  }
  
  console.log(`✅ 迁移完成，共处理 ${orders.data.length} 个订单`);
}
```

---

## 🔄 完整订单状态流转（应该是）

### 正确的状态流转：

```
1. pending_payment（待支付）
   ↓ 用户支付成功
   
2. in_progress（进行中）
   ↓ 摄影师上传作品
   
3. pending_review（待管理员审核）
   ↓ 管理员审核通过
   
4. pending_confirm（待用户确认）
   ↓ 用户确认收货
   
5. completed（已完成）
```

### 当前存在的问题：

1. **支付后状态？**
   - createActivityOrder: `pending_payment`
   - 支付成功后应该变成什么？代码中没找到

2. **pending_upload vs in_progress？**
   - order-status.js 定义了两个状态
   - 但实际使用中似乎只用 `in_progress`

3. **waiting_shoot 是什么？**
   - 定义了但不应该存在（用户反馈过）

---

## 📝 需要立即检查的代码

### 1. 支付回调在哪里？

```bash
grep -r "paymentStatus.*paid" cloudfunctions/
grep -r "payCallback" cloudfunctions/
```

### 2. 订单创建的所有入口

- ✅ `cloudfunctions/createActivityOrder/index.js`
- ✅ `miniprogram/pages/apply/payment.js`
- ❓ 还有其他地方吗？

### 3. 订单查询的所有地方

- ✅ `miniprogram/pages/user/orders/orders.js` (用户订单列表)
- ✅ `miniprogram/pages/user/orders/detail.js` (用户订单详情)
- ✅ `miniprogram/pages/admin/orders/` (管理员订单)
- ✅ `miniprogram/pages/photographer/` (摄影师订单)

---

## 🚨 立即行动项

### 优先级1（紧急）

1. **添加 `userId` 字段**
   - 修改 `createActivityOrder` 云函数
   - 修改 `payment.js`
   - 创建数据迁移工具

2. **修改查询逻辑**
   - 所有订单查询改为 `where({ userId })`

3. **测试验证**
   - 创建新订单
   - 检查 `userId` 字段是否正确
   - 用户能否看到订单

### 优先级2（重要）

4. **梳理支付回调**
   - 确认 `payCallback` 云函数逻辑
   - 确认支付成功后状态变化

5. **统一状态定义**
   - 删除不用的状态（`waiting_shoot`, `pending_upload`）
   - 明确每个状态的含义

### 优先级3（优化）

6. **完善云函数**
   - 用户确认作品 → `userConfirmWork`
   - 用户取消订单 → `cancelOrder`

---

## 📊 数据库表设计建议

### activity_orders 表应该有的字段：

```javascript
{
  // 系统字段
  _id: "订单ID",
  _openid: "创建者openid（系统自动）",
  
  // 订单归属（新增）
  userId: "订单所属用户openid",      // ⭐ 关键字段
  createdBy: "user|admin|system",    // 创建者类型
  
  // 订单基本信息
  orderNo: "订单号",
  activityId: "活动ID",
  studentId: "学生ID",
  photographerId: "摄影师ID",
  
  // 订单状态
  status: "订单状态",
  paymentStatus: "支付状态",
  
  // 价格信息
  price: 订单价格,
  lockedPrice: 锁定价格,
  
  // 作品信息
  photos: ["照片URL"],
  photographerNote: "摄影师备注",
  
  // 时间戳
  createdAt: "创建时间",
  paidAt: "支付时间",
  submittedAt: "提交时间",
  reviewedAt: "审核时间",
  confirmedAt: "确认时间",
  completedAt: "完成时间"
}
```

---

## 🎯 结论

**核心问题：**
1. ❌ 订单归属不明确（_openid != 订单所属用户）
2. ❌ 查询逻辑错误（where({ _openid })）
3. ❌ 缺少明确的 `userId` 字段

**解决方案：**
1. ✅ 添加 `userId` 字段明确订单归属
2. ✅ 修改查询逻辑为 `where({ userId })`
3. ✅ 迁移现有数据

**预期效果：**
- ✅ 用户能看到所有属于自己的订单
- ✅ 不受创建者影响
- ✅ 支持管理员代创建订单

---

需要我立即实现这些修复吗？

