# è®¢å•ç³»ç»Ÿæ¶æ„é—®é¢˜è¯Šæ–­æŠ¥å‘Š

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- æ‘„å½±å¸ˆåœ¨ç”µè„‘æ¨¡æ‹Ÿå™¨æäº¤ä½œå“æˆåŠŸ
- è®¢å•çŠ¶æ€å˜ä¸º `pending_confirm`ï¼ˆå¾…ç”¨æˆ·ç¡®è®¤ï¼‰
- ä½†ç”¨æˆ·åœ¨æ‰‹æœºé¢„è§ˆæ—¶çœ‹ä¸åˆ°è¿™ä¸ªè®¢å•

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### å…³é”®å‘ç°ï¼šè®¢å•æ‰€æœ‰æƒé—®é¢˜

**ç”¨æˆ·è®¢å•åˆ—è¡¨æŸ¥è¯¢é€»è¾‘ï¼ˆ`orders.js` ç¬¬68-73è¡Œï¼‰ï¼š**
```javascript
const res = await db.collection('activity_orders')
  .where({
    _openid: userOpenId  // âŒ é—®é¢˜ï¼šåªæŸ¥è¯¢ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„è®¢å•
  })
  .orderBy('createdAt', 'desc')
  .get();
```

**é—®é¢˜åˆ†æï¼š**
1. è®¢å•çš„ `_openid` å­—æ®µ = **åˆ›å»ºè®¢å•çš„äººçš„openid**
2. å¦‚æœè®¢å•æ˜¯é€šè¿‡"æ³¨å†Œå­©å­"é¡µé¢åˆ›å»ºçš„ â†’ `_openid` = å®¶é•¿çš„openid âœ…
3. å¦‚æœè®¢å•æ˜¯ç®¡ç†å‘˜/æµ‹è¯•åˆ›å»ºçš„ â†’ `_openid` = åˆ›å»ºè€…çš„openid âŒ
4. ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼š`where({ _openid: å½“å‰ç”¨æˆ·openid })` â†’ åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„è®¢å•

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç”¨æˆ·çœ‹ä¸åˆ°è®¢å•çš„åŸå› ï¼**

---

## ğŸ“Š å®Œæ•´è®¢å•æµç¨‹æ¢³ç†

### æµç¨‹1ï¼šæ­£å¸¸ç”¨æˆ·ä¸‹å•ï¼ˆactivity/applyï¼‰

```
ç”¨æˆ·Aç™»å½•
  â†“
å¡«å†™ç”³è¯·è¡¨å•
  â†“
è°ƒç”¨äº‘å‡½æ•° createActivityOrder
  â†“
è®¢å•åˆ›å»ºï¼ˆ_openid = ç”¨æˆ·Açš„openidï¼‰
  â†“
ç”¨æˆ·Aåœ¨"æˆ‘çš„è®¢å•"ä¸­èƒ½çœ‹åˆ° âœ…
```

### æµç¨‹2ï¼šæ³¨å†Œå­©å­ä¸‹å•ï¼ˆapply/paymentï¼‰

```
ç”¨æˆ·Bç™»å½•
  â†“
æ³¨å†Œå­©å­é¡µé¢å¡«å†™ä¿¡æ¯
  â†“
å®¢æˆ·ç«¯ç›´æ¥åˆ›å»ºè®¢å•ï¼ˆpayment.js ç¬¬151è¡Œï¼‰
  â†“
è®¢å•åˆ›å»ºï¼ˆ_openid = ç”¨æˆ·Bçš„openidï¼‰
  â†“
ç”¨æˆ·Båœ¨"æˆ‘çš„è®¢å•"ä¸­èƒ½çœ‹åˆ° âœ…
```

### æµç¨‹3ï¼šæµ‹è¯•/ç®¡ç†å‘˜åˆ›å»ºè®¢å•

```
æµ‹è¯•å·¥å…·/ç®¡ç†å‘˜
  â†“
åˆ›å»ºæµ‹è¯•è®¢å•
  â†“
è®¢å•åˆ›å»ºï¼ˆ_openid = æµ‹è¯•è€…/ç®¡ç†å‘˜çš„openidï¼‰âŒ
  â†“
å®é™…ç”¨æˆ·æŸ¥ä¸åˆ°è¿™ä¸ªè®¢å• âŒ
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡é—®é¢˜æ€»ç»“

### é—®é¢˜1ï¼šè®¢å•æ‰€æœ‰æƒæ··ä¹±

**å½“å‰è®¾è®¡ï¼š**
- `_openid` = åˆ›å»ºè®¢å•çš„äººï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·ã€ç®¡ç†å‘˜ã€æµ‹è¯•è€…ï¼‰
- æŸ¥è¯¢é€»è¾‘ï¼š`where({ _openid: å½“å‰ç”¨æˆ·openid })`

**é—®é¢˜ï¼š**
- âŒ ç®¡ç†å‘˜åˆ›å»ºçš„è®¢å•ï¼Œç”¨æˆ·çœ‹ä¸åˆ°
- âŒ æµ‹è¯•è®¢å•ï¼Œç”¨æˆ·çœ‹ä¸åˆ°
- âŒ æ²¡æœ‰æ˜ç¡®çš„"è®¢å•å½’å±"å­—æ®µ

**æ­£ç¡®è®¾è®¡åº”è¯¥æ˜¯ï¼š**
```javascript
{
  _openid: "åˆ›å»ºè€…openid",           // è‡ªåŠ¨å­—æ®µï¼Œä¿ç•™
  userId: "è®¢å•æ‰€å±ç”¨æˆ·openid",       // æ–°å¢ï¼šè®¢å•å½’å±ç”¨æˆ·
  studentId: "å­¦ç”ŸID",                // å…³è”å­¦ç”Ÿ
  createdBy: "åˆ›å»ºè€…ç±»å‹",            // user/admin/photographer
  // ...
}
```

---

### é—®é¢˜2ï¼šæ”¯ä»˜åè®¢å•çŠ¶æ€ä¸ç»Ÿä¸€

**ä»ä»£ç çœ‹åˆ°çš„çŠ¶æ€è®¾ç½®ï¼š**

#### createActivityOrder äº‘å‡½æ•°ï¼ˆL96ï¼‰
```javascript
status: 'pending_payment'  // å¾…æ”¯ä»˜
```

#### payment.jsï¼ˆL143ï¼‰
```javascript
status: 'pending_payment',  // å¾…æ”¯ä»˜
paymentStatus: 'unpaid'
```

#### æ”¯ä»˜æˆåŠŸååº”è¯¥å˜ä¸ºä»€ä¹ˆï¼Ÿ
- â“ `in_progress`ï¼Ÿ
- â“ `pending_upload`ï¼Ÿ
- â“ ç›´æ¥ä¿æŒ `pending_payment` ç›´åˆ°æ‘„å½±å¸ˆæäº¤ï¼Ÿ

**é—®é¢˜ï¼šæ”¯ä»˜å›è°ƒé€»è¾‘ä¸æ¸…æ¥š**

---

### é—®é¢˜3ï¼šè·¨ç”¨æˆ·å†™æ“ä½œæƒé™

**å·²ä¿®å¤ï¼š**
- âœ… æ‘„å½±å¸ˆæäº¤ä½œå“ â†’ ä½¿ç”¨äº‘å‡½æ•° `photographerSubmitWork`
- âœ… ç®¡ç†å‘˜å®¡æ ¸ â†’ ä½¿ç”¨äº‘å‡½æ•° `adminApproveOrder`

**æœªä¿®å¤ï¼š**
- âŒ ç”¨æˆ·ç¡®è®¤ä½œå“ â†’ ç›´æ¥å®¢æˆ·ç«¯æ“ä½œ
- âŒ ç”¨æˆ·å–æ¶ˆè®¢å• â†’ ç›´æ¥å®¢æˆ·ç«¯æ“ä½œ
- âŒ æ”¯ä»˜å›è°ƒæ›´æ–°è®¢å• â†’ éœ€ç¡®è®¤

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ”¹è®¢å•æ•°æ®ç»“æ„ï¼ˆæ¨èï¼‰

**æ·»åŠ  `userId` å­—æ®µæ˜ç¡®è®¢å•å½’å±ï¼š**

```javascript
// åˆ›å»ºè®¢å•æ—¶
{
  _openid: wxContext.OPENID,      // åˆ›å»ºè€…ï¼ˆç³»ç»Ÿè‡ªåŠ¨ï¼‰
  userId: event.userId,            // è®¢å•æ‰€å±ç”¨æˆ·ï¼ˆæ˜ç¡®æŒ‡å®šï¼‰
  studentId: event.studentId,      // å…³è”å­¦ç”Ÿ
  // ...
}

// æŸ¥è¯¢è®¢å•æ—¶
db.collection('activity_orders')
  .where({ userId: currentUserOpenId })  // æŒ‰userIdæŸ¥è¯¢
  .get();
```

---

### æ–¹æ¡ˆ2ï¼šå…¼å®¹ç°æœ‰æ•°æ®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ï¼Œå¤šå­—æ®µåŒ¹é…ï¼š**

```javascript
// æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„è®¢å•
const res = await db.collection('activity_orders')
  .where(db.command.or([
    { _openid: userOpenId },           // ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„
    { parentPhone: userPhone },         // é€šè¿‡æ‰‹æœºå·åŒ¹é…
    { studentId: userStudentId }        // é€šè¿‡å­¦å·åŒ¹é…
  ]))
  .orderBy('createdAt', 'desc')
  .get();
```

**é—®é¢˜ï¼š**
- âŒ éœ€è¦é¢å¤–å­—æ®µï¼ˆæ‰‹æœºå·ã€å­¦å·ï¼‰
- âŒ æ€§èƒ½è¾ƒå·®
- âŒ ä¸å¤Ÿç²¾ç¡®

---

### æ–¹æ¡ˆ3ï¼šæ•°æ®è¿ç§»ï¼ˆæœ€å½»åº•ï¼‰

**æ­¥éª¤ï¼š**
1. ä¸ºæ‰€æœ‰ç°æœ‰è®¢å•æ·»åŠ  `userId` å­—æ®µ
2. `userId` = `_openid`ï¼ˆå‡è®¾éƒ½æ˜¯ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„ï¼‰
3. ä¿®æ”¹æ‰€æœ‰åˆ›å»ºè®¢å•çš„ä»£ç ï¼Œæ˜ç¡®æŒ‡å®š `userId`
4. ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ä¸º `where({ userId })`

---

## ğŸ¯ æ¨èä¿®å¤æ–¹æ¡ˆï¼ˆåˆ†æ­¥éª¤ï¼‰

### ç¬¬1æ­¥ï¼šç«‹å³ä¿®å¤ - æ·»åŠ userIdå­—æ®µ

**ä¿®æ”¹ `createActivityOrder` äº‘å‡½æ•°ï¼š**
```javascript
const orderRes = await db.collection('activity_orders').add({
  data: {
    _openid: wxContext.OPENID,        // åˆ›å»ºè€…
    userId: wxContext.OPENID,          // é»˜è®¤è®¢å•å½’å±åˆ›å»ºè€…
    // å¦‚æœæ˜¯ç®¡ç†å‘˜ä»£åˆ›å»ºï¼Œä¼ å…¥çœŸå®ç”¨æˆ·çš„openid
    // userId: event.targetUserId || wxContext.OPENID,
    // ...
  }
});
```

**ä¿®æ”¹ `payment.js`ï¼š**
```javascript
const orderData = {
  // ...
  _openid: userOpenId,     // ä¿ç•™ï¼ˆç³»ç»Ÿå­—æ®µï¼‰
  userId: userOpenId,      // æ–°å¢ï¼šæ˜ç¡®è®¢å•å½’å±
  // ...
};
```

---

### ç¬¬2æ­¥ï¼šä¿®æ”¹æŸ¥è¯¢é€»è¾‘

**ä¿®æ”¹ `orders.js`ï¼š**
```javascript
// æŸ¥è¯¢è®¢å•
const res = await db.collection('activity_orders')
  .where({
    userId: userOpenId  // âœ… æ”¹ä¸ºæŸ¥è¯¢userId
  })
  .orderBy('createdAt', 'desc')
  .get();
```

---

### ç¬¬3æ­¥ï¼šæ•°æ®è¿ç§»è„šæœ¬

åˆ›å»ºæµ‹è¯•å·¥å…·"æµ‹è¯•23: è¿ç§»è®¢å•userId"ï¼š

```javascript
async migrateOrderUserId() {
  const db = wx.cloud.database();
  
  // æŸ¥è¯¢æ‰€æœ‰æ²¡æœ‰userIdçš„è®¢å•
  const orders = await db.collection('activity_orders')
    .where({
      userId: db.command.exists(false)
    })
    .get();
  
  // æ‰¹é‡æ›´æ–°ï¼šuserId = _openid
  for (const order of orders.data) {
    await db.collection('activity_orders')
      .doc(order._id)
      .update({
        data: {
          userId: order._openid  // è®¾ç½®userIdä¸ºå½“å‰çš„_openid
        }
      });
  }
  
  console.log(`âœ… è¿ç§»å®Œæˆï¼Œå…±å¤„ç† ${orders.data.length} ä¸ªè®¢å•`);
}
```

---

## ğŸ”„ å®Œæ•´è®¢å•çŠ¶æ€æµè½¬ï¼ˆåº”è¯¥æ˜¯ï¼‰

### æ­£ç¡®çš„çŠ¶æ€æµè½¬ï¼š

```
1. pending_paymentï¼ˆå¾…æ”¯ä»˜ï¼‰
   â†“ ç”¨æˆ·æ”¯ä»˜æˆåŠŸ
   
2. in_progressï¼ˆè¿›è¡Œä¸­ï¼‰
   â†“ æ‘„å½±å¸ˆä¸Šä¼ ä½œå“
   
3. pending_reviewï¼ˆå¾…ç®¡ç†å‘˜å®¡æ ¸ï¼‰
   â†“ ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   
4. pending_confirmï¼ˆå¾…ç”¨æˆ·ç¡®è®¤ï¼‰
   â†“ ç”¨æˆ·ç¡®è®¤æ”¶è´§
   
5. completedï¼ˆå·²å®Œæˆï¼‰
```

### å½“å‰å­˜åœ¨çš„é—®é¢˜ï¼š

1. **æ”¯ä»˜åçŠ¶æ€ï¼Ÿ**
   - createActivityOrder: `pending_payment`
   - æ”¯ä»˜æˆåŠŸååº”è¯¥å˜æˆä»€ä¹ˆï¼Ÿä»£ç ä¸­æ²¡æ‰¾åˆ°

2. **pending_upload vs in_progressï¼Ÿ**
   - order-status.js å®šä¹‰äº†ä¸¤ä¸ªçŠ¶æ€
   - ä½†å®é™…ä½¿ç”¨ä¸­ä¼¼ä¹åªç”¨ `in_progress`

3. **waiting_shoot æ˜¯ä»€ä¹ˆï¼Ÿ**
   - å®šä¹‰äº†ä½†ä¸åº”è¯¥å­˜åœ¨ï¼ˆç”¨æˆ·åé¦ˆè¿‡ï¼‰

---

## ğŸ“ éœ€è¦ç«‹å³æ£€æŸ¥çš„ä»£ç 

### 1. æ”¯ä»˜å›è°ƒåœ¨å“ªé‡Œï¼Ÿ

```bash
grep -r "paymentStatus.*paid" cloudfunctions/
grep -r "payCallback" cloudfunctions/
```

### 2. è®¢å•åˆ›å»ºçš„æ‰€æœ‰å…¥å£

- âœ… `cloudfunctions/createActivityOrder/index.js`
- âœ… `miniprogram/pages/apply/payment.js`
- â“ è¿˜æœ‰å…¶ä»–åœ°æ–¹å—ï¼Ÿ

### 3. è®¢å•æŸ¥è¯¢çš„æ‰€æœ‰åœ°æ–¹

- âœ… `miniprogram/pages/user/orders/orders.js` (ç”¨æˆ·è®¢å•åˆ—è¡¨)
- âœ… `miniprogram/pages/user/orders/detail.js` (ç”¨æˆ·è®¢å•è¯¦æƒ…)
- âœ… `miniprogram/pages/admin/orders/` (ç®¡ç†å‘˜è®¢å•)
- âœ… `miniprogram/pages/photographer/` (æ‘„å½±å¸ˆè®¢å•)

---

## ğŸš¨ ç«‹å³è¡ŒåŠ¨é¡¹

### ä¼˜å…ˆçº§1ï¼ˆç´§æ€¥ï¼‰

1. **æ·»åŠ  `userId` å­—æ®µ**
   - ä¿®æ”¹ `createActivityOrder` äº‘å‡½æ•°
   - ä¿®æ”¹ `payment.js`
   - åˆ›å»ºæ•°æ®è¿ç§»å·¥å…·

2. **ä¿®æ”¹æŸ¥è¯¢é€»è¾‘**
   - æ‰€æœ‰è®¢å•æŸ¥è¯¢æ”¹ä¸º `where({ userId })`

3. **æµ‹è¯•éªŒè¯**
   - åˆ›å»ºæ–°è®¢å•
   - æ£€æŸ¥ `userId` å­—æ®µæ˜¯å¦æ­£ç¡®
   - ç”¨æˆ·èƒ½å¦çœ‹åˆ°è®¢å•

### ä¼˜å…ˆçº§2ï¼ˆé‡è¦ï¼‰

4. **æ¢³ç†æ”¯ä»˜å›è°ƒ**
   - ç¡®è®¤ `payCallback` äº‘å‡½æ•°é€»è¾‘
   - ç¡®è®¤æ”¯ä»˜æˆåŠŸåçŠ¶æ€å˜åŒ–

5. **ç»Ÿä¸€çŠ¶æ€å®šä¹‰**
   - åˆ é™¤ä¸ç”¨çš„çŠ¶æ€ï¼ˆ`waiting_shoot`, `pending_upload`ï¼‰
   - æ˜ç¡®æ¯ä¸ªçŠ¶æ€çš„å«ä¹‰

### ä¼˜å…ˆçº§3ï¼ˆä¼˜åŒ–ï¼‰

6. **å®Œå–„äº‘å‡½æ•°**
   - ç”¨æˆ·ç¡®è®¤ä½œå“ â†’ `userConfirmWork`
   - ç”¨æˆ·å–æ¶ˆè®¢å• â†’ `cancelOrder`

---

## ğŸ“Š æ•°æ®åº“è¡¨è®¾è®¡å»ºè®®

### activity_orders è¡¨åº”è¯¥æœ‰çš„å­—æ®µï¼š

```javascript
{
  // ç³»ç»Ÿå­—æ®µ
  _id: "è®¢å•ID",
  _openid: "åˆ›å»ºè€…openidï¼ˆç³»ç»Ÿè‡ªåŠ¨ï¼‰",
  
  // è®¢å•å½’å±ï¼ˆæ–°å¢ï¼‰
  userId: "è®¢å•æ‰€å±ç”¨æˆ·openid",      // â­ å…³é”®å­—æ®µ
  createdBy: "user|admin|system",    // åˆ›å»ºè€…ç±»å‹
  
  // è®¢å•åŸºæœ¬ä¿¡æ¯
  orderNo: "è®¢å•å·",
  activityId: "æ´»åŠ¨ID",
  studentId: "å­¦ç”ŸID",
  photographerId: "æ‘„å½±å¸ˆID",
  
  // è®¢å•çŠ¶æ€
  status: "è®¢å•çŠ¶æ€",
  paymentStatus: "æ”¯ä»˜çŠ¶æ€",
  
  // ä»·æ ¼ä¿¡æ¯
  price: è®¢å•ä»·æ ¼,
  lockedPrice: é”å®šä»·æ ¼,
  
  // ä½œå“ä¿¡æ¯
  photos: ["ç…§ç‰‡URL"],
  photographerNote: "æ‘„å½±å¸ˆå¤‡æ³¨",
  
  // æ—¶é—´æˆ³
  createdAt: "åˆ›å»ºæ—¶é—´",
  paidAt: "æ”¯ä»˜æ—¶é—´",
  submittedAt: "æäº¤æ—¶é—´",
  reviewedAt: "å®¡æ ¸æ—¶é—´",
  confirmedAt: "ç¡®è®¤æ—¶é—´",
  completedAt: "å®Œæˆæ—¶é—´"
}
```

---

## ğŸ¯ ç»“è®º

**æ ¸å¿ƒé—®é¢˜ï¼š**
1. âŒ è®¢å•å½’å±ä¸æ˜ç¡®ï¼ˆ_openid != è®¢å•æ‰€å±ç”¨æˆ·ï¼‰
2. âŒ æŸ¥è¯¢é€»è¾‘é”™è¯¯ï¼ˆwhere({ _openid })ï¼‰
3. âŒ ç¼ºå°‘æ˜ç¡®çš„ `userId` å­—æ®µ

**è§£å†³æ–¹æ¡ˆï¼š**
1. âœ… æ·»åŠ  `userId` å­—æ®µæ˜ç¡®è®¢å•å½’å±
2. âœ… ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ä¸º `where({ userId })`
3. âœ… è¿ç§»ç°æœ‰æ•°æ®

**é¢„æœŸæ•ˆæœï¼š**
- âœ… ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰å±äºè‡ªå·±çš„è®¢å•
- âœ… ä¸å—åˆ›å»ºè€…å½±å“
- âœ… æ”¯æŒç®¡ç†å‘˜ä»£åˆ›å»ºè®¢å•

---

éœ€è¦æˆ‘ç«‹å³å®ç°è¿™äº›ä¿®å¤å—ï¼Ÿ

