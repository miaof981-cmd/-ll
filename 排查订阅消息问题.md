# 排查订阅消息问题

## 检查清单

### ✅ 第1项：云函数是否上传？

1. 打开微信开发者工具
2. 点击顶部 **"云开发"** 按钮
3. 左侧菜单点击 **"云函数"**
4. 查看列表中是否有 `sendSubscribeMessage`

**如果没有：**
- 右键 `cloudfunctions/sendSubscribeMessage` 文件夹
- 选择：**"上传并部署：云端安装依赖"**

---

### ✅ 第2项：查看控制台日志

在开发者工具底部的 **Console** 标签中查看：

**正常的日志应该是：**
```
用户信息: {_openid: "xxx", nickName: "xxx", ...}
用户openid: o5_xU4wY1pz-JxOi8XdA_O0bBHw
📱 步骤1：请求订阅消息授权
授权结果: {xxx: "accept"}
📝 步骤2：创建测试订单
✅ 测试订单创建成功: order_id_xxx
📨 步骤3：发送订阅消息
✅ 订阅消息发送完成
```

**如果看到错误：**
- 红色的错误信息
- 请把完整的错误信息告诉我

---

### ✅ 第3项：授权窗口

**测试时应该弹出授权窗口：**
```
次元学校想给你发送通知

□ 订单支付成功通知

[总是允许] [允许] [拒绝]
```

**问题：**
1. 授权窗口弹出了吗？
2. 你点击了"允许"还是"拒绝"？
3. 如果没弹出，可能是模板ID配置错误

---

### ✅ 第4项：检查云函数日志

1. 点击开发者工具顶部 **"云开发"**
2. 左侧菜单 → **"云函数"**
3. 找到 `sendSubscribeMessage`
4. 点击 **"日志"** 标签
5. 查看最新的调用记录

**正常的日志：**
```
📨 发送订阅消息: {
  touser: "o5_xU4wY1pz-JxOi8XdA_O0bBHw",
  template_id: "RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg",
  page: "/pages/user/orders/detail?id=xxx"
}
✅ 订阅消息发送成功
```

**常见错误：**

1. **"invalid template_id"**
   - 模板ID错误
   - 检查 `notification.js` 中的模板ID

2. **"user refuse to accept the msg"**
   - 用户拒绝了授权
   - 重新测试并点击"允许"

3. **"openapi is not authorized"**
   - 云函数没有订阅消息权限
   - 需要配置权限

4. **"template_id not exist"**
   - 模板不存在或已被删除
   - 检查微信公众平台的模板列表

---

### ✅ 第5项：检查模板ID

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 左侧菜单：功能 → 订阅消息
3. 点击"我的模板"
4. 找到你创建的模板
5. 查看模板ID是否是：`RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg`

---

### ✅ 第6项：手机测试

**重要：开发者工具可能看不到消息通知！**

**必须用手机测试：**
1. 点击开发者工具右上角 **"预览"**
2. 用手机微信扫码
3. 进入小程序
4. 通过控制台或"我的"页面进入测试页面
5. 点击"测试3"
6. 授权后，**立即打开微信**
7. 查看"服务通知"

---

## 🐛 常见问题

### 问题1：没有弹出授权窗口

**原因：**
- 模板ID配置错误
- 云函数没上传

**解决：**
1. 检查 `miniprogram/utils/notification.js` 第10行
2. 确认模板ID正确
3. 重新编译小程序

---

### 问题2：授权成功但没收到消息

**原因：**
- 在开发者工具测试（工具不显示消息）
- 云函数发送失败

**解决：**
1. **必须用手机扫码测试**
2. 查看云函数日志是否有错误

---

### 问题3：云函数报错 "openapi is not authorized"

**原因：**
- 云函数没有订阅消息权限

**解决：**
检查 `cloudfunctions/sendSubscribeMessage/config.json`：
```json
{
  "permissions": {
    "openapi": [
      "subscribeMessage.send"
    ]
  }
}
```

---

### 问题4：模板数据格式错误

**检查发送的数据格式：**

在 `notification.js` 的 `sendOrderCreatedNotification` 函数中：
```javascript
data: {
  thing1: { value: '证件照拍摄' },           // 不超过20个字符
  character_string2: { value: params.orderNo },  // 订单号
  name3: { value: params.studentName },          // 学生姓名
  amount4: { value: `¥${params.amount}` },       // 金额格式
  thing5: { value: '订单已创建，等待摄影师处理' } // 不超过20个字符
}
```

**注意：**
- `thing` 类型：最多20个字符
- `amount` 类型：必须是 `¥50.00` 格式
- `date` 类型：必须是 `2025-01-18 10:30:00` 格式

---

## 📝 请回答以下问题

帮我排查问题，请告诉我：

1. **云函数上传了吗？**
   - [ ] 是
   - [ ] 否

2. **授权窗口弹出了吗？**
   - [ ] 是，点击了"允许"
   - [ ] 是，点击了"拒绝"
   - [ ] 没有弹出

3. **控制台有错误吗？**
   - [ ] 没有错误
   - [ ] 有错误（请复制错误信息）

4. **云函数日志有什么？**
   - [ ] 还没查看
   - [ ] 有成功日志
   - [ ] 有错误日志（请复制错误信息）

5. **是在手机上测试的吗？**
   - [ ] 是，手机扫码测试
   - [ ] 否，在开发者工具测试

---

**把这些信息告诉我，我帮你精准定位问题！**



