# 💳 微信支付接入完整指南

## 📋 目录

1. [前置准备](#前置准备)
2. [开通微信支付](#开通微信支付)
3. [配置小程序](#配置小程序)
4. [创建云函数](#创建云函数)
5. [修改前端代码](#修改前端代码)
6. [测试流程](#测试流程)
7. [常见问题](#常见问题)

---

## 1. 前置准备

### 1.1 需要的资料

- ✅ 小程序 AppID
- ✅ 小程序 AppSecret
- ✅ 微信商户号（需要申请）
- ✅ 商户 API 密钥
- ✅ 商户证书（用于退款等操作）
- ✅ 营业执照（企业/个体工商户）
- ✅ 对公账户或法人银行卡

### 1.2 费率说明

**微信支付费率：**
- 标准费率：0.6%（每笔交易）
- 例如：用户支付 22 元，到账约 21.87 元

**提现费率：**
- 免费（直接到对公账户或法人银行卡）

---

## 2. 开通微信支付

### 2.1 申请微信支付商户号

**步骤：**

1. **登录微信公众平台**
   - 网址：https://mp.weixin.qq.com
   - 使用小程序管理员微信扫码登录

2. **进入微信支付申请页面**
   - 左侧菜单：微信支付 → 开通
   - 或直接访问：https://pay.weixin.qq.com

3. **填写商户信息**
   ```
   主体类型：
   - 企业：需要营业执照、对公账户
   - 个体工商户：需要营业执照、法人银行卡
   - 个人：不支持（需要升级为企业或个体）
   
   经营类目：
   - 教育培训 → 学历教育/职业培训
   - 或：生活服务 → 摄影服务
   
   结算账户：
   - 对公账户（企业）
   - 法人银行卡（个体工商户）
   ```

4. **提交资料审核**
   - 审核时间：1-3个工作日
   - 审核通过后会收到邮件和短信通知

5. **签署协议**
   - 使用管理员微信扫码签署《微信支付商户平台协议》

6. **获取商户号**
   - 审核通过后，会分配一个商户号（mch_id）
   - 格式：1234567890（10位数字）

---

### 2.2 配置商户平台

**登录商户平台：**
- 网址：https://pay.weixin.qq.com
- 使用管理员微信扫码登录

**设置 API 密钥：**

1. 进入：账户中心 → API安全 → 设置API密钥
2. 点击「设置密钥」
3. 输入32位密钥（建议使用随机生成）
   ```
   示例：abcd1234efgh5678ijkl9012mnop3456
   ```
4. 保存密钥（**重要：请妥善保管，不要泄露**）

**下载商户证书：**

1. 进入：账户中心 → API安全 → 申请API证书
2. 下载证书工具
3. 生成证书
4. 下载三个文件：
   - `apiclient_cert.pem`（商户证书）
   - `apiclient_key.pem`（商户私钥）
   - `apiclient_cert.p12`（商户证书PKCS12格式）

---

### 2.3 关联小程序

**在商户平台关联小程序：**

1. 登录商户平台
2. 产品中心 → AppID账号管理 → 关联AppID
3. 输入小程序 AppID
4. 使用小程序管理员微信扫码确认
5. 关联成功

---

## 3. 配置小程序

### 3.1 配置云开发环境

**在微信开发者工具中：**

1. 点击「云开发」按钮
2. 进入云开发控制台
3. 设置 → 全局设置 → 环境ID
   ```
   记录环境ID：cloud1-9gdsq5jxb7e60ab4
   ```

---

### 3.2 配置支付参数

**在云开发控制台：**

1. 设置 → 环境变量
2. 添加以下变量：
   ```
   WECHAT_APPID=你的小程序AppID
   WECHAT_APPSECRET=你的小程序AppSecret
   WECHAT_MCHID=你的商户号
   WECHAT_APIKEY=你的商户API密钥
   ```

**注意：** 不要在代码中硬编码这些敏感信息！

---

## 4. 创建云函数

### 4.1 创建 `unifiedOrder` 云函数

**目录结构：**
```
cloudfunctions/
  └── unifiedOrder/
      ├── index.js
      ├── package.json
      └── config.json
```

**package.json：**
```json
{
  "name": "unifiedOrder",
  "version": "1.0.0",
  "description": "微信支付统一下单",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

**index.js：**
```javascript
// cloudfunctions/unifiedOrder/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  
  const {
    totalFee,      // 订单金额（单位：分）
    orderNo,       // 订单号
    description    // 商品描述
  } = event;

  try {
    // 调用微信支付统一下单
    const result = await cloud.cloudPay.unifiedOrder({
      "body": description || "次元学校-证件照拍摄",
      "outTradeNo": orderNo,
      "spbillCreateIp": "127.0.0.1",
      "subMchId": "", // 子商户号（如果有）
      "totalFee": totalFee,
      "envId": cloud.DYNAMIC_CURRENT_ENV,
      "functionName": "payCallback" // 支付回调云函数
    });

    return {
      success: true,
      result: result
    };
  } catch (err) {
    console.error('统一下单失败:', err);
    return {
      success: false,
      errMsg: err.message
    };
  }
};
```

---

### 4.2 创建 `payCallback` 云函数

**目录结构：**
```
cloudfunctions/
  └── payCallback/
      ├── index.js
      ├── package.json
      └── config.json
```

**package.json：**
```json
{
  "name": "payCallback",
  "version": "1.0.0",
  "description": "微信支付回调",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

**index.js：**
```javascript
// cloudfunctions/payCallback/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();

exports.main = async (event, context) => {
  console.log('支付回调:', event);

  const {
    outTradeNo,    // 商户订单号
    resultCode,    // 支付结果
    transactionId, // 微信支付订单号
    totalFee       // 支付金额
  } = event;

  // 支付成功
  if (resultCode === 'SUCCESS') {
    try {
      // 更新订单状态
      await db.collection('activity_orders')
        .where({
          orderNo: outTradeNo
        })
        .update({
          data: {
            status: 'in_progress',
            paymentStatus: 'paid',
            transactionId: transactionId,
            paidAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        });

      console.log('订单状态更新成功:', outTradeNo);

      // 发送订单通知给摄影师（可选）
      // await sendNotificationToPhotographer(outTradeNo);

      return {
        errcode: 0,
        errmsg: 'success'
      };
    } catch (err) {
      console.error('更新订单失败:', err);
      return {
        errcode: -1,
        errmsg: err.message
      };
    }
  } else {
    console.error('支付失败:', event);
    return {
      errcode: -1,
      errmsg: '支付失败'
    };
  }
};
```

---

### 4.3 上传云函数

**在微信开发者工具中：**

1. 右键点击 `unifiedOrder` 文件夹
2. 选择「上传并部署：云端安装依赖」
3. 等待上传完成
4. 重复步骤 1-3 上传 `payCallback`

---

## 5. 修改前端代码

### 5.1 修改 `payment.js`

**修改 `submitPayment` 方法：**

```javascript
// pages/apply/payment.js
async submitPayment() {
  // 防止重复提交
  if (this.data.submitting || this.data.orderCreating) {
    console.warn('⚠️ 正在提交中，请勿重复点击');
    return;
  }

  // 设置全局锁
  console.log('🔒 设置全局锁，防止重复创建订单');
  wx.setStorageSync('orderCreating', true);
  this.setData({ submitting: true, orderCreating: true });

  wx.showLoading({
    title: '提交中...',
    mask: true
  });

  try {
    // 1. 获取用户 openid
    const { result } = await wx.cloud.callFunction({
      name: 'unifiedLogin'
    });
    
    const userOpenId = result.userInfo?._openid || result.userInfo?.openid || result._openid || result.openid;
    
    if (!userOpenId) {
      throw new Error('无法获取用户信息');
    }

    const db = wx.cloud.database();

    // 2. 获取证件照活动ID
    const activityRes = await db.collection('activities')
      .where({
        category: '证件照'
      })
      .get();

    let activityId = '';
    if (activityRes.data && activityRes.data.length > 0) {
      const defaultActivity = activityRes.data.find(a => a.isDefault === true);
      activityId = defaultActivity ? defaultActivity._id : activityRes.data[0]._id;
    }

    // 3. 生成订单号
    const orderNumber = require('../../utils/order-number.js');
    const generatedOrderNo = orderNumber.generateOrderNumber();
    console.log('✅ 生成订单号:', generatedOrderNo);
    
    // 4. 创建订单（状态：待支付）
    const orderData = {
      orderNo: generatedOrderNo,
      activityId: activityId,
      studentName: this.data.formData.childName,
      parentName: this.data.formData.parentName || '',
      parentPhone: this.data.formData.parentPhone || '',
      parentWechat: this.data.formData.parentWechat || '',
      gender: this.data.formData.childGender || '',
      age: parseInt(this.data.formData.childAge) || 0,
      class: '待分配',
      photographerId: this.data.photographer._id || this.data.photographer.id,
      photographerName: this.data.photographer.name,
      lifePhotos: this.data.formData.lifePhotos || [],
      remark: this.data.formData.expectations || '',
      expectations: this.data.formData.expectations || '',
      totalPrice: this.data.photographer.price || 20,
      status: 'pending_payment', // 待支付
      paymentStatus: 'unpaid',   // 未支付
      paymentMethod: this.data.paymentMethod,
      rejectCount: 0,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    const orderRes = await db.collection('activity_orders').add({
      data: orderData
    });

    console.log('✅ 订单创建成功:', orderRes._id);

    // 5. 调用微信支付
    if (this.data.paymentMethod === 'wechat') {
      await this.callWechatPay(generatedOrderNo, orderData.totalPrice, orderRes._id);
    } else {
      // 支付宝支付（暂不支持）
      throw new Error('暂不支持支付宝支付');
    }

  } catch (e) {
    console.error('❌ 提交失败:', e);
    
    // 失败时清除全局锁，允许重试
    console.log('❌ 订单创建失败，清除全局锁，允许重试');
    wx.removeStorageSync('orderCreating');
    this.setData({ submitting: false, orderCreating: false });
    
    wx.hideLoading();
    wx.showToast({
      title: '提交失败: ' + e.message,
      icon: 'none',
      duration: 3000
    });
  }
},

// 调用微信支付
async callWechatPay(orderNo, totalPrice, orderId) {
  try {
    console.log('💳 调用微信支付...');
    console.log('   订单号:', orderNo);
    console.log('   金额:', totalPrice);

    // 调用统一下单云函数
    const { result } = await wx.cloud.callFunction({
      name: 'unifiedOrder',
      data: {
        orderNo: orderNo,
        totalFee: Math.round(totalPrice * 100), // 转换为分
        description: '次元学校-证件照拍摄'
      }
    });

    console.log('📦 统一下单结果:', result);

    if (!result.success) {
      throw new Error(result.errMsg || '统一下单失败');
    }

    // 调起微信支付
    const paymentResult = result.result.payment;
    
    wx.hideLoading();
    
    const payRes = await wx.requestPayment({
      timeStamp: paymentResult.timeStamp,
      nonceStr: paymentResult.nonceStr,
      package: paymentResult.package,
      signType: paymentResult.signType,
      paySign: paymentResult.paySign
    });

    console.log('✅ 支付成功:', payRes);

    // 支付成功后清除全局锁和缓存数据
    console.log('✅ 支付成功，清除全局锁和缓存数据');
    wx.removeStorageSync('orderCreating');
    wx.removeStorageSync('applyFormData');
    wx.removeStorageSync('selectedPhotographer');
    wx.removeStorageSync('studentId');
    wx.removeStorageSync('createDate');

    // 显示成功提示
    wx.showModal({
      title: '支付成功',
      content: '您的入学申请已提交，摄影师将在3个工作日内完成拍摄。',
      showCancel: false,
      success: () => {
        // 跳转到订单详情
        wx.redirectTo({
          url: `/pages/user/orders/detail?orderId=${orderId}`
        });
      }
    });

  } catch (err) {
    console.error('❌ 支付失败:', err);
    
    // 支付失败，清除锁
    wx.removeStorageSync('orderCreating');
    this.setData({ submitting: false, orderCreating: false });

    if (err.errMsg === 'requestPayment:fail cancel') {
      // 用户取消支付
      wx.showModal({
        title: '支付取消',
        content: '您取消了支付，订单已保存，可以稍后在"我的订单"中继续支付。',
        showCancel: false,
        success: () => {
          wx.redirectTo({
            url: '/pages/user/orders/orders'
          });
        }
      });
    } else {
      // 其他错误
      wx.showToast({
        title: '支付失败: ' + (err.errMsg || err.message),
        icon: 'none',
        duration: 3000
      });
    }
  }
},
```

---

### 5.2 添加订单列表的继续支付功能

**修改 `pages/user/orders/orders.wxml`：**

```xml
<!-- 待支付订单显示"继续支付"按钮 -->
<view wx:if="{{item.status === 'pending_payment'}}" class="order-actions">
  <button class="btn-pay" bindtap="continuePay" data-order="{{item}}">
    继续支付
  </button>
</view>
```

**修改 `pages/user/orders/orders.js`：**

```javascript
// 继续支付
async continuePay(e) {
  const order = e.currentTarget.dataset.order;
  
  wx.showLoading({ title: '加载中...' });
  
  try {
    // 调用微信支付
    const { result } = await wx.cloud.callFunction({
      name: 'unifiedOrder',
      data: {
        orderNo: order.orderNo,
        totalFee: Math.round(order.totalPrice * 100),
        description: '次元学校-证件照拍摄'
      }
    });

    if (!result.success) {
      throw new Error(result.errMsg || '统一下单失败');
    }

    const paymentResult = result.result.payment;
    
    wx.hideLoading();
    
    await wx.requestPayment({
      timeStamp: paymentResult.timeStamp,
      nonceStr: paymentResult.nonceStr,
      package: paymentResult.package,
      signType: paymentResult.signType,
      paySign: paymentResult.paySign
    });

    wx.showToast({
      title: '支付成功',
      icon: 'success'
    });

    // 刷新订单列表
    setTimeout(() => {
      this.loadOrders();
    }, 1500);

  } catch (err) {
    wx.hideLoading();
    
    if (err.errMsg === 'requestPayment:fail cancel') {
      wx.showToast({
        title: '支付已取消',
        icon: 'none'
      });
    } else {
      wx.showToast({
        title: '支付失败',
        icon: 'none'
      });
    }
  }
},
```

---

## 6. 测试流程

### 6.1 开发环境测试

**使用沙箱环境：**

1. 登录商户平台
2. 开发配置 → 沙箱环境
3. 获取沙箱商户号和密钥
4. 在云函数中使用沙箱配置

**测试步骤：**

1. 填写申请表
2. 选择摄影师
3. 点击「立即支付」
4. 选择「微信支付」
5. 输入沙箱测试金额（如 0.01 元）
6. 完成支付
7. 查看订单状态是否更新

---

### 6.2 生产环境测试

**注意事项：**

1. **使用真实商户号和密钥**
2. **支付金额最低 0.01 元**
3. **测试完成后可以退款**

**测试步骤：**

1. 提交小程序审核并发布
2. 使用真实用户进行测试
3. 支付小额金额（如 0.01 元）
4. 验证支付流程
5. 验证订单状态更新
6. 验证支付回调
7. 测试退款功能（可选）

---

## 7. 常见问题

### 7.1 支付失败

**问题：** 调起支付时提示「支付失败」

**解决方案：**

1. **检查商户号是否正确**
   ```javascript
   console.log('商户号:', WECHAT_MCHID);
   ```

2. **检查 API 密钥是否正确**
   - 登录商户平台
   - 账户中心 → API安全
   - 重新设置密钥

3. **检查小程序是否关联商户号**
   - 商户平台 → 产品中心 → AppID账号管理
   - 确认小程序已关联

4. **检查支付金额**
   - 最低 0.01 元（1 分）
   - 金额单位必须是「分」

---

### 7.2 回调不执行

**问题：** 支付成功但订单状态未更新

**解决方案：**

1. **检查云函数是否上传**
   ```
   云开发控制台 → 云函数 → 查看 payCallback
   ```

2. **检查云函数日志**
   ```
   云开发控制台 → 云函数 → payCallback → 日志
   ```

3. **检查回调函数名称**
   ```javascript
   // unifiedOrder 中的 functionName 必须与云函数名称一致
   "functionName": "payCallback"
   ```

4. **手动触发回调测试**
   ```javascript
   // 在云开发控制台手动调用 payCallback
   ```

---

### 7.3 金额不一致

**问题：** 用户支付金额与订单金额不符

**解决方案：**

1. **检查金额转换**
   ```javascript
   // 正确：元转分
   totalFee: Math.round(totalPrice * 100)
   
   // 错误：直接使用元
   totalFee: totalPrice
   ```

2. **检查数据类型**
   ```javascript
   // 确保 totalPrice 是数字
   totalPrice: parseFloat(this.data.photographer.price)
   ```

---

### 7.4 证书错误

**问题：** 退款时提示「证书错误」

**解决方案：**

1. **重新下载商户证书**
   - 商户平台 → 账户中心 → API安全
   - 申请API证书

2. **上传证书到云开发**
   ```
   云开发控制台 → 云存储 → 上传文件
   ```

3. **在云函数中引用证书**
   ```javascript
   const cert = await cloud.downloadFile({
     fileID: 'cloud://xxx/apiclient_cert.pem'
   });
   ```

---

## 8. 安全建议

### 8.1 敏感信息保护

**不要在代码中硬编码：**
- ❌ 商户号
- ❌ API 密钥
- ❌ 商户证书

**使用环境变量：**
```javascript
// 在云函数中读取环境变量
const WECHAT_MCHID = process.env.WECHAT_MCHID;
const WECHAT_APIKEY = process.env.WECHAT_APIKEY;
```

---

### 8.2 订单验证

**防止金额篡改：**

```javascript
// 在云函数中验证订单金额
const order = await db.collection('activity_orders')
  .where({ orderNo: outTradeNo })
  .get();

if (order.data[0].totalPrice * 100 !== totalFee) {
  console.error('金额不一致！');
  return { errcode: -1, errmsg: '金额不一致' };
}
```

---

### 8.3 重复支付检查

**防止重复支付：**

```javascript
// 在统一下单前检查订单状态
const order = await db.collection('activity_orders')
  .where({ orderNo: orderNo })
  .get();

if (order.data[0].paymentStatus === 'paid') {
  return { success: false, errMsg: '订单已支付' };
}
```

---

## 9. 总结

### 9.1 接入流程

1. ✅ 申请微信支付商户号
2. ✅ 配置商户平台
3. ✅ 创建云函数（unifiedOrder、payCallback）
4. ✅ 修改前端代码
5. ✅ 测试支付流程
6. ✅ 上线运营

---

### 9.2 关键点

- **商户号和密钥**：妥善保管，不要泄露
- **金额单位**：必须使用「分」
- **回调函数**：确保正确配置
- **订单状态**：支付成功后及时更新
- **用户体验**：提供清晰的支付提示

---

### 9.3 后续优化

- 📊 添加支付统计
- 🔔 支付成功通知
- 💰 退款功能
- 📱 支付记录查询
- 🎁 优惠券/折扣
- 📈 营收分析

---

## 10. 参考资料

- [微信支付官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [小程序云开发支付文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/wechatpay.html)
- [商户平台](https://pay.weixin.qq.com)
- [微信公众平台](https://mp.weixin.qq.com)

---

**需要帮助？**
- 微信支付客服：95017
- 小程序客服：在公众平台提交工单

---

**祝您接入顺利！** 🎉
