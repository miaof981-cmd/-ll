# 📷 摄影师角色排查指南

## ❓ 问题描述
绑定为摄影师后，在"我的"页面没有显示摄影师后台入口。

---

## 🔍 排查步骤

### 1️⃣ 重新登录并查看调试信息

#### 操作步骤：
1. 打开小程序
2. 点击"我的"Tab
3. 如果已登录，先退出登录
4. 重新点击"微信授权登录"按钮

#### 查看控制台日志：

登录成功后，控制台应该显示：
```
✅ 登录成功
👤 用户信息: { _openid: "...", nickName: "...", ... }
👤 用户角色: ["parent", "photographer"]  ← 应该包含 photographer
📋 云函数完整返回: { success: true, user: {...}, roles: [...] }
💾 已保存到本地存储:
  currentRole: photographer
  userRoles: ["parent", "photographer"]
```

进入"我的"页面后：
```
🔍 调试信息 - 我的页面加载:
  userInfo: { ... }
  currentRole: photographer
  userRoles: ["parent", "photographer"]
  isAdmin: false
  isPhotographer: true  ← 这里必须是 true
  isParent: true
```

---

### 2️⃣ 检查数据库配置

#### 检查 `photographer_accounts` 集合

打开：云开发控制台 > 数据库 > `photographer_accounts`

**必须存在的记录格式：**
```json
{
  "_id": "...",
  "openid": "您的完整OpenID",     // ⚠️ 必须与登录OpenID完全一致
  "photographerId": "摄影师ID",
  "name": "您的名字",
  "isActive": true,               // ⚠️ 必须为 true
  "createdAt": "2025-10-14T..."
}
```

**关键检查点：**
- ✅ `openid` 字段值必须与您在"我的"页面看到的 OpenID **完全一致**
- ✅ `isActive` 必须为 `true`
- ✅ 不能有多余的空格或换行
- ✅ 字段名必须是 `openid`，不是 `wechatOpenid`

---

### 3️⃣ 如何正确添加摄影师账号

#### 方法一：通过管理后台（推荐✨）

1. **复制您的 OpenID**
   - 打开小程序
   - 点击"我的"Tab
   - 找到"OpenID"显示区域
   - 点击复制按钮

2. **添加摄影师绑定**
   - 管理后台 > 摄影师管理
   - 选择/创建摄影师
   - 点击"编辑"
   - 在"绑定微信账号"处，点击"手动输入OpenID"
   - 粘贴刚才复制的 OpenID
   - 点击"保存"

3. **验证**
   - 保存成功后，系统会自动创建 `photographer_accounts` 记录
   - 重新登录小程序
   - 查看"我的"页面是否显示摄影师工作台

#### 方法二：直接在云数据库添加

1. **获取 OpenID**
   - 在"我的"页面复制 OpenID

2. **添加记录**
   - 打开 `photographer_accounts` 集合
   - 点击"添加记录"
   - 填写 JSON：
     ```json
     {
       "openid": "粘贴您的完整OpenID",
       "photographerId": "对应的摄影师_id",
       "name": "您的名字",
       "isActive": true
     }
     ```

3. **重新登录**
   - 退出小程序登录
   - 重新微信授权登录

---

### 4️⃣ 验证云函数部署

#### 检查 `unifiedLogin` 云函数

1. **查看云函数列表**
   - 云开发控制台 > 云函数
   - 查找 `unifiedLogin`

2. **如果不存在或状态异常：**
   - 在项目中右键 `cloudfunctions/unifiedLogin`
   - 选择"上传并部署：云端安装依赖"
   - 等待部署完成

3. **测试云函数：**
   - 在云函数详情页点击"云端测试"
   - 输入测试参数：
     ```json
     {
       "userInfo": {
         "nickName": "测试",
         "avatarUrl": ""
       }
     }
     ```
   - 查看返回结果是否包含 `roles` 数组

---

### 5️⃣ 常见问题解决

#### 问题1：OpenID 不匹配
**症状：** 云函数返回的角色中没有 `photographer`

**解决：**
1. 在"我的"页面复制 OpenID
2. 在 `photographer_accounts` 集合中检查 `openid` 字段
3. 确保两者**完全一致**（包括大小写）
4. 如果不一致，更新数据库记录

#### 问题2：`isActive` 为 false
**症状：** 数据库中有记录，但仍无法识别

**解决：**
1. 打开 `photographer_accounts` 集合
2. 找到对应记录
3. 将 `isActive` 改为 `true`
4. 重新登录

#### 问题3：字段名错误
**症状：** 使用了 `wechatOpenid` 而不是 `openid`

**解决：**
- 云函数查询时使用的是 `openid` 字段
- 确保 `photographer_accounts` 集合中的字段名是 `openid`
- 如果是 `wechatOpenid`，需要修改或重新添加

#### 问题4：缓存问题
**症状：** 所有配置都正确，但仍不显示

**解决：**
1. 完全退出小程序（不是退出登录）
2. 清除缓存：开发者工具 > 清除缓存 > 全部清除
3. 重新编译
4. 重新登录

---

## 📊 完整的数据流程

```
用户登录
  ↓
调用 unifiedLogin 云函数
  ↓
获取 OpenID
  ↓
查询 photographer_accounts 集合
  WHERE openid = 用户OpenID AND isActive = true
  ↓
找到记录？
  ├─ 是 → roles.push('photographer')
  └─ 否 → 仅返回 ['parent']
  ↓
保存到本地存储
  wx.setStorageSync('userRoles', roles)
  ↓
"我的"页面加载
  const userRoles = wx.getStorageSync('userRoles')
  const isPhotographer = userRoles.includes('photographer')
  ↓
显示摄影师工作台
  wx:if="{{isPhotographer}}"
```

---

## ✅ 最终验证清单

### 数据库检查
- [ ] `photographer_accounts` 集合存在
- [ ] 有您的 OpenID 记录
- [ ] `openid` 字段值与"我的"页面显示的完全一致
- [ ] `isActive` 为 `true`
- [ ] `photographerId` 指向有效的摄影师记录

### 云函数检查
- [ ] `unifiedLogin` 云函数已部署
- [ ] 云函数状态正常
- [ ] 可以正常调用并返回数据

### 前端检查
- [ ] 退出登录
- [ ] 清除缓存
- [ ] 重新编译
- [ ] 重新登录
- [ ] 查看控制台日志
- [ ] 确认 `isPhotographer: true`
- [ ] "我的"页面显示摄影师工作台入口

---

## 🆘 如果仍然无法解决

请提供以下信息：

1. **控制台日志（登录时）：**
   ```
   👤 用户角色: [...]
   ```

2. **控制台日志（"我的"页面）：**
   ```
   🔍 调试信息 - 我的页面加载:
     isPhotographer: ...
   ```

3. **您的 OpenID：**
   ```
   从"我的"页面复制
   ```

4. **数据库截图：**
   - `photographer_accounts` 集合中的记录

5. **云函数状态：**
   - `unifiedLogin` 的部署状态

根据这些信息，可以进一步诊断问题。

---

## 📝 补充说明

### 摄影师工作台功能
一旦成功识别为摄影师角色，您将在"我的"页面看到：

- **摄影师徽章**：显示"📷 摄影师"标识
- **工作台入口**：点击进入摄影师专属工作台
- **功能包括：**
  - 查看分配给自己的订单
  - 按状态筛选订单（待接单、进行中、已完成）
  - 上传拍摄作品
  - 订单统计数据

### 多角色切换
如果您同时是管理员和摄影师：
- 登录后默认显示管理员角色
- 可以在"我的"页面切换角色
- 每个角色有不同的功能入口

---

**祝您使用愉快！📷✨**

