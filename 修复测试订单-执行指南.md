# 修复测试订单 - 执行指南

## 🎯 目标

清理测试数据，解决图片转换失败警告。

---

## 📊 当前发现的问题

从控制台日志中识别出：

### 问题1: 图片文件不存在
```
订单ID: 4798591468f8e5d1003bc3f37b41014d
问题字段: photos[0], photos[1]
文件路径: cloud://.../test-pho...
错误原因: STORAGE_FILE_NONEXIST（文件已被删除）
创建时间: 2025-10-22T14:10:25.325Z
```

### 问题2: 测试活动引用
```
活动ID: test_activity
问题: 测试活动不存在，使用订单快照展示
```

---

## 🚀 立即执行 - 数据完整性检查

### Step 1: 运行检查云函数

1. **打开微信开发者工具**
2. 切换到 "**云开发**" 标签
3. 点击 "**云函数**"
4. 找到 `checkDataIntegrity` 云函数
5. 点击 "**云端测试**"
6. 输入参数：
   ```json
   {}
   ```
7. 点击 "**开始测试**"

### Step 2: 查看检查结果

你会看到类似这样的返回：

```json
{
  "success": true,
  "issueCount": 8,
  "issues": [
    {
      "type": "异常fileID",
      "collection": "activity_orders",
      "docId": "4798591468f8e5d1003bc3f37b41014d",
      "field": "photos[0]",
      "problem": "fileID长度异常: 75 字符",
      "severity": "high",
      "fix": "可能被截断，需人工检查"
    },
    {
      "type": "测试数据",
      "collection": "activity_orders",
      "docId": "xxx",
      "field": "activityId",
      "problem": "引用测试活动: test_activity",
      "severity": "low",
      "fix": "删除或标记为归档"
    }
    // ... 更多问题
  ],
  "summary": {
    "total": 8,
    "high": 1,
    "medium": 2,
    "low": 5,
    "byType": {
      "emptyUrls": 0,
      "abnormalFileIds": 1,
      "missingSnapshots": 2,
      "testData": 4,
      "priceAbnormal": 1
    }
  }
}
```

---

## 🔧 修复方案

### 方案A: 归档测试订单（推荐）

**优点**：数据不丢失，可随时恢复

1. **打开云开发控制台**
2. 进入 `activity_orders` 集合
3. 找到订单 `4798591468f8e5d1003bc3f37b41014d`
4. 点击 "编辑"
5. 添加字段：
   ```json
   {
     "isArchived": true,
     "archivedAt": "2025-10-23T15:30:00.000Z",
     "archivedReason": "测试订单-图片文件已删除"
   }
   ```
6. 保存

**前端修改**（过滤归档订单）：

在 `orders.js` 的查询中添加：

```javascript
const res = await db.collection('activity_orders')
  .where({
    _openid: openid,
    isArchived: _.neq(true)  // 排除归档订单
  })
  .orderBy('createdAt', 'desc')
  .skip(skip)
  .limit(pageSize)
  .get();
```

### 方案B: 直接删除（不可恢复）

1. 打开云开发控制台
2. 进入 `activity_orders` 集合
3. 搜索 `_id` = `4798591468f8e5d1003bc3f37b41014d`
4. 点击删除
5. 确认删除

### 方案C: 补充图片（如果订单重要）

如果这个订单需要保留且需要图片：

1. 重新上传测试图片到云存储
2. 获取新的 fileID
3. 更新订单的 `photos` 字段：
   ```json
   {
     "photos": [
       "cloud://cloud1-9gdsq5jxb7e60ab4.../new-photo1.jpg",
       "cloud://cloud1-9gdsq5jxb7e60ab4.../new-photo2.jpg"
     ]
   }
   ```

---

## 🧹 批量清理所有测试数据

### 清理 test_activity 相关订单

**手动方式**：

1. 云开发控制台 → `activity_orders`
2. 筛选条件：`activityId` = `test_activity`
3. 批量选择
4. 批量归档或删除

**云函数方式**（待创建）：

```javascript
// 创建清理云函数
exports.main = async (event, context) => {
  const db = cloud.database();
  
  // 归档所有 test_activity 订单
  const res = await db.collection('activity_orders')
    .where({ activityId: 'test_activity' })
    .update({
      data: {
        isArchived: true,
        archivedAt: new Date().toISOString(),
        archivedReason: '测试数据自动归档'
      }
    });
  
  return {
    success: true,
    archivedCount: res.stats.updated
  };
};
```

---

## ✅ 验证修复效果

修复后，重新加载订单列表：

### 预期结果

**控制台日志**：
```
✅ 使用缓存: 10 张 | 🔄 转换新图: 5 张 | ⚠️ 转换失败: 0 张
```
- 转换失败应该变为 **0 张**
- 不再出现 `STORAGE_FILE_NONEXIST` 错误

**test_activity 警告**：
- 如果归档：不再显示该订单，警告消失
- 如果删除：彻底移除，警告消失

**订单列表**：
- 所有图片正常显示
- 无默认占位图（除非本来就没有图片）

---

## 📈 长期监控

建议每周运行一次 `checkDataIntegrity` 云函数：

### 监控指标

| 指标 | 正常值 | 当前值 | 状态 |
|------|--------|--------|------|
| 图片转换失败率 | < 5% | 3.4% (2/58) | ✅ 正常 |
| 测试订单数量 | 0 | ≥1 | ⚠️ 需清理 |
| 异常fileID | 0 | 2 | ⚠️ 需处理 |
| 缺少快照订单 | 0 | 未知 | 🔍 待检查 |

### 定期检查计划

- **每周一** 10:00 AM - 运行 `checkDataIntegrity`
- **发现 high 级问题** → 当天处理
- **发现 medium 级问题** → 3天内处理
- **发现 low 级问题** → 1周内处理

---

## 🛡️ 预防措施

### 1. 删除云存储文件前检查引用

```javascript
// 删除文件前
async function safeDeleteFile(fileID) {
  // 检查是否有订单引用
  const orders = await db.collection('activity_orders')
    .where({
      photos: db.command.or([
        db.command.eq(fileID),
        db.command.in([fileID])
      ])
    })
    .get();
  
  if (orders.data.length > 0) {
    console.warn(`⚠️ 文件被 ${orders.data.length} 个订单引用，建议先处理订单`);
    return false;
  }
  
  // 无引用，安全删除
  await wx.cloud.deleteFile({ fileList: [fileID] });
  return true;
}
```

### 2. 上传图片时验证

```javascript
async function uploadWithValidation(filePath) {
  const result = await wx.cloud.uploadFile({
    cloudPath: `orders/${Date.now()}.jpg`,
    filePath
  });
  
  // 验证上传结果
  if (!result.fileID || result.fileID.length < 60) {
    throw new Error('上传失败或fileID异常');
  }
  
  // 验证文件可访问
  const tempRes = await wx.cloud.getTempFileURL({
    fileList: [result.fileID]
  });
  
  if (tempRes.fileList[0].status !== 0) {
    throw new Error('文件上传成功但无法访问');
  }
  
  return result.fileID;
}
```

### 3. 创建订单时保存完整快照

```javascript
async function createOrder(activityId, photos) {
  const activity = await getActivity(activityId);
  
  // 过滤空值
  const cleanPhotos = photos.filter(url => 
    url && typeof url === 'string' && url.trim() !== ''
  );
  
  return {
    activityId: activity._id,
    activityName: activity.name,         // 快照
    activityCover: activity.coverImage, // 快照
    price: activity.price,               // 快照
    photos: cleanPhotos,
    createdAt: new Date().toISOString()
  };
}
```

---

## ❓ FAQ

### Q1: 为什么status=1但warning说status=0？

**A**: 这是一个小bug，我们需要修复判断逻辑：

```javascript
// 当前代码
if (!file.tempFileURL) {
  failReason = '临时URL为空';
  debugInfo.warning = 'status=0但tempFileURL为空...';
}

// 应该改为
if (!file.tempFileURL) {
  failReason = '临时URL为空';
  if (file.status === 0) {
    debugInfo.warning = 'status=0但tempFileURL为空，文件可能已被删除';
  } else {
    debugInfo.warning = `status=${file.status}，错误信息: ${file.errMsg}`;
  }
}
```

### Q2: 归档订单会占用数据库空间吗？

**A**: 会占用，但：
- 一个订单记录约 1-5KB
- 即使1000个归档订单，也只占用 5MB
- 腾讯云数据库免费额度为 2GB
- 归档订单便于审计和数据恢复

### Q3: 能自动删除超过1年的归档订单吗？

**A**: 可以创建定时触发器：

```javascript
// 每月1号清理超过1年的归档订单
exports.main = async (event, context) => {
  const db = cloud.database();
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  
  const res = await db.collection('activity_orders')
    .where({
      isArchived: true,
      archivedAt: db.command.lt(oneYearAgo.toISOString())
    })
    .remove();
  
  return {
    success: true,
    deletedCount: res.removed
  };
};
```

---

## 🎯 立即行动清单

- [ ] 运行 `checkDataIntegrity` 云函数
- [ ] 查看返回的 issues 列表
- [ ] 归档或删除订单 `4798591468f8e5d1003bc3f37b41014d`
- [ ] 清理所有 `test_activity` 相关订单
- [ ] 重新加载订单列表验证
- [ ] 确认图片转换失败数量为 0

---

**修复时间**：约 10-15 分钟  
**建议**：先归档再观察，如无问题再删除

