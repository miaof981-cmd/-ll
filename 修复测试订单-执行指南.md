# ä¿®å¤æµ‹è¯•è®¢å• - æ‰§è¡ŒæŒ‡å—

## ğŸ¯ ç›®æ ‡

æ¸…ç†æµ‹è¯•æ•°æ®ï¼Œè§£å†³å›¾ç‰‡è½¬æ¢å¤±è´¥è­¦å‘Šã€‚

---

## ğŸ“Š å½“å‰å‘ç°çš„é—®é¢˜

ä»æ§åˆ¶å°æ—¥å¿—ä¸­è¯†åˆ«å‡ºï¼š

### é—®é¢˜1: å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨
```
è®¢å•ID: 4798591468f8e5d1003bc3f37b41014d
é—®é¢˜å­—æ®µ: photos[0], photos[1]
æ–‡ä»¶è·¯å¾„: cloud://.../test-pho...
é”™è¯¯åŸå› : STORAGE_FILE_NONEXISTï¼ˆæ–‡ä»¶å·²è¢«åˆ é™¤ï¼‰
åˆ›å»ºæ—¶é—´: 2025-10-22T14:10:25.325Z
```

### é—®é¢˜2: æµ‹è¯•æ´»åŠ¨å¼•ç”¨
```
æ´»åŠ¨ID: test_activity
é—®é¢˜: æµ‹è¯•æ´»åŠ¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨è®¢å•å¿«ç…§å±•ç¤º
```

---

## ğŸš€ ç«‹å³æ‰§è¡Œ - æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### Step 1: è¿è¡Œæ£€æŸ¥äº‘å‡½æ•°

1. **æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·**
2. åˆ‡æ¢åˆ° "**äº‘å¼€å‘**" æ ‡ç­¾
3. ç‚¹å‡» "**äº‘å‡½æ•°**"
4. æ‰¾åˆ° `checkDataIntegrity` äº‘å‡½æ•°
5. ç‚¹å‡» "**äº‘ç«¯æµ‹è¯•**"
6. è¾“å…¥å‚æ•°ï¼š
   ```json
   {}
   ```
7. ç‚¹å‡» "**å¼€å§‹æµ‹è¯•**"

### Step 2: æŸ¥çœ‹æ£€æŸ¥ç»“æœ

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¿”å›ï¼š

```json
{
  "success": true,
  "issueCount": 8,
  "issues": [
    {
      "type": "å¼‚å¸¸fileID",
      "collection": "activity_orders",
      "docId": "4798591468f8e5d1003bc3f37b41014d",
      "field": "photos[0]",
      "problem": "fileIDé•¿åº¦å¼‚å¸¸: 75 å­—ç¬¦",
      "severity": "high",
      "fix": "å¯èƒ½è¢«æˆªæ–­ï¼Œéœ€äººå·¥æ£€æŸ¥"
    },
    {
      "type": "æµ‹è¯•æ•°æ®",
      "collection": "activity_orders",
      "docId": "xxx",
      "field": "activityId",
      "problem": "å¼•ç”¨æµ‹è¯•æ´»åŠ¨: test_activity",
      "severity": "low",
      "fix": "åˆ é™¤æˆ–æ ‡è®°ä¸ºå½’æ¡£"
    }
    // ... æ›´å¤šé—®é¢˜
  ],
  "summary": {
    "total": 8,
    "high": 1,
    "medium": 2,
    "low": 5,
    "byType": {
      "emptyUrls": 0,
      "abnormalFileIds": 1,
      "missingSnapshots": 2,
      "testData": 4,
      "priceAbnormal": 1
    }
  }
}
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆA: å½’æ¡£æµ‹è¯•è®¢å•ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼šæ•°æ®ä¸ä¸¢å¤±ï¼Œå¯éšæ—¶æ¢å¤

1. **æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°**
2. è¿›å…¥ `activity_orders` é›†åˆ
3. æ‰¾åˆ°è®¢å• `4798591468f8e5d1003bc3f37b41014d`
4. ç‚¹å‡» "ç¼–è¾‘"
5. æ·»åŠ å­—æ®µï¼š
   ```json
   {
     "isArchived": true,
     "archivedAt": "2025-10-23T15:30:00.000Z",
     "archivedReason": "æµ‹è¯•è®¢å•-å›¾ç‰‡æ–‡ä»¶å·²åˆ é™¤"
   }
   ```
6. ä¿å­˜

**å‰ç«¯ä¿®æ”¹**ï¼ˆè¿‡æ»¤å½’æ¡£è®¢å•ï¼‰ï¼š

åœ¨ `orders.js` çš„æŸ¥è¯¢ä¸­æ·»åŠ ï¼š

```javascript
const res = await db.collection('activity_orders')
  .where({
    _openid: openid,
    isArchived: _.neq(true)  // æ’é™¤å½’æ¡£è®¢å•
  })
  .orderBy('createdAt', 'desc')
  .skip(skip)
  .limit(pageSize)
  .get();
```

### æ–¹æ¡ˆB: ç›´æ¥åˆ é™¤ï¼ˆä¸å¯æ¢å¤ï¼‰

1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
2. è¿›å…¥ `activity_orders` é›†åˆ
3. æœç´¢ `_id` = `4798591468f8e5d1003bc3f37b41014d`
4. ç‚¹å‡»åˆ é™¤
5. ç¡®è®¤åˆ é™¤

### æ–¹æ¡ˆC: è¡¥å……å›¾ç‰‡ï¼ˆå¦‚æœè®¢å•é‡è¦ï¼‰

å¦‚æœè¿™ä¸ªè®¢å•éœ€è¦ä¿ç•™ä¸”éœ€è¦å›¾ç‰‡ï¼š

1. é‡æ–°ä¸Šä¼ æµ‹è¯•å›¾ç‰‡åˆ°äº‘å­˜å‚¨
2. è·å–æ–°çš„ fileID
3. æ›´æ–°è®¢å•çš„ `photos` å­—æ®µï¼š
   ```json
   {
     "photos": [
       "cloud://cloud1-9gdsq5jxb7e60ab4.../new-photo1.jpg",
       "cloud://cloud1-9gdsq5jxb7e60ab4.../new-photo2.jpg"
     ]
   }
   ```

---

## ğŸ§¹ æ‰¹é‡æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®

### æ¸…ç† test_activity ç›¸å…³è®¢å•

**æ‰‹åŠ¨æ–¹å¼**ï¼š

1. äº‘å¼€å‘æ§åˆ¶å° â†’ `activity_orders`
2. ç­›é€‰æ¡ä»¶ï¼š`activityId` = `test_activity`
3. æ‰¹é‡é€‰æ‹©
4. æ‰¹é‡å½’æ¡£æˆ–åˆ é™¤

**äº‘å‡½æ•°æ–¹å¼**ï¼ˆå¾…åˆ›å»ºï¼‰ï¼š

```javascript
// åˆ›å»ºæ¸…ç†äº‘å‡½æ•°
exports.main = async (event, context) => {
  const db = cloud.database();
  
  // å½’æ¡£æ‰€æœ‰ test_activity è®¢å•
  const res = await db.collection('activity_orders')
    .where({ activityId: 'test_activity' })
    .update({
      data: {
        isArchived: true,
        archivedAt: new Date().toISOString(),
        archivedReason: 'æµ‹è¯•æ•°æ®è‡ªåŠ¨å½’æ¡£'
      }
    });
  
  return {
    success: true,
    archivedCount: res.stats.updated
  };
};
```

---

## âœ… éªŒè¯ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼Œé‡æ–°åŠ è½½è®¢å•åˆ—è¡¨ï¼š

### é¢„æœŸç»“æœ

**æ§åˆ¶å°æ—¥å¿—**ï¼š
```
âœ… ä½¿ç”¨ç¼“å­˜: 10 å¼  | ğŸ”„ è½¬æ¢æ–°å›¾: 5 å¼  | âš ï¸ è½¬æ¢å¤±è´¥: 0 å¼ 
```
- è½¬æ¢å¤±è´¥åº”è¯¥å˜ä¸º **0 å¼ **
- ä¸å†å‡ºç° `STORAGE_FILE_NONEXIST` é”™è¯¯

**test_activity è­¦å‘Š**ï¼š
- å¦‚æœå½’æ¡£ï¼šä¸å†æ˜¾ç¤ºè¯¥è®¢å•ï¼Œè­¦å‘Šæ¶ˆå¤±
- å¦‚æœåˆ é™¤ï¼šå½»åº•ç§»é™¤ï¼Œè­¦å‘Šæ¶ˆå¤±

**è®¢å•åˆ—è¡¨**ï¼š
- æ‰€æœ‰å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- æ— é»˜è®¤å ä½å›¾ï¼ˆé™¤éæœ¬æ¥å°±æ²¡æœ‰å›¾ç‰‡ï¼‰

---

## ğŸ“ˆ é•¿æœŸç›‘æ§

å»ºè®®æ¯å‘¨è¿è¡Œä¸€æ¬¡ `checkDataIntegrity` äº‘å‡½æ•°ï¼š

### ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | æ­£å¸¸å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| å›¾ç‰‡è½¬æ¢å¤±è´¥ç‡ | < 5% | 3.4% (2/58) | âœ… æ­£å¸¸ |
| æµ‹è¯•è®¢å•æ•°é‡ | 0 | â‰¥1 | âš ï¸ éœ€æ¸…ç† |
| å¼‚å¸¸fileID | 0 | 2 | âš ï¸ éœ€å¤„ç† |
| ç¼ºå°‘å¿«ç…§è®¢å• | 0 | æœªçŸ¥ | ğŸ” å¾…æ£€æŸ¥ |

### å®šæœŸæ£€æŸ¥è®¡åˆ’

- **æ¯å‘¨ä¸€** 10:00 AM - è¿è¡Œ `checkDataIntegrity`
- **å‘ç° high çº§é—®é¢˜** â†’ å½“å¤©å¤„ç†
- **å‘ç° medium çº§é—®é¢˜** â†’ 3å¤©å†…å¤„ç†
- **å‘ç° low çº§é—®é¢˜** â†’ 1å‘¨å†…å¤„ç†

---

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. åˆ é™¤äº‘å­˜å‚¨æ–‡ä»¶å‰æ£€æŸ¥å¼•ç”¨

```javascript
// åˆ é™¤æ–‡ä»¶å‰
async function safeDeleteFile(fileID) {
  // æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•å¼•ç”¨
  const orders = await db.collection('activity_orders')
    .where({
      photos: db.command.or([
        db.command.eq(fileID),
        db.command.in([fileID])
      ])
    })
    .get();
  
  if (orders.data.length > 0) {
    console.warn(`âš ï¸ æ–‡ä»¶è¢« ${orders.data.length} ä¸ªè®¢å•å¼•ç”¨ï¼Œå»ºè®®å…ˆå¤„ç†è®¢å•`);
    return false;
  }
  
  // æ— å¼•ç”¨ï¼Œå®‰å…¨åˆ é™¤
  await wx.cloud.deleteFile({ fileList: [fileID] });
  return true;
}
```

### 2. ä¸Šä¼ å›¾ç‰‡æ—¶éªŒè¯

```javascript
async function uploadWithValidation(filePath) {
  const result = await wx.cloud.uploadFile({
    cloudPath: `orders/${Date.now()}.jpg`,
    filePath
  });
  
  // éªŒè¯ä¸Šä¼ ç»“æœ
  if (!result.fileID || result.fileID.length < 60) {
    throw new Error('ä¸Šä¼ å¤±è´¥æˆ–fileIDå¼‚å¸¸');
  }
  
  // éªŒè¯æ–‡ä»¶å¯è®¿é—®
  const tempRes = await wx.cloud.getTempFileURL({
    fileList: [result.fileID]
  });
  
  if (tempRes.fileList[0].status !== 0) {
    throw new Error('æ–‡ä»¶ä¸Šä¼ æˆåŠŸä½†æ— æ³•è®¿é—®');
  }
  
  return result.fileID;
}
```

### 3. åˆ›å»ºè®¢å•æ—¶ä¿å­˜å®Œæ•´å¿«ç…§

```javascript
async function createOrder(activityId, photos) {
  const activity = await getActivity(activityId);
  
  // è¿‡æ»¤ç©ºå€¼
  const cleanPhotos = photos.filter(url => 
    url && typeof url === 'string' && url.trim() !== ''
  );
  
  return {
    activityId: activity._id,
    activityName: activity.name,         // å¿«ç…§
    activityCover: activity.coverImage, // å¿«ç…§
    price: activity.price,               // å¿«ç…§
    photos: cleanPhotos,
    createdAt: new Date().toISOString()
  };
}
```

---

## â“ FAQ

### Q1: ä¸ºä»€ä¹ˆstatus=1ä½†warningè¯´status=0ï¼Ÿ

**A**: è¿™æ˜¯ä¸€ä¸ªå°bugï¼Œæˆ‘ä»¬éœ€è¦ä¿®å¤åˆ¤æ–­é€»è¾‘ï¼š

```javascript
// å½“å‰ä»£ç 
if (!file.tempFileURL) {
  failReason = 'ä¸´æ—¶URLä¸ºç©º';
  debugInfo.warning = 'status=0ä½†tempFileURLä¸ºç©º...';
}

// åº”è¯¥æ”¹ä¸º
if (!file.tempFileURL) {
  failReason = 'ä¸´æ—¶URLä¸ºç©º';
  if (file.status === 0) {
    debugInfo.warning = 'status=0ä½†tempFileURLä¸ºç©ºï¼Œæ–‡ä»¶å¯èƒ½å·²è¢«åˆ é™¤';
  } else {
    debugInfo.warning = `status=${file.status}ï¼Œé”™è¯¯ä¿¡æ¯: ${file.errMsg}`;
  }
}
```

### Q2: å½’æ¡£è®¢å•ä¼šå ç”¨æ•°æ®åº“ç©ºé—´å—ï¼Ÿ

**A**: ä¼šå ç”¨ï¼Œä½†ï¼š
- ä¸€ä¸ªè®¢å•è®°å½•çº¦ 1-5KB
- å³ä½¿1000ä¸ªå½’æ¡£è®¢å•ï¼Œä¹Ÿåªå ç”¨ 5MB
- è…¾è®¯äº‘æ•°æ®åº“å…è´¹é¢åº¦ä¸º 2GB
- å½’æ¡£è®¢å•ä¾¿äºå®¡è®¡å’Œæ•°æ®æ¢å¤

### Q3: èƒ½è‡ªåŠ¨åˆ é™¤è¶…è¿‡1å¹´çš„å½’æ¡£è®¢å•å—ï¼Ÿ

**A**: å¯ä»¥åˆ›å»ºå®šæ—¶è§¦å‘å™¨ï¼š

```javascript
// æ¯æœˆ1å·æ¸…ç†è¶…è¿‡1å¹´çš„å½’æ¡£è®¢å•
exports.main = async (event, context) => {
  const db = cloud.database();
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  
  const res = await db.collection('activity_orders')
    .where({
      isArchived: true,
      archivedAt: db.command.lt(oneYearAgo.toISOString())
    })
    .remove();
  
  return {
    success: true,
    deletedCount: res.removed
  };
};
```

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨æ¸…å•

- [ ] è¿è¡Œ `checkDataIntegrity` äº‘å‡½æ•°
- [ ] æŸ¥çœ‹è¿”å›çš„ issues åˆ—è¡¨
- [ ] å½’æ¡£æˆ–åˆ é™¤è®¢å• `4798591468f8e5d1003bc3f37b41014d`
- [ ] æ¸…ç†æ‰€æœ‰ `test_activity` ç›¸å…³è®¢å•
- [ ] é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨éªŒè¯
- [ ] ç¡®è®¤å›¾ç‰‡è½¬æ¢å¤±è´¥æ•°é‡ä¸º 0

---

**ä¿®å¤æ—¶é—´**ï¼šçº¦ 10-15 åˆ†é’Ÿ  
**å»ºè®®**ï¼šå…ˆå½’æ¡£å†è§‚å¯Ÿï¼Œå¦‚æ— é—®é¢˜å†åˆ é™¤

