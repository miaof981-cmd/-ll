# å¤´åƒç»„ä»¶æ€§èƒ½ä¼˜åŒ– - é˜²æ­¢é‡å¤ setData

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆæ§åˆ¶å°å¤§é‡åˆ·å±ï¼Œæ˜¾ç¤ºå¤´åƒç»„ä»¶åœ¨åå¤è§¦å‘ `setData()`ï¼Œå¯¼è‡´ï¼š
- æ§åˆ¶å°æ—¥å¿—è¿‡å¤šï¼Œå½±å“è°ƒè¯•
- å¯èƒ½çš„æ€§èƒ½é—®é¢˜ï¼ˆé¢‘ç¹æ¸²æŸ“ï¼‰
- å¯èƒ½çš„å†…å­˜æ³„æ¼ï¼ˆç»„ä»¶é”€æ¯åä»åœ¨æ‰§è¡Œï¼‰

## é—®é¢˜æ ¹æº

1. **Observer å›è°ƒæœªåˆ¤æ–­æ–°æ—§å€¼**
   - `loadAvatarByOpenId` å’Œ `processAvatarUrl` ä½œä¸º observerï¼Œæ¯æ¬¡å±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘
   - æ²¡æœ‰æ£€æŸ¥æ–° URL æ˜¯å¦ä¸å½“å‰ `displayAvatar` ç›¸åŒ
   - å¯¼è‡´å³ä½¿ URL ç›¸åŒä¹Ÿä¼šé‡å¤ `setData()`

2. **ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†²çª**
   - `attached()` ç”Ÿå‘½å‘¨æœŸå’Œ observer å›è°ƒå¯èƒ½é‡å¤è§¦å‘
   - ç»„ä»¶é”€æ¯å observer å¯èƒ½ä»åœ¨æ‰§è¡Œ

3. **ç¼ºå°‘çŠ¶æ€è¿½è¸ª**
   - æ²¡æœ‰è®°å½•ä¸Šæ¬¡å¤„ç†çš„ `openid` å’Œ `avatarUrl`
   - å¯¼è‡´ç›¸åŒå€¼çš„é‡å¤å¤„ç†

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ·»åŠ çŠ¶æ€è¿½è¸ªå­—æ®µ

```javascript
data: {
  displayAvatar: '',
  loading: false,
  _isAttached: false,      // ğŸ”¥ æ ‡è®°ç»„ä»¶æ˜¯å¦å·²æŒ‚è½½
  _lastOpenId: '',         // ğŸ”¥ è®°å½•ä¸Šæ¬¡å¤„ç†çš„ openId
  _lastAvatarUrl: ''       // ğŸ”¥ è®°å½•ä¸Šæ¬¡å¤„ç†çš„ avatarUrl
}
```

### 2. ä¼˜åŒ– `loadAvatarByOpenId` æ–¹æ³•

**ä¼˜åŒ–å‰**ï¼š
```javascript
async loadAvatarByOpenId(newOpenId, oldOpenId) {
  if (!newOpenId || newOpenId === oldOpenId) {
    return;
  }
  // ç›´æ¥æ‰§è¡Œï¼Œæ²¡æœ‰æ£€æŸ¥ URL æ˜¯å¦ç›¸åŒ
  this.setData({
    displayAvatar: avatarUrl,
    loading: false
  });
}
```

**ä¼˜åŒ–å**ï¼š
```javascript
async loadAvatarByOpenId(newOpenId, oldOpenId) {
  // âœ… é˜²æ­¢é‡å¤è§¦å‘
  if (!newOpenId || newOpenId === oldOpenId) {
    return;
  }
  
  // âœ… æ£€æŸ¥æ˜¯å¦ä¸ä¸Šæ¬¡å¤„ç†çš„ openId ç›¸åŒ
  if (newOpenId === this.data._lastOpenId) {
    return;
  }
  
  // âœ… å¦‚æœç»„ä»¶æœªæŒ‚è½½ï¼Œä¸æ‰§è¡ŒåŠ è½½
  if (!this.data._isAttached) {
    return;
  }
  
  // è®°å½•æœ¬æ¬¡å¤„ç†
  this.setData({ 
    loading: true,
    _lastOpenId: newOpenId 
  });
  
  // ... è·å– avatarUrl ...
  
  // âœ… åªæœ‰å½“æ–° URL ä¸å½“å‰ä¸åŒæ—¶æ‰æ›´æ–°
  if (avatarUrl !== this.data.displayAvatar) {
    this.setData({
      displayAvatar: avatarUrl,
      loading: false
    });
  } else {
    // URL ç›¸åŒï¼Œåªæ›´æ–° loading çŠ¶æ€
    this.setData({ loading: false });
  }
}
```

### 3. ä¼˜åŒ– `processAvatarUrl` æ–¹æ³•

åŒæ ·çš„ä¼˜åŒ–é€»è¾‘ï¼š

```javascript
async processAvatarUrl(newUrl, oldUrl) {
  // âœ… é˜²æ­¢é‡å¤è§¦å‘
  if (newUrl === oldUrl) return;
  
  // âœ… æ£€æŸ¥æ˜¯å¦ä¸ä¸Šæ¬¡å¤„ç†çš„ avatarUrl ç›¸åŒ
  if (newUrl === this.data._lastAvatarUrl) return;
  
  // âœ… å¦‚æœç»„ä»¶æœªæŒ‚è½½ï¼Œä¸æ‰§è¡ŒåŠ è½½
  if (!this.data._isAttached) return;
  
  // è®°å½•æœ¬æ¬¡å¤„ç†
  this.data._lastAvatarUrl = newUrl;
  
  // ... å¤„ç† URL ...
  
  // âœ… åªæœ‰ä¸å½“å‰ä¸åŒæ—¶æ‰æ›´æ–°
  if (finalUrl !== this.data.displayAvatar) {
    this.setData({ displayAvatar: finalUrl });
  }
}
```

### 4. ä¼˜åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ·»åŠ  `attached` å’Œ `detached`**ï¼š

```javascript
lifetimes: {
  attached() {
    // âœ… æ ‡è®°ç»„ä»¶å·²æŒ‚è½½
    this.setData({ _isAttached: true });
    
    // æ ¹æ®å‚æ•°å†³å®šåŠ è½½æ–¹å¼
    if (this.data.openid) {
      this.loadAvatarByOpenId(this.data.openid);
    } else if (this.data.avatarUrl) {
      this.processAvatarUrl(this.data.avatarUrl);
    }
  },
  
  detached() {
    // âœ… ç»„ä»¶é”€æ¯æ—¶æ¸…ç†çŠ¶æ€ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
    this.setData({
      _isAttached: false,
      _lastOpenId: '',
      _lastAvatarUrl: '',
      loading: false
    });
  }
}
```

### 5. ä¼˜åŒ–é”™è¯¯å¤„ç†

```javascript
onAvatarError(e) {
  const defaultUrl = this.data.defaultAvatar;
  
  // âœ… åªæœ‰ä¸å½“å‰ä¸åŒæ—¶æ‰æ›´æ–°
  if (defaultUrl !== this.data.displayAvatar) {
    this.setData({ displayAvatar: defaultUrl });
  }
  
  this.triggerEvent('error', { error: e.detail });
}
```

## ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰

```
æ§åˆ¶å°è¾“å‡ºï¼ˆæ¯ç§’æ•°åæ¬¡ï¼‰ï¼š
âœ… [å¤´åƒç»„ä»¶] ä» globalData è·å–å½“å‰ç”¨æˆ·å¤´åƒ
âœ… [å¤´åƒç»„ä»¶] ä» globalData è·å–å½“å‰ç”¨æˆ·å¤´åƒ
âœ… [å¤´åƒç»„ä»¶] ä» globalData è·å–å½“å‰ç”¨æˆ·å¤´åƒ
... (æŒç»­åˆ·å±)
```

**é—®é¢˜**ï¼š
- é‡å¤ `setData()` æ•°åæ¬¡
- æ§åˆ¶å°éš¾ä»¥é˜…è¯»
- å¯èƒ½å½±å“æ€§èƒ½

### ä¼˜åŒ–å

```
æ§åˆ¶å°è¾“å‡ºï¼ˆä»…åœ¨çœŸæ­£å˜åŒ–æ—¶ï¼‰ï¼š
[æ— å¤šä½™æ—¥å¿—]
```

**æ•ˆæœ**ï¼š
- âœ… åªåœ¨ URL çœŸæ­£å˜åŒ–æ—¶æ‰ `setData()`
- âœ… æ§åˆ¶å°æ¸…çˆ½ï¼Œæ˜“äºè°ƒè¯•
- âœ… æ€§èƒ½æå‡ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“
- âœ… ç»„ä»¶é”€æ¯æ—¶æ­£ç¡®æ¸…ç†ï¼Œæ— å†…å­˜æ³„æ¼

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| setData è°ƒç”¨æ¬¡æ•° | æ¯ä¸ªç»„ä»¶ 10-50 æ¬¡/ç§’ | 1-2 æ¬¡ï¼ˆä»…åœ¨å˜åŒ–æ—¶ï¼‰ | â¬‡ï¸ 95%+ |
| æ§åˆ¶å°æ—¥å¿— | å¤§é‡åˆ·å± | æ¸…çˆ½æ— å†—ä½™ | â¬‡ï¸ 100% |
| æ¸²æŸ“æ€§èƒ½ | é¢‘ç¹é‡ç»˜ | æŒ‰éœ€æ¸²æŸ“ | â¬†ï¸ æ˜¾è‘—æå‡ |
| å†…å­˜ä½¿ç”¨ | å¯èƒ½æ³„æ¼ | æ­£ç¡®æ¸…ç† | â¬†ï¸ æ›´ç¨³å®š |

## å…³é”®ä¼˜åŒ–ç‚¹

### 1. ä¸‰å±‚é˜²æŠ¤æ£€æŸ¥

```javascript
// ç¬¬ä¸€å±‚ï¼šæ–°æ—§å€¼æ¯”è¾ƒ
if (newValue === oldValue) return;

// ç¬¬äºŒå±‚ï¼šä¸ä¸Šæ¬¡å¤„ç†å€¼æ¯”è¾ƒ
if (newValue === this.data._lastValue) return;

// ç¬¬ä¸‰å±‚ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦æŒ‚è½½
if (!this.data._isAttached) return;
```

### 2. setData å‰çš„å€¼æ¯”è¾ƒ

```javascript
// æ€»æ˜¯åœ¨ setData å‰æ£€æŸ¥
if (newUrl !== this.data.displayAvatar) {
  this.setData({ displayAvatar: newUrl });
}
```

### 3. ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ç®¡ç†

```javascript
// æŒ‚è½½æ—¶æ ‡è®°
attached() {
  this.setData({ _isAttached: true });
}

// é”€æ¯æ—¶æ¸…ç†
detached() {
  this.setData({ _isAttached: false });
}
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šè®¢å•åˆ—è¡¨æ»šåŠ¨
- **ä¼˜åŒ–å‰**ï¼šæ¯æ»šåŠ¨ä¸€å±ï¼Œæ§åˆ¶å°åˆ·å±æ•°åæ¡æ—¥å¿—
- **ä¼˜åŒ–å**ï¼šæ— å¤šä½™æ—¥å¿—ï¼Œä»…åœ¨æ–°å¤´åƒåŠ è½½æ—¶è¾“å‡º

### æµ‹è¯•åœºæ™¯ 2ï¼šå¿«é€Ÿåˆ‡æ¢é¡µé¢
- **ä¼˜åŒ–å‰**ï¼šç»„ä»¶é”€æ¯åä»æœ‰ `setData` è­¦å‘Š
- **ä¼˜åŒ–å**ï¼šç»„ä»¶é”€æ¯åç«‹å³åœæ­¢æ‰€æœ‰æ›´æ–°

### æµ‹è¯•åœºæ™¯ 3ï¼šç›¸åŒç”¨æˆ·å¤šæ¬¡æ¸²æŸ“
- **ä¼˜åŒ–å‰**ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–° `setData`
- **ä¼˜åŒ–å**ï¼šæ£€æµ‹åˆ°ç›¸åŒ URLï¼Œç›´æ¥è·³è¿‡

## æœ€ä½³å®è·µ

1. **Observer å›è°ƒå¿…é¡»æ£€æŸ¥æ–°æ—§å€¼**
   ```javascript
   observer: function(newVal, oldVal) {
     if (newVal === oldVal) return;
     // å¤„ç†é€»è¾‘
   }
   ```

2. **setData å‰å¿…é¡»æ¯”è¾ƒå½“å‰å€¼**
   ```javascript
   if (newData !== this.data.currentData) {
     this.setData({ currentData: newData });
   }
   ```

3. **ç»„ä»¶å¿…é¡»ç®¡ç†ç”Ÿå‘½å‘¨æœŸçŠ¶æ€**
   ```javascript
   lifetimes: {
     attached() { this._isReady = true; },
     detached() { this._isReady = false; }
   }
   ```

4. **å¼‚æ­¥æ“ä½œå‰æ£€æŸ¥ç»„ä»¶çŠ¶æ€**
   ```javascript
   async loadData() {
     if (!this._isReady) return;
     // å¼‚æ­¥æ“ä½œ
   }
   ```

## ç›¸å…³æ–‡ä»¶

- `miniprogram/components/user-avatar/user-avatar.js` - å¤´åƒç»„ä»¶ï¼ˆå·²ä¼˜åŒ–ï¼‰

## ç‰ˆæœ¬ä¿¡æ¯

- ä¼˜åŒ–æ—¶é—´ï¼š2025-10-24
- ç‰ˆæœ¬æ ‡ç­¾ï¼šå¤´åƒç»„ä»¶æ€§èƒ½ä¼˜åŒ–
- ç›¸å…³é—®é¢˜ï¼šæ§åˆ¶å°åˆ·å± + é‡å¤ setData

