# 📸 编辑生活照功能说明

## 一、功能概述

用户可以编辑孩子的生活照，最多4张可编辑，证件照作为第5张锁定不可编辑。

## 二、功能入口

**路径**：我的 → 我的孩子 → 📸 编辑生活照

## 三、功能特点

### 1. 查看所有照片
- 网格布局（3列）
- 显示所有生活照（包括证件照）
- 点击预览大图

### 2. 证件照锁定
- 显示🔒图标和"证件照"标识
- 金色边框区分
- 不可替换、不可删除
- 始终在末尾位置

### 3. 生活照编辑
- **替换**：点击🔄按钮上传新照片
- **删除**：点击×按钮删除照片
- **添加**：最多4张，点击+号添加
- 自动保存到云存储和数据库

## 四、界面设计

```
┌─────────────────────────────────┐
│ ‹ 编辑生活照      张三            │
├─────────────────────────────────┤
│ 💡 提示信息                      │
│  • 最多4张生活照                 │
│  • 证件照自动添加为第5张锁定      │
├─────────────────────────────────┤
│ 生活照片 (5张)                   │
│                                  │
│  ┌────┐ ┌────┐ ┌────┐           │
│  │ 🔄 │ │ 🔄 │ │ 🔄 │           │
│  │ ×  │ │ ×  │ │ ×  │           │
│  └────┘ └────┘ └────┘           │
│                                  │
│  ┌────┐ ┌────┐                  │
│  │ 🔄 │ │ 🔒 │ ← 证件照（锁定） │
│  │ ×  │ │    │                  │
│  └────┘ └────┘                  │
│                                  │
│  ┌────┐                          │
│  │  + │ ← 添加照片               │
│  └────┘                          │
├─────────────────────────────────┤
│ 📖 使用说明                      │
│  • 点击照片预览大图               │
│  • 点击🔄替换照片                │
│  • 点击×删除照片                 │
│  • 证件照锁定不可编辑             │
│  • 摄影师可下载所有照片参考       │
└─────────────────────────────────┘
```

## 五、操作流程

### 替换照片
```
1. 点击🔄按钮
2. 选择新照片
3. 确认替换
4. 上传到云存储
5. 自动保存到数据库
```

### 删除照片
```
1. 点击×按钮
2. 确认删除
3. 从数组中移除
4. 自动保存到数据库
```

### 添加照片
```
1. 点击+号
2. 选择照片
3. 上传到云存储
4. 插入到证件照前
5. 自动保存到数据库
```

## 六、技术实现

### 1. 数据加载
```javascript
async loadStudentPhotos(studentId) {
  const student = await db.collection('students')
    .where({ studentId }).get();
  
  this.setData({
    lifePhotos: student.lifePhotos || [],
    certificatePhoto: student.certificatePhoto || ''
  });
}
```

### 2. 判断证件照
```javascript
isCertificatePhoto(photoUrl) {
  return photoUrl === this.data.certificatePhoto;
}
```

### 3. 上传照片
```javascript
const cloudPath = `life_photos/${studentId}_${timestamp}.jpg`;
const uploadResult = await wx.cloud.uploadFile({
  cloudPath: cloudPath,
  filePath: tempFilePath
});
```

### 4. 保存到数据库
```javascript
await db.collection('students')
  .where({ studentId })
  .update({
    data: {
      lifePhotos: this.data.lifePhotos,
      updatedAt: new Date().toISOString()
    }
  });
```

## 七、样式特点

### 证件照锁定样式
```css
.photo-item.locked {
  border: 3rpx solid #f59e0b; /* 金色边框 */
}

.photo-lock {
  background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  /* 渐变遮罩，显示锁定标识 */
}
```

### 操作按钮样式
```css
.action-btn.replace {
  background: rgba(59, 130, 246, 0.9); /* 蓝色，替换 */
}

.action-btn.delete {
  background: rgba(239, 68, 68, 0.9); /* 红色，删除 */
}
```

## 八、权限控制

### 用户权限
- ✅ 查看自己孩子的照片
- ✅ 编辑生活照（前4张）
- ❌ 不能编辑证件照
- ❌ 不能查看其他孩子的照片

### 摄影师权限
- ✅ 查看订单中的所有照片
- ✅ 下载所有照片（未来功能）
- ❌ 不能编辑照片

### 管理员权限
- ✅ 查看所有学生的照片
- ✅ 帮助学生编辑照片
- ✅ 批量管理照片（未来功能）

## 九、错误处理

### 1. 照片数量限制
```javascript
if (lifePhotoCount >= 4) {
  wx.showToast({
    title: '最多4张生活照',
    icon: 'none'
  });
  return;
}
```

### 2. 证件照保护
```javascript
if (this.isCertificatePhoto(photoUrl)) {
  wx.showToast({
    title: '证件照不可编辑',
    icon: 'none'
  });
  return;
}
```

### 3. 上传失败处理
```javascript
try {
  await uploadFile();
} catch (e) {
  wx.showToast({
    title: '上传失败',
    icon: 'error'
  });
}
```

## 十、注意事项

1. **证件照位置**：始终在 `lifePhotos` 数组末尾
2. **添加逻辑**：新照片插入到证件照前
3. **云存储路径**：`life_photos/${studentId}_${timestamp}.jpg`
4. **自动保存**：每次操作后立即保存到数据库
5. **UI反馈**：所有操作都有 loading 和 toast 提示

## 十一、未来扩展

### 摄影师下载功能
- 在订单详情页添加"下载所有照片"按钮
- 批量下载或单独下载
- 自动命名：`学生姓名_生活照1.jpg`

### 照片裁剪功能
- 上传后可以裁剪
- 调整照片尺寸
- 添加滤镜效果

### 照片排序功能
- 拖拽排序
- 调整照片顺序
- 证件照始终在末尾

---

**版本**: v2.2  
**更新日期**: 2025-10-15  
**功能**: 编辑生活照（4张可编辑 + 1张锁定）
