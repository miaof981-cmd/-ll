<!--pages/records/records.wxml-->
<view class="records-container">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="header-bar">
    <view class="header-left">
      <text class="header-icon">ğŸ“š</text>
      <text class="header-title">å­¦ç”Ÿæ¡£æ¡ˆ</text>
    </view>
    <!-- ç®¡ç†å‘˜æ“ä½œæŒ‰é’® -->
    <view wx:if="{{isAdmin}}" class="header-actions">
      <view class="icon-btn" bindtap="showAddRecordDialog">
        <text class="icon-btn-icon">+</text>
      </view>
      <view class="icon-btn delete" bindtap="deleteStudent">
        <text class="icon-btn-icon">ğŸ—‘ï¸</text>
      </view>
    </view>
  </view>

  <!-- ç€‘å¸ƒæµæ¡£æ¡ˆå¡ç‰‡ -->
  <view wx:if="{{!loading}}" class="waterfall-container">
    <!-- å­¦ç±æ¡£æ¡ˆå¡ç‰‡ï¼ˆå¤ç”¨é¢„è§ˆé¡µé¢æ ·å¼ï¼‰ -->
    <view wx:if="{{student}}" class="student-archive-card {{archiveExpanded ? 'expanded' : 'collapsed'}}">
      <!-- ç®¡ç†å‘˜ç¼–è¾‘æŒ‰é’® - åœ†å½¢é“…ç¬”å›¾æ ‡ -->
      <view wx:if="{{isAdmin}}" class="floating-edit-btn" catchtap="editStudentBasicInfo">
        <text class="edit-icon">âœï¸</text>
      </view>
      <view class="archive-header" bindtap="toggleArchive">
        <view class="school-logo">ğŸ“</view>
        <view class="school-info">
          <view class="school-name">æ¬¡å…ƒå­¦æ ¡ Â· å­¦ç±æ¡£æ¡ˆ</view>
          <view class="school-subtitle">CIYUAN ACADEMY</view>
        </view>
        <view class="expand-icon">{{archiveExpanded ? 'â–²' : 'â–¼'}}</view>
      </view>

      <!-- ç¼©ç•¥ä¿¡æ¯ï¼ˆæ”¶èµ·æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{!archiveExpanded}}" class="archive-summary">
        <view class="summary-photo">
          <image wx:if="{{student.avatar}}" class="summary-photo-img" src="{{student.avatar}}" mode="aspectFill" />
          <text wx:else class="summary-photo-placeholder">ğŸ“·</text>
        </view>
        <view class="summary-info">
          <view class="summary-row">
            <text class="summary-label">å§“åï¼š</text>
            <text class="summary-value">{{student.name}}</text>
          </view>
          <view class="summary-row">
            <text class="summary-label">å­¦å·ï¼š</text>
            <text class="summary-value">{{student.studentId}}</text>
          </view>
          <view class="summary-row">
            <text class="summary-label">æ€§åˆ«ï¼š</text>
            <text class="summary-value">{{student.gender || 'æœªå¡«å†™'}}</text>
          </view>
        </view>
      </view>

      <!-- è¯¦ç»†ä¿¡æ¯ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{archiveExpanded}}" class="archive-details" catchtap="">
        <!-- è¯ä»¶ç…§åŒºåŸŸ -->
        <view class="photo-section" wx:if="{{student.avatar}}">
          <image class="id-photo" src="{{student.avatar}}" mode="aspectFit" />
        </view>
        <view class="photo-section missing" wx:else>
          <view class="photo-placeholder">
            <view class="placeholder-icon">ğŸ“·</view>
            <view class="placeholder-text">æš‚æ— è¯ä»¶ç…§</view>
          </view>
        </view>

        <!-- å­¦ç”Ÿä¿¡æ¯ -->
        <view class="archive-info-section">
          <view class="archive-info-row">
            <view class="archive-info-label">å­¦å·</view>
            <view class="archive-info-value">{{student.studentId}}</view>
          </view>
          <view class="archive-info-row">
            <view class="archive-info-label">å§“å</view>
            <view class="archive-info-value">{{student.name}}</view>
          </view>
          <view class="archive-info-row">
            <view class="archive-info-label">æ€§åˆ«</view>
            <view class="archive-info-value">{{student.gender || 'æœªå¡«å†™'}}</view>
          </view>
          <view class="archive-info-row">
            <view class="archive-info-label">å¹´é¾„</view>
            <view class="archive-info-value">{{student.age || 'æœªå¡«å†™'}}</view>
          </view>
          <view class="archive-info-row" wx:if="{{student.class && student.class !== 'å¾…åˆ†é…'}}">
            <view class="archive-info-label">ç­çº§</view>
            <view class="archive-info-value">{{student.class}}</view>
          </view>
        </view>

        <!-- å®¶é•¿ä¿¡æ¯ -->
        <view class="archive-section-title">å®¶é•¿ä¿¡æ¯</view>
        <view class="archive-info-section">
          <view class="archive-info-row">
            <view class="archive-info-label">å®¶é•¿å§“å</view>
            <view class="archive-info-value">{{student.parentName || 'æœªå¡«å†™'}}</view>
          </view>
          <view class="archive-info-row">
            <view class="archive-info-label">è”ç³»ç”µè¯</view>
            <view class="archive-info-value">{{student.parentPhone || 'æœªå¡«å†™'}}</view>
          </view>
          <view class="archive-info-row">
            <view class="archive-info-label">è”ç³»å¾®ä¿¡</view>
            <view class="archive-info-value">{{student.parentWechat || 'æœªå¡«å†™'}}</view>
          </view>
        </view>

        <!-- å®¶é•¿æœŸè®¸ -->
        <view wx:if="{{student.expectations}}">
          <view class="archive-section-title">å®¶é•¿æœŸè®¸</view>
          <view class="archive-expectations-content">
            {{student.expectations}}
          </view>
        </view>

        <!-- æ¡£æ¡ˆåº•éƒ¨ä¿¡æ¯ -->
        <view class="archive-footer">
          <view class="footer-text">å»ºæ¡£æ—¥æœŸï¼š{{student.createdAt}}</view>
          <view class="footer-seal">ğŸ« æ¬¡å…ƒå­¦æ ¡å°</view>
        </view>
      </view>
    </view>

    <!-- ç”Ÿæ´»ç…§ç›¸å†Œå¡ç‰‡ -->
    <view wx:if="{{student && (student.avatar || student.certificatePhoto || (student.lifePhotos && student.lifePhotos.length > 0))}}" class="archive-card life-photos-card">
      <view class="card-header">
        <view class="card-icon">ğŸ“¸</view>
        <text class="card-type">ç”Ÿæ´»ç…§ç›¸å†Œ</text>
        <text class="photo-count">({{displayPhotoCount}}å¼ )</text>
        <view class="edit-icon" catchtap="editLifePhotos">
          <text>âœï¸</text>
        </view>
      </view>
      <view class="card-body">
        <view class="life-photos-grid">
          <!-- ç¬¬ä¸€å¼ ï¼šè¯ä»¶ç…§ï¼ˆé”å®šï¼‰- ä½¿ç”¨ avatar å­—æ®µ -->
          <view 
            wx:if="{{student.avatar || student.certificatePhoto}}"
            class="life-photo-item locked"
            bindtap="previewLifePhoto"
            data-index="0"
          >
            <image class="life-photo-img" src="{{student.avatar || student.certificatePhoto}}" mode="aspectFill"/>
            <view class="photo-lock-badge">
              <text class="lock-icon">ğŸ”’</text>
            </view>
          </view>
          
          <!-- ç¬¬äºŒå¼ ï¼šç”Ÿæ´»ç…§ -->
          <view 
            wx:if="{{displayPhotos[0]}}"
            class="life-photo-item"
            bindtap="previewLifePhoto"
            data-index="1"
          >
            <image class="life-photo-img" src="{{displayPhotos[0]}}" mode="aspectFill"/>
          </view>
          
          <!-- ç¬¬ä¸‰å¼ ï¼šç”Ÿæ´»ç…§ æˆ– æ›´å¤šæ ‡è¯† -->
          <view 
            wx:if="{{displayPhotos[1]}}"
            class="life-photo-item {{hasMorePhotos ? 'more-photos' : ''}}"
            bindtap="previewLifePhoto"
            data-index="2"
          >
            <image class="life-photo-img" src="{{displayPhotos[1]}}" mode="aspectFill"/>
            <!-- å¦‚æœæœ‰æ›´å¤šç…§ç‰‡ï¼Œæ˜¾ç¤ºé®ç½© -->
            <view wx:if="{{hasMorePhotos}}" class="more-overlay">
              <text class="more-count">+{{morePhotoCount}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆç»©å¡ç‰‡ -->
    <view 
      wx:for="{{records.reportCards}}" 
      wx:key="_id" 
      class="archive-card grade-card"
    >
      <view class="card-header">
        <view class="card-icon">ğŸ“Š</view>
        <text class="card-type">æˆç»©æŠ¥å‘Š</text>
        <!-- ç®¡ç†å‘˜ç¼–è¾‘æŒ‰é’® -->
        <view wx:if="{{isAdmin}}" class="card-actions">
          <view class="card-edit-icon" bindtap="editRecord" data-id="{{item._id}}" data-type="grade" data-item="{{item}}">
            <text>âœï¸</text>
          </view>
          <view class="card-delete-icon" bindtap="deleteRecord" data-id="{{item._id}}" data-type="grade">
            <text>ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
      <view class="card-body">
        <text class="card-title">{{item.term}}</text>
        <view class="grade-grid">
          <view class="grade-item">
            <text class="subject">è¯­æ–‡</text>
            <text class="score">{{item.chinese}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">æ•°å­¦</text>
            <text class="score">{{item.math}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">è‹±è¯­</text>
            <text class="score">{{item.english}}</text>
          </view>
        </view>
      </view>
      <view class="card-footer">
        <view class="average-badge">
          <text>å¹³å‡åˆ†ï¼š{{item.average || '-'}}</text>
        </view>
      </view>
    </view>

    <!-- å¤„ç½šè®°å½•å¡ç‰‡ -->
    <view 
      wx:for="{{records.punishments}}" 
      wx:key="_id" 
      class="archive-card punishment-card"
    >
      <view class="card-header">
        <view class="card-icon warning">âš ï¸</view>
        <text class="card-type">å¤„ç½šè®°å½•</text>
        <!-- ç®¡ç†å‘˜ç¼–è¾‘æŒ‰é’® -->
        <view wx:if="{{isAdmin}}" class="card-actions">
          <view class="card-edit-icon" bindtap="editRecord" data-id="{{item._id}}" data-type="punishment" data-item="{{item}}">
            <text>âœï¸</text>
          </view>
          <view class="card-delete-icon" bindtap="deleteRecord" data-id="{{item._id}}" data-type="punishment">
            <text>ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
      <view class="card-body">
        <view class="punishment-type">
          <text class="type-label">ç±»å‹ï¼š</text>
          <text class="type-value">{{item.type}}</text>
        </view>
        <text class="punishment-reason">{{item.reason}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">ğŸ“… {{item.createdAt}}</text>
      </view>
    </view>

    <!-- å›¾ç‰‡æ¡£æ¡ˆå¡ç‰‡ -->
    <view 
      wx:for="{{records.images}}" 
      wx:key="_id" 
      class="archive-card image-card"
      bindtap="previewImage"
      data-url="{{item.imageUrl}}"
    >
      <view class="card-header">
        <view class="card-icon">ğŸ–¼ï¸</view>
        <text class="card-type">{{item.activityName || 'å›¾ç‰‡æ¡£æ¡ˆ'}}</text>
        <!-- ç®¡ç†å‘˜ç¼–è¾‘æŒ‰é’® -->
        <view wx:if="{{isAdmin}}" class="card-actions">
          <view class="card-edit-icon" catchtap="editRecord" data-id="{{item._id}}" data-type="image" data-item="{{item}}">
            <text>âœï¸</text>
          </view>
          <view class="card-delete-icon" catchtap="deleteRecord" data-id="{{item._id}}" data-type="image">
            <text>ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
      <!-- å›¾ç‰‡å®¹å™¨ï¼Œç»Ÿä¸€åœ†è§’è¾¹æ¡† -->
      <view class="image-container">
        <image class="card-image" src="{{item.imageUrl}}" mode="aspectFill" />
      </view>
      <view class="card-body">
        <text class="card-title">{{item.title}}</text>
        <text wx:if="{{item.description}}" class="card-desc">{{item.description}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">ğŸ“… {{item.createdAt}}</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{records.reportCards.length === 0 && records.punishments.length === 0 && records.images.length === 0 && (!student.lifePhotos || student.lifePhotos.length === 0)}}" class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— æ¡£æ¡ˆè®°å½•</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- æ·»åŠ æ¡£æ¡ˆå¼¹çª— -->
<view class="add-dialog-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog">
  <view class="add-dialog" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">
        {{addRecordType === 'grade' ? 'æ·»åŠ æˆç»©' : addRecordType === 'punishment' ? 'æ·»åŠ å¤„åˆ†' : 'æ·»åŠ å›¾ç‰‡æ¡£æ¡ˆ'}}
      </text>
      <view class="dialog-close" bindtap="closeAddDialog">Ã—</view>
    </view>

    <view class="dialog-body">
      <!-- æ·»åŠ æˆç»© -->
      <view wx:if="{{addRecordType === 'grade'}}">
        <view class="form-item">
          <text class="label">å­¦æœŸ *</text>
          <input class="input" placeholder="å¦‚ï¼š2024-2025ä¸Šå­¦æœŸ" bindinput="onRecordInput" data-field="term" />
        </view>
        <view class="form-item">
          <text class="label">è¯­æ–‡ *</text>
          <input class="input" type="digit" placeholder="è¯·è¾“å…¥åˆ†æ•°" bindinput="onRecordInput" data-field="chinese" />
        </view>
        <view class="form-item">
          <text class="label">æ•°å­¦</text>
          <input class="input" type="digit" placeholder="è¯·è¾“å…¥åˆ†æ•°" bindinput="onRecordInput" data-field="math" />
        </view>
        <view class="form-item">
          <text class="label">è‹±è¯­</text>
          <input class="input" type="digit" placeholder="è¯·è¾“å…¥åˆ†æ•°" bindinput="onRecordInput" data-field="english" />
        </view>
      </view>

      <!-- æ·»åŠ å¤„åˆ† -->
      <view wx:if="{{addRecordType === 'punishment'}}">
        <view class="form-item">
          <text class="label">å¤„åˆ†ç±»å‹ *</text>
          <input class="input" placeholder="å¦‚ï¼šè­¦å‘Šã€è®°è¿‡" bindinput="onRecordInput" data-field="type" />
        </view>
        <view class="form-item">
          <text class="label">åŸå›  *</text>
          <textarea class="textarea" placeholder="è¯·è¾“å…¥å¤„åˆ†åŸå› " bindinput="onRecordInput" data-field="reason" maxlength="200"></textarea>
        </view>
      </view>

      <!-- æ·»åŠ å›¾ç‰‡æ¡£æ¡ˆ -->
      <view wx:if="{{addRecordType === 'image'}}">
        <view class="form-item">
          <text class="label">æ ‡é¢˜ *</text>
          <input class="input" placeholder="è¯·è¾“å…¥æ ‡é¢˜" bindinput="onRecordInput" data-field="title" />
        </view>
        <view class="form-item">
          <text class="label">æè¿°</text>
          <textarea class="textarea" placeholder="è¯·è¾“å…¥æè¿°" bindinput="onRecordInput" data-field="description" maxlength="200"></textarea>
        </view>
        <view class="form-item">
          <text class="label">å›¾ç‰‡ *</text>
          <view class="image-upload">
            <image wx:if="{{newRecord.imageUrl}}" class="preview" src="{{newRecord.imageUrl}}" mode="aspectFill" />
            <view wx:else class="upload-btn" bindtap="uploadRecordImage">
              <text>+</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeAddDialog">å–æ¶ˆ</button>
      <button class="btn-save" bindtap="saveNewRecord">ä¿å­˜</button>
    </view>
  </view>
</view>
