<!--pages/records/records.wxml-->
<view class="records-container">
  <!-- 顶部标题栏 -->
  <view class="header-bar">
    <view class="header-left">
      <text class="header-icon">📚</text>
      <text class="header-title">学生档案</text>
    </view>
    <view class="header-right" wx:if="{{isAdmin}}">
      <button class="btn-edit" bindtap="toggleEdit">
        {{isEditing ? '完成' : '编辑'}}
      </button>
      <button class="btn-add" wx:if="{{isEditing}}" bindtap="showAddRecordDialog">
        + 添加
      </button>
    </view>
    <view class="header-action" wx:else bindtap="logout">
      <text class="action-text">退出</text>
    </view>
  </view>

  <!-- 瀑布流档案卡片 -->
  <view wx:if="{{!loading}}" class="waterfall-container">
    <!-- 学籍档案卡片 -->
    <view wx:if="{{student}}" class="archive-card profile-card {{isEditing ? 'editing' : ''}}">
      <view class="card-header">
        <view class="card-icon">🎓</view>
        <text class="card-type">学籍档案</text>
      </view>
      <view class="card-body profile-body">
        <view class="profile-photo-wrapper">
          <text class="photo-title">📸 证件照</text>
          <view class="profile-photo">
            <image wx:if="{{student.avatar}}" class="photo-img" src="{{student.avatar}}" mode="aspectFit" />
            <text wx:else class="photo-placeholder">📷</text>
          </view>
        </view>
        <view class="profile-info">
          <view class="info-row">
            <text class="info-label">姓名</text>
            <text class="info-value">{{student.name}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">学号</text>
            <text class="info-value">{{student.studentId}}</text>
          </view>
          <view class="info-row" wx:if="{{student.class && student.class !== '待分配'}}">
            <text class="info-label">班级</text>
            <text class="info-value">{{student.class}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">性别</text>
            <text class="info-value">{{student.gender || '-'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">年龄</text>
            <text class="info-value">{{student.age || '-'}}岁</text>
          </view>
          <view class="info-row">
            <text class="info-label">家长姓名</text>
            <text class="info-value">{{student.parentName || '-'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">联系电话</text>
            <text class="info-value">{{student.parentPhone || '-'}}</text>
          </view>
          <view class="info-row" wx:if="{{student.parentWechat}}">
            <text class="info-label">家长微信</text>
            <text class="info-value">{{student.parentWechat}}</text>
          </view>
        </view>
        <view wx:if="{{student.expectations}}" class="expectations-section">
          <view class="expectations-title">💭 家长期许</view>
          <view class="expectations-content">{{student.expectations}}</view>
        </view>
      </view>
    </view>

    <!-- 成绩卡片 -->
    <view 
      wx:for="{{records.reportCards}}" 
      wx:key="_id" 
      class="archive-card grade-card {{isEditing ? 'editing' : ''}}"
    >
      <view class="card-header">
        <view class="card-icon">📊</view>
        <text class="card-type">成绩报告</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="grade">
          <text>×</text>
        </view>
      </view>
      <view class="card-body">
        <text class="card-title">{{item.term}}</text>
        <view class="grade-grid">
          <view class="grade-item">
            <text class="subject">语文</text>
            <text class="score">{{item.chinese}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">数学</text>
            <text class="score">{{item.math}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">英语</text>
            <text class="score">{{item.english}}</text>
          </view>
        </view>
      </view>
      <view class="card-footer">
        <view class="average-badge">
          <text>平均分：{{item.average || '-'}}</text>
        </view>
      </view>
    </view>

    <!-- 处罚记录卡片 -->
    <view 
      wx:for="{{records.punishments}}" 
      wx:key="_id" 
      class="archive-card punishment-card {{isEditing ? 'editing' : ''}}"
    >
      <view class="card-header">
        <view class="card-icon warning">⚠️</view>
        <text class="card-type">处罚记录</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="punishment">
          <text>×</text>
        </view>
      </view>
      <view class="card-body">
        <view class="punishment-type">
          <text class="type-label">类型：</text>
          <text class="type-value">{{item.type}}</text>
        </view>
        <text class="punishment-reason">{{item.reason}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">📅 {{item.createdAt}}</text>
      </view>
    </view>

    <!-- 图片档案卡片 -->
    <view 
      wx:for="{{records.images}}" 
      wx:key="_id" 
      class="archive-card image-card {{isEditing ? 'editing' : ''}}"
      bindtap="{{isEditing ? '' : 'previewImage'}}"
      data-url="{{item.imageUrl}}"
    >
      <view class="card-header">
        <view class="card-icon">🖼️</view>
        <text class="card-type">图片档案</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="image">
          <text>×</text>
        </view>
      </view>
      <image class="card-image" src="{{item.imageUrl}}" mode="widthFix" />
      <view class="card-body">
        <text class="card-title">{{item.title}}</text>
        <text class="card-desc">{{item.description}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">📅 {{item.createdAt}}</text>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{records.reportCards.length === 0 && records.punishments.length === 0 && records.images.length === 0}}" class="empty-state">
      <view class="empty-icon">📋</view>
      <text class="empty-text">暂无档案记录</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 添加档案弹窗 -->
<view class="add-dialog-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog">
  <view class="add-dialog" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">
        {{addRecordType === 'grade' ? '添加成绩' : addRecordType === 'punishment' ? '添加处分' : '添加图片档案'}}
      </text>
      <view class="dialog-close" bindtap="closeAddDialog">×</view>
    </view>

    <view class="dialog-body">
      <!-- 添加成绩 -->
      <view wx:if="{{addRecordType === 'grade'}}">
        <view class="form-item">
          <text class="label">学期 *</text>
          <input class="input" placeholder="如：2024-2025上学期" bindinput="onRecordInput" data-field="term" />
        </view>
        <view class="form-item">
          <text class="label">语文 *</text>
          <input class="input" type="digit" placeholder="请输入分数" bindinput="onRecordInput" data-field="chinese" />
        </view>
        <view class="form-item">
          <text class="label">数学</text>
          <input class="input" type="digit" placeholder="请输入分数" bindinput="onRecordInput" data-field="math" />
        </view>
        <view class="form-item">
          <text class="label">英语</text>
          <input class="input" type="digit" placeholder="请输入分数" bindinput="onRecordInput" data-field="english" />
        </view>
      </view>

      <!-- 添加处分 -->
      <view wx:if="{{addRecordType === 'punishment'}}">
        <view class="form-item">
          <text class="label">处分类型 *</text>
          <input class="input" placeholder="如：警告、记过" bindinput="onRecordInput" data-field="type" />
        </view>
        <view class="form-item">
          <text class="label">原因 *</text>
          <textarea class="textarea" placeholder="请输入处分原因" bindinput="onRecordInput" data-field="reason" maxlength="200"></textarea>
        </view>
      </view>

      <!-- 添加图片档案 -->
      <view wx:if="{{addRecordType === 'image'}}">
        <view class="form-item">
          <text class="label">标题 *</text>
          <input class="input" placeholder="请输入标题" bindinput="onRecordInput" data-field="title" />
        </view>
        <view class="form-item">
          <text class="label">描述</text>
          <textarea class="textarea" placeholder="请输入描述" bindinput="onRecordInput" data-field="description" maxlength="200"></textarea>
        </view>
        <view class="form-item">
          <text class="label">图片 *</text>
          <view class="image-upload">
            <image wx:if="{{newRecord.imageUrl}}" class="preview" src="{{newRecord.imageUrl}}" mode="aspectFill" />
            <view wx:else class="upload-btn" bindtap="uploadRecordImage">
              <text>+</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeAddDialog">取消</button>
      <button class="btn-save" bindtap="saveNewRecord">保存</button>
    </view>
  </view>
</view>
