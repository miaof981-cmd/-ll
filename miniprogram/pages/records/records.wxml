<!--pages/records/records.wxml-->
<view class="records-container">
  <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-profile-card">
    <view class="profile-avatar">
      <text class="avatar-icon">ğŸ‘¤</text>
    </view>
    <view class="profile-info">
      <text class="profile-name">{{userInfo.name}}</text>
      <text class="profile-id">å­¦å·ï¼š{{userInfo.studentId}}</text>
    </view>
    <view class="profile-action" bindtap="logout">
      <text class="action-text">é€€å‡º</text>
    </view>
  </view>

  <!-- æ¡£æ¡ˆæ ‡é¢˜ -->
  <view class="section-title-bar">
    <view class="title-left">
      <text class="section-icon">ğŸ“š</text>
      <text class="section-title">å­¦ç”Ÿæ¡£æ¡ˆ</text>
    </view>
    <view class="title-right" wx:if="{{isAdmin}}">
      <button class="btn-edit" bindtap="toggleEdit">
        {{isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}
      </button>
      <button class="btn-add" wx:if="{{isEditing}}" bindtap="showAddRecordDialog">
        + æ·»åŠ 
      </button>
    </view>
  </view>

  <!-- ç€‘å¸ƒæµæ¡£æ¡ˆå¡ç‰‡ -->
  <view wx:if="{{!loading}}" class="waterfall-container">
    <!-- æˆç»©å¡ç‰‡ -->
    <view 
      wx:for="{{records.reportCards}}" 
      wx:key="_id" 
      class="archive-card grade-card {{isEditing ? 'editing' : ''}}"
    >
      <view class="card-header">
        <view class="card-icon">ğŸ“Š</view>
        <text class="card-type">æˆç»©æŠ¥å‘Š</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="grade">
          <text>Ã—</text>
        </view>
      </view>
      <view class="card-body">
        <text class="card-title">{{item.term}}</text>
        <view class="grade-grid">
          <view class="grade-item">
            <text class="subject">è¯­æ–‡</text>
            <text class="score">{{item.chinese}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">æ•°å­¦</text>
            <text class="score">{{item.math}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">è‹±è¯­</text>
            <text class="score">{{item.english}}</text>
          </view>
        </view>
      </view>
      <view class="card-footer">
        <view class="average-badge">
          <text>å¹³å‡åˆ†ï¼š{{item.average || '-'}}</text>
        </view>
      </view>
    </view>

    <!-- å¤„ç½šè®°å½•å¡ç‰‡ -->
    <view 
      wx:for="{{records.punishments}}" 
      wx:key="_id" 
      class="archive-card punishment-card {{isEditing ? 'editing' : ''}}"
    >
      <view class="card-header">
        <view class="card-icon warning">âš ï¸</view>
        <text class="card-type">å¤„ç½šè®°å½•</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="punishment">
          <text>Ã—</text>
        </view>
      </view>
      <view class="card-body">
        <view class="punishment-type">
          <text class="type-label">ç±»å‹ï¼š</text>
          <text class="type-value">{{item.type}}</text>
        </view>
        <text class="punishment-reason">{{item.reason}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">ğŸ“… {{item.createdAt}}</text>
      </view>
    </view>

    <!-- å›¾ç‰‡æ¡£æ¡ˆå¡ç‰‡ -->
    <view 
      wx:for="{{records.images}}" 
      wx:key="_id" 
      class="archive-card image-card {{isEditing ? 'editing' : ''}}"
      bindtap="{{isEditing ? '' : 'previewImage'}}"
      data-url="{{item.imageUrl}}"
    >
      <view class="card-header">
        <view class="card-icon">ğŸ–¼ï¸</view>
        <text class="card-type">å›¾ç‰‡æ¡£æ¡ˆ</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="image">
          <text>Ã—</text>
        </view>
      </view>
      <image class="card-image" src="{{item.imageUrl}}" mode="widthFix" />
      <view class="card-body">
        <text class="card-title">{{item.title}}</text>
        <text class="card-desc">{{item.description}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">ğŸ“… {{item.createdAt}}</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{records.reportCards.length === 0 && records.punishments.length === 0 && records.images.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— æ¡£æ¡ˆè®°å½•</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- æ·»åŠ æ¡£æ¡ˆå¼¹çª— -->
<view class="add-dialog-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog">
  <view class="add-dialog" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">
        {{addRecordType === 'grade' ? 'æ·»åŠ æˆç»©' : addRecordType === 'punishment' ? 'æ·»åŠ å¤„åˆ†' : 'æ·»åŠ å›¾ç‰‡æ¡£æ¡ˆ'}}
      </text>
      <view class="dialog-close" bindtap="closeAddDialog">Ã—</view>
    </view>

    <view class="dialog-body">
      <!-- æ·»åŠ æˆç»© -->
      <view wx:if="{{addRecordType === 'grade'}}">
        <view class="form-item">
          <text class="label">å­¦æœŸ *</text>
          <input class="input" placeholder="å¦‚ï¼š2024-2025ä¸Šå­¦æœŸ" bindinput="onRecordInput" data-field="term" />
        </view>
        <view class="form-item">
          <text class="label">è¯­æ–‡ *</text>
          <input class="input" type="digit" placeholder="è¯·è¾“å…¥åˆ†æ•°" bindinput="onRecordInput" data-field="chinese" />
        </view>
        <view class="form-item">
          <text class="label">æ•°å­¦</text>
          <input class="input" type="digit" placeholder="è¯·è¾“å…¥åˆ†æ•°" bindinput="onRecordInput" data-field="math" />
        </view>
        <view class="form-item">
          <text class="label">è‹±è¯­</text>
          <input class="input" type="digit" placeholder="è¯·è¾“å…¥åˆ†æ•°" bindinput="onRecordInput" data-field="english" />
        </view>
      </view>

      <!-- æ·»åŠ å¤„åˆ† -->
      <view wx:if="{{addRecordType === 'punishment'}}">
        <view class="form-item">
          <text class="label">å¤„åˆ†ç±»å‹ *</text>
          <input class="input" placeholder="å¦‚ï¼šè­¦å‘Šã€è®°è¿‡" bindinput="onRecordInput" data-field="type" />
        </view>
        <view class="form-item">
          <text class="label">åŸå›  *</text>
          <textarea class="textarea" placeholder="è¯·è¾“å…¥å¤„åˆ†åŸå› " bindinput="onRecordInput" data-field="reason" maxlength="200"></textarea>
        </view>
      </view>

      <!-- æ·»åŠ å›¾ç‰‡æ¡£æ¡ˆ -->
      <view wx:if="{{addRecordType === 'image'}}">
        <view class="form-item">
          <text class="label">æ ‡é¢˜ *</text>
          <input class="input" placeholder="è¯·è¾“å…¥æ ‡é¢˜" bindinput="onRecordInput" data-field="title" />
        </view>
        <view class="form-item">
          <text class="label">æè¿°</text>
          <textarea class="textarea" placeholder="è¯·è¾“å…¥æè¿°" bindinput="onRecordInput" data-field="description" maxlength="200"></textarea>
        </view>
        <view class="form-item">
          <text class="label">å›¾ç‰‡ *</text>
          <view class="image-upload">
            <image wx:if="{{newRecord.imageUrl}}" class="preview" src="{{newRecord.imageUrl}}" mode="aspectFill" />
            <view wx:else class="upload-btn" bindtap="uploadRecordImage">
              <text>+</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeAddDialog">å–æ¶ˆ</button>
      <button class="btn-save" bindtap="saveNewRecord">ä¿å­˜</button>
    </view>
  </view>
</view>
