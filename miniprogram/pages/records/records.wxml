<!--pages/records/records.wxml-->
<view class="records-container">
  <!-- 顶部标题栏 -->
  <view class="header-bar">
    <view class="header-left">
      <text class="header-icon">📚</text>
      <text class="header-title">学生档案</text>
    </view>
    <view class="header-right" wx:if="{{isAdmin}}">
      <button class="btn-edit" bindtap="toggleEdit">
        {{isEditing ? '完成' : '编辑'}}
      </button>
      <button class="btn-add" wx:if="{{isEditing}}" bindtap="showAddRecordDialog">
        + 添加
      </button>
    </view>
    <view class="header-action" wx:else bindtap="logout">
      <text class="action-text">退出</text>
    </view>
  </view>

  <!-- 瀑布流档案卡片 -->
  <view wx:if="{{!loading}}" class="waterfall-container">
    <!-- 学籍档案卡片（复用预览页面样式） -->
    <view wx:if="{{student}}" class="student-archive-card">
      <view class="archive-header">
        <view class="school-logo">🎓</view>
        <view class="school-info">
          <view class="school-name">次元学校</view>
          <view class="school-subtitle">CIYUAN ACADEMY</view>
        </view>
      </view>

      <view class="archive-title">学籍档案</view>

      <!-- 证件照区域 -->
      <view class="photo-section" wx:if="{{student.avatar}}">
        <image class="id-photo" src="{{student.avatar}}" mode="aspectFit" />
        <view class="photo-label">证件照</view>
      </view>
      <view class="photo-section missing" wx:else>
        <view class="photo-placeholder">
          <view class="placeholder-icon">📷</view>
          <view class="placeholder-text">暂无证件照</view>
        </view>
      </view>

      <!-- 学生信息 -->
      <view class="archive-info-section">
        <view class="archive-info-row">
          <view class="archive-info-label">学号</view>
          <view class="archive-info-value">{{student.studentId}}</view>
        </view>
        <view class="archive-info-row">
          <view class="archive-info-label">姓名</view>
          <view class="archive-info-value">{{student.name}}</view>
        </view>
        <view class="archive-info-row">
          <view class="archive-info-label">性别</view>
          <view class="archive-info-value">{{student.gender || '未填写'}}</view>
        </view>
        <view class="archive-info-row">
          <view class="archive-info-label">年龄</view>
          <view class="archive-info-value">{{student.age || '未填写'}}</view>
        </view>
        <view class="archive-info-row" wx:if="{{student.class && student.class !== '待分配'}}">
          <view class="archive-info-label">班级</view>
          <view class="archive-info-value">{{student.class}}</view>
        </view>
      </view>

      <!-- 家长信息 -->
      <view class="archive-section-title">家长信息</view>
      <view class="archive-info-section">
        <view class="archive-info-row">
          <view class="archive-info-label">家长姓名</view>
          <view class="archive-info-value">{{student.parentName || '未填写'}}</view>
        </view>
        <view class="archive-info-row">
          <view class="archive-info-label">联系电话</view>
          <view class="archive-info-value">{{student.parentPhone || '未填写'}}</view>
        </view>
        <view class="archive-info-row">
          <view class="archive-info-label">联系微信</view>
          <view class="archive-info-value">{{student.parentWechat || '未填写'}}</view>
        </view>
      </view>

      <!-- 家长期许 -->
      <view wx:if="{{student.expectations}}">
        <view class="archive-section-title">家长期许</view>
        <view class="archive-expectations-content">
          {{student.expectations}}
        </view>
      </view>

      <!-- 档案底部信息 -->
      <view class="archive-footer">
        <view class="footer-text">建档日期：{{student.createdAt}}</view>
        <view class="footer-seal">🏫 次元学校印</view>
      </view>
    </view>

    <!-- 成绩卡片 -->
    <view 
      wx:for="{{records.reportCards}}" 
      wx:key="_id" 
      class="archive-card grade-card {{isEditing ? 'editing' : ''}}"
    >
      <view class="card-header">
        <view class="card-icon">📊</view>
        <text class="card-type">成绩报告</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="grade">
          <text>×</text>
        </view>
      </view>
      <view class="card-body">
        <text class="card-title">{{item.term}}</text>
        <view class="grade-grid">
          <view class="grade-item">
            <text class="subject">语文</text>
            <text class="score">{{item.chinese}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">数学</text>
            <text class="score">{{item.math}}</text>
          </view>
          <view class="grade-item">
            <text class="subject">英语</text>
            <text class="score">{{item.english}}</text>
          </view>
        </view>
      </view>
      <view class="card-footer">
        <view class="average-badge">
          <text>平均分：{{item.average || '-'}}</text>
        </view>
      </view>
    </view>

    <!-- 处罚记录卡片 -->
    <view 
      wx:for="{{records.punishments}}" 
      wx:key="_id" 
      class="archive-card punishment-card {{isEditing ? 'editing' : ''}}"
    >
      <view class="card-header">
        <view class="card-icon warning">⚠️</view>
        <text class="card-type">处罚记录</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="punishment">
          <text>×</text>
        </view>
      </view>
      <view class="card-body">
        <view class="punishment-type">
          <text class="type-label">类型：</text>
          <text class="type-value">{{item.type}}</text>
        </view>
        <text class="punishment-reason">{{item.reason}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">📅 {{item.createdAt}}</text>
      </view>
    </view>

    <!-- 图片档案卡片 -->
    <view 
      wx:for="{{records.images}}" 
      wx:key="_id" 
      class="archive-card image-card {{isEditing ? 'editing' : ''}}"
      bindtap="{{isEditing ? '' : 'previewImage'}}"
      data-url="{{item.imageUrl}}"
    >
      <view class="card-header">
        <view class="card-icon">🖼️</view>
        <text class="card-type">图片档案</text>
        <view class="card-delete" wx:if="{{isEditing}}" bindtap="deleteRecord" data-id="{{item._id}}" data-type="image">
          <text>×</text>
        </view>
      </view>
      <image class="card-image" src="{{item.imageUrl}}" mode="widthFix" />
      <view class="card-body">
        <text class="card-title">{{item.title}}</text>
        <text class="card-desc">{{item.description}}</text>
      </view>
      <view class="card-footer">
        <text class="card-date">📅 {{item.createdAt}}</text>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{records.reportCards.length === 0 && records.punishments.length === 0 && records.images.length === 0}}" class="empty-state">
      <view class="empty-icon">📋</view>
      <text class="empty-text">暂无档案记录</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 添加档案弹窗 -->
<view class="add-dialog-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog">
  <view class="add-dialog" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">
        {{addRecordType === 'grade' ? '添加成绩' : addRecordType === 'punishment' ? '添加处分' : '添加图片档案'}}
      </text>
      <view class="dialog-close" bindtap="closeAddDialog">×</view>
    </view>

    <view class="dialog-body">
      <!-- 添加成绩 -->
      <view wx:if="{{addRecordType === 'grade'}}">
        <view class="form-item">
          <text class="label">学期 *</text>
          <input class="input" placeholder="如：2024-2025上学期" bindinput="onRecordInput" data-field="term" />
        </view>
        <view class="form-item">
          <text class="label">语文 *</text>
          <input class="input" type="digit" placeholder="请输入分数" bindinput="onRecordInput" data-field="chinese" />
        </view>
        <view class="form-item">
          <text class="label">数学</text>
          <input class="input" type="digit" placeholder="请输入分数" bindinput="onRecordInput" data-field="math" />
        </view>
        <view class="form-item">
          <text class="label">英语</text>
          <input class="input" type="digit" placeholder="请输入分数" bindinput="onRecordInput" data-field="english" />
        </view>
      </view>

      <!-- 添加处分 -->
      <view wx:if="{{addRecordType === 'punishment'}}">
        <view class="form-item">
          <text class="label">处分类型 *</text>
          <input class="input" placeholder="如：警告、记过" bindinput="onRecordInput" data-field="type" />
        </view>
        <view class="form-item">
          <text class="label">原因 *</text>
          <textarea class="textarea" placeholder="请输入处分原因" bindinput="onRecordInput" data-field="reason" maxlength="200"></textarea>
        </view>
      </view>

      <!-- 添加图片档案 -->
      <view wx:if="{{addRecordType === 'image'}}">
        <view class="form-item">
          <text class="label">标题 *</text>
          <input class="input" placeholder="请输入标题" bindinput="onRecordInput" data-field="title" />
        </view>
        <view class="form-item">
          <text class="label">描述</text>
          <textarea class="textarea" placeholder="请输入描述" bindinput="onRecordInput" data-field="description" maxlength="200"></textarea>
        </view>
        <view class="form-item">
          <text class="label">图片 *</text>
          <view class="image-upload">
            <image wx:if="{{newRecord.imageUrl}}" class="preview" src="{{newRecord.imageUrl}}" mode="aspectFill" />
            <view wx:else class="upload-btn" bindtap="uploadRecordImage">
              <text>+</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeAddDialog">取消</button>
      <button class="btn-save" bindtap="saveNewRecord">保存</button>
    </view>
  </view>
</view>
