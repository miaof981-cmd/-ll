<view class="order-detail-page">
  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>

  <view wx:else class="order-container">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-card">
      <view class="status-icon" style="color: {{order.statusColor}}">{{order.statusIcon}}</view>
      <view class="status-info">
        <text class="status-text" style="color: {{order.statusColor}}">{{order.statusText}}</text>
        <text class="status-time">{{order.updatedAt || order.createdAt}}</text>
      </view>
    </view>

    <!-- æ´»åŠ¨ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">æ´»åŠ¨ä¿¡æ¯</view>
      <view wx:if="{{activityInfo}}" class="activity-info">
        <image class="activity-cover" src="{{activityInfo.coverImage}}" mode="aspectFill"></image>
        <view class="activity-details">
          <text class="activity-title">{{activityInfo.title}}</text>
          <text class="activity-subtitle">{{activityInfo.subtitle}}</text>
          <text class="activity-price">Â¥{{order.totalPrice}}</text>
        </view>
      </view>
      <view wx:else class="no-data">æ´»åŠ¨å·²åˆ é™¤</view>
    </view>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">ç”¨æˆ·ä¿¡æ¯</view>
      <view class="info-row">
        <text class="label">ç”¨æˆ·æ˜µç§°</text>
        <text class="value">{{userInfo ? userInfo.nickName : 'æœªçŸ¥'}}</text>
      </view>
      <view class="info-row">
        <text class="label">OpenID</text>
        <text class="value code">{{order._openid}}</text>
      </view>
      <view wx:if="{{userInfo && userInfo.phone}}" class="info-row">
        <text class="label">è”ç³»ç”µè¯</text>
        <text class="value contact" bindtap="contactUser">{{userInfo.phone}}</text>
      </view>
    </view>

    <!-- æ‘„å½±å¸ˆä¿¡æ¯ -->
    <view wx:if="{{photographerInfo}}" class="section-card">
      <view class="section-title">æ‘„å½±å¸ˆä¿¡æ¯</view>
      <view class="photographer-info">
        <image wx:if="{{photographerInfo.avatar}}" class="photographer-avatar" src="{{photographerInfo.avatar}}" mode="aspectFill"></image>
        <view wx:else class="photographer-avatar-placeholder">{{photographerInfo.name.substring(0,1)}}</view>
        <view class="photographer-details">
          <text class="photographer-name">{{photographerInfo.name}}</text>
          <text class="photographer-specialty">{{photographerInfo.specialty || 'ä¸“ä¸šæ‘„å½±å¸ˆ'}}</text>
        </view>
      </view>
    </view>

    <!-- ä½œå“ç…§ç‰‡ -->
    <view wx:if="{{order.photos && order.photos.length > 0}}" class="section-card">
      <view class="section-title">æäº¤ä½œå“ï¼ˆ{{order.photos.length}}å¼ ï¼‰</view>
      <view class="photos-grid">
        <image 
          wx:for="{{order.photos}}" 
          wx:key="index" 
          class="photo-item"
          src="{{item}}" 
          mode="aspectFill"
          bindtap="previewPhoto"
          data-url="{{item}}"
        />
      </view>
    </view>

    <!-- å¤„ç†è®°å½•ï¼ˆæ—¶é—´çº¿ï¼‰ -->
    <view class="section-card">
      <view class="section-title">å¤„ç†è®°å½•</view>
      <view class="timeline">
        <!-- æœ€æ–°çŠ¶æ€ï¼ˆå¦‚æœæœ‰å½“å‰ä½œå“ï¼‰ -->
        <view wx:if="{{order.photos && order.photos.length > 0 && order.status === 'pending_review'}}" class="timeline-item">
          <view class="timeline-dot current"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <text class="timeline-label">ğŸ“¸ æ‘„å½±å¸ˆæäº¤ä½œå“</text>
              <text class="timeline-time">{{order.submittedAt}}</text>
            </view>
            <view class="current-photos">
              <view class="history-photos-grid">
                <image 
                  wx:for="{{order.photos}}" 
                  wx:key="index"
                  class="history-photo"
                  src="{{item}}" 
                  mode="aspectFill"
                  bindtap="previewPhoto"
                  data-url="{{item}}"
                />
              </view>
            </view>
          </view>
        </view>

        <!-- å†å²è®°å½•ï¼ˆæŒ‰æ—¶é—´å€’åºï¼Œæ¯æ¡è®°å½•å†…éƒ¨å…ˆæäº¤åæ‹’ç»ï¼‰ -->
        <block wx:for="{{historyPhotos}}" wx:key="index" wx:for-item="history">
          <!-- æäº¤è®°å½•ï¼ˆå…ˆå‘ç”Ÿï¼‰ -->
          <view class="timeline-item">
            <view class="timeline-dot"></view>
            <view class="timeline-content">
              <view class="timeline-header">
                <text class="timeline-label">ğŸ“¸ æ‘„å½±å¸ˆæäº¤ä½œå“</text>
                <text class="timeline-time">{{history.submittedAt}}</text>
              </view>
              <!-- æ˜¾ç¤ºæäº¤çš„ç…§ç‰‡ -->
              <view wx:if="{{history.photos && history.photos.length > 0}}" class="history-photos">
                <view class="history-photos-grid">
                  <image 
                    wx:for="{{history.photos}}" 
                    wx:for-item="photo"
                    wx:key="photo"
                    class="history-photo"
                    src="{{photo}}" 
                    mode="aspectFill"
                    bindtap="previewPhoto"
                    data-url="{{photo}}"
                  />
                </view>
              </view>
            </view>
          </view>
          
          <!-- æ‹’ç»è®°å½•ï¼ˆåå‘ç”Ÿï¼‰ -->
          <view class="timeline-item">
            <view class="timeline-dot reject"></view>
            <view class="timeline-content">
              <view class="timeline-header">
                <text class="timeline-label" wx:if="{{history.rejectType === 'admin'}}">âŒ ç®¡ç†å‘˜æ‹’ç»</text>
                <text class="timeline-label" wx:else>ğŸ”„ ç”¨æˆ·è¦æ±‚ä¿®æ”¹</text>
                <text class="timeline-time">{{history.rejectedAt}}</text>
              </view>
              <view class="reject-reason">
                <text class="reject-label">æ‹’ç»åŸå› ï¼š</text>
                <text class="reject-text">{{history.rejectReason}}</text>
              </view>
            </view>
          </view>
        </block>

        <!-- è®¢å•åˆ›å»ºï¼ˆæœ€åº•éƒ¨ï¼Œæœ€æ—©çš„äº‹ä»¶ï¼‰ -->
        <view class="timeline-item">
          <view class="timeline-dot create"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <text class="timeline-label">ğŸ“ å®¢æˆ·ä¸‹å•</text>
              <text class="timeline-time">{{order.createdAt}}</text>
            </view>
            <view class="timeline-desc">
              <text>å­¦ç”Ÿï¼š{{order.studentName}}</text>
              <text>æ´»åŠ¨ï¼š{{activityInfo.name || 'æ´»åŠ¨'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="info-row">
        <text class="label">è®¢å•å·</text>
        <text class="value code">{{order.orderNo || order._id}}</text>
      </view>
      <view class="info-row">
        <text class="label">åˆ›å»ºæ—¶é—´</text>
        <text class="value">{{order.createdAt}}</text>
      </view>
      <view class="info-row">
        <text class="label">æ›´æ–°æ—¶é—´</text>
        <text class="value">{{order.updatedAt || order.createdAt}}</text>
      </view>
      <view wx:if="{{order.remark}}" class="info-row">
        <text class="label">å¤‡æ³¨</text>
        <text class="value">{{order.remark}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view wx:if="{{order.adminActions && order.adminActions.length > 0}}" class="action-bar">
      <view
        wx:for="{{order.adminActions}}"
        wx:key="index"
        wx:for-item="action"
        class="action-button action-{{action}}"
        bindtap="handleAction"
        data-action="{{action}}"
      >
        {{action === 'start' ? 'å¼€å§‹æ‹æ‘„' : action === 'complete' ? 'æ ‡è®°å®Œæˆ' : action === 'refund' ? 'åŒæ„é€€æ¬¾' : action === 'reject' ? 'æ‹’ç»å”®å' : action === 'cancel' ? 'å–æ¶ˆè®¢å•' : action}}
      </view>
    </view>
  </view>
</view>

