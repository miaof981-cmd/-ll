<!--pages/photographer/order-detail.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <view wx:else class="content">
    <!-- 订单基本信息 -->
    <view class="order-info-card">
      <view class="card-header">
        <text class="title">订单信息</text>
        <view class="order-status {{order.status}}">
          <text wx:if="{{order.status === 'in_progress'}}">📸 拍摄中</text>
          <text wx:elif="{{order.status === 'pending_confirm'}}">⏳ 待确认</text>
          <text wx:elif="{{order.status === 'completed'}}">✅ 已完成</text>
          <text wx:else>{{order.status}}</text>
        </view>
      </view>

      <view class="info-row">
        <text class="label">订单号：</text>
        <text class="value">{{order._id}}</text>
      </view>

      <view class="info-row">
        <text class="label">下单时间：</text>
        <text class="value">{{order.createdAt}}</text>
      </view>

      <view class="info-row" wx:if="{{order.submittedAt}}">
        <text class="label">提交时间：</text>
        <text class="value">{{order.submittedAt}}</text>
      </view>

      <view class="info-row">
        <text class="label">活动名称：</text>
        <text class="value">{{activity.name || '证件照拍摄'}}</text>
      </view>
    </view>

    <!-- 学生信息 -->
    <view class="student-card">
      <view class="card-header">
        <text class="title">学生信息</text>
      </view>

      <view class="student-details">
        <view class="detail-item">
          <text class="label">姓名：</text>
          <text class="value">{{order.studentName}}</text>
        </view>

        <view class="detail-item" wx:if="{{student}}">
          <text class="label">性别：</text>
          <text class="value">{{student.gender === 'male' ? '男' : '女'}}</text>
        </view>

        <view class="detail-item" wx:if="{{student}}">
          <text class="label">年龄：</text>
          <text class="value">{{student.age}}岁</text>
        </view>
      </view>
    </view>

    <!-- 参考照片（生活照） -->
    <view class="reference-card" wx:if="{{order.lifePhotos && order.lifePhotos.length > 0}}">
      <view class="card-header">
        <text class="title">📷 参考照片（生活照）</text>
        <text class="subtitle">共{{order.lifePhotos.length}}张</text>
      </view>

      <view class="photo-grid">
        <image
          wx:for="{{order.lifePhotos}}"
          wx:key="index"
          class="photo-item"
          src="{{item}}"
          mode="aspectFill"
          bindtap="previewLifePhoto"
          data-index="{{index}}"
        ></image>
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="remark-card" wx:if="{{order.remark}}">
      <view class="card-header">
        <text class="title">📝 备注与要求</text>
      </view>
      <text class="remark-text">{{order.remark}}</text>
    </view>

    <!-- 历史提交记录（被拒绝的） -->
    <view wx:if="{{historyPhotos.length > 0}}" class="history-card">
      <view class="card-header">
        <text class="title">📋 历史提交</text>
        <text class="reject-badge">已拒绝</text>
      </view>
      
      <view wx:if="{{order.adminRejectReason || order.rejectReason}}" class="reject-reason">
        <text class="reason-label">拒绝原因：</text>
        <text class="reason-text">{{order.adminRejectReason || order.rejectReason}}</text>
      </view>

      <view class="photo-grid">
        <view
          wx:for="{{historyPhotos}}"
          wx:key="index"
          class="upload-item history"
          bindtap="previewUploadedPhoto"
          data-index="{{index}}"
        >
          <image
            src="{{item}}"
            mode="aspectFill"
            class="photo"
          />
          <view class="history-mask">
            <text>已拒绝</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 当前编辑区 -->
    <view class="uploaded-card">
      <view class="card-header">
        <text class="title">🎨 我的作品</text>
        <text class="subtitle">{{uploadedPhotos.length}}/20</text>
      </view>

      <view class="upload-area">
        <!-- 已上传的照片 -->
        <view class="photo-grid">
          <view
            wx:for="{{uploadedPhotos}}"
            wx:key="index"
            class="upload-item"
          >
            <image
              class="photo"
              src="{{item}}"
              mode="aspectFill"
              bindtap="previewUploadedPhoto"
              data-index="{{index}}"
            />
            <view class="delete-btn" bindtap="deletePhoto" data-index="{{index}}">
              <text>✕</text>
            </view>
          </view>

          <!-- 上传按钮 -->
          <view
            wx:if="{{uploadedPhotos.length < 20 && order.status === 'in_progress'}}"
            class="upload-btn"
            bindtap="uploadPhotos"
          >
            <text class="upload-icon">+</text>
            <text class="upload-text">上传照片</text>
          </view>
        </view>

        <view wx:if="{{uploadedPhotos.length === 0}}" class="empty-upload">
          <text class="empty-icon">📸</text>
          <text class="empty-text">还没有上传作品</text>
          <text class="empty-hint">点击上方"+"上传照片</text>
        </view>
      </view>

      <!-- 摄影师备注给用户 -->
      <view wx:if="{{order.status === 'in_progress' && uploadedPhotos.length > 0}}" class="photographer-note-section">
        <view class="note-header">
          <text class="note-title">💬 给用户的说明</text>
          <text class="note-hint">（选填）</text>
        </view>
        <textarea
          class="note-textarea"
          placeholder="可以在这里写一些拍摄说明、注意事项等，用户查看作品时会看到"
          value="{{photographerNote}}"
          bindinput="onPhotographerNoteInput"
          maxlength="200"
        />
        <view class="note-counter">{{photographerNote.length || 0}}/200</view>
      </view>
    </view>

    <!-- 完整历史记录（数据库查询） -->
    <view wx:if="{{allHistoryPhotos.length > 0}}" class="full-history-card">
      <view class="card-header">
        <text class="title">📚 完整历史记录</text>
        <text class="history-count">共{{allHistoryPhotos.length}}次</text>
      </view>
      
      <!-- 时间线显示 -->
      <view class="timeline">
        <block wx:for="{{allHistoryPhotos}}" wx:key="index" wx:for-item="history">
          <!-- 拒绝记录 -->
          <view class="timeline-item">
            <view class="timeline-dot {{history.rejectType === 'admin' ? 'admin-reject' : 'user-reject'}}"></view>
            <view class="timeline-content">
              <view class="timeline-header">
                <text class="timeline-label" wx:if="{{history.rejectType === 'admin'}}">❌ 管理员拒绝</text>
                <text class="timeline-label" wx:else>🔄 用户要求修改</text>
                <text class="timeline-time">{{history.rejectedAt}}</text>
              </view>
              <view class="timeline-reject {{history.rejectType === 'admin' ? 'admin-reject-bg' : 'user-reject-bg'}}">
                {{history.rejectReason}}
              </view>
            </view>
          </view>
          
          <!-- 提交记录 -->
          <view class="timeline-item">
            <view class="timeline-dot submit"></view>
            <view class="timeline-content">
              <view class="timeline-header">
                <text class="timeline-label">📸 您提交了作品</text>
                <text class="timeline-time">{{history.submittedAt}}</text>
              </view>
              <view class="timeline-desc">提交了 {{history.photos.length}} 张照片</view>
              <!-- 历史照片缩略图 -->
              <view wx:if="{{history.photos.length > 0}}" class="timeline-photos">
                <image
                  wx:for="{{history.photos}}"
                  wx:for-item="photo"
                  wx:key="photo"
                  class="timeline-photo"
                  src="{{photo}}"
                  mode="aspectFill"
                  bindtap="previewHistoryPhoto"
                  data-photos="{{history.photos}}"
                  data-index="{{index}}"
                />
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-bar" wx:if="{{order.status === 'in_progress'}}">
      <button class="action-btn secondary" bindtap="contactUser">
        <text>💬 联系用户</text>
      </button>
      <button 
        class="action-btn primary" 
        bindtap="submitWork"
        disabled="{{uploadedPhotos.length === 0}}"
      >
        <text>✅ 提交作品</text>
      </button>
    </view>

    <view class="action-bar" wx:elif="{{order.status === 'pending_confirm'}}">
      <view class="status-tip">
        <text class="tip-icon">⏳</text>
        <text class="tip-text">等待用户确认中...</text>
      </view>
    </view>

    <view class="action-bar" wx:elif="{{order.status === 'completed'}}">
      <view class="status-tip success">
        <text class="tip-icon">✅</text>
        <text class="tip-text">订单已完成</text>
      </view>
    </view>
  </view>
</view>

