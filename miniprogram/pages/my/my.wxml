<!--pages/my/my.wxml - 个人中心-->
<view class="my-page">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 已登录状态 -->
  <view wx:elif="{{isLoggedIn}}">
    <!-- 用户信息卡片 -->
    <view class="user-card">
      <image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
      <view class="user-info">
        <text class="nickname">{{userInfo.nickName}}</text>
        <!-- 显示所有拥有的角色标签 -->
        <view class="roles-badges">
          <view wx:if="{{isAdmin}}" class="role-badge admin">
            <text class="role-icon">⚙️</text>
            <text class="role-name">管理员</text>
          </view>
          <view wx:if="{{isPhotographer}}" class="role-badge photographer">
            <text class="role-icon">📷</text>
            <text class="role-name">摄影师</text>
          </view>
          <view wx:if="{{isParent}}" class="role-badge parent">
            <text class="role-icon">👨‍👩‍👧‍👦</text>
            <text class="role-name">家长</text>
          </view>
        </view>
        <!-- OpenID 显示区域（用于添加管理员） -->
        <view class="openid-box" wx:if="{{userInfo.openid || userInfo._openid}}" bindtap="copyOpenId">
          <text class="openid-label">OpenID: </text>
          <text class="openid-value">{{userInfo.openid || userInfo._openid}}</text>
          <text class="copy-icon">📋</text>
        </view>
      </view>
    </view>

    <!-- 家长功能：孩子列表 -->
    <view wx:if="{{isParent}}" class="children-section">
      <view class="section-header">
        <text class="section-title">我的孩子</text>
        <view class="add-btn" bindtap="addChild">+ 添加</view>
      </view>
      
      <view wx:if="{{children.length === 0}}" class="empty-tip">
        <text class="empty-text">还没有关联孩子</text>
        <text class="empty-hint">点击右上角"添加"按钮或"申请入学"</text>
      </view>
      
      <view 
        wx:for="{{children}}" 
        wx:key="studentId"
        class="child-card"
        bindtap="viewChildRecord"
        data-studentid="{{item.studentId}}"
      >
        <view class="child-avatar">{{item.name.substr(0,1)}}</view>
        <view class="child-info">
          <text class="child-name">{{item.name}}</text>
          <text class="child-detail">学号: {{item.studentId}}</text>
          <text wx:if="{{item.class && item.class !== '待分配'}}" class="child-detail">{{item.grade}} {{item.class}}</text>
        </view>
        <view class="arrow">→</view>
      </view>
    </view>

    <!-- 管理员功能：快捷入口 -->
    <view wx:if="{{isAdmin}}" class="admin-section">
      <text class="section-title">管理功能</text>
      <navigator class="menu-item" url="/pages/admin/admin">
        <text class="menu-icon">⚙️</text>
        <text class="menu-text">管理后台</text>
        <text class="arrow">→</text>
      </navigator>
      <navigator class="menu-item test-item" url="/pages/test/archive-test">
        <text class="menu-icon">🧪</text>
        <text class="menu-text">档案测试工具</text>
        <text class="arrow">→</text>
      </navigator>
      <navigator class="menu-item test-item" url="/pages/test-notification/test-notification">
        <text class="menu-icon">📨</text>
        <text class="menu-text">订阅消息测试</text>
        <text class="arrow">→</text>
      </navigator>
    </view>

    <!-- 摄影师功能：快捷入口 -->
    <view wx:if="{{isPhotographer}}" class="photographer-section">
      <text class="section-title">摄影功能</text>
      <navigator class="menu-item" url="/pages/photographer/tasks">
        <text class="menu-icon">📷</text>
        <text class="menu-text">工作台</text>
        <text class="arrow">→</text>
      </navigator>
    </view>

    <!-- 通用功能 -->
    <view class="menu-section">
      <text class="section-title">功能菜单</text>
      <view class="menu-item" bindtap="myOrders">
        <text class="menu-icon">📦</text>
        <text class="menu-text">我的订单</text>
        <text class="arrow">→</text>
      </view>
      <view class="menu-item" bindtap="myActivities">
        <text class="menu-icon">🎯</text>
        <text class="menu-text">我的活动</text>
        <text class="arrow">→</text>
      </view>
      <view class="menu-item" bindtap="settings">
        <text class="menu-icon">⚙️</text>
        <text class="menu-text">设置</text>
        <text class="arrow">→</text>
      </view>
    </view>

    <!-- 退出登录 -->
    <view class="logout-section">
      <button class="logout-btn" bindtap="logout">退出登录</button>
    </view>
  </view>

  <!-- 未登录状态 -->
  <view wx:else class="not-login">
    <view class="login-icon">👤</view>
    <text class="login-tip">欢迎来到次元学校</text>
    <text class="login-subtitle">请先登录查看更多功能</text>
    <navigator class="login-btn" url="/pages/login/login">
      <text>微信登录</text>
    </navigator>
  </view>
</view>
