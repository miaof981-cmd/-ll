<view class="order-detail-page">
  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>

  <view wx:else class="order-container">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-card">
      <view class="status-icon" style="color: {{order.statusColor}}">{{order.statusIcon}}</view>
      <view class="status-info">
        <text class="status-text" style="color: {{order.statusColor}}">{{order.statusText}}</text>
        <text class="status-time">{{order.updatedAt || order.createdAt}}</text>
      </view>
    </view>

    <!-- æ´»åŠ¨ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">æ´»åŠ¨ä¿¡æ¯</view>
      <view wx:if="{{activityInfo}}" class="activity-info">
        <image class="activity-cover" src="{{activityInfo.coverImage}}" mode="aspectFill"></image>
        <view class="activity-details">
          <text class="activity-title">{{activityInfo.title}}</text>
          <text class="activity-subtitle">{{activityInfo.subtitle}}</text>
          <text class="activity-price">Â¥{{order.totalPrice}}</text>
        </view>
      </view>
      <view wx:else class="no-data">æ´»åŠ¨å·²åˆ é™¤</view>
    </view>

    <!-- æ‘„å½±å¸ˆä¿¡æ¯ -->
    <view wx:if="{{photographerInfo}}" class="section-card">
      <view class="section-title">æ‘„å½±å¸ˆä¿¡æ¯</view>
      <view class="photographer-info">
        <image wx:if="{{photographerInfo.avatar}}" class="photographer-avatar" src="{{photographerInfo.avatar}}" mode="aspectFill"></image>
        <view wx:else class="photographer-avatar-placeholder">{{photographerInfo.name.substring(0,1)}}</view>
        <view class="photographer-details">
          <text class="photographer-name">{{photographerInfo.name}}</text>
          <text class="photographer-specialty">{{photographerInfo.specialty || 'ä¸“ä¸šæ‘„å½±å¸ˆ'}}</text>
        </view>
      </view>
    </view>

    <!-- æ‘„å½±å¸ˆä½œå“ -->
    <view wx:if="{{order.photos && order.photos.length > 0}}" class="section-card">
      <view class="section-title">
        <text>ğŸ“¸ æ‘„å½±å¸ˆä½œå“</text>
        <text class="photo-count">å…±{{order.photos.length}}å¼ </text>
      </view>
      
      <view class="photos-grid">
        <image
          wx:for="{{order.photos}}"
          wx:key="index"
          class="photo-item"
          src="{{item}}"
          mode="aspectFill"
          bindtap="previewPhoto"
          data-index="{{index}}"
        ></image>
      </view>

      <!-- å¾…ç¡®è®¤çŠ¶æ€æç¤º -->
      <view wx:if="{{order.status === 'pending_confirm'}}" class="confirm-tip">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">è¯·ä»”ç»†æŸ¥çœ‹æ‘„å½±å¸ˆçš„ä½œå“ï¼Œå¦‚æ»¡æ„è¯·ç¡®è®¤ï¼Œå¦‚ä¸æ»¡æ„å¯ä»¥æ‹’ç»å¹¶æå‡ºä¿®æ”¹æ„è§</text>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="info-row">
        <text class="label">è®¢å•å·</text>
        <text class="value code">{{order.orderNo || order._id.slice(-12)}}</text>
      </view>
      <view class="info-row">
        <text class="label">ä¸‹å•æ—¶é—´</text>
        <text class="value">{{order.createdAt}}</text>
      </view>
      <view wx:if="{{order.submittedAt}}" class="info-row">
        <text class="label">æäº¤æ—¶é—´</text>
        <text class="value">{{order.submittedAt}}</text>
      </view>
      <view class="info-row">
        <text class="label">è®¢å•é‡‘é¢</text>
        <text class="value price">Â¥{{order.totalPrice}}</text>
      </view>
      <view wx:if="{{order.remark}}" class="info-row">
        <text class="label">æˆ‘çš„å¤‡æ³¨</text>
        <text class="value">{{order.remark}}</text>
      </view>
      <view wx:if="{{order.rejectReason}}" class="info-row reject-reason">
        <text class="label">æ‹’ç»åŸå› </text>
        <text class="value">{{order.rejectReason}}</text>
      </view>
    </view>

    <!-- è®¢å•æ—¶é—´çº¿ -->
    <view class="section-card">
      <view class="section-title">ğŸ“‹ è®¢å•è¿›åº¦</view>
      
      <view class="timeline">
        <!-- è®¢å•åˆ›å»º -->
        <view class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-title">è®¢å•åˆ›å»º</view>
            <view class="timeline-time">{{order.createdAt}}</view>
            <view class="timeline-desc" wx:if="{{order.remark}}">å¤‡æ³¨ï¼š{{order.remark}}</view>
          </view>
        </view>

        <!-- æ‘„å½±å¸ˆæ¥å• -->
        <view wx:if="{{order.status !== 'pending_payment' && order.status !== 'cancelled'}}" class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-title">æ‘„å½±å¸ˆæ¥å•</view>
            <view class="timeline-time">{{order.createdAt}}</view>
            <view class="timeline-desc">æ‘„å½±å¸ˆ {{photographerInfo.name}} å·²å¼€å§‹æ‹æ‘„</view>
          </view>
        </view>

        <!-- æäº¤ä½œå“ -->
        <view wx:if="{{order.submittedAt}}" class="timeline-item">
          <view class="timeline-dot {{order.status === 'pending_confirm' || order.status === 'completed' ? 'active' : ''}}"></view>
          <view class="timeline-content">
            <view class="timeline-title">æäº¤ä½œå“</view>
            <view class="timeline-time">{{order.submittedAt}}</view>
            <view class="timeline-desc">æ‘„å½±å¸ˆå·²æäº¤ {{order.photos.length}} å¼ ç…§ç‰‡</view>
          </view>
        </view>

        <!-- æ‹’ç»è®°å½• -->
        <view wx:if="{{order.rejectedAt && order.rejectReason}}" class="timeline-item">
          <view class="timeline-dot warning"></view>
          <view class="timeline-content">
            <view class="timeline-title">ä½œå“è¢«æ‹’ç»</view>
            <view class="timeline-time">{{order.rejectedAt}}</view>
            <view class="timeline-desc reject">æ‹’ç»åŸå› ï¼š{{order.rejectReason}}</view>
          </view>
        </view>

        <!-- ç¡®è®¤å®Œæˆ -->
        <view wx:if="{{order.confirmedAt}}" class="timeline-item">
          <view class="timeline-dot success"></view>
          <view class="timeline-content">
            <view class="timeline-title">ç¡®è®¤å®Œæˆ</view>
            <view class="timeline-time">{{order.confirmedAt}}</view>
            <view class="timeline-desc">è®¢å•å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„ç¡®è®¤</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-bar">
      <!-- å¾…ç¡®è®¤çŠ¶æ€ï¼šæ˜¾ç¤ºç¡®è®¤å’Œæ‹’ç»æŒ‰é’® -->
      <view wx:if="{{order.status === 'pending_confirm'}}" class="confirm-actions">
        <button class="action-btn reject-btn" bindtap="rejectWork">
          âŒ æ‹’ç»ä½œå“
        </button>
        <button class="action-btn confirm-btn" bindtap="confirmWork">
          âœ… ç¡®è®¤æ»¡æ„
        </button>
      </view>

      <!-- å…¶ä»–çŠ¶æ€ï¼šæ˜¾ç¤ºåŸæœ‰æ“ä½œæŒ‰é’® -->
      <view wx:elif="{{order.userActions && order.userActions.length > 0}}" class="other-actions">
        <button
          wx:for="{{order.userActions}}"
          wx:key="index"
          wx:for-item="action"
          class="action-btn {{action === 'after_sale' ? 'secondary-btn' : 'primary-btn'}}"
          bindtap="handleAction"
          data-action="{{action}}"
        >
          {{getActionText(action)}}
        </button>
      </view>
    </view>
  </view>

  <!-- æ‹’ç»åŸå› å¼¹çª— -->
  <view wx:if="{{showRejectModal}}" class="reject-modal">
    <view class="modal-mask" bindtap="closeRejectModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ‹’ç»ä½œå“</text>
        <view class="close-btn" bindtap="closeRejectModal">âœ•</view>
      </view>
      
      <view class="modal-body">
        <view class="input-label">è¯·è¯¦ç»†è¯´æ˜æ‹’ç»åŸå› ï¼Œæ‘„å½±å¸ˆå°†æ ¹æ®æ‚¨çš„æ„è§é‡æ–°æ‹æ‘„</view>
        <textarea 
          class="reject-textarea"
          placeholder="ä¾‹å¦‚ï¼šå…‰çº¿ä¸å¤Ÿæ˜äº®ã€æ‹æ‘„è§’åº¦ä¸å¤ªå¥½ã€èƒŒæ™¯ä¸å¤Ÿå¹²å‡€ç­‰ï¼Œè¯·å°½é‡è¯¦ç»†è¯´æ˜æ‚¨çš„è¦æ±‚"
          value="{{rejectReason}}"
          bindinput="onRejectReasonInput"
          maxlength="200"
          auto-height
        ></textarea>
        <view class="char-count">{{rejectReason.length}}/200</view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeRejectModal">å–æ¶ˆ</button>
        <button class="modal-btn submit-btn" bindtap="submitReject">æäº¤</button>
      </view>
    </view>
  </view>

  <!-- æ°´å°é¢„è§ˆé®ç½©å±‚ï¼ˆæœªç¡®è®¤æ—¶ï¼‰ -->
  <view wx:if="{{order.status === 'pending_confirm'}}" class="watermark-overlay" hidden>
    <canvas canvas-id="watermarkCanvas" class="watermark-canvas"></canvas>
  </view>
</view>

