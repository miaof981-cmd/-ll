<view class="order-detail-page">
  <view wx:if="{{loading}}" class="loading">加载中...</view>

  <view wx:else class="order-container">
    <!-- 订单状态 -->
    <view class="status-card">
      <view class="status-icon" style="color: {{order.statusColor}}">{{order.statusIcon}}</view>
      <view class="status-info">
        <text class="status-text" style="color: {{order.statusColor}}">{{order.statusText}}</text>
        <text class="status-time">{{order.updatedAt || order.createdAt}}</text>
      </view>
    </view>

    <!-- 活动信息 -->
    <view class="section-card">
      <view class="section-title">活动信息</view>
      <view wx:if="{{activityInfo}}" class="activity-info">
        <image class="activity-cover" src="{{activityInfo.coverImage}}" mode="aspectFill"></image>
        <view class="activity-details">
          <text class="activity-title">{{activityInfo.title}}</text>
          <text class="activity-subtitle">{{activityInfo.subtitle}}</text>
          <text class="activity-price">¥{{order.totalPrice}}</text>
        </view>
      </view>
      <view wx:else class="no-data">活动已删除</view>
    </view>

    <!-- 摄影师信息 -->
    <view wx:if="{{photographerInfo}}" class="section-card">
      <view class="section-title">摄影师信息</view>
      <view class="photographer-info">
        <image wx:if="{{photographerInfo.avatar}}" class="photographer-avatar" src="{{photographerInfo.avatar}}" mode="aspectFill"></image>
        <view wx:else class="photographer-avatar-placeholder">{{photographerInfo.name.substring(0,1)}}</view>
        <view class="photographer-details">
          <text class="photographer-name">{{photographerInfo.name}}</text>
          <text class="photographer-specialty">{{photographerInfo.specialty || '专业摄影师'}}</text>
        </view>
      </view>
    </view>

    <!-- 摄影师作品 -->
    <view wx:if="{{order.photos && order.photos.length > 0}}" class="section-card">
      <view class="section-title">
        <text>📸 摄影师作品</text>
        <text class="photo-count">共{{order.photos.length}}张</text>
      </view>
      
      <view class="photos-grid">
        <image
          wx:for="{{order.photos}}"
          wx:key="index"
          class="photo-item"
          src="{{item}}"
          mode="aspectFill"
          bindtap="previewPhoto"
          data-index="{{index}}"
        ></image>
      </view>

      <!-- 待确认状态提示 -->
      <view wx:if="{{order.status === 'pending_confirm'}}" class="confirm-tip">
        <text class="tip-icon">💡</text>
        <text class="tip-text">请仔细查看摄影师的作品，如满意请确认，如不满意可以拒绝并提出修改意见</text>
      </view>
    </view>

    <!-- 订单信息 -->
    <view class="section-card">
      <view class="section-title">订单信息</view>
      <view class="info-row">
        <text class="label">订单号</text>
        <text class="value code">{{order.orderNo || order._id.slice(-12)}}</text>
      </view>
      <view class="info-row">
        <text class="label">下单时间</text>
        <text class="value">{{order.createdAt}}</text>
      </view>
      <view wx:if="{{order.submittedAt}}" class="info-row">
        <text class="label">提交时间</text>
        <text class="value">{{order.submittedAt}}</text>
      </view>
      <view class="info-row">
        <text class="label">订单金额</text>
        <text class="value price">¥{{order.totalPrice}}</text>
      </view>
      <view wx:if="{{order.remark}}" class="info-row">
        <text class="label">我的备注</text>
        <text class="value">{{order.remark}}</text>
      </view>
      <view wx:if="{{order.rejectReason}}" class="info-row reject-reason">
        <text class="label">拒绝原因</text>
        <text class="value">{{order.rejectReason}}</text>
      </view>
    </view>

    <!-- 订单时间线 -->
    <view class="section-card">
      <view class="section-title">📋 订单进度</view>
      
      <view class="timeline">
        <!-- 订单创建 -->
        <view class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-title">订单创建</view>
            <view class="timeline-time">{{order.createdAt}}</view>
            <view class="timeline-desc" wx:if="{{order.remark}}">备注：{{order.remark}}</view>
          </view>
        </view>

        <!-- 摄影师接单 -->
        <view wx:if="{{order.status !== 'pending_payment' && order.status !== 'cancelled'}}" class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-title">摄影师接单</view>
            <view class="timeline-time">{{order.createdAt}}</view>
            <view class="timeline-desc">摄影师 {{photographerInfo.name}} 已开始拍摄</view>
          </view>
        </view>

        <!-- 提交作品 -->
        <view wx:if="{{order.submittedAt}}" class="timeline-item">
          <view class="timeline-dot {{order.status === 'pending_confirm' || order.status === 'completed' ? 'active' : ''}}"></view>
          <view class="timeline-content">
            <view class="timeline-title">提交作品</view>
            <view class="timeline-time">{{order.submittedAt}}</view>
            <view class="timeline-desc">摄影师已提交 {{order.photos.length}} 张照片</view>
          </view>
        </view>

        <!-- 拒绝记录 -->
        <view wx:if="{{order.rejectedAt && order.rejectReason}}" class="timeline-item">
          <view class="timeline-dot warning"></view>
          <view class="timeline-content">
            <view class="timeline-title">作品被拒绝</view>
            <view class="timeline-time">{{order.rejectedAt}}</view>
            <view class="timeline-desc reject">拒绝原因：{{order.rejectReason}}</view>
          </view>
        </view>

        <!-- 确认完成 -->
        <view wx:if="{{order.confirmedAt}}" class="timeline-item">
          <view class="timeline-dot success"></view>
          <view class="timeline-content">
            <view class="timeline-title">确认完成</view>
            <view class="timeline-time">{{order.confirmedAt}}</view>
            <view class="timeline-desc">订单已完成，感谢您的确认</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-bar">
      <!-- 待确认状态：显示确认和拒绝按钮 -->
      <view wx:if="{{order.status === 'pending_confirm'}}" class="confirm-actions">
        <button class="action-btn reject-btn" bindtap="rejectWork">
          ❌ 拒绝作品
        </button>
        <button class="action-btn confirm-btn" bindtap="confirmWork">
          ✅ 确认满意
        </button>
      </view>

      <!-- 其他状态：显示原有操作按钮 -->
      <view wx:elif="{{order.userActions && order.userActions.length > 0}}" class="other-actions">
        <button
          wx:for="{{order.userActions}}"
          wx:key="index"
          wx:for-item="action"
          class="action-btn {{action === 'after_sale' ? 'secondary-btn' : 'primary-btn'}}"
          bindtap="handleAction"
          data-action="{{action}}"
        >
          {{getActionText(action)}}
        </button>
      </view>
    </view>
  </view>

  <!-- 拒绝原因弹窗 -->
  <view wx:if="{{showRejectModal}}" class="reject-modal">
    <view class="modal-mask" bindtap="closeRejectModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">拒绝作品</text>
        <view class="close-btn" bindtap="closeRejectModal">✕</view>
      </view>
      
      <view class="modal-body">
        <view class="input-label">请详细说明拒绝原因，摄影师将根据您的意见重新拍摄</view>
        <textarea 
          class="reject-textarea"
          placeholder="例如：光线不够明亮、拍摄角度不太好、背景不够干净等，请尽量详细说明您的要求"
          value="{{rejectReason}}"
          bindinput="onRejectReasonInput"
          maxlength="200"
          auto-height
        ></textarea>
        <view class="char-count">{{rejectReason.length}}/200</view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeRejectModal">取消</button>
        <button class="modal-btn submit-btn" bindtap="submitReject">提交</button>
      </view>
    </view>
  </view>

  <!-- 水印预览遮罩层（未确认时） -->
  <view wx:if="{{order.status === 'pending_confirm'}}" class="watermark-overlay" hidden>
    <canvas canvas-id="watermarkCanvas" class="watermark-canvas"></canvas>
  </view>
</view>

