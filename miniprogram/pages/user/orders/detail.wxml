<view class="order-detail-page">
  <!-- æµ®åŠ¨è¿”å›æŒ‰é’® -->
  <view wx:if="{{!canGoBack}}" class="float-back-btn" bindtap="goBack">
    <text class="back-icon">â†</text>
  </view>

  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>

  <view wx:else class="order-container">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-card">
      <view class="status-icon" style="color: {{order.statusColor}}">{{order.statusIcon}}</view>
      <view class="status-info">
        <text class="status-text" style="color: {{order.statusColor}}">{{order.statusText}}</text>
        <text class="status-time">{{order.updatedAt || order.createdAt}}</text>
      </view>
    </view>

    <!-- è®¢å•æ—¶é—´çº¿ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰ -->
    <view class="section-card timeline-card">
      <view class="section-title">ğŸ“‹ æœ€æ–°è¿›å±•</view>
      
      <view class="timeline reverse">
        <!-- ç¡®è®¤å®Œæˆ -->
        <view wx:if="{{order.confirmedAt}}" class="timeline-item">
          <view class="timeline-dot success"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">âœ… ç¡®è®¤å®Œæˆ</view>
              <view class="timeline-time">{{order.confirmedAt}}</view>
            </view>
            <view class="timeline-desc">è®¢å•å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„ç¡®è®¤</view>
          </view>
        </view>

        <!-- æ‹’ç»è®°å½• -->
        <view wx:if="{{order.rejectedAt && order.rejectReason}}" class="timeline-item">
          <view class="timeline-dot warning"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">âŒ ä½œå“è¢«æ‹’ç»</view>
              <view class="timeline-time">{{order.rejectedAt}}</view>
            </view>
            <view class="timeline-desc reject">æ‹’ç»åŸå› ï¼š{{order.rejectReason}}</view>
            <view class="timeline-note">æ‘„å½±å¸ˆå°†é‡æ–°æ‹æ‘„</view>
          </view>
        </view>

        <!-- æäº¤ä½œå“ -->
        <view wx:if="{{order.submittedAt}}" class="timeline-item {{order.status === 'pending_confirm' ? 'highlight' : ''}}">
          <view class="timeline-dot {{order.status === 'pending_confirm' || order.status === 'completed' ? 'active' : ''}}"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">ğŸ“¸ æäº¤ä½œå“</view>
              <view class="timeline-time">{{order.submittedAt}}</view>
            </view>
            <view class="timeline-desc">æ‘„å½±å¸ˆå·²æäº¤ {{order.photos.length}} å¼ ç…§ç‰‡</view>
            
            <!-- æ‘„å½±å¸ˆå¤‡æ³¨ -->
            <view wx:if="{{order.photographerNote}}" class="photographer-note">
              <view class="note-label">ğŸ’¬ æ‘„å½±å¸ˆè¯´ï¼š</view>
              <view class="note-content">{{order.photographerNote}}</view>
            </view>

            <!-- å¾…ç¡®è®¤çŠ¶æ€æç¤º -->
            <view wx:if="{{order.status === 'pending_confirm'}}" class="timeline-tip">
              ğŸ’¡ è¯·ä»”ç»†æŸ¥çœ‹ä½œå“ï¼Œæ»¡æ„è¯·ç‚¹å‡»ä¸‹æ–¹"ç¡®è®¤æ»¡æ„"
              <view wx:if="{{order.rejectCount < 3}}" class="reject-count-tip">
                å‰©ä½™ä¿®æ”¹æœºä¼šï¼š{{3 - (order.rejectCount || 0)}}æ¬¡
              </view>
              <view wx:else class="reject-count-warning">
                âš ï¸ ä¿®æ”¹æœºä¼šå·²ç”¨å®Œï¼Œåªèƒ½ç¡®è®¤æ”¶è´§
              </view>
            </view>

            <!-- ç…§ç‰‡é¢„è§ˆï¼ˆæ—¶é—´çº¿ä¸­ï¼‰ -->
            <view class="timeline-photos">
              <view
                wx:for="{{order.photos}}"
                wx:key="index"
                class="timeline-photo-item"
                bindtap="previewPhoto"
                data-index="{{index}}"
              >
                <image class="timeline-photo-img" src="{{item}}" mode="aspectFill"></image>
                <view wx:if="{{order.status === 'pending_confirm'}}" class="watermark-badge">é¢„è§ˆ</view>
              </view>
            </view>
          </view>
        </view>

        <!-- æ‘„å½±å¸ˆæ¥å• -->
        <view wx:if="{{order.status !== 'pending_payment' && order.status !== 'cancelled'}}" class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">ğŸ‘ æ‘„å½±å¸ˆæ¥å•</view>
            </view>
            <view class="timeline-desc">æ‘„å½±å¸ˆ {{photographerInfo.name}} å·²å¼€å§‹æ‹æ‘„</view>
          </view>
        </view>

        <!-- å†å²ä¿®æ”¹è®°å½•ï¼ˆä»…æ˜¾ç¤ºç”¨æˆ·è‡ªå·±è¦æ±‚ä¿®æ”¹çš„è®°å½•ï¼‰ -->
        <block wx:if="{{historyPhotos.length > 0}}">
          <view class="history-divider">
            <text class="divider-text">ğŸ“š ä¿®æ”¹è®°å½•ï¼ˆå…±{{historyPhotos.length}}æ¬¡ï¼‰</text>
          </view>
          
          <block wx:for="{{historyPhotos}}" wx:key="index" wx:for-item="history">
            <!-- ç”¨æˆ·è¦æ±‚ä¿®æ”¹ -->
            <view class="timeline-item">
              <view class="timeline-dot user-reject"></view>
              <view class="timeline-content">
                <view class="timeline-header">
                  <view class="timeline-title">ğŸ”„ æ‚¨è¦æ±‚ä¿®æ”¹</view>
                  <view class="timeline-time">{{history.rejectedAt}}</view>
                </view>
                <view class="timeline-desc reject user-reject-bg">
                  ä¿®æ”¹åŸå› ï¼š{{history.rejectReason}}
                </view>
              </view>
            </view>
            
            <!-- æ‘„å½±å¸ˆæäº¤è®°å½• -->
            <view class="timeline-item">
              <view class="timeline-dot"></view>
              <view class="timeline-content">
                <view class="timeline-header">
                  <view class="timeline-title">ğŸ“¸ æ‘„å½±å¸ˆæäº¤</view>
                  <view class="timeline-time">{{history.submittedAt}}</view>
                </view>
                <view class="timeline-desc">æäº¤äº† {{history.photos.length}} å¼ ç…§ç‰‡</view>
                <!-- å†å²ç…§ç‰‡é¢„è§ˆ -->
                <view wx:if="{{history.photos.length > 0}}" class="timeline-photos history-photos">
                  <view
                    wx:for="{{history.photos}}"
                    wx:for-item="photo"
                    wx:key="photo"
                    class="timeline-photo-item"
                    bindtap="previewHistoryPhoto"
                    data-photos="{{history.photos}}"
                    data-index="{{index}}"
                  >
                    <image class="timeline-photo-img" src="{{photo}}" mode="aspectFill"></image>
                    <view class="history-badge">å†å²</view>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </block>

        <!-- è®¢å•åˆ›å»º -->
        <view class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">ğŸ“ è®¢å•åˆ›å»º</view>
              <view class="timeline-time">{{order.createdAt}}</view>
            </view>
            <view wx:if="{{order.remark}}" class="timeline-desc">å¤‡æ³¨ï¼š{{order.remark}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢å•è¯¦æƒ…å¡ç‰‡ï¼ˆæ•´åˆï¼šæ´»åŠ¨+æ‘„å½±å¸ˆ+è®¢å•ä¿¡æ¯ï¼‰ -->
    <view class="section-card detail-card">
      <view class="section-title">ğŸ“‹ è®¢å•è¯¦æƒ…</view>
      
      <!-- æ´»åŠ¨ä¿¡æ¯ -->
      <view class="detail-section">
        <view wx:if="{{activityInfo}}" class="activity-info-compact" bindtap="viewActivity">
          <image class="activity-thumb" src="{{activityInfo.coverImage}}" mode="aspectFill"></image>
          <view class="activity-text">
            <text class="activity-name">{{activityInfo.title}}</text>
            <text class="activity-subtitle">{{activityInfo.subtitle}}</text>
          </view>
          <view class="activity-arrow">â†’</view>
        </view>
        <view wx:else class="no-data">æ´»åŠ¨å·²åˆ é™¤</view>
      </view>

      <view class="divider"></view>

      <!-- æ‘„å½±å¸ˆä¿¡æ¯ -->
      <view wx:if="{{photographerInfo}}" class="detail-section">
        <view class="photographer-info-compact" bindtap="viewPhotographer">
          <image wx:if="{{photographerInfo.avatar}}" class="photographer-avatar-small" src="{{photographerInfo.avatar}}" mode="aspectFill"></image>
          <view wx:else class="photographer-avatar-small placeholder">{{photographerInfo.name.substring(0,1)}}</view>
          <view class="photographer-text">
            <text class="photographer-name-small">{{photographerInfo.name}}</text>
            <text class="photographer-specialty-small">{{photographerInfo.specialty || 'ä¸“ä¸šæ‘„å½±å¸ˆ'}}</text>
          </view>
          <view class="photographer-arrow">â†’</view>
        </view>
      </view>

      <view class="divider"></view>

      <!-- è®¢å•ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="info-row">
          <text class="label">è®¢å•å·</text>
          <text class="value code">{{order.orderNo || order._id.slice(-12)}}</text>
        </view>
        <view class="info-row">
          <text class="label">ä¸‹å•æ—¶é—´</text>
          <text class="value">{{order.createdAt}}</text>
        </view>
        <view class="info-row">
          <text class="label">è®¢å•é‡‘é¢</text>
          <text class="value price">Â¥{{order.totalPrice}}</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view wx:if="{{order.status === 'pending_confirm'}}" class="action-bar">
      <view class="confirm-actions">
        <button class="action-btn reject-btn" bindtap="rejectWork">
          âŒ æ‹’ç»ä½œå“
        </button>
        <button class="action-btn confirm-btn" bindtap="confirmWork" catchtap="confirmWork">
          âœ… ç¡®è®¤æ»¡æ„
        </button>
      </view>
    </view>
  </view>

  <!-- æ‹’ç»åŸå› å¼¹çª— -->
  <view wx:if="{{showRejectModal}}" class="reject-modal">
    <view class="modal-mask" bindtap="closeRejectModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ‹’ç»ä½œå“</text>
        <view class="close-btn" bindtap="closeRejectModal">âœ•</view>
      </view>
      
      <view class="modal-body">
        <view class="input-label">è¯·è¯¦ç»†è¯´æ˜æ‹’ç»åŸå› ï¼Œæ‘„å½±å¸ˆå°†æ ¹æ®æ‚¨çš„æ„è§é‡æ–°æ‹æ‘„</view>
        <textarea 
          class="reject-textarea"
          placeholder="ä¾‹å¦‚ï¼šå…‰çº¿ä¸å¤Ÿæ˜äº®ã€æ‹æ‘„è§’åº¦ä¸å¤ªå¥½ã€èƒŒæ™¯ä¸å¤Ÿå¹²å‡€ç­‰ï¼Œè¯·å°½é‡è¯¦ç»†è¯´æ˜æ‚¨çš„è¦æ±‚"
          value="{{rejectReason}}"
          bindinput="onRejectReasonInput"
          maxlength="200"
          auto-height
        ></textarea>
        <view class="char-count">{{rejectReason.length}}/200</view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeRejectModal">å–æ¶ˆ</button>
        <button class="modal-btn submit-btn" bindtap="submitReject">æäº¤</button>
      </view>
    </view>
  </view>

  <!-- æ°´å°Canvasï¼ˆéšè—ï¼‰ -->
  <canvas 
    type="2d" 
    id="watermarkCanvas" 
    class="watermark-canvas"
    style="position: fixed; left: -9999px; top: -9999px; width: 300px; height: 300px;"
  ></canvas>
</view>
