<view class="order-detail-page">
  <!-- 浮动返回按钮 -->
  <view wx:if="{{!canGoBack}}" class="float-back-btn" bindtap="goBack">
    <text class="back-icon">←</text>
  </view>

  <view wx:if="{{loading}}" class="loading">加载中...</view>

  <view wx:else class="order-container">
    <!-- 订单状态 -->
    <view class="status-card">
      <view class="status-icon" style="color: {{order.statusColor}}">{{order.statusIcon}}</view>
      <view class="status-info">
        <text class="status-text" style="color: {{order.statusColor}}">{{order.statusText}}</text>
        <text class="status-time">{{order.updatedAtText}}</text>
      </view>
    </view>

    <!-- 订单时间线（最新在上） -->
    <view class="section-card timeline-card">
      <view class="section-title">📋 最新进展</view>
      
      <view class="timeline reverse">
        <!-- 确认完成 -->
        <view wx:if="{{order.confirmedAt}}" class="timeline-item">
          <view class="timeline-dot success"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">✅ 确认完成</view>
              <view class="timeline-time">{{order.confirmedAtText}}</view>
            </view>
            <view class="timeline-desc">订单已完成，感谢您的确认</view>
          </view>
        </view>

        <!-- 拒绝记录 -->
        <view wx:if="{{order.rejectedAt && order.rejectReason}}" class="timeline-item">
          <view class="timeline-dot warning"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">❌ 作品被拒绝</view>
              <view class="timeline-time">{{order.rejectedAtText}}</view>
            </view>
            <view class="timeline-desc reject">拒绝原因：{{order.rejectReason}}</view>
            <view class="timeline-note">摄影师将重新拍摄</view>
          </view>
        </view>

        <!-- 提交作品 -->
        <view wx:if="{{order.submittedAt}}" class="timeline-item {{order.status === 'pending_confirm' ? 'highlight' : ''}}">
          <view class="timeline-dot {{order.status === 'pending_confirm' || order.status === 'completed' ? 'active' : ''}}"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">📸 提交作品</view>
              <view class="timeline-time">{{order.submittedAtText}}</view>
            </view>
            <view class="timeline-desc">摄影师已提交 {{order.photos.length}} 张照片</view>
            
            <!-- 摄影师备注 -->
            <view wx:if="{{order.photographerNote}}" class="photographer-note">
              <view class="note-label">💬 摄影师说：</view>
              <view class="note-content">{{order.photographerNote}}</view>
            </view>

            <!-- 待确认状态提示 -->
            <view wx:if="{{order.status === 'pending_confirm'}}" class="timeline-tip">
              💡 请仔细查看作品，满意请点击下方"确认满意"
              <view wx:if="{{order.rejectCount < 3}}" class="reject-count-tip">
                剩余修改机会：{{3 - (order.rejectCount || 0)}}次
              </view>
              <view wx:else class="reject-count-warning">
                ⚠️ 修改机会已用完，只能确认收货
              </view>
            </view>

            <!-- 照片预览（时间线中） -->
            <view class="timeline-photos">
              <view
                wx:for="{{order.photos}}"
                wx:key="index"
                class="timeline-photo-item"
                bindtap="previewPhoto"
                data-index="{{index}}"
              >
                <image class="timeline-photo-img" src="{{item}}" mode="aspectFill"></image>
                <view wx:if="{{order.status === 'pending_confirm'}}" class="watermark-badge">预览</view>
              </view>
            </view>
          </view>
        </view>

        <!-- 摄影师接单 -->
        <view wx:if="{{order.status !== 'pending_payment' && order.status !== 'cancelled'}}" class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">👍 摄影师接单</view>
            </view>
            <view class="timeline-desc">摄影师 {{photographerInfo.name}} 已开始拍摄</view>
          </view>
        </view>

        <!-- 历史修改记录（仅显示用户自己要求修改的记录） -->
        <block wx:if="{{historyPhotos.length > 0}}">
          <view class="history-divider">
            <text class="divider-text">📚 修改记录（共{{historyPhotos.length}}次）</text>
          </view>
          
          <block wx:for="{{historyPhotos}}" wx:key="index" wx:for-item="history">
            <!-- 用户要求修改 -->
            <view class="timeline-item">
              <view class="timeline-dot user-reject"></view>
              <view class="timeline-content">
                <view class="timeline-header">
                  <view class="timeline-title">🔄 您要求修改</view>
                  <view class="timeline-time">{{history.rejectedAt}}</view>
                </view>
                <view class="timeline-desc reject user-reject-bg">
                  修改原因：{{history.rejectReason}}
                </view>
              </view>
            </view>
            
            <!-- 摄影师提交记录 -->
            <view class="timeline-item">
              <view class="timeline-dot"></view>
              <view class="timeline-content">
                <view class="timeline-header">
                  <view class="timeline-title">📸 摄影师提交</view>
                  <view class="timeline-time">{{history.submittedAt}}</view>
                </view>
                <view class="timeline-desc">提交了 {{history.photos.length}} 张照片</view>
                <!-- 历史照片预览 -->
                <view wx:if="{{history.photos.length > 0}}" class="timeline-photos history-photos">
                  <view
                    wx:for="{{history.photos}}"
                    wx:for-item="photo"
                    wx:key="photo"
                    class="timeline-photo-item"
                    bindtap="previewHistoryPhoto"
                    data-photos="{{history.photos}}"
                    data-index="{{index}}"
                  >
                    <image class="timeline-photo-img" src="{{photo}}" mode="aspectFill"></image>
                    <view class="history-badge">历史</view>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </block>

        <!-- 订单创建 -->
        <view class="timeline-item">
          <view class="timeline-dot active"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <view class="timeline-title">📝 订单创建</view>
              <view class="timeline-time">{{order.createdAtText}}</view>
            </view>
            <view wx:if="{{order.remark}}" class="timeline-desc">备注：{{order.remark}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 订单详情卡片（整合：活动+摄影师+订单信息） -->
    <view class="section-card detail-card">
      <view class="section-title">📋 订单详情</view>
      
      <!-- 活动信息 -->
      <view class="detail-section">
        <view wx:if="{{activityInfo}}" class="activity-info-compact" bindtap="viewActivity">
          <image class="activity-thumb" src="{{activityInfo.coverImage}}" mode="aspectFill"></image>
          <view class="activity-text">
            <text class="activity-name">{{activityInfo.title}}</text>
            <text class="activity-subtitle">{{activityInfo.subtitle}}</text>
          </view>
          <view class="activity-arrow">→</view>
        </view>
        <view wx:else class="no-data">活动已删除</view>
      </view>

      <view class="divider"></view>

      <!-- 摄影师信息 -->
      <view wx:if="{{photographerInfo}}" class="detail-section">
        <view class="photographer-info-compact" bindtap="viewPhotographer">
          <image wx:if="{{photographerInfo.avatar}}" class="photographer-avatar-small" src="{{photographerInfo.avatar}}" mode="aspectFill"></image>
          <view wx:else class="photographer-avatar-small placeholder">{{photographerInfo.name.substring(0,1)}}</view>
          <view class="photographer-text">
            <text class="photographer-name-small">{{photographerInfo.name}}</text>
            <text class="photographer-specialty-small">{{photographerInfo.specialty || '专业摄影师'}}</text>
          </view>
          <view class="photographer-arrow">→</view>
        </view>
      </view>

      <view class="divider"></view>

      <!-- 订单信息 -->
      <view class="detail-section">
        <view class="info-row">
          <text class="label">订单号</text>
          <text class="value code">{{order.orderNo || order._id.slice(-12)}}</text>
        </view>
        <view class="info-row">
          <text class="label">下单时间</text>
          <text class="value">{{order.createdAtText}}</text>
        </view>
        <view class="info-row">
          <text class="label">订单金额</text>
          <text class="value price">¥{{order.totalPrice}}</text>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <!-- 待确认：确认/拒绝 -->
    <view wx:if="{{order.status === 'pending_confirm'}}" class="action-bar">
      <view class="confirm-actions">
        <button class="action-btn reject-btn" bindtap="rejectWork">
          ❌ 拒绝作品
        </button>
        <button class="action-btn confirm-btn" bindtap="confirmWork">
          ✅ 确认满意
        </button>
      </view>
    </view>

    <!-- 待支付：立即支付/取消订单 + 倒计时 -->
    <view wx:elif="{{order.status === 'pending_payment'}}" class="action-bar">
      <view class="countdown-text">支付剩余时间：{{countdownText}}</view>
      <view class="confirm-actions">
        <button class="action-btn reject-btn" bindtap="cancelOrder">取消订单</button>
        <button class="action-btn confirm-btn" bindtap="payOrder" disabled="{{payDisabled}}">立即支付</button>
      </view>
    </view>
  </view>

  <!-- 拒绝原因弹窗 -->
  <view wx:if="{{showRejectModal}}" class="reject-modal">
    <view class="modal-mask" bindtap="closeRejectModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">拒绝作品</text>
        <view class="close-btn" bindtap="closeRejectModal">✕</view>
      </view>
      
      <view class="modal-body">
        <view class="input-label">请详细说明拒绝原因，摄影师将根据您的意见重新拍摄</view>
        <textarea 
          class="reject-textarea"
          placeholder="例如：光线不够明亮、拍摄角度不太好、背景不够干净等，请尽量详细说明您的要求"
          value="{{rejectReason}}"
          bindinput="onRejectReasonInput"
          maxlength="200"
          auto-height
        ></textarea>
        <view class="char-count">{{rejectReason.length}}/200</view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeRejectModal">取消</button>
        <button class="modal-btn submit-btn" bindtap="submitReject">提交</button>
      </view>
    </view>
  </view>

  <!-- 水印Canvas（隐藏） -->
  <canvas 
    type="2d" 
    id="watermarkCanvas" 
    class="watermark-canvas"
    style="position: fixed; left: -9999px; top: -9999px; width: 300px; height: 300px;"
  ></canvas>
</view>
