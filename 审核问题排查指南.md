# 审核问题排查指南

## 问题描述

管理员审核订单时点击"审核通过"，但返回列表后订单仍显示为"待审核"状态。

---

## 可能的原因

### 1. 数据库权限问题
管理员账号可能没有修改订单的权限。

### 2. 缓存问题
页面缓存导致显示的是旧数据。

### 3. 数据更新失败
数据库更新操作失败但没有正确提示。

### 4. 页面刷新问题
审核详情页更新了数据，但列表页没有重新加载。

---

## 排查步骤

### 步骤1：检查数据库权限

1. **打开微信开发者工具**
2. **点击"云开发"控制台**
3. **进入"数据库"**
4. **找到 `activity_orders` 集合**
5. **点击"权限设置"**

**正确的权限配置应该是：**
```
所有用户可读，仅创建者可写
```

**如果管理员需要修改所有订单，需要改为：**
```
所有用户可读，所有用户可写
```

或者使用**自定义安全规则**：
```json
{
  "read": true,
  "write": "auth.openid != null"
}
```

---

### 步骤2：使用测试工具检查

1. **打开小程序**
2. **进入"我的" → "测试工具"**
3. **点击"测试8: 检查订单审核状态"**
4. **查看日志输出**

**日志会显示：**
- 待审核订单数量
- 待确认订单数量
- 每个订单的详细状态

---

### 步骤3：查看控制台日志

**在管理员审核时：**

1. **打开微信开发者工具的控制台**
2. **点击"审核通过"按钮**
3. **观察控制台输出**

**正常情况应该看到：**
```
处理中...
✅ 审核通过
```

**如果失败会看到：**
```
❌ 操作失败: [错误信息]
```

---

### 步骤4：手动修复

如果确认是数据更新失败，可以使用测试工具手动修复：

1. **打开"测试工具"页面**
2. **点击"测试9: 批量审核通过订单"**
3. **确认批量审核**

这会将所有待审核订单强制改为"待确认"状态。

---

## 快速修复方案

### 方案1：修改数据库权限（推荐）

**步骤：**
1. 云开发控制台 → 数据库 → `activity_orders`
2. 权限设置 → 改为"所有用户可写"
3. 保存

**优点：** 彻底解决权限问题
**缺点：** 安全性略低（但对小程序影响不大）

---

### 方案2：使用云函数审核

创建一个云函数来处理审核操作，云函数有完整的数据库权限。

**代码示例：**
```javascript
// cloudfunctions/reviewOrder/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const { orderId, approved, rejectReason } = event;
  
  try {
    if (approved) {
      // 审核通过
      await db.collection('activity_orders')
        .doc(orderId)
        .update({
          data: {
            status: 'pending_confirm',
            reviewedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        });
    } else {
      // 审核拒绝
      await db.collection('activity_orders')
        .doc(orderId)
        .update({
          data: {
            status: 'in_progress',
            adminRejectReason: rejectReason,
            adminRejectedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        });
    }
    
    return { success: true };
  } catch (e) {
    return { success: false, error: e.message };
  }
};
```

---

### 方案3：临时手动修复

如果只是偶尔出现问题，可以：

1. 使用"测试9"批量审核
2. 或者在云开发控制台手动修改订单状态

---

## 验证修复

修复后，按以下步骤验证：

### 1. 创建测试订单
- 用户下单 → 摄影师上传照片 → 订单变为"待审核"

### 2. 管理员审核
- 管理员打开审核页面
- 点击"审核通过"
- 观察是否成功

### 3. 检查状态
- 返回审核列表，订单应该消失（不再显示在待审核列表）
- 进入"我的订单"，订单状态应该是"待确认"

### 4. 查看日志
- 使用"测试8"检查订单状态
- 确认订单已从 `pending_review` 变为 `pending_confirm`

---

## 常见错误信息

### 错误1：`permission denied`
**原因：** 数据库权限不足
**解决：** 修改 `activity_orders` 集合权限为"所有用户可写"

### 错误2：`doc not found`
**原因：** 订单ID不存在
**解决：** 检查订单是否已被删除

### 错误3：`update failed`
**原因：** 数据格式错误或字段冲突
**解决：** 检查更新的数据格式

---

## 预防措施

### 1. 统一使用云函数
所有重要的数据库操作都通过云函数执行，避免权限问题。

### 2. 添加详细日志
在关键操作处添加 console.log，方便排查问题。

### 3. 错误提示优化
将错误信息详细展示给用户，而不是只显示"操作失败"。

### 4. 定期检查
使用测试工具定期检查订单状态，及时发现异常。

---

## 联系开发人员

如果以上方法都无法解决，请提供以下信息：

1. **控制台完整日志**（截图）
2. **订单号**（出问题的订单）
3. **操作步骤**（详细描述如何复现问题）
4. **测试8的输出结果**（截图）

---

**最后更新：2025-01-18**


