# 扫码预览权限配置指南

## 问题描述

使用微信开发者工具的"预览"功能生成二维码，扫码后在手机上打开小程序时，可能出现以下问题：
- ❌ 提示无权限
- ❌ 无法访问云资源
- ❌ 图片加载失败
- ❌ 数据库操作失败

---

## 问题原因

1. **云开发权限未配置**
   - 真机环境需要独立的云开发权限配置
   - 开发者工具中的权限与真机权限是分离的

2. **合法域名未配置**
   - 真机环境需要配置服务器合法域名
   - 云存储、云函数的域名需要加入白名单

3. **openid 验证问题**
   - 真机环境的 openid 与模拟器不同
   - 需要确保云开发权限规则正确

---

## 解决方案

### 方案一：使用"真机调试"（推荐）

**适用场景：** 开发测试阶段

**操作步骤：**

1. **打开真机调试**
   - 点击开发者工具顶部工具栏"真机调试"按钮
   - 扫描生成的二维码

2. **授权登录**
   - 首次使用需要授权
   - 允许调试权限

3. **开始调试**
   - 手机上会显示"开发版"标识
   - 可以实时查看手机上的运行情况
   - 开发者工具会显示手机上的控制台日志

**优点：**
- ✅ 无需配置域名
- ✅ 可以查看真机控制台日志
- ✅ 可以实时调试
- ✅ 完整的云开发权限

**缺点：**
- ❌ 需要数据线连接（或同一局域网）
- ❌ 只能一台手机同时调试

---

### 方案二：配置体验版（正式测试使用）

**适用场景：** 多人测试、正式测试

**操作步骤：**

#### 步骤1：上传代码为体验版

1. 点击开发者工具顶部"上传"按钮
2. 填写版本号：`1.0.0`
3. 填写项目备注：`完整功能测试版`
4. 点击"上传"

#### 步骤2：设置为体验版

1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入"开发管理" → "开发版本"
3. 找到刚上传的版本
4. 点击"设为体验版"

#### 步骤3：添加体验成员

1. 在"成员管理" → "体验成员"
2. 点击"添加成员"
3. 输入微信号
4. 体验成员会收到体验版邀请

#### 步骤4：扫码体验

1. 在"开发版本"页面找到体验版二维码
2. 体验成员扫码即可使用
3. 小程序显示"体验版"标识

**优点：**
- ✅ 多人可以同时测试
- ✅ 完整的云开发权限
- ✅ 接近真实环境

**缺点：**
- ❌ 需要上传代码
- ❌ 需要管理员权限

---

### 方案三：配置合法域名（上线前必须）

**适用场景：** 正式发布前

**操作步骤：**

#### 步骤1：获取云开发域名

1. 打开开发者工具
2. 点击"云开发"按钮
3. 进入"设置" → "环境设置"
4. 复制以下域名：
   - 云存储域名：`https://636c-cloud1-9gdsq5jxb7e60ab4-1382624595.tcb.qcloud.la`
   - 云函数域名：`https://tcb-api.tencentcloudapi.com`
   - 数据库域名：需要在云开发控制台查看

#### 步骤2：配置服务器域名

1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入"开发管理" → "开发设置"
3. 找到"服务器域名"配置
4. 添加以下域名：

**request 合法域名：**
```
https://tcb-api.tencentcloudapi.com
```

**uploadFile 合法域名：**
```
https://636c-cloud1-9gdsq5jxb7e60ab4-1382624595.tcb.qcloud.la
```

**downloadFile 合法域名：**
```
https://636c-cloud1-9gdsq5jxb7e60ab4-1382624595.tcb.qcloud.la
```

5. 点击"保存并提交"

#### 步骤3：配置云开发权限

1. 打开云开发控制台
2. 进入"数据库" → "权限设置"
3. 设置为"所有用户可读"：

```json
{
  "read": true,
  "write": "auth.openid == resource.openid"
}
```

4. 进入"云存储" → "权限设置"
5. 设置为"所有用户可读"：

```json
{
  "read": true,
  "write": "auth.openid == resource.openid"
}
```

---

## 快速测试流程（推荐）

### 开发测试阶段

**使用"真机调试"：**

1. 点击开发者工具"真机调试"
2. 扫码连接手机
3. 在手机上测试所有功能
4. 查看开发者工具的控制台日志

### 提交测试阶段

**使用"体验版"：**

1. 上传代码为体验版
2. 添加测试人员为体验成员
3. 测试人员扫码体验版二维码
4. 按照《测试文档-完整功能测试指南.md》进行测试

### 正式发布前

**配置合法域名：**

1. 按照"方案三"配置所有域名
2. 上传代码并提审
3. 等待审核通过
4. 发布正式版

---

## 常见问题排查

### 1. 扫码后提示"开发者工具登录态异常"

**原因：** 使用了"预览"功能，但未配置合法域名

**解决：** 改用"真机调试"或"体验版"

---

### 2. 扫码后白屏，无任何显示

**原因：** 云开发初始化失败

**解决：**
1. 检查 `app.js` 中的云开发环境ID是否正确
2. 检查手机网络连接
3. 使用"真机调试"查看控制台错误

---

### 3. 图片无法加载（403错误）

**原因：** 云存储权限未配置

**解决：**
1. 打开云开发控制台
2. 进入"云存储" → "权限设置"
3. 设置为"所有用户可读"

---

### 4. 数据库操作失败

**原因：** 数据库权限未配置

**解决：**
1. 打开云开发控制台
2. 进入"数据库" → "权限设置"
3. 设置为"所有用户可读"

---

### 5. 无法登录

**原因：** 真机环境的 openid 与模拟器不同

**解决：**
1. 删除手机小程序缓存
2. 重新扫码进入
3. 重新授权登录

---

## 推荐配置（按阶段）

### 阶段一：自己开发调试
- ✅ 使用开发者工具模拟器
- ✅ 偶尔使用"真机调试"验证

### 阶段二：提交助理测试
- ✅ 上传体验版
- ✅ 添加助理为体验成员
- ✅ 提供《测试文档-完整功能测试指南.md》

### 阶段三：正式发布前
- ✅ 配置所有合法域名
- ✅ 配置云开发权限
- ✅ 上传审核版本

---

## 当前环境信息

**云开发环境ID：** `cloud1-9gdsq5jxb7e60ab4`

**云存储域名：**
```
https://636c-cloud1-9gdsq5jxb7e60ab4-1382624595.tcb.qcloud.la
```

**需要配置的域名列表：**
1. `https://tcb-api.tencentcloudapi.com`
2. `https://636c-cloud1-9gdsq5jxb7e60ab4-1382624595.tcb.qcloud.la`

---

## 给助理测试人员的指引

### 方式一：真机调试（需要你在场）

1. 你打开开发者工具，点击"真机调试"
2. 助理扫码连接
3. 助理在手机上测试
4. 你可以在电脑上查看日志

### 方式二：体验版（推荐）

1. 你上传代码为体验版
2. 添加助理为体验成员
3. 助理扫码体验版二维码
4. 助理独立测试
5. 填写测试报告反馈

---

## 总结

**最简单的方式（立即可用）：**
- 使用"真机调试"，无需任何配置

**最适合多人测试的方式：**
- 上传"体验版"，添加体验成员

**正式发布必须做的：**
- 配置合法域名，配置云开发权限

**当前阶段建议：**
- 使用"体验版" + 《测试文档-完整功能测试指南.md》
- 让助理扫码体验版进行完整测试
- 根据测试报告修复问题

---

**如有问题，随时沟通！** 💪



