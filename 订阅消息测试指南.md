# 订阅消息测试指南

## ✅ 已完成的配置

### 1. 模板ID配置
- **订单支付成功通知**: `RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg`
- 已填入 `miniprogram/utils/notification.js` 文件

### 2. 云函数准备
- `cloudfunctions/sendSubscribeMessage/` 已创建
- 包含完整的发送逻辑

---

## 🎯 第一步：上传云函数

### 在微信开发者工具中操作：

1. **找到云函数目录**
   - 左侧文件列表 → `cloudfunctions` → `sendSubscribeMessage`

2. **右键点击 `sendSubscribeMessage` 文件夹**

3. **选择：上传并部署：云端安装依赖**
   - 这会自动安装 `wx-server-sdk` 依赖

4. **等待上传完成**
   - 看到"上传成功"提示
   - 大约需要 1-2 分钟

5. **验证上传成功**
   - 打开微信开发者工具的"云开发控制台"
   - 点击左侧"云函数"
   - 应该能看到 `sendSubscribeMessage` 函数

---

## 🧪 第二步：测试订阅消息

### 测试场景：用户下单后收到通知

#### 1. 在代码中添加测试调用

打开 `miniprogram/pages/apply/payment.js`，找到支付成功后的代码（大约在第 180 行左右），添加测试代码：

```javascript
// 在支付成功后，添加订阅消息测试
const notificationUtil = require('../../utils/notification');

// 先请求订阅消息授权
await notificationUtil.requestSubscribeMessage([
  notificationUtil.TEMPLATE_IDS.ORDER_CREATED
]);

// 发送订单创建通知
await notificationUtil.sendOrderCreatedNotification({
  openid: wx.getStorageSync('userOpenid'), // 用户openid
  orderId: orderData._id,
  orderNo: orderData.orderNo,
  studentName: orderData.studentName,
  amount: orderData.totalAmount,
  photographerName: '测试摄影师'
});
```

#### 2. 测试流程

**步骤 A：清空缓存**
- 微信开发者工具 → 工具 → 清除缓存 → 清除全部缓存
- 重新编译

**步骤 B：模拟下单**
1. 进入小程序
2. 选择一个活动
3. 填写学生信息
4. 点击"提交订单"

**步骤 C：查看授权弹窗**
- 应该会弹出订阅消息授权窗口
- 显示："次元学校想给你发送通知"
- 包含模板名称："订单支付成功通知"
- 点击"允许"或"总是允许"

**步骤 D：查看控制台日志**
```
📨 发送订阅消息: { touser: 'xxx', template_id: 'RWj4PBhIbcTzunNXYo-jJPTw9P_S7HQGCtqmDQTcqWg', page: '/pages/user/orders/detail?id=xxx' }
✅ 订阅消息发送成功
```

**步骤 E：查看微信消息**
- 打开微信（手机或电脑）
- 查看"服务通知"
- 应该收到一条来自"次元学校"的订阅消息

---

## 📱 第三步：查看消息效果

### 消息应该包含以下内容：

```
订单支付成功通知

服务类型：证件照拍摄
订单编号：ORD20250118XXXX
学生姓名：张三
订单金额：¥50
温馨提示：订单已创建，等待摄影师处理

点击查看详情 →
```

---

## ❓ 常见问题排查

### Q1: 没有弹出授权窗口？

**检查：**
1. 模板ID是否填写正确
2. 云函数是否上传成功
3. 控制台是否有报错

### Q2: 授权成功但没收到消息？

**检查：**
1. 查看云函数日志：
   - 云开发控制台 → 云函数 → sendSubscribeMessage → 日志
   - 查看是否有错误信息

2. 检查 openid 是否正确：
   ```javascript
   console.log('用户openid:', wx.getStorageSync('userOpenid'));
   ```

3. 检查模板数据格式：
   - 每个字段的值不能超过20个字符
   - `amount` 字段格式：`¥50.00`
   - `date` 字段格式：`2025-01-18 10:30:00`

### Q3: 云函数报错？

**常见错误：**

1. **"invalid template_id"**
   - 模板ID填写错误
   - 检查 `notification.js` 中的 `TEMPLATE_IDS.ORDER_CREATED`

2. **"user refuse to accept the msg"**
   - 用户拒绝了授权
   - 需要重新请求授权

3. **"openapi is not authorized"**
   - 云函数没有订阅消息权限
   - 检查 `config.json` 配置

---

## 🎉 测试成功标准

- ✅ 授权窗口正常弹出
- ✅ 用户点击允许后无报错
- ✅ 控制台显示"发送成功"
- ✅ 微信收到订阅消息
- ✅ 消息内容显示正确
- ✅ 点击消息能跳转到订单详情页

---

## 📝 测试记录

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 云函数上传 | ⏳ 待测试 | |
| 授权弹窗 | ⏳ 待测试 | |
| 消息发送 | ⏳ 待测试 | |
| 消息接收 | ⏳ 待测试 | |
| 跳转功能 | ⏳ 待测试 | |

---

## 🚀 下一步

测试成功后，可以继续创建其他4个模板：
1. 服务进度通知
2. 审核结果通知
3. 订单完成通知
4. 待处理提醒

---

**有任何问题随时告诉我！**



