# 🐛 问题报告：重复订单和数据异常

## 📋 问题描述

### 问题1: 点击返回按钮创建重复订单

**现象：**
1. 用户在支付页面选择摄影师"瓜瓜"并支付
2. 支付成功后，用户点击左上角返回按钮
3. 系统创建了2个订单（订单2和订单3）
4. 订单2显示摄影师"瓜瓜"，价格¥22
5. 订单3不显示摄影师，价格¥20

**影响：**
- 用户困惑：不知道哪个订单是有效的
- 摄影师困惑：收到多个订单通知
- 数据混乱：订单信息不一致

---

### 问题2: 订单详情显示学生信息为空

**现象：**
- 管理员查看订单详情时，"学生："字段后面为空
- 但订单列表中显示了学生名字

**原因：**
- 订单数据中 `studentName` 字段可能为空
- 或者页面读取字段名称不一致

---

### 问题3: 摄影师无法看到参考图

**现象：**
- 订单1（第一次下单）在"待上传"状态
- 摄影师打开订单详情，看不到用户上传的参考图（生活照）

**原因：**
- 旧订单没有 `lifePhotos` 字段
- 需要运行测试工具7修复

---

## 🔍 问题分析

### 问题1的根本原因

**时间线：**
1. 用户点击"立即支付" → `submitPayment()` 开始执行
2. `submitting` 设置为 `true`
3. 创建订单（异步操作，需要1-2秒）
4. 订单创建成功
5. 清除缓存数据
6. 显示成功弹窗
7. `wx.reLaunch` 跳转到首页

**问题点：**
- 在步骤3-5之间（订单创建中），用户点击了返回按钮
- 此时缓存数据还未清除
- 用户返回到选择摄影师页面
- 再次选择摄影师并支付
- 创建了第二个订单

**为什么会有两个订单？**
- 第一次支付的订单创建成功（订单2）
- 用户返回后再次支付（订单3）
- 第二次支付时，可能数据不完整（因为页面状态被破坏）

---

### 问题2的根本原因

**可能原因：**
1. **字段名不一致**
   - 订单创建时使用 `studentName`
   - 但某些地方可能使用了其他字段名

2. **数据未正确传递**
   - `formData.childName` 为空
   - 导致 `studentName` 为空字符串

3. **重复订单导致**
   - 第二次创建订单时，页面状态不正确
   - `formData` 可能已被清空

---

## ✅ 解决方案

### 方案1: 完善防重复提交机制

**目标：** 确保用户无法在订单创建过程中返回并重复提交

**实现：**

#### 1.1 在支付页面添加全局锁

```javascript
// pages/apply/payment.js
Page({
  data: {
    submitting: false,
    orderCreating: false  // 新增：订单创建中标志
  },

  onLoad() {
    // 检查是否正在创建订单
    const isCreating = wx.getStorageSync('orderCreating');
    if (isCreating) {
      console.warn('⚠️ 检测到订单正在创建中，禁止重复进入');
      wx.showModal({
        title: '提示',
        content: '订单正在创建中，请稍候...',
        showCancel: false,
        success: () => {
          wx.reLaunch({
            url: '/pages/index/index'
          });
        }
      });
      return;
    }

    // 原有逻辑...
  },

  async submitPayment() {
    if (this.data.submitting) {
      return;
    }

    // 设置全局锁
    wx.setStorageSync('orderCreating', true);
    this.setData({ submitting: true, orderCreating: true });

    try {
      // 创建订单...
      
      // 成功后清除锁和缓存
      wx.removeStorageSync('orderCreating');
      wx.removeStorageSync('applyFormData');
      wx.removeStorageSync('selectedPhotographer');
      wx.removeStorageSync('studentId');
      
      // 显示成功提示并跳转
      wx.showModal({
        title: '申请成功',
        content: '您的入学申请已提交，摄影师将在3个工作日内完成拍摄。',
        showCancel: false,
        success: () => {
          wx.reLaunch({
            url: '/pages/index/index'
          });
        }
      });
    } catch (e) {
      // 失败时清除锁，允许重试
      wx.removeStorageSync('orderCreating');
      this.setData({ submitting: false, orderCreating: false });
      
      wx.showToast({
        title: '提交失败: ' + e.message,
        icon: 'none'
      });
    }
  }
});
```

#### 1.2 在页面卸载时清理

```javascript
onUnload() {
  // 如果订单还在创建中，不清除锁
  if (!this.data.orderCreating) {
    wx.removeStorageSync('orderCreating');
  }
}
```

---

### 方案2: 添加订单去重检查

**目标：** 即使创建了重复订单，也能在数据库层面检测并阻止

**实现：**

```javascript
async submitPayment() {
  // ... 前面的代码

  // 检查是否已存在相同的订单
  const existingOrders = await db.collection('activity_orders')
    .where({
      _openid: userOpenId,
      studentName: this.data.formData.childName,
      photographerId: this.data.photographer._id,
      createdAt: db.command.gte(new Date(Date.now() - 60000).toISOString()) // 1分钟内
    })
    .get();

  if (existingOrders.data.length > 0) {
    console.warn('⚠️ 检测到重复订单，阻止创建');
    wx.showModal({
      title: '提示',
      content: '您已提交过此订单，请勿重复提交',
      showCancel: false,
      success: () => {
        wx.reLaunch({
          url: '/pages/user/orders/orders'
        });
      }
    });
    return;
  }

  // 继续创建订单...
}
```

---

### 方案3: 修复学生信息显示问题

**检查点：**

1. **确保 formData.childName 有值**
   ```javascript
   console.log('📝 表单数据:', this.data.formData);
   console.log('👤 学生姓名:', this.data.formData.childName);
   ```

2. **确保订单数据正确保存**
   ```javascript
   const orderData = {
     studentName: this.data.formData.childName || '未知学生',
     // ... 其他字段
   };
   console.log('💾 订单数据:', orderData);
   ```

3. **确保页面正确读取**
   ```xml
   <!-- admin/orders/detail.wxml -->
   <text>学生：{{order.studentName || '未知'}}</text>
   ```

---

### 方案4: 修复参考图问题

**已有解决方案：** 运行测试工具7

```
1. 进入测试工具页面：/pages/test/archive-test
2. 点击「测试7: 修复旧订单添加生活照」
3. 等待批量更新完成
4. 刷新摄影师订单页面
```

---

## 🧪 测试步骤

### 测试1: 验证防重复提交

1. 填写申请表
2. 选择摄影师
3. 点击"立即支付"
4. **立即点击左上角返回按钮**
5. 检查是否能再次进入支付页面
6. 检查是否创建了重复订单

**预期结果：**
- 返回后提示"订单信息已失效"
- 自动跳转到首页
- 只创建1个订单

---

### 测试2: 验证学生信息显示

1. 创建一个新订单
2. 管理员查看订单详情
3. 检查"学生："字段是否显示正确

**预期结果：**
- 显示学生姓名
- 不为空

---

### 测试3: 验证参考图显示

1. 运行测试工具7
2. 摄影师打开"待上传"订单
3. 检查是否能看到4张参考图

**预期结果：**
- 显示4张参考图
- 可以点击预览

---

## 📊 数据修复

### 修复异常订单3

**手动修复步骤：**

1. 打开云开发控制台
2. 数据库 → activity_orders
3. 找到订单3（没有摄影师的那个）
4. 检查数据：
   ```json
   {
     "studentName": "",  // 如果为空，需要补充
     "photographerId": "",  // 如果为空，需要补充
     "photographerName": ""  // 如果为空，需要补充
   }
   ```
5. 两种选择：
   - **删除订单3**（推荐）：点击删除按钮
   - **修复订单3**：补充缺失的字段

**推荐操作：** 删除订单3，因为它是误创建的重复订单。

---

## 💡 预防措施

### 1. 用户教育

在支付成功后的提示中明确说明：
```
申请成功！

您的入学申请已提交，摄影师将在3个工作日内完成拍摄。

请勿重复提交订单。
```

### 2. UI优化

- 支付中显示全屏加载遮罩，禁止用户操作
- 支付成功后立即跳转，不给用户返回的机会

### 3. 数据库约束

- 添加唯一索引：`_openid + studentName + photographerId + createdAt`
- 防止相同用户在短时间内创建相同订单

### 4. 日志监控

- 记录所有订单创建操作
- 监控重复订单的创建
- 及时发现和处理异常

---

## 🎯 优先级

**P0（立即修复）：**
1. ✅ 完善防重复提交机制（方案1）
2. ✅ 添加订单去重检查（方案2）

**P1（尽快修复）：**
3. ✅ 修复学生信息显示问题（方案3）
4. ✅ 运行测试工具7修复参考图（方案4）

**P2（优化）：**
5. 添加全屏加载遮罩
6. 优化用户提示文案
7. 添加数据库约束

---

## 📝 总结

**核心问题：** 用户在订单创建过程中点击返回，导致重复提交

**根本原因：** 
1. 缓存数据清除时机不对
2. 没有全局锁机制
3. 没有订单去重检查

**解决方案：**
1. 添加全局锁（`orderCreating`）
2. 页面加载时检查锁状态
3. 添加订单去重检查
4. 优化数据清除逻辑

**预期效果：**
- 用户无法创建重复订单
- 即使尝试返回，也会被拦截
- 数据一致性得到保证
