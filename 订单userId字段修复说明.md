# è®¢å•userIdå­—æ®µä¿®å¤è¯´æ˜

## âœ… ä¿®å¤å®Œæˆ

å·²æˆåŠŸä¿®å¤è®¢å•å½’å±é—®é¢˜ï¼Œç”¨æˆ·ç°åœ¨å¯ä»¥çœ‹åˆ°æ‰€æœ‰å±äºè‡ªå·±çš„è®¢å•äº†ã€‚

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. äº‘å‡½æ•° `createActivityOrder`
**æ–‡ä»¶ï¼š** `/cloudfunctions/createActivityOrder/index.js`

**ä¿®æ”¹ï¼š** æ·»åŠ  `userId` å­—æ®µ
```javascript
const orderRes = await db.collection('activity_orders').add({
  data: {
    _openid: wxContext.OPENID,
    userId: wxContext.OPENID,  // âœ… æ–°å¢ï¼šè®¢å•å½’å±ç”¨æˆ·
    // ...
  }
});
```

---

### 2. æ³¨å†Œå­©å­é¡µé¢ `payment.js`
**æ–‡ä»¶ï¼š** `/miniprogram/pages/apply/payment.js`

**ä¿®æ”¹ï¼š** æ·»åŠ  `userId` å­—æ®µ
```javascript
const orderData = {
  userId: userOpenId,  // âœ… æ–°å¢ï¼šè®¢å•å½’å±ç”¨æˆ·
  orderNo: generatedOrderNo,
  // ...
};
```

---

### 3. ç”¨æˆ·è®¢å•åˆ—è¡¨ `orders.js`
**æ–‡ä»¶ï¼š** `/miniprogram/pages/user/orders/orders.js`

**ä¿®æ”¹ï¼š** æŸ¥è¯¢é€»è¾‘æ”¹ä¸º `userId` æˆ– `_openid`ï¼ˆå…¼å®¹å†å²æ•°æ®ï¼‰
```javascript
// æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„è®¢å•
const res = await db.collection('activity_orders')
  .where(db.command.or([
    { userId: userOpenId },      // âœ… æ–°å­—æ®µï¼šè®¢å•å½’å±ç”¨æˆ·
    { _openid: userOpenId }      // âœ… æ—§å­—æ®µï¼šå…¼å®¹å†å²æ•°æ®
  ]))
  .orderBy('createdAt', 'desc')
  .get();
```

---

### 4. æ•°æ®è¿ç§»å·¥å…·
**æ–‡ä»¶ï¼š** `/miniprogram/pages/test/archive-test.js`

**æ–°å¢ï¼š** æµ‹è¯•23 - è¿ç§»è®¢å•userIdå­—æ®µ

**åŠŸèƒ½ï¼š**
- æŸ¥è¯¢æ‰€æœ‰æ²¡æœ‰ `userId` å­—æ®µçš„è®¢å•
- ä¸ºæ¯ä¸ªè®¢å•æ·»åŠ  `userId = _openid`
- æ˜¾ç¤ºè¿ç§»è¿›åº¦å’Œç»“æœ
- éªŒè¯è¿ç§»ç»“æœ

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šä¸Šä¼ äº‘å‡½æ•° â­ï¸ é‡è¦

1. **å³é”®ç‚¹å‡»** `cloudfunctions/createActivityOrder` æ–‡ä»¶å¤¹
2. **é€‰æ‹©** "ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
3. **ç­‰å¾…ä¸Šä¼ æˆåŠŸ**ï¼ˆæ–‡ä»¶å¤¹å˜ç»¿è‰²ï¼‰

### æ­¥éª¤2ï¼šç¼–è¯‘å°ç¨‹åº

ç‚¹å‡»"ç¼–è¯‘"æŒ‰é’®

### æ­¥éª¤3ï¼šè¿è¡Œæ•°æ®è¿ç§»å·¥å…·

1. è¿›å…¥"æµ‹è¯•å·¥å…·"é¡µé¢
2. ç‚¹å‡» **"æµ‹è¯•23: è¿ç§»è®¢å•userIdå­—æ®µ"**
3. ç¡®è®¤è¿ç§»
4. ç­‰å¾…å®Œæˆ

**é¢„æœŸè¾“å‡ºï¼š**
```
éœ€è¦è¿ç§»çš„è®¢å•: X ä¸ª
å·²æœ‰userIdçš„è®¢å•: Y ä¸ª

å¼€å§‹è¿ç§»...
  å·²å¤„ç† 10/50 ä¸ªè®¢å•...
  å·²å¤„ç† 20/50 ä¸ªè®¢å•...
  ...

è¿ç§»å®Œæˆï¼
  æˆåŠŸ: 50 ä¸ª
  å¤±è´¥: 0 ä¸ª

éªŒè¯è¿ç§»ç»“æœ...
è®¢å• 1:
  _openid: âœ… å­˜åœ¨
  userId: âœ… å­˜åœ¨
  userId == _openid: âœ… æ˜¯
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæŸ¥çœ‹å†å²è®¢å•

1. ç”¨æˆ·ç™»å½•
2. è¿›å…¥"æˆ‘çš„è®¢å•"
3. åº”è¯¥èƒ½çœ‹åˆ°ä¹‹å‰çœ‹ä¸åˆ°çš„è®¢å• âœ…

### æµ‹è¯•2ï¼šåˆ›å»ºæ–°è®¢å•

1. åˆ›å»ºä¸€ä¸ªæ–°è®¢å•
2. æ£€æŸ¥æ•°æ®åº“ä¸­çš„è®¢å•
3. åº”è¯¥æœ‰ `userId` å­—æ®µ âœ…

### æµ‹è¯•3ï¼šè·¨ç”¨æˆ·éªŒè¯

1. ç®¡ç†å‘˜åˆ›å»ºæµ‹è¯•è®¢å•
2. è®¾ç½® `userId` ä¸ºæŸä¸ªç”¨æˆ·çš„ openid
3. è¯¥ç”¨æˆ·åº”è¯¥èƒ½åœ¨"æˆ‘çš„è®¢å•"ä¸­çœ‹åˆ° âœ…

---

## ğŸ” é—®é¢˜éªŒè¯

### åŸé—®é¢˜é‡ç°ï¼ˆä¿®å¤å‰ï¼‰

```
æ‘„å½±å¸ˆæäº¤ä½œå“ â†’ è®¢å•çŠ¶æ€ = pending_confirm
ç”¨æˆ·æŸ¥è¯¢ï¼šwhere({ _openid: ç”¨æˆ·openid })
è®¢å•çš„ _openid = ç®¡ç†å‘˜openid
ç»“æœï¼šæŸ¥è¯¢ä¸åˆ° âŒ
```

### ä¿®å¤å

```
æ‘„å½±å¸ˆæäº¤ä½œå“ â†’ è®¢å•çŠ¶æ€ = pending_confirm
ç”¨æˆ·æŸ¥è¯¢ï¼šwhere({ userId: ç”¨æˆ·openid })
è®¢å•çš„ userId = ç”¨æˆ·openid
ç»“æœï¼šèƒ½æŸ¥è¯¢åˆ° âœ…
```

---

## ğŸ“Š æ•°æ®åº“å­—æ®µè¯´æ˜

### ä¿®æ”¹å‰
```javascript
{
  _openid: "åˆ›å»ºè€…openid",  // å¯èƒ½æ˜¯ç”¨æˆ·ã€ç®¡ç†å‘˜ã€æµ‹è¯•è€…
  orderNo: "è®¢å•å·",
  // ...
}
```

### ä¿®æ”¹å
```javascript
{
  _openid: "åˆ›å»ºè€…openid",      // ä¿ç•™ï¼ˆç³»ç»Ÿè‡ªåŠ¨å­—æ®µï¼‰
  userId: "è®¢å•å½’å±ç”¨æˆ·openid",  // æ–°å¢ï¼ˆæ˜ç¡®è®¢å•å½’å±ï¼‰
  orderNo: "è®¢å•å·",
  // ...
}
```

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### é—®é¢˜1ï¼šç”¨æˆ·çœ‹ä¸åˆ°è®¢å• âœ…
- **åŸå› ï¼š** è®¢å•çš„ `_openid` ä¸æ˜¯ç”¨æˆ·çš„ openid
- **è§£å†³ï¼š** æ–°å¢ `userId` å­—æ®µæ˜ç¡®è®¢å•å½’å±

### é—®é¢˜2ï¼šç®¡ç†å‘˜åˆ›å»ºçš„è®¢å•ç”¨æˆ·çœ‹ä¸åˆ° âœ…
- **åŸå› ï¼š** æŸ¥è¯¢é€»è¾‘åªåŒ¹é… `_openid`
- **è§£å†³ï¼š** æŸ¥è¯¢é€»è¾‘æ”¹ä¸º `userId` æˆ– `_openid`

### é—®é¢˜3ï¼šæµ‹è¯•è®¢å•å¹²æ‰° âœ…
- **åŸå› ï¼š** æµ‹è¯•åˆ›å»ºçš„è®¢å•æ²¡æœ‰æ­£ç¡®çš„ `userId`
- **è§£å†³ï¼š** æ•°æ®è¿ç§»å·¥å…·ç»Ÿä¸€å¤„ç†

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¿…é¡»è¿è¡Œæ•°æ®è¿ç§»

**å†å²è®¢å•ä¸ä¼šè‡ªåŠ¨æ·»åŠ  `userId` å­—æ®µ**

å¿…é¡»è¿è¡Œ"æµ‹è¯•23"æ¥è¿ç§»ç°æœ‰æ•°æ®ï¼

### 2. äº‘å‡½æ•°å¿…é¡»ä¸Šä¼ 

æ–°åˆ›å»ºçš„è®¢å•æ‰ä¼šæœ‰ `userId` å­—æ®µ

å¿…é¡»ä¸Šä¼  `createActivityOrder` äº‘å‡½æ•°ï¼

### 3. å…¼å®¹æ€§ä¿è¯

æŸ¥è¯¢é€»è¾‘ä½¿ç”¨ `or` æ¡ä»¶ï¼š
- æ–°è®¢å•ï¼šé€šè¿‡ `userId` æŸ¥è¯¢
- æ—§è®¢å•ï¼šé€šè¿‡ `_openid` æŸ¥è¯¢
- è¿ç§»åï¼šä¸¤è€…éƒ½èƒ½æŸ¥è¯¢

---

## ğŸ”® æœªæ¥ä¼˜åŒ–å»ºè®®

### 1. æ”¯æŒç®¡ç†å‘˜ä»£åˆ›å»ºè®¢å•

ä¿®æ”¹äº‘å‡½æ•°ï¼Œå…è®¸ä¼ å…¥ `targetUserId`ï¼š

```javascript
// createActivityOrder äº‘å‡½æ•°
const orderRes = await db.collection('activity_orders').add({
  data: {
    _openid: wxContext.OPENID,           // åˆ›å»ºè€…
    userId: event.targetUserId || wxContext.OPENID,  // è®¢å•å½’å±ç”¨æˆ·
    createdBy: event.targetUserId ? 'admin' : 'user',  // åˆ›å»ºè€…ç±»å‹
    // ...
  }
});
```

### 2. æ·»åŠ è®¢å•æƒé™æ ¡éªŒ

åœ¨è®¢å•è¯¦æƒ…é¡µæ·»åŠ æƒé™æ£€æŸ¥ï¼š

```javascript
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæŸ¥çœ‹è®¢å•
if (order.userId !== currentUserOpenId && !isAdmin) {
  wx.showToast({ title: 'æ— æƒæŸ¥çœ‹è¯¥è®¢å•', icon: 'none' });
  wx.navigateBack();
}
```

### 3. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

ä¸º `userId` å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ï¼š

1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
2. æ•°æ®åº“ â†’ activity_orders
3. ç´¢å¼•ç®¡ç† â†’ æ·»åŠ ç´¢å¼•
4. å­—æ®µï¼šuserIdï¼Œç±»å‹ï¼šå‡åº

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `/cloudfunctions/createActivityOrder/index.js`
2. âœ… `/miniprogram/pages/apply/payment.js`
3. âœ… `/miniprogram/pages/user/orders/orders.js`
4. âœ… `/miniprogram/pages/test/archive-test.js`
5. âœ… `/miniprogram/pages/test/archive-test.wxml`
6. âœ… `/è®¢å•ç³»ç»Ÿæ¶æ„é—®é¢˜è¯Šæ–­.md`ï¼ˆè¯Šæ–­æ–‡æ¡£ï¼‰
7. âœ… `/è®¢å•userIdå­—æ®µä¿®å¤è¯´æ˜.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## ğŸ‰ ä¿®å¤å®Œæˆ

**æ ¸å¿ƒä¿®å¤ï¼š**
- âœ… æ·»åŠ  `userId` å­—æ®µæ˜ç¡®è®¢å•å½’å±
- âœ… ä¿®æ”¹æŸ¥è¯¢é€»è¾‘å…¼å®¹æ–°æ—§æ•°æ®
- âœ… æä¾›æ•°æ®è¿ç§»å·¥å…·

**é¢„æœŸæ•ˆæœï¼š**
- âœ… ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰å±äºè‡ªå·±çš„è®¢å•
- âœ… ä¸å—è®¢å•åˆ›å»ºè€…å½±å“
- âœ… æ”¯æŒç®¡ç†å‘˜ä»£åˆ›å»ºè®¢å•ï¼ˆæœªæ¥ï¼‰

**ç°åœ¨è¯·æŒ‰ç…§éƒ¨ç½²æ­¥éª¤æ“ä½œï¼Œç„¶åæµ‹è¯•éªŒè¯ï¼** ğŸš€

