# 📨 订阅消息配置指南

## ✅ 已完成的工作

### 1. 创建了消息通知工具类
- 文件：`miniprogram/utils/notification.js`
- 包含所有通知场景的发送方法

### 2. 创建了发送消息云函数
- 文件：`cloudfunctions/sendSubscribeMessage/`
- 用于调用微信API发送订阅消息

---

## 📋 需要配置的订阅消息模板

### 用户端通知（6个）

#### 1. 订单创建成功
```
模板内容示例：
服务类型：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
学生姓名：{{name3.DATA}}
订单金额：{{amount4.DATA}}
温馨提示：{{thing5.DATA}}
```

#### 2. 照片已上传待审核
```
模板内容示例：
服务类型：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
提示信息：{{thing3.DATA}}
上传时间：{{date4.DATA}}
```

#### 3. 照片审核通过
```
模板内容示例：
审核结果：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
提示信息：{{thing3.DATA}}
审核时间：{{date4.DATA}}
```

#### 4. 照片被拒绝
```
模板内容示例：
审核结果：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
拒绝原因：{{thing3.DATA}}
拒绝时间：{{date4.DATA}}
```

#### 5. 订单已完成
```
模板内容示例：
服务类型：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
完成说明：{{thing3.DATA}}
完成时间：{{date4.DATA}}
```

### 摄影师端通知（3个）

#### 6. 新订单待处理
```
模板内容示例：
服务类型：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
学生姓名：{{name3.DATA}}
订单金额：{{amount4.DATA}}
提示信息：{{thing5.DATA}}
```

#### 7. 照片审核通过
```
模板内容示例：
审核结果：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
提示信息：{{thing3.DATA}}
审核时间：{{date4.DATA}}
```

#### 8. 照片被拒绝需修改
```
模板内容示例：
审核结果：{{thing1.DATA}}
订单编号：{{character_string2.DATA}}
拒绝原因：{{thing3.DATA}}
拒绝时间：{{date4.DATA}}
```

---

## 🔧 配置步骤

### 第一步：在微信公众平台添加模板

1. **登录微信公众平台**
   - 网址：https://mp.weixin.qq.com
   - 使用小程序管理员微信扫码登录

2. **进入订阅消息管理**
   - 左侧菜单：功能 → 订阅消息
   - 或直接访问：https://mp.weixin.qq.com/wxamp/newtmpl/index

3. **选择消息模板**
   - 点击"选用"
   - 在模板库中搜索相关模板
   - 或者自己创建模板

4. **记录模板ID**
   - 每个模板都有一个唯一的模板ID
   - 格式类似：`xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
   - 记录下来，后面会用到

---

### 第二步：配置模板ID

**修改文件：`miniprogram/utils/notification.js`**

找到 `TEMPLATE_IDS` 对象，填入你的模板ID：

```javascript
const TEMPLATE_IDS = {
  // 用户端通知
  ORDER_CREATED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',        // 订单创建成功
  ORDER_ACCEPTED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',       // 摄影师已接单
  PHOTO_UPLOADED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',       // 照片已上传待审核
  PHOTO_APPROVED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',       // 照片审核通过
  PHOTO_REJECTED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',       // 照片被拒绝
  ORDER_COMPLETED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',      // 订单已完成
  
  // 摄影师端通知
  NEW_ORDER: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',            // 新订单待处理
  PHOTO_REVIEW_PASS: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',    // 照片审核通过
  PHOTO_REVIEW_REJECT: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',  // 照片被拒绝需修改
  
  // 管理员端通知（可选）
  ADMIN_NEW_ORDER: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',      // 新订单待审核
  ADMIN_PHOTO_UPLOADED: 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx', // 摄影师已上传照片
};
```

---

### 第三步：上传云函数

**在微信开发者工具中：**

1. 找到 `cloudfunctions/sendSubscribeMessage` 文件夹
2. 右键点击
3. 选择：**"上传并部署：云端安装依赖"**
4. 等待上传完成

---

### 第四步：在代码中调用通知

**示例：支付成功后发送通知**

```javascript
// 在 payment.js 中
const notification = require('../../utils/notification.js');

// 支付成功后
await notification.sendOrderCreatedNotification({
  openid: userOpenId,
  orderId: orderRes._id,
  orderNo: generatedOrderNo,
  studentName: this.data.formData.childName,
  amount: orderData.totalPrice,
  photographerName: this.data.photographer.name
});
```

---

## 📱 用户授权流程

### 订阅消息需要用户授权

**在关键操作前请求授权：**

```javascript
// 在下单前请求授权
const notification = require('../../utils/notification.js');

// 请求订阅多个消息
await notification.requestSubscribeMessage([
  notification.TEMPLATE_IDS.ORDER_CREATED,
  notification.TEMPLATE_IDS.PHOTO_UPLOADED,
  notification.TEMPLATE_IDS.PHOTO_APPROVED
]);
```

**授权弹窗：**
- 用户会看到订阅消息授权弹窗
- 可以选择"总是允许"、"允许"或"拒绝"
- 只有授权后才能收到消息

---

## 🎯 集成到现有代码

### 1. 支付成功后通知

**修改：`miniprogram/pages/apply/payment.js`**

在支付成功的地方添加：

```javascript
// 支付成功后
await notification.sendOrderCreatedNotification({
  openid: userOpenId,
  orderId: orderRes._id,
  orderNo: generatedOrderNo,
  studentName: this.data.formData.childName,
  amount: orderData.totalPrice
});

// 通知摄影师
await notification.sendNewOrderToPhotographer({
  photographerOpenid: photographerOpenId,
  orderId: orderRes._id,
  orderNo: generatedOrderNo,
  studentName: this.data.formData.childName,
  amount: orderData.totalPrice
});
```

### 2. 摄影师上传照片后通知

**修改：摄影师上传照片的代码**

```javascript
// 上传成功后
await notification.sendPhotoUploadedNotification({
  openid: userOpenId,
  orderId: orderId,
  orderNo: orderNo,
  uploadTime: new Date().toLocaleString('zh-CN')
});
```

### 3. 管理员审核后通知

**修改：管理员审核的代码**

```javascript
// 审核通过
await notification.sendPhotoApprovedNotification({
  openid: userOpenId,
  orderId: orderId,
  orderNo: orderNo,
  approveTime: new Date().toLocaleString('zh-CN')
});

// 审核拒绝
await notification.sendPhotoRejectedNotification({
  openid: userOpenId,
  orderId: orderId,
  orderNo: orderNo,
  rejectReason: rejectReason,
  rejectTime: new Date().toLocaleString('zh-CN')
});
```

### 4. 用户确认完成后通知

**修改：用户确认收货的代码**

```javascript
// 订单完成
await notification.sendOrderCompletedNotification({
  openid: userOpenId,
  orderId: orderId,
  orderNo: orderNo,
  studentId: studentId,
  completeTime: new Date().toLocaleString('zh-CN')
});
```

---

## ⚠️ 注意事项

### 1. 订阅消息限制

- **需要用户主动授权**
- **一次授权只能发送一次消息**
- **需要在关键操作前请求授权**

### 2. 模板内容限制

- **thing类型**：最多20个汉字
- **character_string类型**：数字、字母、符号
- **name类型**：最多10个汉字
- **amount类型**：金额格式
- **date类型**：时间格式

### 3. 发送频率限制

- **每个用户每天最多接收3条相同模板的消息**
- **建议合理控制发送频率**

---

## 🧪 测试步骤

### 1. 配置模板ID

- 在微信公众平台添加模板
- 记录模板ID
- 填入 `notification.js`

### 2. 上传云函数

- 上传 `sendSubscribeMessage`
- 验证上传成功

### 3. 测试授权

- 在小程序中请求订阅授权
- 查看授权弹窗是否正常

### 4. 测试发送

- 完成一个订单流程
- 查看是否收到消息通知
- 检查消息内容是否正确

---

## 📝 常见问题

### Q1: 用户没有收到消息

**检查：**
1. 用户是否授权了订阅消息
2. 模板ID是否正确
3. 云函数是否上传成功
4. 查看云函数日志是否有错误

### Q2: 消息内容显示不正确

**检查：**
1. 模板字段类型是否匹配
2. 传入的数据格式是否正确
3. 字段长度是否超限

### Q3: 授权弹窗不显示

**检查：**
1. 模板ID是否正确
2. 是否在正确的时机请求授权
3. 用户是否已经拒绝过授权

---

## 🎉 完成后的效果

**用户体验：**
- ✅ 下单后立即收到确认消息
- ✅ 照片上传后收到通知
- ✅ 审核结果及时推送
- ✅ 订单完成后收到提醒

**摄影师体验：**
- ✅ 新订单及时通知
- ✅ 审核结果及时反馈

**整体效果：**
- ✅ 提升用户体验
- ✅ 减少客服咨询
- ✅ 提高订单完成率

---

**需要帮助随时告诉我！** 🚀



