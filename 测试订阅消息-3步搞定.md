# 测试订阅消息 - 3步搞定

## 重要说明
**这个测试不会触发真实支付！只是模拟下单成功后发送订阅消息。**
**不会影响现有的支付代码！**

---

## 第1步：上传云函数（2分钟）

在微信开发者工具中：

1. 找到 `cloudfunctions/sendSubscribeMessage` 文件夹
2. **右键点击**
3. 选择：**"上传并部署：云端安装依赖"**
4. 等待上传完成

---

## 第2步：打开测试页面（10秒）

在微信开发者工具顶部的页面路径输入框中输入：

```
pages/test-notification/test-notification
```

按回车键

---

## 第3步：测试（1分钟）

你会看到一个测试页面，点击：

**"测试3: 模拟下单并发送通知"** 按钮

然后：
1. 弹出授权窗口 → 点击 **"允许"**
2. 等待几秒
3. 提示"测试完成"

---

## 📱 查看结果

### 在手机上测试（推荐）

1. 点击开发者工具右上角 **"预览"**
2. 用手机扫码
3. 进入测试页面（路径：pages/test-notification/test-notification）
4. 点击"测试3"按钮
5. 授权后，**立即打开微信**
6. 查看 **"服务通知"**
7. 应该收到一条 **"订单支付成功通知"**

### 在开发者工具测试

- 可以看到授权和发送流程
- 但看不到实际的微信通知
- 需要用手机扫码才能看到真实通知

---

## ✅ 测试成功的标志

- ✅ 授权窗口弹出
- ✅ 点击允许后无报错
- ✅ 提示"测试完成"
- ✅ 创建了测试订单（订单号以TEST开头）
- ✅ **手机微信收到服务通知**

---

## 🔍 如果没收到通知

### 1. 检查云函数日志

1. 点击开发者工具顶部 **"云开发"**
2. 左侧菜单 → **"云函数"**
3. 找到 `sendSubscribeMessage`
4. 点击 **"日志"**
5. 查看是否有错误

### 2. 检查控制台

在开发者工具的控制台（Console）中查看：
- 是否有红色错误信息
- 是否显示"✅ 订阅消息发送成功"

### 3. 常见问题

**问题1：提示"请先登录小程序"**
- 解决：先进入小程序首页，完成登录

**问题2：授权窗口没弹出**
- 解决：检查模板ID是否正确填写在 `notification.js` 中

**问题3：发送成功但没收到**
- 解决：必须用手机扫码测试，开发者工具看不到通知

---

## 🧹 测试完成后清理

测试订单可以在数据库中删除：

1. 云开发控制台 → 数据库
2. 打开 `activity_orders` 集合
3. 找到 `orderNo` 以 `TEST` 开头的记录
4. 删除这些测试数据

---

## 📝 测试记录

- [ ] 云函数已上传
- [ ] 测试页面能打开
- [ ] 授权窗口正常弹出
- [ ] 测试订单创建成功
- [ ] 手机收到微信通知

---

**完成这3步，就能验证订阅消息功能是否正常工作！**

**有问题随时告诉我！**



