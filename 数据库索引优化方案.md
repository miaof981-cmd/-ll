# æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€é—®é¢˜åˆ†æ

### å½“å‰è­¦å‘Š

```
å‘èµ·çš„å¦‚ä¸‹æ•°æ®åº“æŸ¥è¯¢ç»è‡ªåŠ¨æ£€æµ‹å‘ç°ä»¥ä¸‹é—®é¢˜ï¼Œä¸”å¯èƒ½è¾ƒä¹‹é«˜æ•ˆçš„ç´¢å¼•æ”¯æŒ
```

**é—®é¢˜æŸ¥è¯¢ï¼š**
```javascript
db.collection('activity_orders').where({
  userId: 'o5_xU4wY1pz-JxOi8XdAX_O0bbHw'
}, {
  _openid: 'o5_xU4wY1pz-JxOi8XdAX_O0bbHw'
})
.orderBy('createdAt', 'desc')
.get()
```

### æ€§èƒ½å½±å“

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| å…¨è¡¨æ‰«æ | æŸ¥è¯¢æ…¢ï¼ŒCPUå ç”¨é«˜ | ğŸ”´ é«˜ |
| æ— æ’åºç´¢å¼• | å†…å­˜æ’åºï¼Œæ€§èƒ½å·® | ğŸŸ¡ ä¸­ |
| éšæ•°æ®å¢é•¿æ¶åŒ– | è®¢å•è¶Šå¤šè¶Šæ…¢ | ğŸ”´ é«˜ |

---

## äºŒã€ç´¢å¼•é…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆæ€»è§ˆ

| é›†åˆ | ç´¢å¼•ç±»å‹ | å­—æ®µ | ä½œç”¨ |
|------|---------|------|------|
| `activity_orders` | ç»„åˆç´¢å¼• | userId + _openid + createdAt | ç”¨æˆ·è®¢å•æŸ¥è¯¢+æ’åº |
| `activity_orders` | å•å­—æ®µç´¢å¼• | photographerId | æ‘„å½±å¸ˆè®¢å•æŸ¥è¯¢ |
| `activity_orders` | å•å­—æ®µç´¢å¼• | status | æŒ‰çŠ¶æ€ç­›é€‰ |
| `users` | å”¯ä¸€ç´¢å¼• | _openid | ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ |
| `photographers` | å•å­—æ®µç´¢å¼• | _openid | æ‘„å½±å¸ˆä¿¡æ¯æŸ¥è¯¢ |

---

### è¯¦ç»†é…ç½®

#### 1. `activity_orders` - æ ¸å¿ƒè®¢å•ç´¢å¼•

**ç´¢å¼•1ï¼šç”¨æˆ·è®¢å•æŸ¥è¯¢ + æ—¶é—´æ’åº**

```json
{
  "name": "idx_user_time",
  "keys": {
    "userId": 1,
    "_openid": 1,
    "createdAt": -1
  },
  "unique": false
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ”¯æŒ `userId` æˆ– `_openid` æŸ¥è¯¢
- âœ… æ”¯æŒ `createdAt` é™åºæ’åˆ—
- âœ… é¿å…å…¨è¡¨æ‰«æ
- âœ… æŸ¥è¯¢é€Ÿåº¦æå‡ **100-1000å€**

**é€‚ç”¨åœºæ™¯ï¼š**
```javascript
// æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ï¼ŒæŒ‰æ—¶é—´å€’åº
db.collection('activity_orders')
  .where({ userId: 'xxx' })
  .orderBy('createdAt', 'desc')
  .get();

// æŸ¥è¯¢ç”¨æˆ·çš„å¾…æ”¯ä»˜è®¢å•
db.collection('activity_orders')
  .where({ 
    _openid: 'xxx',
    status: 'pending_payment'
  })
  .orderBy('createdAt', 'desc')
  .get();
```

---

**ç´¢å¼•2ï¼šæ‘„å½±å¸ˆè®¢å•æŸ¥è¯¢**

```json
{
  "name": "idx_photographer",
  "keys": {
    "photographerId": 1
  },
  "unique": false
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ‘„å½±å¸ˆæŸ¥çœ‹è‡ªå·±çš„ä»»åŠ¡åˆ—è¡¨
- âœ… ç®¡ç†å‘˜æŒ‰æ‘„å½±å¸ˆç­›é€‰è®¢å•

**é€‚ç”¨åœºæ™¯ï¼š**
```javascript
// æ‘„å½±å¸ˆå·¥ä½œå°ï¼šæŸ¥è¯¢åˆ†é…ç»™æˆ‘çš„è®¢å•
db.collection('activity_orders')
  .where({ photographerId: 'photographer_id_xxx' })
  .get();
```

---

**ç´¢å¼•3ï¼šè®¢å•çŠ¶æ€ç´¢å¼•**

```json
{
  "name": "idx_status",
  "keys": {
    "status": 1
  },
  "unique": false
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æŒ‰çŠ¶æ€ç­›é€‰è®¢å•ï¼ˆå¾…æ”¯ä»˜ã€è¿›è¡Œä¸­ç­‰ï¼‰
- âœ… ç»Ÿè®¡å„çŠ¶æ€è®¢å•æ•°é‡

**é€‚ç”¨åœºæ™¯ï¼š**
```javascript
// æŸ¥è¯¢æ‰€æœ‰å¾…å®¡æ ¸è®¢å•
db.collection('activity_orders')
  .where({ status: 'pending_review' })
  .get();

// ç»Ÿè®¡å¾…æ”¯ä»˜è®¢å•æ•°é‡
db.collection('activity_orders')
  .where({ status: 'pending_payment' })
  .count();
```

---

#### 2. `users` - ç”¨æˆ·ä¿¡æ¯ç´¢å¼•

**ç´¢å¼•ï¼šOpenID å”¯ä¸€ç´¢å¼•**

```json
{
  "name": "idx_openid",
  "keys": {
    "_openid": 1
  },
  "unique": true
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… ç”¨æˆ·ç™»å½•æŸ¥è¯¢
- âœ… æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- âœ… ä¿è¯OpenIDå”¯ä¸€æ€§

**é€‚ç”¨åœºæ™¯ï¼š**
```javascript
// ç”¨æˆ·ç™»å½•
db.collection('users')
  .where({ _openid: 'xxx' })
  .get();

// æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
db.collection('users')
  .where({
    _openid: db.command.in(['openid1', 'openid2', 'openid3'])
  })
  .get();
```

---

#### 3. `photographers` - æ‘„å½±å¸ˆä¿¡æ¯ç´¢å¼•

**ç´¢å¼•ï¼šOpenID ç´¢å¼•**

```json
{
  "name": "idx_openid",
  "keys": {
    "_openid": 1
  },
  "unique": false
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ ¹æ®OpenIDæŸ¥è¯¢æ‘„å½±å¸ˆä¿¡æ¯
- âœ… æ”¯æŒå¤´åƒåŒæ­¥åŠŸèƒ½

**é€‚ç”¨åœºæ™¯ï¼š**
```javascript
// æ ¹æ®OpenIDæŸ¥è¯¢æ‘„å½±å¸ˆ
db.collection('photographers')
  .where({ _openid: 'xxx' })
  .get();
```

---

## ä¸‰ã€åˆ›å»ºç´¢å¼•æ­¥éª¤

### æ–¹å¼ä¸€ï¼šäº‘å¼€å‘æ§åˆ¶å°ï¼ˆæ¨è â­ï¼‰

#### æ­¥éª¤1ï¼šæ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°

1. å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. ç‚¹å‡»é¡¶éƒ¨"äº‘å¼€å‘"æŒ‰é’®
3. é€‰æ‹©"æ•°æ®åº“"æ ‡ç­¾

#### æ­¥éª¤2ï¼šåˆ›å»º activity_orders ç´¢å¼•

1. ç‚¹å‡» `activity_orders` é›†åˆ
2. ç‚¹å‡»"ç´¢å¼•"æ ‡ç­¾
3. ç‚¹å‡»"æ–°å»ºç´¢å¼•"

**å¡«å†™ä¿¡æ¯ï¼š**
```
ç´¢å¼•åç§°ï¼šidx_user_time

ç´¢å¼•å­—æ®µï¼š
  userId: å‡åº
  _openid: å‡åº
  createdAt: é™åº

ç´¢å¼•å±æ€§ï¼šæ™®é€šç´¢å¼•ï¼ˆä¸å‹¾é€‰å”¯ä¸€ï¼‰
```

4. ç‚¹å‡»"ç¡®å®š"ï¼Œç­‰å¾…åˆ›å»ºå®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

#### æ­¥éª¤3ï¼šé‡å¤åˆ›å»ºå…¶ä»–ç´¢å¼•

æŒ‰ç…§åŒæ ·æ–¹å¼åˆ›å»ºï¼š
- `idx_photographer` (photographerId: å‡åº)
- `idx_status` (status: å‡åº)

#### æ­¥éª¤4ï¼šåˆ›å»º users ç´¢å¼•

1. åˆ‡æ¢åˆ° `users` é›†åˆ
2. åˆ›å»ºç´¢å¼•ï¼š
   ```
   ç´¢å¼•åç§°ï¼šidx_openid
   ç´¢å¼•å­—æ®µï¼š_openid: å‡åº
   ç´¢å¼•å±æ€§ï¼šå”¯ä¸€ç´¢å¼• âœ“
   ```

#### æ­¥éª¤5ï¼šåˆ›å»º photographers ç´¢å¼•

1. åˆ‡æ¢åˆ° `photographers` é›†åˆ
2. åˆ›å»ºç´¢å¼•ï¼š
   ```
   ç´¢å¼•åç§°ï¼šidx_openid
   ç´¢å¼•å­—æ®µï¼š_openid: å‡åº
   ç´¢å¼•å±æ€§ï¼šæ™®é€šç´¢å¼•
   ```

---

### æ–¹å¼äºŒï¼šä½¿ç”¨äº‘å‡½æ•°è‡ªåŠ¨åˆ›å»º

#### æ­¥éª¤1ï¼šä¸Šä¼ äº‘å‡½æ•°

```bash
# å³é”® cloudfunctions/createIndexes æ–‡ä»¶å¤¹
# é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
```

#### æ­¥éª¤2ï¼šæµ‹è¯•è¿è¡Œ

1. å³é”® `createIndexes` äº‘å‡½æ•°
2. é€‰æ‹©"äº‘å‡½æ•°æµ‹è¯•"
3. ç‚¹å‡»"è°ƒç”¨"
4. æŸ¥çœ‹è¿”å›ç»“æœ

**æˆåŠŸç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "ç´¢å¼•åˆ›å»ºå®Œæˆ",
  "results": [
    { "collection": "activity_orders", "index": "idx_user_time", "status": "success" },
    { "collection": "activity_orders", "index": "idx_photographer", "status": "success" },
    { "collection": "activity_orders", "index": "idx_status", "status": "success" },
    { "collection": "users", "index": "idx_openid", "status": "success" },
    { "collection": "photographers", "index": "idx_openid", "status": "success" }
  ],
  "summary": {
    "total": 5,
    "success": 5,
    "exists": 0
  }
}
```

---

## å››ã€éªŒè¯ç´¢å¼•æ•ˆæœ

### 1. æ§åˆ¶å°éªŒè¯

åˆ›å»ºç´¢å¼•åï¼Œé‡æ–°è¿›å…¥è®¢å•åˆ—è¡¨ï¼Œæ§åˆ¶å°åº”è¯¥**ä¸å†å‡ºç°**ç´¢å¼•è­¦å‘Šï¼

### 2. æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æŸ¥è¯¢50ä¸ªè®¢å• | 2-5ç§’ | 0.1-0.3ç§’ | **10-50å€** |
| æŸ¥è¯¢1000ä¸ªè®¢å• | 10-30ç§’ | 0.2-0.5ç§’ | **50-100å€** |
| æŒ‰çŠ¶æ€ç­›é€‰ | 3-8ç§’ | 0.1-0.2ç§’ | **30-80å€** |

### 3. æŸ¥çœ‹ç´¢å¼•çŠ¶æ€

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ é€‰æ‹©é›†åˆ â†’ "ç´¢å¼•"æ ‡ç­¾

åº”è¯¥èƒ½çœ‹åˆ°ï¼š
```
âœ… idx_user_time (userIdâ†‘, _openidâ†‘, createdAtâ†“)
âœ… idx_photographer (photographerIdâ†‘)
âœ… idx_status (statusâ†‘)
```

---

## äº”ã€æ³¨æ„äº‹é¡¹

### 1. ç´¢å¼•ç»´æŠ¤æˆæœ¬

| æ“ä½œ | å½±å“ | è¯´æ˜ |
|------|------|------|
| æŸ¥è¯¢ | âœ… å¿« | ç´¢å¼•å¤§å¹…æå‡æŸ¥è¯¢é€Ÿåº¦ |
| æ’å…¥ | âš ï¸ ç•¥æ…¢ | éœ€è¦æ›´æ–°ç´¢å¼•ï¼ˆå¯å¿½ç•¥ï¼‰ |
| æ›´æ–° | âš ï¸ ç•¥æ…¢ | æ›´æ–°ç´¢å¼•å­—æ®µæ—¶éœ€è¦æ›´æ–°ç´¢å¼• |
| åˆ é™¤ | âš ï¸ ç•¥æ…¢ | éœ€è¦æ›´æ–°ç´¢å¼• |

**ç»“è®ºï¼š** æŸ¥è¯¢é¢‘ç‡è¿œé«˜äºå†™å…¥ï¼Œç´¢å¼•æ”¶ç›Šè¿œå¤§äºæˆæœ¬ âœ…

### 2. ç´¢å¼•ç©ºé—´å ç”¨

- æ¯ä¸ªç´¢å¼•çº¦å æ•°æ®é‡çš„ 10-20%
- 5ä¸ªç´¢å¼• + 10000æ¡è®¢å• â‰ˆ 10-20MB
- å¾®ä¿¡äº‘å¼€å‘æœ‰è¶³å¤Ÿç©ºé—´ï¼Œæ— éœ€æ‹…å¿ƒ

### 3. ä½•æ—¶é‡å»ºç´¢å¼•

- âŒ æ­£å¸¸æƒ…å†µä¸‹æ— éœ€é‡å»º
- âœ… æ•°æ®è¿ç§»åå¯è€ƒè™‘é‡å»º
- âœ… å‘ç°æŸ¥è¯¢å¼‚å¸¸å˜æ…¢æ—¶æ£€æŸ¥ç´¢å¼•

---

## å…­ã€ç´¢å¼•æœ€ä½³å®è·µ

### âœ… åº”è¯¥åˆ›å»ºç´¢å¼•çš„æƒ…å†µ

1. **é«˜é¢‘æŸ¥è¯¢å­—æ®µ** - å¦‚ userId, _openid, status
2. **æ’åºå­—æ®µ** - å¦‚ createdAt, updatedAt
3. **å”¯ä¸€æ€§å­—æ®µ** - å¦‚ _openid (usersé›†åˆ)
4. **å¤–é”®å­—æ®µ** - å¦‚ photographerId, activityId

### âŒ ä¸åº”è¯¥åˆ›å»ºç´¢å¼•çš„æƒ…å†µ

1. **ä½é¢‘æŸ¥è¯¢å­—æ®µ** - å¦‚ childName, parentName
2. **æ•°æ®é‡å¾ˆå°çš„é›†åˆ** - å¦‚ < 100 æ¡
3. **é¢‘ç¹æ›´æ–°çš„å­—æ®µ** - ç´¢å¼•ç»´æŠ¤æˆæœ¬é«˜
4. **å¤§å­—æ®µ** - å¦‚é•¿æ–‡æœ¬ã€æ•°ç»„

---

## ä¸ƒã€æ•…éšœæ’æŸ¥

### Q1: ç´¢å¼•åˆ›å»ºå¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- æƒé™ä¸è¶³
- é›†åˆä¸å­˜åœ¨
- ç´¢å¼•åç§°é‡å¤

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥äº‘å¼€å‘æƒé™
# æ£€æŸ¥é›†åˆæ˜¯å¦å­˜åœ¨
# å°è¯•ä½¿ç”¨ä¸åŒçš„ç´¢å¼•åç§°
```

### Q2: åˆ›å»ºåè¿˜æœ‰è­¦å‘Šï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- ç´¢å¼•æœªç”Ÿæ•ˆï¼ˆéœ€è¦1-2åˆ†é’Ÿï¼‰
- ä½¿ç”¨äº†ä¸åŒçš„æŸ¥è¯¢æ¡ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**
- ç­‰å¾…2-3åˆ†é’Ÿåé‡æ–°æµ‹è¯•
- æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦åŒ¹é…ç´¢å¼•

### Q3: æŸ¥è¯¢è¿˜æ˜¯æ…¢ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- æ•°æ®é‡å¤ªå¤§
- ç´¢å¼•æœªå‘½ä¸­
- è¿”å›ç»“æœå¤ªå¤š

**è§£å†³æ–¹æ¡ˆï¼š**
- æ·»åŠ åˆ†é¡µ `.limit(20).skip(0)`
- æ£€æŸ¥ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º
- ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶

---

## å…«ã€ç›‘æ§ä¸ç»´æŠ¤

### 1. å®šæœŸæ£€æŸ¥

- æ¯æœˆæ£€æŸ¥ä¸€æ¬¡ç´¢å¼•çŠ¶æ€
- å…³æ³¨æ…¢æŸ¥è¯¢è­¦å‘Š
- æ•°æ®é‡å¢é•¿åé‡æ–°è¯„ä¼°

### 2. æ€§èƒ½ç›‘æ§

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ ç»Ÿè®¡åˆ†æ â†’ æ•°æ®åº“ç»Ÿè®¡

å…³æ³¨æŒ‡æ ‡ï¼š
- å¹³å‡æŸ¥è¯¢æ—¶é—´
- æ…¢æŸ¥è¯¢æ¬¡æ•°
- æ•°æ®åº“QPS

---

## æ€»ç»“

âœ… **ç«‹å³åˆ›å»ºçš„ç´¢å¼•**ï¼š

1. `activity_orders.idx_user_time` (userId, _openid, createdAt)
2. `activity_orders.idx_photographer` (photographerId)
3. `activity_orders.idx_status` (status)
4. `users.idx_openid` (_openid, å”¯ä¸€)
5. `photographers.idx_openid` (_openid)

âš¡ **é¢„æœŸæ•ˆæœ**ï¼š

- è®¢å•åˆ—è¡¨åŠ è½½é€Ÿåº¦æå‡ **10-50å€**
- æ§åˆ¶å°ä¸å†å‡ºç°ç´¢å¼•è­¦å‘Š
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

ğŸ¯ **è¡ŒåŠ¨å»ºè®®**ï¼š

1. **ç«‹å³åˆ›å»º** - é€šè¿‡äº‘å¼€å‘æ§åˆ¶å°åˆ›å»ºç´¢å¼•
2. **æµ‹è¯•éªŒè¯** - é‡æ–°è¿›å…¥è®¢å•åˆ—è¡¨ï¼Œç¡®è®¤æ— è­¦å‘Š
3. **ç›‘æ§æ•ˆæœ** - è§‚å¯ŸæŸ¥è¯¢é€Ÿåº¦æ˜¯å¦æå‡

---

**æœ€åæ›´æ–°ï¼š2025-10-23**  
**ç»´æŠ¤è€…ï¼šAI Assistant**

