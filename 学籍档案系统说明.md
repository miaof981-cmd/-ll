# 学籍档案系统说明

## 📋 系统架构

### 数据库集合

1. **`students`** - 学生基本档案
   - 用途：存储学生基本信息，用于"我的孩子"列表
   - 字段：
     ```javascript
     {
       studentId: "20250001",    // 学号（年份+序号）
       name: "张三",             // 姓名
       avatar: "cloud://...",    // 证件照
       gender: "男",             // 性别
       age: 8,                   // 年龄
       class: "一年级1班",        // 班级
       parentName: "张父",        // 家长姓名
       parentPhone: "138...",    // 家长电话
       createdAt: "2025-...",    // 创建时间
       updatedAt: "2025-...",    // 更新时间
       source: "order",          // 来源：订单
       sourceOrderId: "..."      // 源订单ID
     }
     ```

2. **`student_records`** - 学业档案记录
   - 用途：存储学生的学业记录（成绩、处罚、图片等）
   - 字段：
     ```javascript
     {
       studentId: "20250001",    // 关联的学号
       type: "grade",            // 类型：grade/punishment/image
       // 成绩记录 (type: grade)
       term: "2024-2025上学期",
       chinese: 95,
       math: 90,
       english: 88,
       // 处罚记录 (type: punishment)
       type: "警告",
       reason: "迟到",
       // 图片档案 (type: image)
       title: "运动会照片",
       description: "...",
       imageUrl: "cloud://...",
       // 通用字段
       createdAt: "2025-..."
     }
     ```

## 🔄 工作流程

### 1. 用户下单流程
```
用户填写入学信息 
  ↓
选择摄影师 
  ↓
支付订单（创建 activity_orders 记录）
  ↓
摄影师上传证件照 
  ↓
订单状态 → pending_confirm
```

### 2. 学籍档案创建流程
```
用户确认收货
  ↓
系统生成学号（如：20250001）
  ↓
创建 students 记录（基本信息 + 证件照）
  ↓
创建 student_records 初始记录
  ↓
绑定到用户账号（_openid）
  ↓
"我的孩子"显示档案
```

### 3. 档案展示流程
```
"我的" → 点击孩子头像
  ↓
跳转到 /pages/records/records
  ↓
显示学生基本信息卡片（证件照、姓名、学号、班级等）
  ↓
显示学业记录（成绩、处罚、图片档案）
```

## 🎯 学号生成规则

### 格式
```
YYYYNNNN
年份(4位) + 序号(4位)
```

### 示例
- 2025年第1个学生：`20250001`
- 2025年第2个学生：`20250002`
- ...
- 2025年第9999个学生：`20259999`

### 生成逻辑
1. 获取当前年份（如：2025）
2. 查询该年份已有的最大学号
3. 序号 +1
4. 格式化为 `年份0000` 格式

## 🧪 测试流程

### 方法1：使用测试工具（推荐）

1. **刷新小程序**
2. **进入测试工具**
   - "我的" → "档案测试工具"
3. **点击"测试2：创建待确认订单"**
   - 系统会创建一个 pending_confirm 状态的订单
   - 包含真实照片和完整信息
4. **点击"去确认"**
   - 自动跳转到"我的订单"
5. **找到订单，点击"确认满意"**
6. **查看控制台日志**
   ```
   🔢 开始生成学号...
   ✅ 学号生成成功: 20250001
   ✅ 学生档案创建成功！
   📝 创建学籍档案记录...
   ✅ 学籍档案记录创建成功！
   ```
7. **返回"我的"页面**
   - 应该能看到新创建的孩子
8. **点击孩子头像**
   - 进入学籍档案页面
   - 应该能看到证件照、姓名、学号、性别、年龄、班级、家长信息

### 方法2：完整流程测试

1. **创建新订单**
   - "首页" → 选择活动 → "立即报名"
   - 填写学生信息（含照片）
   - 选择摄影师 → 支付
2. **摄影师上传照片**
   - 切换角色为"摄影师"
   - "工作台" → 找到订单 → 上传证件照
3. **用户确认收货**
   - 切换回"家长"角色
   - "我的订单" → 点击订单 → "确认满意"
4. **查看档案**
   - "我的" → 点击孩子头像

## ⚠️ 常见问题

### Q1: 学号显示为 0001 而不是 20250001
**A:** 需要更新 `utils/student-id.js`，确保生成的学号包含年份前缀。

### Q2: 学籍档案页面为空
**A:** 可能的原因：
1. `student_records` 集合不存在（第一次使用时会自动创建）
2. `students` 记录中的 `avatar` 字段为空
3. 数据查询失败

**解决方法**：
- 使用测试工具创建一个新订单并确认
- 检查控制台日志，查看是否有错误

### Q3: 点击孩子头像后显示"学生不存在"
**A:** 可能的原因：
1. `students` 记录未创建
2. 学号格式不匹配

**解决方法**：
- 检查数据库中的 `students` 集合
- 确认学号格式正确

### Q4: 图片不显示
**A:** 可能的原因：
1. 云存储路径错误
2. 图片未上传成功

**解决方法**：
- 检查 `avatar` 字段的值
- 确认是 `cloud://` 开头的云存储路径

## 📊 数据库索引建议

为了提升查询性能，建议创建以下索引：

### students 集合
```javascript
{ studentId: 1 }  // 单字段索引
```

### student_records 集合
```javascript
{ studentId: 1, createdAt: -1 }  // 组合索引
{ type: 1 }  // 单字段索引
```

### activity_orders 集合
```javascript
{ _openid: 1, createdAt: -1 }  // 组合索引
{ status: 1 }  // 单字段索引
```

## 🔍 调试技巧

### 1. 查看完整日志
控制台会输出详细的创建流程日志：
```
========================================
🎯 confirmWork() 点击触发！！！
========================================
📦 当前订单数据: {...}
📦 当前活动数据: {...}
📋 检查是否需要创建学生档案...
   订单信息: {...}
   活动信息: {...}
✅ 条件匹配！这是证件照订单，开始创建学生档案...
🔍 检查学生档案是否已存在...
   查询结果数量: 0
📝 档案不存在，开始创建新档案...
🔢 开始生成学号...
✅ 学号生成成功: 20250001
✅ 学生档案创建成功！
📝 创建学籍档案记录...
✅ 学籍档案记录创建成功！
```

### 2. 检查数据库
在云开发控制台查看：
- `students` 集合是否有记录
- `student_records` 集合是否存在
- 学号格式是否正确
- `avatar` 字段是否有值

### 3. 查看页面数据
在 `pages/records/records.js` 的 `onLoad` 中添加：
```javascript
console.log('student 数据:', this.data.student);
console.log('records 数据:', this.data.records);
```

## 📝 更新日志

### v2.0.0 (2025-10-15)
- ✅ 修复学号格式（改为年份+序号）
- ✅ 统一数据库集合结构（student_records）
- ✅ 优化学籍档案页面显示
- ✅ 添加学生基本信息卡片
- ✅ 完善测试工具

