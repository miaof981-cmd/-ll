# 修复审核问题 - 完整方案

## 问题现象

管理员审核订单时点击"审核通过"，但返回列表后订单仍显示为"待审核"状态，审核操作无效。

---

## 根本原因

**数据库权限配置问题**

`activity_orders` 集合的权限设置不正确，导致管理员账号无法修改订单状态。

---

## 解决方案（3步搞定）

### 第1步：修改数据库权限（最重要）

1. **打开微信开发者工具**
2. **点击顶部"云开发"按钮**
3. **进入"数据库"标签**
4. **找到 `activity_orders` 集合**
5. **点击集合右侧的"权限设置"按钮**
6. **选择"所有用户可读，所有用户可写"**
7. **点击"保存"**

**截图参考：**
```
┌─────────────────────────────────────┐
│  集合名称: activity_orders          │
│                                     │
│  权限设置:                          │
│  ○ 仅创建者可读写                   │
│  ○ 所有用户可读，仅创建者可写       │
│  ● 所有用户可读，所有用户可写  ✓    │  ← 选择这个
│  ○ 自定义安全规则                   │
│                                     │
│  [保存]  [取消]                     │
└─────────────────────────────────────┘
```

---

### 第2步：使用测试工具检查

1. **打开小程序**
2. **进入"我的"页面**
3. **找到并点击"测试工具"**（如果没有，请添加入口）
4. **点击"测试8: 检查订单审核状态"**
5. **查看日志输出**

**预期输出：**
```
========================================
🔍 测试8: 检查订单审核状态
========================================
📋 查询待审核订单...
📊 待审核订单数量: 1

订单 1:
  订单号: ORD20250118001
  学生: 崽崽
  状态: pending_review
  上传时间: 2025-01-18T10:30:00.000Z
  照片数量: 2
  订单ID: xxxxx

📋 查询待确认订单（已审核通过）...
📊 待确认订单数量: 0

订单状态统计:
  pending_review: 1 个
  in_progress: 2 个
  completed: 5 个

========================================
✅ 检查完成
========================================
```

---

### 第3步：手动修复现有订单（如果需要）

如果第1步修改权限后，现有的待审核订单仍然无法审核，使用测试工具批量修复：

1. **在测试工具页面**
2. **点击"测试9: 批量审核通过订单"**
3. **确认批量审核**

**操作流程：**
```
点击"测试9"
   ↓
显示待审核订单列表
   ↓
弹窗询问："发现 1 个待审核订单，是否全部审核通过？"
   ↓
点击"全部通过"
   ↓
批量审核完成
   ↓
订单状态变为"待确认"
```

---

## 验证修复

完成以上步骤后，按以下流程验证：

### 1. 创建新的测试订单

**用户端操作：**
- 登录小程序
- 选择活动下单
- 选择摄影师
- 完成支付

**摄影师端操作：**
- 登录摄影师账号
- 进入"待上传"订单
- 上传照片
- 提交审核

此时订单状态应该变为 `pending_review`（待审核）

---

### 2. 管理员审核

**管理员端操作：**
1. 登录管理员账号
2. 进入"审核管理"
3. 找到待审核订单
4. 点击订单进入详情
5. 点击"审核通过"按钮

**预期结果：**
- 显示"审核通过"提示
- 2秒后自动返回列表
- 订单从列表中消失（不再显示在待审核列表）

---

### 3. 检查订单状态

**方法1：用户端查看**
- 用户进入"我的订单"
- 找到该订单
- 订单状态应该显示为"待确认"

**方法2：使用测试工具**
- 运行"测试8: 检查订单审核状态"
- 查看"待确认订单"列表
- 应该能看到刚才审核通过的订单

---

## 如果还是不行

### 检查点1：控制台日志

审核时打开开发者工具控制台，观察日志输出：

**正常情况：**
```
处理中...
✅ 审核通过
```

**异常情况：**
```
❌ 操作失败: permission denied
```

如果看到 `permission denied`，说明权限还是没配置好，重新检查第1步。

---

### 检查点2：数据库实际数据

1. **打开云开发控制台**
2. **进入数据库 → `activity_orders`**
3. **找到对应的订单记录**
4. **查看 `status` 字段**

**应该看到：**
- 审核前：`status: "pending_review"`
- 审核后：`status: "pending_confirm"`

如果 `status` 没有变化，说明数据库更新失败。

---

### 检查点3：管理员权限

确认当前登录的是管理员账号：

1. **在"我的"页面查看**
2. **应该显示"管理员"角色**
3. **能看到"管理后台"入口**

如果不是管理员，需要在 `admin_list` 集合中添加你的 openid。

---

## 预防措施

### 1. 统一权限配置

建议将以下集合都设置为"所有用户可读，所有用户可写"（测试环境）：

- `activity_orders`（订单）
- `students`（学生）
- `archives`（档案）
- `photographers`（摄影师）

**生产环境可以使用自定义安全规则：**
```json
{
  "read": true,
  "write": "auth.openid != null"
}
```

---

### 2. 添加详细日志

在审核操作中添加更多日志：

```javascript
// miniprogram/pages/admin/review/detail.js
async approveWork() {
  console.log('🔍 开始审核操作...');
  console.log('   订单ID:', this.data.orderId);
  console.log('   当前状态:', this.data.order.status);
  
  try {
    const db = wx.cloud.database();
    const result = await db.collection('activity_orders')
      .doc(this.data.orderId)
      .update({
        data: {
          status: 'pending_confirm',
          reviewedAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        }
      });
    
    console.log('✅ 数据库更新成功:', result);
    console.log('   更新记录数:', result.stats.updated);
    
    if (result.stats.updated === 0) {
      console.error('⚠️ 警告：没有记录被更新！');
    }
  } catch (e) {
    console.error('❌ 数据库更新失败:', e);
    console.error('   错误代码:', e.errCode);
    console.error('   错误信息:', e.errMsg);
  }
}
```

---

### 3. 使用云函数审核（可选）

如果权限问题无法解决，可以创建云函数来处理审核：

```javascript
// cloudfunctions/reviewOrder/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const { orderId, approved, rejectReason } = event;
  const wxContext = cloud.getWXContext();
  
  try {
    // 验证是否为管理员
    const adminCheck = await db.collection('admin_list')
      .where({ openid: wxContext.OPENID, isActive: true })
      .get();
    
    if (adminCheck.data.length === 0) {
      return { success: false, error: '无权限操作' };
    }
    
    // 更新订单状态
    if (approved) {
      await db.collection('activity_orders')
        .doc(orderId)
        .update({
          data: {
            status: 'pending_confirm',
            reviewedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        });
    } else {
      await db.collection('activity_orders')
        .doc(orderId)
        .update({
          data: {
            status: 'in_progress',
            adminRejectReason: rejectReason,
            adminRejectedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        });
    }
    
    return { success: true };
  } catch (e) {
    console.error('审核失败:', e);
    return { success: false, error: e.message };
  }
};
```

然后在前端调用：

```javascript
// miniprogram/pages/admin/review/detail.js
async approveWork() {
  try {
    wx.showLoading({ title: '处理中...' });
    
    const { result } = await wx.cloud.callFunction({
      name: 'reviewOrder',
      data: {
        orderId: this.data.orderId,
        approved: true
      }
    });
    
    wx.hideLoading();
    
    if (result.success) {
      wx.showToast({ title: '审核通过', icon: 'success' });
      setTimeout(() => wx.navigateBack(), 2000);
    } else {
      wx.showToast({ title: result.error, icon: 'error' });
    }
  } catch (e) {
    wx.hideLoading();
    wx.showToast({ title: '操作失败', icon: 'error' });
  }
}
```

---

## 总结

**最简单的解决方案：**

1. 修改 `activity_orders` 集合权限为"所有用户可写"
2. 使用测试工具检查和修复现有订单
3. 重新测试审核流程

**如果还是不行，请提供：**
- 控制台完整日志截图
- 测试8的输出结果
- 数据库权限配置截图

---

**最后更新：2025-01-18**


