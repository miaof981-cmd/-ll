# 入学申请完整流程 - 实现指南

## 📋 项目概述

本项目实现了从"入学申请→证件照确认→学籍档案生成"的完整业务流程，涉及家长端（小程序）、摄影师端（后台）、客服端（后台）三个角色。

---

## ✅ 已完成功能（当前进度：40%）

### 1. 核心数据架构 ✅
- **订单状态系统**：6种状态流转
  - `waiting_draw` - 等待绘制（蓝色）
  - `pending_review` - 待审核（黄色）
  - `pending_confirm` - 待客户确认（橙色）
  - `confirmed` - 已确认（绿色）
  - `archived` - 档案已归档（灰色）
  - `overdue` - 已超期（红色）

- **学籍档案系统**：
  - 自动生成学号（年份+4位序号）
  - 默认密码：123456
  - 包含：证件照、生活照、录取通知书、家长期许

- **通知系统**：
  - 状态变化自动触发通知
  - 按角色推送（摄影师/客服/家长）

### 2. 摄影师工作台 ✅
**文件位置**：`admin/pages/photographer-tasks.html`

**功能**：
- ✅ 只显示分配给自己的任务
- ✅ 查看孩子资料、生活照、家长期许
- ✅ 上传作品文件
- ✅ 填写备注说明
- ✅ 提交审核

**使用方法**：
1. 摄影师使用账号登录后台
2. 进入"我的任务"页面
3. 选择订单，点击"上传作品"
4. 上传证件照文件，填写备注
5. 点击"提交审核"

---

## 🔄 待实现功能（剩余60%）

### 阶段1：后台管理功能（预计15个文件）

#### A. 客服审核功能
**需要修改**：`admin/pages/applications.html` + `admin/js/applications.js`

**功能需求**：
1. 在订单详情中显示摄影师上传的作品
2. 添加"审核通过"按钮
3. 添加"退回修改"按钮（需填写退回原因）
4. 通过后状态变为 `pending_confirm`，通知家长
5. 退回后状态变为 `waiting_draw`，通知摄影师

**实现要点**：
```javascript
// 审核通过
function approveWork(applicationId) {
  Storage.updateApplication(applicationId, {
    status: 'pending_confirm',
    reviewedAt: new Date().toISOString(),
    reviewedBy: currentUser.name,
    operator: 'service',
    statusNote: '客服审核通过'
  });
  
  // 通知家长确认
  Storage.addNotification({
    type: 'work_approved',
    applicationId,
    targetRole: 'parent',
    message: '证件照已完成，请确认'
  });
}

// 退回修改
function rejectWork(applicationId, reason) {
  Storage.updateApplication(applicationId, {
    status: 'waiting_draw',
    rejectedAt: new Date().toISOString(),
    rejectedBy: currentUser.name,
    rejectReason: reason,
    operator: 'service',
    statusNote: `退回原因：${reason}`
  });
}
```

#### B. 学籍档案管理页面
**需要创建**：`admin/pages/archives.html` + `admin/js/archives.js`

**功能需求**：
1. 显示所有已生成的学籍档案
2. 档案列表显示：学号、姓名、证件照缩略图、状态
3. 点击查看详情
4. 上传录取通知书功能
5. 导出档案为PDF（可选）

**页面结构**：
```html
<div class="archives-list">
  <div class="archive-card">
    <img src="证件照" class="id-photo-thumb">
    <div class="archive-info">
      <h3>学号: 20250001</h3>
      <p>姓名: 张三</p>
      <p>家长: 张父</p>
      <span class="status-badge">待上传录取通知书</span>
    </div>
    <div class="archive-actions">
      <button onclick="viewArchive()">查看详情</button>
      <button onclick="uploadAdmissionLetter()">上传录取通知书</button>
    </div>
  </div>
</div>
```

#### C. 订单管理页面增强
**需要修改**：`admin/pages/applications.html`

**新增功能**：
1. 状态筛选下拉框（6种状态）
2. 订单详情显示状态历史时间线
3. 根据状态显示不同操作按钮

**状态筛选**：
```html
<select id="statusFilter" onchange="filterByStatus()">
  <option value="">全部状态</option>
  <option value="waiting_draw">等待绘制</option>
  <option value="pending_review">待审核</option>
  <option value="pending_confirm">待客户确认</option>
  <option value="confirmed">已确认</option>
  <option value="archived">档案已归档</option>
  <option value="overdue">已超期</option>
</select>
```

### 阶段2：小程序功能（预计10个文件）

#### A. 订单状态页面增强
**需要修改**：`miniprogram/pages/apply/status.wxml` + `.js`

**功能需求**：
1. 显示订单当前状态和进度
2. 当状态为 `pending_confirm` 时显示证件照
3. 添加"确认证件照"按钮
4. 确认后自动生成学籍档案

**实现逻辑**：
```javascript
// 确认证件照
confirmIdPhoto() {
  const applicationId = this.data.applicationId;
  
  // 更新订单状态
  storage.updateApplication(applicationId, {
    status: 'confirmed',
    confirmedAt: new Date().toISOString(),
    operator: 'parent'
  });
  
  // 自动生成学籍档案
  const archive = storage.createArchive(applicationId);
  
  // 显示学号和密码
  wx.showModal({
    title: '学籍档案已生成',
    content: `学号：${archive.studentId}\n密码：${archive.password}\n请妥善保管`,
    showCancel: false,
    success: () => {
      // 跳转到档案页面
      wx.navigateTo({
        url: `/pages/archive/detail?id=${archive.id}`
      });
    }
  });
}
```

#### B. 学籍档案查看页面
**需要创建**：`miniprogram/pages/archive/detail.wxml` + `.js` + `.wxss` + `.json`

**功能需求**：
1. 使用学号+密码登录
2. 显示完整档案信息
3. 生活照轮播展示
4. 证件照大图展示
5. 录取通知书展示
6. 家长期许文字

**页面布局**：
```xml
<view class="archive-container">
  <!-- 学生信息 -->
  <view class="student-info">
    <image class="id-photo" src="{{archive.idPhoto}}" mode="aspectFit"></image>
    <view class="info-text">
      <text class="student-id">学号：{{archive.studentId}}</text>
      <text class="student-name">{{archive.childName}}</text>
      <text class="gender-age">{{archive.childGender}} {{archive.childAge}}岁</text>
    </view>
  </view>
  
  <!-- 生活照轮播 -->
  <view class="life-photos">
    <swiper indicator-dots autoplay>
      <swiper-item wx:for="{{archive.lifePhotos}}" wx:key="index">
        <image src="{{item}}" mode="aspectFill"></image>
      </swiper-item>
    </swiper>
  </view>
  
  <!-- 家长期许 -->
  <view class="expectations">
    <text class="section-title">家长期许</text>
    <text class="content">{{archive.expectations}}</text>
  </view>
  
  <!-- 录取通知书 -->
  <view class="admission-letter" wx:if="{{archive.admissionLetter}}">
    <text class="section-title">录取通知书</text>
    <image src="{{archive.admissionLetter}}" mode="widthFix"></image>
  </view>
</view>
```

### 阶段3：通知系统（预计3个文件）

#### A. 通知中心页面
**需要创建**：`admin/pages/notifications.html` + `admin/js/notifications.js`

**功能需求**：
1. 显示未读通知列表
2. 按角色筛选
3. 点击通知跳转到相关页面
4. 标记为已读

#### B. 小程序通知
**需要修改**：`miniprogram/app.js` 添加通知检查

**实现方式**：
- 使用 `wx.showModal` 显示重要通知
- 在"我的"页面显示未读通知数量
- 点击通知跳转到对应页面

---

## 🎯 完整流程测试步骤

### 测试流程1：摄影师上传作品
1. 家长在小程序提交申请并支付
2. 系统自动分配摄影师
3. 摄影师登录后台（用户名：photographer / 密码：photo123）
4. 进入"我的任务"
5. 选择订单，上传作品
6. 填写备注，提交审核
7. ✅ 状态变为"待审核"

### 测试流程2：客服审核
1. 客服登录后台（用户名：service / 密码：service123）
2. 进入"订单管理"
3. 筛选"待审核"状态
4. 查看作品
5. 点击"审核通过"
6. ✅ 状态变为"待客户确认"

### 测试流程3：家长确认
1. 家长在小程序收到通知
2. 进入"我的订单"
3. 查看证件照
4. 点击"确认证件照"
5. ✅ 自动生成学号和密码
6. ✅ 创建学籍档案

### 测试流程4：上传录取通知书
1. 客服进入"学籍档案管理"
2. 找到待上传录取通知书的档案
3. 上传录取通知书图片
4. ✅ 状态变为"档案已归档"

### 测试流程5：查看档案
1. 家长使用学号+密码登录
2. 查看完整学籍档案
3. ✅ 包含所有信息

---

## 📝 开发建议

### 优先级排序
1. **高优先级**：客服审核功能（核心流程）
2. **高优先级**：家长确认证件照功能
3. **中优先级**：学籍档案管理页面
4. **中优先级**：小程序档案查看页面
5. **低优先级**：通知系统优化
6. **低优先级**：PDF导出功能

### 技术要点
1. **权限控制**：确保摄影师只能看自己的任务
2. **状态流转**：严格按照状态机流转，不能跳过
3. **数据一致性**：订单和档案数据要保持同步
4. **通知触发**：每次状态变化都要触发通知
5. **学号唯一性**：确保学号不重复

### 代码复用
- 状态显示：使用 `Utils.getStatusText()` 和 `Utils.getStatusClass()`
- 图片预览：复用现有的预览函数
- 模态框：复用现有的模态框样式

---

## 📦 文件清单

### 已创建文件 ✅
1. `admin/js/storage.js` - 扩展了学籍档案和通知功能
2. `admin/js/utils.js` - 添加了状态映射函数
3. `admin/css/common.css` - 添加了新状态样式
4. `admin/pages/photographer-tasks.html` - 摄影师任务页面
5. `admin/js/photographer-tasks.js` - 摄影师任务逻辑
6. `完整流程实现进度.md` - 进度文档
7. `完整流程实现指南.md` - 本文档

### 待创建/修改文件 ⏳
1. `admin/pages/archives.html` - 学籍档案管理页面
2. `admin/js/archives.js` - 档案管理逻辑
3. `admin/pages/notifications.html` - 通知中心
4. `admin/js/notifications.js` - 通知逻辑
5. `admin/js/applications.js` - 需要添加审核功能
6. `miniprogram/pages/apply/status.js` - 需要添加确认功能
7. `miniprogram/pages/archive/detail.*` - 档案查看页面（4个文件）
8. `miniprogram/app.json` - 需要注册新页面

---

## 🚀 下一步行动

### 立即可以测试的功能
1. ✅ 摄影师登录后台查看任务
2. ✅ 摄影师上传作品
3. ✅ 摄影师提交审核
4. ✅ 订单状态变化

### 需要继续开发的功能
1. 客服审核功能（最重要）
2. 家长确认证件照
3. 自动生成学籍档案
4. 学籍档案管理
5. 小程序档案查看

---

**当前完成度**：40%  
**预计剩余工作量**：约2000行代码，15个文件  
**建议开发时间**：继续2-3小时可完成核心流程

如需继续开发，请告诉我优先实现哪个功能！

