# 📚 档案系统功能说明

## 一、系统概述

档案系统支持三种创建方式：
1. **自动创建**：证件照订单确认后自动创建学籍档案
2. **自动添加**：所有活动订单确认后自动添加图片档案
3. **手动管理**：管理员可以添加/编辑/删除任何档案

## 二、档案类型

### 1. 学籍档案（必有）
- **触发条件**：用户确认证件照订单
- **创建内容**：
  - 学号（自动生成，格式：年份+4位序号，如 20250001）
  - 基本信息（姓名、性别、年龄、班级）
  - 证件照（作为头像）
  - 家长信息（姓名、电话、微信号）
  - 家长期许
- **显示方式**：可展开/收起的卡片，置顶显示

### 2. 活动图片档案（自动）
- **触发条件**：用户确认任何活动订单（有照片）
- **创建内容**：
  - 每张照片创建一个档案记录
  - 标题：活动名称 + 序号
  - 活动信息（活动名称、活动ID、订单ID）
  - 描述：来自活动XXX
- **显示方式**：圆角边框图片卡片

### 3. 成绩档案（手动）
- **创建方式**：管理员手动添加
- **包含字段**：
  - 学期
  - 语文、数学、英语成绩
  - 平均分（自动计算）
- **显示方式**：成绩卡片

### 4. 处分档案（手动）
- **创建方式**：管理员手动添加
- **包含字段**：
  - 处分类型
  - 处分原因
  - 创建时间
- **显示方式**：警告样式卡片

### 5. 其他图片档案（手动）
- **创建方式**：管理员手动添加
- **包含字段**：
  - 标题
  - 图片
  - 描述
- **显示方式**：圆角边框图片卡片

## 三、自动创建逻辑

### 证件照订单确认流程
```javascript
用户确认订单
  ↓
检查是否是证件照订单
  ↓
检查学生是否已有档案
  ↓
生成学号（年份+序号）
  ↓
创建学生档案（students表）
  ↓
创建学籍档案记录（student_records表）
  ↓
更新订单，关联学号
```

### 活动图片档案创建流程
```javascript
用户确认订单
  ↓
检查订单是否有照片
  ↓
查找学生档案
  ↓
为每张照片创建图片档案记录
  ↓
保存到 student_records 表
```

## 四、管理员功能

### 查看档案
- 路径：管理员 → 学生管理 → 更多 → 查看档案
- 功能：只读模式查看学生所有档案

### 管理档案
- 路径：管理员 → 学生管理 → 更多 → 管理档案
- 功能：
  - 点击"编辑"按钮进入编辑模式
  - 点击"+ 添加"按钮添加新档案
  - 选择档案类型：成绩/处分/图片
  - 填写信息并保存
  - 点击档案卡片的删除按钮删除档案

### 编辑学生信息
- 路径：管理员 → 学生管理 → 更多 → 编辑信息
- 功能：修改学生基本信息（姓名、性别、年龄等）

## 五、图片样式统一

### 圆角边框设计
```css
.image-container {
  border-radius: 16rpx;  /* 圆角 */
  overflow: hidden;       /* 裁剪溢出 */
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.08);  /* 阴影 */
}

.card-image {
  width: 100%;
  height: 400rpx;
  object-fit: cover;  /* 填充模式 */
}
```

### 应用场景
- ✅ 活动图片档案
- ✅ 手动添加的图片档案
- ✅ 学籍档案的证件照（圆形）

## 六、数据库结构

### students 表（学生档案）
```javascript
{
  _id: "xxx",
  studentId: "20250001",  // 学号
  name: "张三",
  avatar: "cloud://...",  // 证件照
  gender: "男",
  age: 7,
  class: "一年级1班",
  parentName: "张父",
  parentPhone: "13800138000",
  parentWechat: "zhangfu",
  expectations: "希望孩子健康成长",
  createdAt: "2025-10-15T12:00:00.000Z",
  source: "order",  // 来源：order/manual
  sourceOrderId: "xxx"
}
```

### student_records 表（档案记录）
```javascript
// 成绩档案
{
  studentId: "20250001",
  type: "grade",
  term: "2025年春季",
  chinese: 95,
  math: 92,
  english: 88,
  average: "91.7",
  createdAt: "2025-10-15T12:00:00.000Z"
}

// 处分档案
{
  studentId: "20250001",
  type: "punishment",
  punishmentType: "警告",
  reason: "上课讲话",
  createdAt: "2025-10-15T12:00:00.000Z"
}

// 图片档案
{
  studentId: "20250001",
  type: "image",
  title: "春游活动 - 1",
  imageUrl: "cloud://...",
  activityName: "春游活动",
  activityId: "xxx",
  orderId: "xxx",
  description: "来自活动：春游活动",
  source: "order",  // order/manual
  createdAt: "2025-10-15T12:00:00.000Z"
}
```

## 七、用户体验

### 家长视角
1. 购买证件照活动 → 摄影师拍摄 → 确认满意
2. 系统自动创建学生档案，生成学号
3. 前往"学生档案"查看完整档案
4. 购买其他活动 → 确认满意 → 照片自动添加到档案

### 管理员视角
1. 查看所有学生档案
2. 为学生添加成绩、处分等记录
3. 手动上传图片档案
4. 编辑学生基本信息
5. 删除不需要的档案记录

## 八、注意事项

1. **学号唯一性**：学号由年份+序号组成，确保唯一
2. **档案完整性**：证件照订单必须确认后才创建档案
3. **图片存储**：所有图片上传到云存储，使用 cloud:// 路径
4. **权限控制**：
   - 家长只能查看自己孩子的档案
   - 管理员可以查看和管理所有档案
5. **数据安全**：删除学生时需确认，防止误删

## 九、未来扩展

### 可能的新档案类型
- 📜 荣誉证书
- 🏆 获奖记录
- 📖 作品集
- 🎨 艺术作品
- 📝 成长日记

### 扩展方式
1. 在 `showAddRecordDialog` 中添加新类型
2. 在 `saveNewRecord` 中添加验证逻辑
3. 在 `records.wxml` 中添加显示模板
4. 在 `records.wxss` 中添加样式

---

**版本**: v2.0  
**更新日期**: 2025-10-15  
**功能**: 完整档案系统（自动创建 + 手动管理）
