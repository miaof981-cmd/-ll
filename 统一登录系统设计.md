# 统一登录系统设计

## 📝 设计理念

所有用户通过**同一个入口**（微信授权登录）进入系统，系统根据用户的微信 `openid` 自动识别角色，无需密码、无需区分入口。

---

## 🗄️ 数据库设计

### 1. users 集合（用户表）

```javascript
{
  _id: "自动生成",
  _openid: "微信openid（自动）",
  nickName: "微信昵称",
  avatarUrl: "微信头像",
  roles: ["parent", "admin", "photographer"],  // 角色数组，支持多角色
  currentRole: "parent",  // 当前选中的角色
  children: [  // 家长角色：绑定的孩子列表
    {
      studentId: "STU20250001",
      name: "张小明",
      grade: "一年级",
      class: "1班"
    }
  ],
  photographerId: "PHO001",  // 摄影师角色：关联的摄影师ID
  isActive: true,
  createdAt: "2025-01-01T00:00:00.000Z",
  lastLoginAt: "2025-01-01T00:00:00.000Z"
}
```

### 2. admin_list 集合（管理员白名单）

```javascript
{
  _id: "自动生成",
  openid: "微信openid",
  name: "管理员姓名",
  phone: "13800138000",
  permissions: ["all"],  // 权限列表
  isActive: true,
  createdAt: "2025-01-01T00:00:00.000Z"
}
```

### 3. photographer_accounts 集合（摄影师账号）

```javascript
{
  _id: "自动生成",
  openid: "微信openid",
  photographerId: "PHO001",  // 关联 photographers 表
  name: "摄影师姓名",
  isActive: true,
  createdAt: "2025-01-01T00:00:00.000Z"
}
```

---

## 🔐 登录流程

### 1. 微信授权登录
```
用户点击登录
   ↓
wx.getUserProfile() 获取微信信息
   ↓
调用云函数 userLogin
   ↓
系统自动识别角色
```

### 2. 角色识别逻辑

```javascript
async function identifyUserRole(openid) {
  const roles = [];
  
  // 1. 检查是否为管理员
  const admin = await db.collection('admin_list')
    .where({ openid, isActive: true })
    .get();
  if (admin.data.length > 0) {
    roles.push('admin');
  }
  
  // 2. 检查是否为摄影师
  const photographer = await db.collection('photographer_accounts')
    .where({ openid, isActive: true })
    .get();
  if (photographer.data.length > 0) {
    roles.push('photographer');
  }
  
  // 3. 默认都是家长
  roles.push('parent');
  
  return roles;
}
```

### 3. 登录后跳转

```javascript
// 单一角色：直接跳转
if (roles.length === 1) {
  switch(roles[0]) {
    case 'admin':
      wx.reLaunch({ url: '/pages/admin/admin' });
      break;
    case 'photographer':
      wx.reLaunch({ url: '/pages/photographer/tasks' });
      break;
    case 'parent':
      wx.reLaunch({ url: '/pages/my/my' });
      break;
  }
}

// 多角色：显示角色选择
else {
  wx.navigateTo({ url: '/pages/role-select/role-select' });
}
```

---

## 🔄 角色切换

### 切换界面
- 位置：个人中心页面顶部
- 触发：点击当前角色标签
- 效果：弹出角色选择器

### 切换逻辑
```javascript
async switchRole(newRole) {
  // 1. 更新用户当前角色
  await db.collection('users').doc(userId).update({
    data: { currentRole: newRole }
  });
  
  // 2. 更新全局状态
  app.globalData.currentRole = newRole;
  
  // 3. 跳转到对应首页
  wx.reLaunch({ url: getRoleHomePage(newRole) });
}
```

---

## 📱 页面结构

### 1. 统一登录页（/pages/login/login）
- 微信授权按钮
- 自动角色识别
- 角色选择（如有多角色）

### 2. 角色选择页（/pages/role-select/role-select）
- 显示用户拥有的所有角色
- 点击选择角色
- 跳转到对应首页

### 3. 各角色首页
- **家长** → `/pages/my/my`（我的档案、孩子列表）
- **管理员** → `/pages/admin/admin`（后台控制面板）
- **摄影师** → `/pages/photographer/tasks`（接单中心）

---

## 🎯 优势

1. **统一入口**：所有人都从同一个登录页进入
2. **自动识别**：无需手动选择身份
3. **多角色支持**：一个人可以有多个身份
4. **灵活扩展**：新增角色只需加入识别逻辑
5. **无密码**：基于微信 openid，安全可靠

---

## 🔧 实现步骤

1. ✅ 创建数据库集合（users, admin_list, photographer_accounts）
2. ✅ 实现云函数 userLogin（角色识别）
3. ✅ 修改登录页面（统一微信授权）
4. ✅ 创建角色选择页面
5. ✅ 实现角色切换功能
6. ✅ 修改首页路由逻辑

---

## 📌 数据库权限设置

### users 集合
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### admin_list 集合
```json
{
  "read": true,
  "write": false
}
```

### photographer_accounts 集合
```json
{
  "read": true,
  "write": false
}
```

---

## 🚀 下一步

- 手动在云数据库创建管理员白名单
- 绑定摄影师账号
- 测试完整登录流程

