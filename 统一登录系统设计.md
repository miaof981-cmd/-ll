# ç»Ÿä¸€ç™»å½•ç³»ç»Ÿè®¾è®¡

## ğŸ“ è®¾è®¡ç†å¿µ

æ‰€æœ‰ç”¨æˆ·é€šè¿‡**åŒä¸€ä¸ªå…¥å£**ï¼ˆå¾®ä¿¡æˆæƒç™»å½•ï¼‰è¿›å…¥ç³»ç»Ÿï¼Œç³»ç»Ÿæ ¹æ®ç”¨æˆ·çš„å¾®ä¿¡ `openid` è‡ªåŠ¨è¯†åˆ«è§’è‰²ï¼Œæ— éœ€å¯†ç ã€æ— éœ€åŒºåˆ†å…¥å£ã€‚

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. users é›†åˆï¼ˆç”¨æˆ·è¡¨ï¼‰

```javascript
{
  _id: "è‡ªåŠ¨ç”Ÿæˆ",
  _openid: "å¾®ä¿¡openidï¼ˆè‡ªåŠ¨ï¼‰",
  nickName: "å¾®ä¿¡æ˜µç§°",
  avatarUrl: "å¾®ä¿¡å¤´åƒ",
  roles: ["parent", "admin", "photographer"],  // è§’è‰²æ•°ç»„ï¼Œæ”¯æŒå¤šè§’è‰²
  currentRole: "parent",  // å½“å‰é€‰ä¸­çš„è§’è‰²
  children: [  // å®¶é•¿è§’è‰²ï¼šç»‘å®šçš„å­©å­åˆ—è¡¨
    {
      studentId: "STU20250001",
      name: "å¼ å°æ˜",
      grade: "ä¸€å¹´çº§",
      class: "1ç­"
    }
  ],
  photographerId: "PHO001",  // æ‘„å½±å¸ˆè§’è‰²ï¼šå…³è”çš„æ‘„å½±å¸ˆID
  isActive: true,
  createdAt: "2025-01-01T00:00:00.000Z",
  lastLoginAt: "2025-01-01T00:00:00.000Z"
}
```

### 2. admin_list é›†åˆï¼ˆç®¡ç†å‘˜ç™½åå•ï¼‰

```javascript
{
  _id: "è‡ªåŠ¨ç”Ÿæˆ",
  openid: "å¾®ä¿¡openid",
  name: "ç®¡ç†å‘˜å§“å",
  phone: "13800138000",
  permissions: ["all"],  // æƒé™åˆ—è¡¨
  isActive: true,
  createdAt: "2025-01-01T00:00:00.000Z"
}
```

### 3. photographer_accounts é›†åˆï¼ˆæ‘„å½±å¸ˆè´¦å·ï¼‰

```javascript
{
  _id: "è‡ªåŠ¨ç”Ÿæˆ",
  openid: "å¾®ä¿¡openid",
  photographerId: "PHO001",  // å…³è” photographers è¡¨
  name: "æ‘„å½±å¸ˆå§“å",
  isActive: true,
  createdAt: "2025-01-01T00:00:00.000Z"
}
```

---

## ğŸ” ç™»å½•æµç¨‹

### 1. å¾®ä¿¡æˆæƒç™»å½•
```
ç”¨æˆ·ç‚¹å‡»ç™»å½•
   â†“
wx.getUserProfile() è·å–å¾®ä¿¡ä¿¡æ¯
   â†“
è°ƒç”¨äº‘å‡½æ•° userLogin
   â†“
ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«è§’è‰²
```

### 2. è§’è‰²è¯†åˆ«é€»è¾‘

```javascript
async function identifyUserRole(openid) {
  const roles = [];
  
  // 1. æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
  const admin = await db.collection('admin_list')
    .where({ openid, isActive: true })
    .get();
  if (admin.data.length > 0) {
    roles.push('admin');
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦ä¸ºæ‘„å½±å¸ˆ
  const photographer = await db.collection('photographer_accounts')
    .where({ openid, isActive: true })
    .get();
  if (photographer.data.length > 0) {
    roles.push('photographer');
  }
  
  // 3. é»˜è®¤éƒ½æ˜¯å®¶é•¿
  roles.push('parent');
  
  return roles;
}
```

### 3. ç™»å½•åè·³è½¬

```javascript
// å•ä¸€è§’è‰²ï¼šç›´æ¥è·³è½¬
if (roles.length === 1) {
  switch(roles[0]) {
    case 'admin':
      wx.reLaunch({ url: '/pages/admin/admin' });
      break;
    case 'photographer':
      wx.reLaunch({ url: '/pages/photographer/tasks' });
      break;
    case 'parent':
      wx.reLaunch({ url: '/pages/my/my' });
      break;
  }
}

// å¤šè§’è‰²ï¼šæ˜¾ç¤ºè§’è‰²é€‰æ‹©
else {
  wx.navigateTo({ url: '/pages/role-select/role-select' });
}
```

---

## ğŸ”„ è§’è‰²åˆ‡æ¢

### åˆ‡æ¢ç•Œé¢
- ä½ç½®ï¼šä¸ªäººä¸­å¿ƒé¡µé¢é¡¶éƒ¨
- è§¦å‘ï¼šç‚¹å‡»å½“å‰è§’è‰²æ ‡ç­¾
- æ•ˆæœï¼šå¼¹å‡ºè§’è‰²é€‰æ‹©å™¨

### åˆ‡æ¢é€»è¾‘
```javascript
async switchRole(newRole) {
  // 1. æ›´æ–°ç”¨æˆ·å½“å‰è§’è‰²
  await db.collection('users').doc(userId).update({
    data: { currentRole: newRole }
  });
  
  // 2. æ›´æ–°å…¨å±€çŠ¶æ€
  app.globalData.currentRole = newRole;
  
  // 3. è·³è½¬åˆ°å¯¹åº”é¦–é¡µ
  wx.reLaunch({ url: getRoleHomePage(newRole) });
}
```

---

## ğŸ“± é¡µé¢ç»“æ„

### 1. ç»Ÿä¸€ç™»å½•é¡µï¼ˆ/pages/login/loginï¼‰
- å¾®ä¿¡æˆæƒæŒ‰é’®
- è‡ªåŠ¨è§’è‰²è¯†åˆ«
- è§’è‰²é€‰æ‹©ï¼ˆå¦‚æœ‰å¤šè§’è‰²ï¼‰

### 2. è§’è‰²é€‰æ‹©é¡µï¼ˆ/pages/role-select/role-selectï¼‰
- æ˜¾ç¤ºç”¨æˆ·æ‹¥æœ‰çš„æ‰€æœ‰è§’è‰²
- ç‚¹å‡»é€‰æ‹©è§’è‰²
- è·³è½¬åˆ°å¯¹åº”é¦–é¡µ

### 3. å„è§’è‰²é¦–é¡µ
- **å®¶é•¿** â†’ `/pages/my/my`ï¼ˆæˆ‘çš„æ¡£æ¡ˆã€å­©å­åˆ—è¡¨ï¼‰
- **ç®¡ç†å‘˜** â†’ `/pages/admin/admin`ï¼ˆåå°æ§åˆ¶é¢æ¿ï¼‰
- **æ‘„å½±å¸ˆ** â†’ `/pages/photographer/tasks`ï¼ˆæ¥å•ä¸­å¿ƒï¼‰

---

## ğŸ¯ ä¼˜åŠ¿

1. **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰äººéƒ½ä»åŒä¸€ä¸ªç™»å½•é¡µè¿›å…¥
2. **è‡ªåŠ¨è¯†åˆ«**ï¼šæ— éœ€æ‰‹åŠ¨é€‰æ‹©èº«ä»½
3. **å¤šè§’è‰²æ”¯æŒ**ï¼šä¸€ä¸ªäººå¯ä»¥æœ‰å¤šä¸ªèº«ä»½
4. **çµæ´»æ‰©å±•**ï¼šæ–°å¢è§’è‰²åªéœ€åŠ å…¥è¯†åˆ«é€»è¾‘
5. **æ— å¯†ç **ï¼šåŸºäºå¾®ä¿¡ openidï¼Œå®‰å…¨å¯é 

---

## ğŸ”§ å®ç°æ­¥éª¤

1. âœ… åˆ›å»ºæ•°æ®åº“é›†åˆï¼ˆusers, admin_list, photographer_accountsï¼‰
2. âœ… å®ç°äº‘å‡½æ•° userLoginï¼ˆè§’è‰²è¯†åˆ«ï¼‰
3. âœ… ä¿®æ”¹ç™»å½•é¡µé¢ï¼ˆç»Ÿä¸€å¾®ä¿¡æˆæƒï¼‰
4. âœ… åˆ›å»ºè§’è‰²é€‰æ‹©é¡µé¢
5. âœ… å®ç°è§’è‰²åˆ‡æ¢åŠŸèƒ½
6. âœ… ä¿®æ”¹é¦–é¡µè·¯ç”±é€»è¾‘

---

## ğŸ“Œ æ•°æ®åº“æƒé™è®¾ç½®

### users é›†åˆ
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### admin_list é›†åˆ
```json
{
  "read": true,
  "write": false
}
```

### photographer_accounts é›†åˆ
```json
{
  "read": true,
  "write": false
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

- æ‰‹åŠ¨åœ¨äº‘æ•°æ®åº“åˆ›å»ºç®¡ç†å‘˜ç™½åå•
- ç»‘å®šæ‘„å½±å¸ˆè´¦å·
- æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹

