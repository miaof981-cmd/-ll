# 修复摄影师列表重复显示问题

## 问题描述

在活动详情页面，"可选摄影师"列表中出现了重复的摄影师（例如"妙妙"显示了两次）。

<img width="300" alt="问题截图" src="截图显示：可选摄影师（3位）- 微信用户、妙妙、妙妙">

## 问题根源分析

经过代码分析，发现可能有两个原因导致重复：

### 原因1：活动配置的 `photographerIds` 中有重复ID

```javascript
// 例如活动数据：
{
  photographerIds: [
    "photographer_id_1",
    "photographer_id_1"  // ❌ 重复的ID
  ]
}
```

### 原因2：数据库中有重复的摄影师记录

```javascript
// photographers 集合中可能有两条记录：
{ _id: "id1", name: "妙妙", _openid: "openid_xxx" }
{ _id: "id2", name: "妙妙", _openid: "openid_xxx" }  // ❌ 相同的人但不同的记录
```

## 解决方案

在云函数 `getActivityDetail` 中添加**两层去重逻辑**：

### 第一层：对输入的 `photographerIds` 去重

```javascript
// 优化前
const photographersRes = await db.collection('photographers')
  .where({ _id: db.command.in(activity.photographerIds) })
  .get();

// 优化后
const uniqueIds = [...new Set(activity.photographerIds)];  // ✅ 去重ID
const photographersRes = await db.collection('photographers')
  .where({ _id: db.command.in(uniqueIds) })
  .get();
```

**效果**：即使活动配置中有重复的摄影师ID，也只会查询一次。

### 第二层：对查询结果按 `_openid` 去重

```javascript
const seenOpenIds = new Set();
photographers = photographers.filter(p => {
  if (!p._openid) return true; // 保留没有 openid 的记录
  
  if (seenOpenIds.has(p._openid)) {
    console.warn(`⚠️ 发现重复摄影师: ${p.name} (openid: ${p._openid})`);
    return false; // ❌ 过滤掉重复的
  }
  
  seenOpenIds.add(p._openid);
  return true;  // ✅ 保留第一次出现的
});
```

**效果**：即使数据库中有多条相同 `_openid` 的摄影师记录，也只保留第一条。

## 完整修改代码

```javascript
// 获取摄影师信息
let photographers = [];
try {
  if (activity.photographerIds && activity.photographerIds.length > 0) {
    // 🔥 第一层去重：对 photographerIds 去重
    const uniqueIds = [...new Set(activity.photographerIds)];
    
    const photographersRes = await db.collection('photographers')
      .where({ _id: db.command.in(uniqueIds) })
      .limit(100)
      .get();
    photographers = photographersRes.data || [];
  }

  // 兜底策略：若未配置或数量过少，则展示可用摄影师
  if (!photographers || photographers.length === 0) {
    const fallbackRes = await db.collection('photographers')
      .where({ status: 'available' })
      .limit(100)
      .get();
    photographers = fallbackRes.data || [];
  }
  
  // 🔥 第二层去重：根据 _openid 去重
  const seenOpenIds = new Set();
  photographers = photographers.filter(p => {
    if (!p._openid) return true;
    if (seenOpenIds.has(p._openid)) {
      console.warn(`⚠️ 发现重复摄影师: ${p.name} (openid: ${p._openid})`);
      return false;
    }
    seenOpenIds.add(p._openid);
    return true;
  });
  
  console.log(`✅ 加载摄影师列表成功，共 ${photographers.length} 位（已去重）`);
} catch (e) {
  console.error('加载摄影师列表失败:', e);
  photographers = [];
}
```

## 去重逻辑说明

### 为什么需要两层去重？

1. **第一层（ID去重）**：解决配置问题
   - 管理员在配置活动时可能不小心选择了同一个摄影师多次
   - 防止重复的数据库查询

2. **第二层（OpenID去重）**：解决数据问题
   - 数据库中可能存在同一个人的多条记录
   - 确保最终展示给用户的列表没有重复

### 去重规则

使用 `_openid` 作为唯一标识，因为：
- ✅ `_openid` 是微信用户的唯一标识
- ✅ 一个真实的人只有一个 `_openid`
- ✅ 即使数据库中有多条记录，也能正确去重

### 保留规则

- 保留**第一次**出现的记录
- 后续相同 `_openid` 的记录会被过滤掉
- 没有 `_openid` 的记录会被保留（兼容旧数据）

## 测试验证

### 测试场景1：活动配置了重复ID

**测试数据**：
```javascript
activity.photographerIds = ["id1", "id1", "id2"]
```

**预期结果**：
- 第一层去重：`uniqueIds = ["id1", "id2"]`
- 只查询两次，返回两位摄影师

### 测试场景2：数据库中有重复记录

**测试数据**：
```javascript
// photographers 集合
[
  { _id: "id1", name: "妙妙", _openid: "openid_a" },
  { _id: "id2", name: "妙妙", _openid: "openid_a" },  // 重复
  { _id: "id3", name: "测试", _openid: "openid_b" }
]
```

**预期结果**：
- 第二层去重：检测到 `openid_a` 重复
- 保留第一条"妙妙"（id1）
- 过滤掉第二条"妙妙"（id2）
- 最终返回：["妙妙", "测试"]（2位，无重复）

### 测试场景3：既有配置重复又有数据重复

**测试数据**：
```javascript
activity.photographerIds = ["id1", "id1", "id2"]  // 配置重复
// id1 和 id2 在数据库中有相同的 _openid
```

**预期结果**：
- 第一层去重：`uniqueIds = ["id1", "id2"]`
- 查询返回两条记录
- 第二层去重：检测到 `_openid` 重复，只保留一条
- 最终返回：1位摄影师

## 日志输出

修复后，控制台会输出：

### 正常情况
```
✅ 加载摄影师列表成功，共 3 位（已去重）
```

### 发现重复时
```
⚠️ 发现重复摄影师: 妙妙 (openid: openid_xxx)
✅ 加载摄影师列表成功，共 2 位（已去重）
```

## 如何应用修复

### 步骤1：部署云函数

1. 在微信开发者工具中：
   - 找到 `cloudfunctions/getActivityDetail`
   - 右键 → "上传并部署：云端安装依赖"

2. 等待部署完成

### 步骤2：验证修复

1. 重新进入有问题的活动详情页
2. 查看"可选摄影师"列表
3. 确认不再有重复的摄影师

### 步骤3：检查数据（可选）

如果想彻底解决数据问题，建议：

#### 检查活动配置
```javascript
// 在云开发控制台执行
db.collection('activities')
  .where({
    _id: 'your_activity_id'
  })
  .get()
  
// 查看 photographerIds 字段是否有重复
```

#### 检查摄影师记录
```javascript
// 查找可能重复的摄影师
db.collection('photographers')
  .where({
    name: '妙妙'
  })
  .get()
  
// 如果返回多条，检查是否有相同的 _openid
```

## 预防措施

### 1. 管理后台添加去重提示

在管理后台选择摄影师时，如果选择了重复的，给予提示。

### 2. 数据库唯一索引

为 `photographers` 集合添加 `_openid` 唯一索引（建议）：
```javascript
db.collection('photographers').createIndex({
  keys: { _openid: 1 },
  unique: true  // ✅ 确保 _openid 唯一
})
```

**注意**：如果当前数据已有重复，需要先清理后再创建唯一索引。

### 3. 定期数据清理

定期检查并清理重复的摄影师记录。

## 相关文件

- `cloudfunctions/getActivityDetail/index.js` - 活动详情云函数（已修复）
- 本文档：`修复摄影师列表重复显示问题.md`

## 版本信息

- 修复时间：2025-10-24
- 问题类型：数据重复显示
- 解决方案：两层去重（ID + OpenID）
- 影响范围：活动详情页面的摄影师列表

