# 头像系统架构文档

## 设计理念

**核心原则**：头像跟着 OpenID 走，同一个用户在不同角色下显示同一个头像

```
一个 OpenID = 一个用户 = 一个头像
角色（家长/摄影师/管理员）只是权限区分，不影响头像
```

---

## 架构概览

### 1. 小程序端 - 统一头像组件

**组件路径**：`miniprogram/components/user-avatar/user-avatar`

#### 组件属性

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `openid` | String | '' | 用户OpenID（优先级最高） |
| `avatarUrl` | String | '' | 直接传入的头像URL（无openid时使用） |
| `size` | Number | 80 | 头像大小（rpx） |
| `round` | Boolean | true | 是否圆形 |
| `borderRadius` | String | '8rpx' | 边框圆角（round=false时生效） |
| `mode` | String | 'aspectFill' | 图片裁剪模式 |
| `customClass` | String | '' | 自定义CSS类名 |
| `lazyLoad` | Boolean | false | 是否懒加载 |
| `defaultAvatar` | String | (默认头像URL) | 默认头像 |

#### 使用示例

```xml
<!-- 通过OpenID自动查询头像 -->
<user-avatar 
  openid="{{user._openid}}"
  size="100"
  round="{{true}}"
></user-avatar>

<!-- 直接传入头像URL -->
<user-avatar 
  avatar-url="{{user.avatarUrl}}"
  size="80"
  custom-class="my-avatar"
></user-avatar>
```

#### 核心功能

1. **自动查询**：根据 OpenID 从 `users` 集合自动查询头像
2. **云存储转换**：自动将 `cloud://` URL 转换为 HTTPS 临时 URL
3. **错误处理**：加载失败自动显示默认头像
4. **缓存优化**：避免重复查询

---

### 2. 后台管理端 - 头像工具类

**工具路径**：`admin/js/avatar-helper.js`

#### 核心方法

##### `getAvatarByOpenId(openid)`
根据 OpenID 获取头像 URL

```javascript
const avatarUrl = await AvatarHelper.getAvatarByOpenId('openid_xxx');
```

##### `renderAvatar(openid, options)`
生成头像 HTML 元素

```javascript
const avatarHtml = await AvatarHelper.renderAvatar('openid_xxx', {
  size: 40,
  className: 'custom-avatar',
  fallbackText: '用户'
});
```

##### `getAvatarsBatch(openids)`
批量获取头像（列表渲染优化）

```javascript
const avatarMap = await AvatarHelper.getAvatarsBatch(['openid1', 'openid2']);
```

##### `renderOrderAvatars(order, options)`
为订单卡片生成用户和摄影师头像

```javascript
const { userAvatar, photographerAvatar } = await AvatarHelper.renderOrderAvatars(order, {
  size: 40
});
```

---

## 已集成页面

### 小程序端

| 页面 | 路径 | 头像显示内容 |
|------|------|------------|
| 我的页面 | `pages/my/my` | 用户自己的头像 |
| 订单列表 | `pages/user/orders/orders` | 下单用户头像 + 摄影师头像 |
| 摄影师工作台 | `pages/photographer/tasks` | 摄影师自己的头像 |

### 后台管理端（待集成）

| 页面 | 路径 | 头像显示内容 |
|------|------|------------|
| 订单管理 | `admin/pages/applications.html` | 下单用户头像 + 摄影师头像 |
| 摄影师管理 | `admin/pages/photographers.html` | 摄影师头像 |
| 摄影师仪表盘 | `admin/js/photographer-dashboard.js` | 下单用户头像 |
| 首页仪表盘 | `admin/pages/dashboard.html` | 摄影师头像 |

---

## 数据流

```
┌─────────────────────────────────────────────────────────┐
│                      用户登录                            │
│                         ↓                                │
│              头像上传到云存储（cloud://）                │
│                         ↓                                │
│        保存到 users 集合（avatarUrl字段）                │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   头像显示流程                            │
│                                                           │
│  1. 前端传入 OpenID                                       │
│  2. 组件/工具从 users 集合查询 avatarUrl                  │
│  3. 如果是 cloud:// 格式，转换为 HTTPS 临时 URL          │
│  4. 渲染头像 <image src="https://..." />                 │
│  5. 加载失败则显示默认头像                                │
└─────────────────────────────────────────────────────────┘
```

---

## 关键优化点

### 1. 性能优化
- ✅ 组件内部缓存机制，避免重复查询
- ✅ 懒加载支持
- ✅ 批量查询API（后台管理端）

### 2. 错误处理
- ✅ 加载失败自动回退到默认头像
- ✅ 云存储URL转换失败的容错处理
- ✅ 查询失败的日志记录

### 3. 一致性保证
- ✅ **统一数据源**：所有头像都从 `users` 集合读取
- ✅ **OpenID唯一性**：同一OpenID在所有角色和页面显示相同头像
- ✅ **自动同步**：更新头像后自动在所有地方生效

---

## 迁移指南

### 旧代码 ❌

```xml
<!-- 旧方式：直接使用image标签 -->
<image 
  src="{{item.userAvatarUrl || defaultAvatar}}" 
  mode="aspectFill"
></image>
```

```javascript
// 旧方式：手动查询和转换
const userRes = await db.collection('users').where({ _openid: userId }).get();
if (userRes.data[0].avatarUrl.startsWith('cloud://')) {
  const tempRes = await wx.cloud.getTempFileURL({ ... });
  avatarUrl = tempRes.fileList[0].tempFileURL;
}
```

### 新代码 ✅

```xml
<!-- 新方式：使用统一组件 -->
<user-avatar 
  openid="{{item.userId}}"
  size="60"
  round="{{true}}"
></user-avatar>
```

```javascript
// 新方式：只需查询基本信息，头像由组件处理
const userRes = await db.collection('users')
  .where({ _openid: userId })
  .field({ nickName: true })
  .get();
```

---

## 待完成任务

- [ ] 集成后台管理端所有页面
- [ ] 添加头像预加载机制
- [ ] 实现头像更新的实时同步
- [ ] 添加头像压缩和CDN加速

---

## 维护指南

### 添加新的头像显示位置

1. **小程序端**：
   ```json
   // 在页面的 .json 文件中引入组件
   {
     "usingComponents": {
       "user-avatar": "/components/user-avatar/user-avatar"
     }
   }
   ```
   
   ```xml
   <!-- 在 .wxml 文件中使用组件 -->
   <user-avatar openid="{{openid}}" size="80"></user-avatar>
   ```

2. **后台管理端**：
   ```html
   <!-- 在页面中引入工具文件 -->
   <script src="../js/avatar-helper.js"></script>
   ```
   
   ```javascript
   // 在 JS 中使用工具方法
   const avatarHtml = await AvatarHelper.renderAvatar(openid, { size: 40 });
   ```

### 修改默认头像

在以下位置修改：
- 小程序组件：`miniprogram/components/user-avatar/user-avatar.js` 的 `defaultAvatar` 属性
- 后台工具：`admin/js/avatar-helper.js` 的 `DEFAULT_AVATAR` 常量

---

## 常见问题

### Q: 为什么头像不显示？
A: 检查以下几点：
1. OpenID 是否正确传入
2. users 集合中该 OpenID 的用户是否有 avatarUrl 字段
3. 云存储URL是否有效
4. 控制台是否有错误日志

### Q: 如何更新用户头像？
A: 只需更新 users 集合中的 avatarUrl 字段，所有使用该组件的地方会自动更新

### Q: 头像加载慢怎么办？
A: 
1. 启用懒加载：`lazy-load="{{true}}"`
2. 使用批量查询API（后台管理端）
3. 考虑添加CDN加速

---

**最后更新时间**：2025-10-23  
**版本**：v1.0  
**作者**：AI Assistant

