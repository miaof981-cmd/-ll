# 🔍 数据不同步问题排查

## 问题描述
在开发者工具添加的学生（命名为"1"），在手机端登录时显示的是旧的"测试学生"数据，说明数据没有同步。

---

## 🎯 问题原因

### 核心原因：权限隔离
微信云数据库默认使用 **`_openid`（用户唯一标识）** 来隔离数据：
- 开发者工具模拟器：有一个 `_openid`
- 手机微信预览：有另一个不同的 `_openid`

当前代码在查询数据时可能添加了 `_openid` 过滤，导致：
- 开发者工具添加的数据只能在开发者工具看到
- 手机端看不到开发者工具的数据

---

## 🔧 解决方案

### 方案1：修改数据库权限（推荐）

#### 步骤1：登录微信公众平台
1. 访问：https://mp.weixin.qq.com
2. 进入"云开发" → "数据库"

#### 步骤2：修改 `students` 集合权限
1. 找到 `students` 集合
2. 点击"权限设置"
3. 修改为：**所有用户可读，所有用户可写**（仅测试环境）
4. 或者：**所有用户可读，仅创建者可写**（生产环境）

#### 步骤3：同样修改其他集合
需要修改以下集合的权限：
- `photographers`
- `applications`
- `announcements`
- `banners`
- `archives`

---

### 方案2：去除查询中的 _openid 过滤

检查 `cloud-db.js` 中是否有类似的查询：
```javascript
// ❌ 错误：添加了 _openid 过滤
db.collection('students').where({
  _openid: '{openid}'  // 这会导致只能看到自己创建的数据
}).get()

// ✅ 正确：不过滤 _openid
db.collection('students').get()
```

---

## 🔍 快速诊断

### 在开发者工具 Console 执行以下命令：

```javascript
// 1. 查看当前 _openid
wx.cloud.callFunction({
  name: 'login',
  success: res => console.log('开发者工具 _openid:', res.result.openid)
});

// 2. 查看数据库中的学生数据
const db = wx.cloud.database();
db.collection('students').get({
  success: res => {
    console.log('数据库中的所有学生:', res.data);
    res.data.forEach(s => {
      console.log(`学号: ${s.studentId}, 姓名: ${s.name}, _openid: ${s._openid}`);
    });
  }
});
```

### 在手机端执行（通过 vConsole）：
相同的命令，对比 `_openid` 是否不同。

---

## ✅ 临时测试方案

### 方法1：在云开发控制台手动添加学生

1. 登录微信公众平台 → 云开发 → 数据库
2. 打开 `students` 集合
3. 点击"添加记录"
4. 手动输入以下JSON：
```json
{
  "studentId": "20250001",
  "name": "1",
  "parentName": "家长1",
  "password": "123456",
  "admissionLetter": "",
  "createdAt": "2025-10-14T12:00:00.000Z"
}
```
5. 保存

这样添加的数据**没有 _openid 限制**，所有端都能访问。

---

### 方法2：使用云函数添加数据

创建一个云函数来添加学生，云函数添加的数据不受 _openid 限制。

---

## 🎯 推荐做法（生产环境）

### 1. 数据库权限设置
- **读权限**：所有用户可读
- **写权限**：仅管理员可写（通过云函数控制）

### 2. 使用云函数管理数据
所有增删改操作都通过云函数，不要在小程序端直接操作数据库。

### 3. 云函数中验证管理员身份
```javascript
// 云函数中验证
const { OPENID } = cloud.getWXContext();
const ADMIN_OPENID = 'xxx'; // 管理员的 openid

if (OPENID !== ADMIN_OPENID) {
  return { success: false, error: '无权限' };
}
```

---

## 🚀 立即执行的步骤

### 步骤1：修改数据库权限（最快）
1. 打开微信公众平台
2. 云开发 → 数据库 → `students` 集合
3. 权限设置 → **所有用户可读，所有用户可写**
4. 保存

### 步骤2：重新测试
1. 开发者工具添加学生
2. 手机端登录
3. 查看是否能看到新学生

---

## 📝 验证方法

### 在开发者工具 Console：
```javascript
wx.cloud.database().collection('students').get({
  success: res => console.log('学生列表:', res.data)
});
```

### 预期结果：
应该能看到刚才添加的学生（名字为"1"）

---

## ⚠️ 重要提示

**当前问题是权限配置问题，不是代码问题。**

修改数据库权限为"所有用户可读"后，问题应该立即解决。

如果仍有问题，把开发者工具 Console 的输出发给我！

