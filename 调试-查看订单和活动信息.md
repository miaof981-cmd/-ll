# 调试：查看订单和活动信息

## 问题
确认收货后，学生档案没有自动创建

## 调试步骤

### 1. 查看控制台日志

在微信开发者工具的控制台中，查找以下日志：

```
📋 检查是否需要创建学生档案...
   活动类别: xxx
   学生姓名: xxx
```

**重点关注：**
- 活动类别是否为 `证件照`
- 学生姓名是否存在

---

### 2. 如果日志没有出现

可能的原因：
1. ❌ 订单状态不是 `pending_confirm`（待确认）
2. ❌ 没有点击"确认满意"按钮
3. ❌ JavaScript 报错，导致代码没有执行

---

### 3. 如果日志显示"活动类别: undefined"

说明订单关联的活动信息没有加载成功。

#### 解决方法：检查数据库

1. 打开微信开发者工具
2. 点击"云开发" → "数据库"
3. 打开 `activity_orders` 集合
4. 找到你的订单记录
5. 查看以下字段：
   - `activityId`: 是否有值？
   - `studentName`: 是否有值？
   - `photos`: 是否有照片？

6. 如果 `activityId` 有值，再打开 `activities` 集合
7. 找到对应的活动记录（用 `_id` 匹配）
8. 查看 `category` 字段是否为 `证件照`

---

### 4. 如果活动类别不是"证件照"

需要修改活动类别：

1. 云开发 → 数据库 → `activities` 集合
2. 找到证件照活动
3. 编辑 `category` 字段，改为 `证件照`（注意：必须是完全一致的中文）
4. 保存

---

### 5. 如果活动不存在或没有设置为默认

#### 创建默认证件照活动

在数据库 `activities` 集合中添加一条记录：

```json
{
  "name": "证件照拍摄",
  "category": "证件照",
  "description": "专业证件照拍摄服务",
  "coverImage": "",
  "price": 20,
  "isDefault": true,
  "status": "active",
  "createdAt": "2025-10-15T00:00:00.000Z",
  "updatedAt": "2025-10-15T00:00:00.000Z"
}
```

**重要字段说明：**
- `category`: 必须是 `证件照`（完全一致）
- `isDefault`: 必须是 `true`（表示默认活动）

---

### 6. 临时修复：手动更新订单的 activityId

如果现有订单的 `activityId` 为空，可以手动修复：

1. 获取证件照活动的 `_id`（从 `activities` 集合）
2. 更新 `activity_orders` 集合中的订单
3. 设置 `activityId` 为活动的 `_id`

---

### 7. 测试新订单

修复后，创建一个新订单测试：

1. 下单 → 摄影师上传 → 用户确认收货
2. 查看控制台日志
3. 查看"我的孩子"页面，是否出现新档案

---

## 快速检查清单

### 数据库检查

- [ ] `activities` 集合中有证件照活动
- [ ] 证件照活动的 `category` 为 `证件照`
- [ ] 证件照活动的 `isDefault` 为 `true`
- [ ] 订单的 `activityId` 有值
- [ ] 订单的 `studentName` 有值
- [ ] 订单的 `photos` 有照片

### 控制台日志检查

- [ ] 看到"📋 检查是否需要创建学生档案..."
- [ ] 活动类别显示为"证件照"
- [ ] 学生姓名有显示
- [ ] 看到"✅ 这是证件照订单，开始创建学生档案..."
- [ ] 看到"✅ 生成学号: 0001"
- [ ] 看到"✅ 学生档案创建成功！学号: 0001"

---

## 常见问题

### Q1: 为什么活动类别必须是"证件照"？

**A:** 代码中的判断条件是：
```javascript
if (activity?.category === '证件照' && order?.studentName) {
  // 创建档案
}
```

必须完全匹配，大小写、空格都要一致。

### Q2: 如果活动类别是"证件照拍摄"怎么办？

**A:** 有两种解决方法：
1. 在数据库中改为"证件照"
2. 修改代码，允许多个类别触发

### Q3: 如果我有多个证件照活动怎么办？

**A:** 确保其中一个设置为 `isDefault: true`，或者修改代码逻辑。

---

## 需要我帮助的信息

如果问题还没解决，请提供：

1. **控制台日志截图**（包含"检查是否需要创建学生档案"的部分）
2. **订单数据截图**（从数据库 `activity_orders`）
3. **活动数据截图**（从数据库 `activities`）

这样我可以更准确地帮你定位问题。

---

最后更新：2025-10-15

