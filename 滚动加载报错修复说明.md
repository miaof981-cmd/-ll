# 滚动加载报错修复说明

## 问题描述

**错误信息**：
```
Error: document.get:fail
document.get:fail cannot find document with __id test_activity, 
please make sure that the document exists and you have the corresponding access permission
```

**发生场景**：
- 用户滚动订单列表，触发分页加载下一页
- 当加载到引用了不存在活动（如 `test_activity`）的订单时
- 系统尝试从 `activities` 集合获取活动详情失败

## 根本原因

1. **测试数据遗留**：某些订单的 `activityId` 字段指向了测试活动（如 `test_activity`）
2. **活动已删除**：活动在数据库中已被删除，但订单仍然引用
3. **缺少降级方案**：代码虽然有 `try-catch`，但没有提供有效的降级策略

## 修复方案

### 核心改进
在 `orders.js` 的活动信息加载逻辑中，增加**降级方案**：

```javascript
// 加载活动信息（带降级方案）
try {
  const activityRes = await db.collection('activities')
    .doc(order.activityId)
    .get();
  
  if (activityRes.data) {
    order.activityInfo = activityRes.data;
  } else {
    // 活动不存在，使用订单快照信息
    order.activityInfo = {
      name: order.activityName || '活动已下架',
      coverImage: order.activityCover || '',
      price: order.price || order.totalPrice || 0
    };
  }
} catch (e) {
  // 活动加载失败（如活动已删除），使用订单快照信息
  console.warn(`⚠️ 活动 ${order.activityId} 不存在，使用快照信息`);
  order.activityInfo = {
    name: order.activityName || '活动已下架',
    coverImage: order.activityCover || '',
    price: order.price || order.totalPrice || 0
  };
}
```

### 降级策略

**优先级顺序**：
1. **活动存在**：显示最新的活动信息
2. **活动不存在**：使用订单快照信息（`activityName`, `activityCover`）
3. **快照缺失**：显示默认信息（"活动已下架"）

### 用户体验

**修复前**：
- 遇到不存在的活动时，页面报错
- 滚动加载中断
- 控制台红色错误，影响调试

**修复后**：
- 订单正常显示，标题显示"活动已下架"
- 使用订单快照中的封面图
- 滚动加载流畅，不中断
- 仅输出警告日志，便于定位问题订单

## 测试验证

### 测试步骤

1. **创建测试订单**：
   ```javascript
   // 在数据库中创建一个引用不存在活动的订单
   {
     activityId: 'test_activity',
     activityName: '测试活动',
     activityCover: 'cloud://...',
     // ... 其他字段
   }
   ```

2. **滚动加载测试**：
   - 进入订单页
   - 滚动到底部，触发分页加载
   - 观察是否正常显示

3. **控制台验证**：
   ```
   ⚠️ 活动 test_activity 不存在，使用快照信息
   ✅ 使用缓存: X 张 | 🔄 转换新图: Y 张
   📊 [订单列表] 总计 20 条，可加载更多
   ```

### 预期结果

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| 活动不存在 | 报错，加载中断 | 显示"活动已下架"，正常加载 |
| 控制台日志 | 红色 Error | 黄色 Warning |
| 用户体验 | 无法查看订单 | 正常查看，略有提示 |
| 开发调试 | 难以定位问题 | 清晰标识问题订单 |

## 建议后续优化

### 1. 数据清理
定期清理引用不存在活动的订单：
```javascript
// 云函数：清理无效订单
const orders = await db.collection('activity_orders')
  .where({ activityId: 'test_activity' })
  .get();

// 删除或修复这些订单
```

### 2. 订单快照完整性
创建订单时，确保保存完整的活动快照：
```javascript
{
  activityId: '...',
  activityName: '...',      // 快照
  activityCover: '...',     // 快照
  activityPrice: 0.01,      // 快照
  activityDesc: '...'       // 快照（可选）
}
```

### 3. 活动状态标记
在 `activities` 集合中增加 `status` 字段：
```javascript
{
  _id: '...',
  name: '...',
  status: 'active' | 'archived' | 'deleted',
  // ...
}
```

不要物理删除活动，而是标记为 `deleted`，保证订单引用完整性。

### 4. 前端提示优化
为已下架活动增加视觉标识：
```xml
<!-- orders.wxml -->
<view wx:if="{{item.activityInfo.status === 'deleted'}}" class="activity-archived-badge">
  活动已下架
</view>
```

## 修改文件

- ✅ `miniprogram/pages/user/orders/orders.js` - 增加降级方案

## 验收标准

- ✅ 滚动加载不再报错
- ✅ 不存在的活动显示"活动已下架"
- ✅ 订单快照信息正常显示
- ✅ 控制台仅输出警告，无错误
- ✅ 用户体验流畅，无感知异常

---

**修复完成时间**：2025-10-23  
**修复版本**：在"完美的加载优化版本"基础上增量修复

