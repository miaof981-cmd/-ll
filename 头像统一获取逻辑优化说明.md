# 头像统一获取逻辑优化说明

## 问题描述

摄影师头像在不同页面显示不一致，原因是页面取头像的来源不统一：
- 有些页面从 `photographers.avatar` 获取
- 有些页面从 `users.avatarUrl` 获取
- 有些页面在 `onLoad` 时获取，此时 `globalData` 可能还未加载完成

## 解决方案

### 核心原则

1. **统一数据源**：所有头像统一从 `users` 集合的 `avatarUrl` 字段获取
2. **优先使用 globalData**：当前登录用户的头像优先从 `app.globalData.userInfo.avatarUrl` 获取
3. **在 onShow 阶段取数据**：避免在 `onLoad()` 时 `globalData` 还未加载完成

### 修改文件清单

#### 1. 摄影师主页 `miniprogram/pages/photographer/tasks.js`

**修改内容**：
- ✅ 将数据加载从 `onLoad()` 移到 `onShow()`
- ✅ 优先从 `app.globalData.userInfo` 获取当前用户信息
- ✅ 如果 `globalData` 为空，调用云函数并更新 `globalData`
- ✅ 如果 `userInfo` 没有头像，从 `users` 集合查询
- ✅ 设置 `photographerInfo.avatarUrl` 为 `userInfo.avatarUrl`（而非 `photographers.avatar`）

**关键代码**：
```javascript
// 优先从 globalData 获取用户信息
const app = getApp();
let userInfo = app.globalData.userInfo;

// 如果 globalData 没有，则调用云函数获取
if (!userInfo) {
  const { result } = await wx.cloud.callFunction({ name: 'unifiedLogin' });
  userInfo = result.userInfo || result.user;
  app.globalData.userInfo = userInfo;
}

// 如果 userInfo 中没有头像，从 users 集合查询
if (!userInfo || !userInfo.avatarUrl) {
  const { data: users } = await db.collection('users')
    .where({ _openid: userOpenId })
    .get();
  if (users && users.length > 0) {
    userInfo = users[0];
    app.globalData.userInfo = userInfo;
  }
}

// 使用 users 集合的 avatarUrl
photographerInfo.avatarUrl = userInfo?.avatarUrl || photographers.avatar || '';
```

#### 2. 头像组件 `miniprogram/components/user-avatar/user-avatar.js`

**修改内容**：
- ✅ 优先从 `app.globalData.userInfo` 获取当前登录用户头像
- ✅ 比对 `openid`，如果是当前用户，直接使用 `globalData` 的头像
- ✅ 否则使用 `avatarManager` 从数据库查询

**关键代码**：
```javascript
// 优先从 globalData 获取当前用户头像
const app = getApp();
const globalUserInfo = app.globalData.userInfo;
const globalOpenId = globalUserInfo?._openid || globalUserInfo?.openid;

let avatarUrl = null;

// 如果是当前登录用户，直接使用 globalData 的头像
if (globalOpenId && globalOpenId === newOpenId && globalUserInfo?.avatarUrl) {
  avatarUrl = globalUserInfo.avatarUrl;
  console.log('✅ [头像组件] 从 globalData 获取当前用户头像');
} else {
  // 否则使用全局头像管理器从数据库查询
  avatarUrl = await avatarManager.getAvatar(newOpenId);
}
```

#### 3. 用户订单详情页 `miniprogram/pages/user/orders/detail.js`

**修改内容**：
- ✅ 从 `photographers` 集合获取基本信息（name, status等）
- ✅ 从 `users` 集合获取最新头像
- ✅ 设置 `photographerInfo.avatarUrl` 而非 `photographerInfo.avatar`

**关键代码**：
```javascript
// 从 photographers 集合获取基本信息
const photographerRes = await db.collection('photographers').doc(order.photographerId).get();
photographerInfo = photographerRes.data;

// 统一从 users 集合获取最新头像
if (photographerInfo && photographerInfo._openid) {
  const userRes = await db.collection('users')
    .where({ _openid: photographerInfo._openid })
    .get();
  
  if (userRes.data && userRes.data.length > 0) {
    const userData = userRes.data[0];
    photographerInfo.avatarUrl = userData.avatarUrl || photographerInfo.avatar || '';
  }
}
```

#### 4. WXML 文件修改

**修改文件**：
- `miniprogram/pages/user/orders/detail.wxml`
- `miniprogram/pages/admin/orders/detail.wxml`

**修改内容**：
- ✅ 将 `{{photographerInfo.avatar}}` 改为 `{{photographerInfo.avatarUrl}}`

#### 5. 管理员订单详情页 `miniprogram/pages/admin/orders/detail.js`

**修改内容**：
- ✅ 同用户订单详情页的修改逻辑

## 数据流程图

```
┌─────────────────────────────────────────┐
│   登录授权（login.js）                    │
│   ↓                                      │
│   上传头像到云存储                        │
│   ↓                                      │
│   调用 unifiedLogin 云函数                │
│   ↓                                      │
│   写入 users 集合（avatarUrl）            │
│   ↓                                      │
│   保存到 localStorage (unifiedUserInfo)   │
│   ↓                                      │
│   更新 app.globalData.userInfo           │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   摄影师主页 (tasks.js)                   │
│   - onShow() 时从 globalData 获取         │
│   - 如果为空，调用云函数更新 globalData    │
│   - 从 users 集合查询最新头像             │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   头像组件 (user-avatar.js)              │
│   - 比对 openid 是否为当前用户            │
│   - 是：直接用 globalData.userInfo.avatarUrl │
│   - 否：用 avatarManager 从 users 查询    │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   订单详情页 (detail.js)                 │
│   - 从 photographers 获取 name 等基本信息  │
│   - 从 users 获取 avatarUrl               │
│   - 设置 photographerInfo.avatarUrl       │
└─────────────────────────────────────────┘
```

## 测试要点

### 1. 摄影师头像一致性测试

**测试场景**：以摄影师身份登录

| 页面 | 预期结果 |
|------|---------|
| 我的页面 (`my.wxml`) | 显示 `globalData.userInfo.avatarUrl` |
| 摄影师主页 (`tasks.wxml`) | 显示 `globalData.userInfo.avatarUrl` |
| 用户订单详情页 (摄影师信息) | 显示从 `users` 集合查询的 `avatarUrl` |
| 管理员订单详情页 (摄影师信息) | 显示从 `users` 集合查询的 `avatarUrl` |

**验证标准**：
- ✅ 所有页面显示的摄影师头像完全一致
- ✅ 修改头像后，所有页面同步更新（刷新后）
- ✅ 不会出现部分页面显示旧头像的情况

### 2. 头像更新流程测试

**测试步骤**：
1. 以摄影师身份登录
2. 在"我的"页面点击"刷新用户信息"
3. 跳转到登录页（编辑模式）
4. 选择新头像并保存
5. 返回各个页面验证头像是否更新

**预期结果**：
- ✅ 所有页面的头像同步更新为新头像
- ✅ 云数据库 `users` 集合的 `avatarUrl` 字段已更新
- ✅ `app.globalData.userInfo.avatarUrl` 已更新

### 3. 页面加载时序测试

**测试场景**：冷启动小程序

**测试步骤**：
1. 清除小程序缓存
2. 重新打开小程序
3. 依次访问：我的页面 → 摄影师主页 → 订单详情页

**预期结果**：
- ✅ 摄影师主页在 `onShow()` 时能正确获取 `globalData`
- ✅ 如果 `globalData` 为空，能自动调用云函数并更新
- ✅ 所有页面头像正常显示，无空白或默认头像

### 4. 多角色用户测试

**测试场景**：一个用户同时拥有家长和摄影师角色

**测试步骤**：
1. 以摄影师身份登录
2. 查看摄影师主页的头像
3. 切换到家长角色
4. 查看"我的"页面的头像
5. 查看自己创建的订单，其中摄影师是自己

**预期结果**：
- ✅ 无论哪个角色，显示的都是同一个头像（来自 `users.avatarUrl`）
- ✅ 订单中的摄影师头像也是同一个

## 技术优势

1. **性能优化**：当前用户头像直接从内存 `globalData` 读取，无需查询数据库
2. **数据一致性**：所有头像来源统一为 `users.avatarUrl`，消除数据不一致风险
3. **加载时序优化**：在 `onShow()` 获取数据，确保 `globalData` 已准备好
4. **降级策略**：多层降级机制，确保即使某个环节失败也能显示头像

## 注意事项

1. **旧数据兼容**：如果 `photographers` 集合中有 `avatar` 字段，代码会自动降级使用
2. **OpenID 必须存在**：`photographers` 表必须有 `_openid` 字段才能从 `users` 查询
3. **缓存清理**：如果用户反馈头像不更新，可能需要清理 `avatarManager` 的缓存

## 相关文件

- `miniprogram/pages/photographer/tasks.js` - 摄影师主页
- `miniprogram/components/user-avatar/user-avatar.js` - 头像组件
- `miniprogram/pages/user/orders/detail.js` - 用户订单详情
- `miniprogram/pages/admin/orders/detail.js` - 管理员订单详情
- `miniprogram/pages/user/orders/detail.wxml` - 用户订单详情模板
- `miniprogram/pages/admin/orders/detail.wxml` - 管理员订单详情模板
- `cloudfunctions/unifiedLogin/index.js` - 统一登录云函数
- `miniprogram/utils/avatar-manager.js` - 头像缓存管理器

## 版本信息

- 修改时间：2025-10-24
- 版本标签：头像统一获取逻辑优化
- 相关问题：摄影师头像在不同页面显示不一致

